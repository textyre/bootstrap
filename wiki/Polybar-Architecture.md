# Polybar — Архитектура и требования

## Концепция: три плавающих острова

Polybar реализован как три визуально независимых панели ("острова") вверху экрана поверх i3 WM. Каждый остров — отдельный процесс polybar, не управляемый оконным менеджером.

```
[Workspaces] [+]         [Clock]              [System Info]
   левый край           по центру             правый край
```

### Визуальное оформление

- Фон экрана полностью прозрачный, острова — полупрозрачные с тонкой рамкой
- Скруглённые углы, одинаковая высота и вертикальный отступ у всех баров
- Nerd Font иконки для всех модулей
- Все визуальные параметры (высота, радиус, отступы, шрифты) определяются централизованно через chezmoi data-файлы

### Темы

Поддерживаются две цветовые схемы, переключаемые через chezmoi:

- **Dracula (Catppuccin Mocha)** — тёмно-фиолетовая палитра с цветными акцентами (фиолетовый, зелёный, жёлтый, голубой, розовый)
- **Monochrome** — чёрно-белая палитра, единственный цветной элемент — urgent (тёмно-красный)

Тема применяется ко всем компонентам: polybar, rofi-меню, рамки баров.

**Формат цветов:** polybar использует `#AARRGGBB` (альфа первой), а не стандартный `#RRGGBBAA`.

---

## 4 бара

### workspaces (левый остров)

Отображает индикаторы рабочих пространств i3. Ширина динамическая — пересчитывается при изменении числа WS. Работает в tail-режиме: скрипт подписан на i3 IPC и обновляет отображение при каждом событии WM.

Визуальные состояния воркспейсов:
- **Focused** — акцентный цвет + подчёркивание
- **Occupied** — основной цвет текста
- **Empty** — приглушённый цвет
- **Urgent** — красный

WS 1-3 видны всегда (даже пустые), WS 4-10 появляются по мере создания.

### workspace-add (левый остров, кнопка "+")

Маленькая кнопка справа от workspace-бара. При клике открывает rofi-меню выбора иконки и создаёт новый воркспейс.

### clock (центральный остров)

Фиксированная ширина, по центру экрана. Показывает день недели, дату и время. Обновляется каждую секунду. Клик открывает календарь.

### system (правый остров)

Фиксированная ширина, прижат к правому краю. Содержит модули системного мониторинга и управления.

---

## Модули

### Системный мониторинг

| Модуль | Что показывает | Обновление | Интерактивность |
|--------|---------------|------------|-----------------|
| network | IP-адрес или статус disconnected | Поллинг 3s | Клик → сетевые настройки |
| volume | Громкость в % или muted | Событийный (PulseAudio) | Скролл +/-5%, клик → микшер |
| cpu | Загрузка CPU в % | Поллинг 2s | — |
| memory | Использование RAM в % | Поллинг 3s | — |
| date | День, дата, время | Поллинг 1s | Клик → календарь |

### Управление

| Модуль | Назначение | Интерактивность |
|--------|-----------|-----------------|
| controlcenter | Иконка настроек | Клик → rofi-скрипт центра управления |
| powermenu | Иконка питания | Клик → rofi-скрипт выключения/перезагрузки |
| tray | Системный трей | Зарезервирован, сейчас пуст |

### Вспомогательные

| Модуль | Назначение |
|--------|-----------|
| workspaces | Скрипт отображения WS (tail mode, i3 IPC) |
| workspace-add-btn | Кнопка "+" для создания WS |
| sep | Фиксированный отступ между модулями |

---

## Конфигурация и темплейтирование

Все конфиги polybar и rofi — chezmoi-шаблоны. При `chezmoi apply` подставляются значения из трёх data-файлов:

- **themes** — цветовые палитры (22 цвета на тему)
- **layout** — размеры баров, отступы, радиусы, gaps (~16 параметров)
- **fonts** — семейство шрифтов и размеры

Тема выбирается в `chezmoi.toml` по имени. Шаблоны рендерят итоговые конфиги с подставленными цветами, размерами и шрифтами.

---

## Запуск и перезагрузка

- Polybar запускается из i3 config через `exec_always` — при каждом рестарте i3
- Лаунчер убивает предыдущие процессы, рассчитывает ширину WS-бара, запускает 4 бара на каждый монитор
- Multi-monitor: определяется через xrandr, graceful fallback на один экран
- IPC включён, но `polybar-msg restart` не перечитывает env vars — поэтому при изменении числа WS требуется полный перезапуск

---

## Зависимости

**Обязательные:** i3 WM, jq, rofi, pamixer, xrandr (fallback если нет)

**Опциональные:** gsimplecal (календарь), pavucontrol (микшер), alacritty (терминал для nmtui)

**Системные требования:** локаль UTF-8, Nerd Font установлен, X11, PulseAudio или PipeWire

---

## Известные проблемы

- Полный перезапуск polybar при добавлении/удалении WS вызывает видимый flash
- Несколько констант (padding, gap, icon width) захардкожены в скриптах вместо data-файлов — при изменении нужно править в нескольких местах
- Dracula тема и multi-monitor не тестированы визуально
- Polybar не поддерживает Wayland — при миграции потребуется waybar/eww

---

## Динамические воркспейсы — чеклист на подумать

> Отдельная подсистема управления WS 4-10. Требует ревизии перед миграцией.

- [ ] Ширина workspace-бара пересчитывается корректно при 4-10 WS
- [ ] Добавление WS через "+" не вызывает визуальных артефактов
- [ ] Смена иконки без перезапуска работает стабильно
- [ ] Закрытие WS: окна корректно перемещаются в WS 1
- [ ] Right-click меню работает только для WS 4+
- [ ] workspace-icons.conf не конфликтует при multi-monitor
- [ ] Перезапуск polybar можно заменить на IPC hot-reload
- [ ] Захардкоженные константы вынести в layout.toml
