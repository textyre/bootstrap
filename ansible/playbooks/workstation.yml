---
# Полная настройка рабочей станции после установки ОС
#
# Использование:
#   Через bootstrap: ./bootstrap.sh
#   Вручную: task workstation
#   Dry-run: task dry-run
#
# Переопределение переменных:
#   ansible-playbook playbooks/workstation.yml -e '{"packages_docker": ["docker", "docker-compose", "docker-buildx"]}'
#
# Выборочный запуск по тегам:
#   ansible-playbook playbooks/workstation.yml --tags packages
#   ansible-playbook playbooks/workstation.yml --tags "docker,firewall"
#
# Пароль sudo зашифрован в inventory/group_vars/all/vault.yml (Ansible Vault)
# Vault password: ~/.vault-pass или pass show ansible/vault-password
#
# Тип подключения определяется в inventory/hosts.ini (local или ssh)

- name: Setup workstation
  hosts: workstations
  become: true
  gather_facts: true

  roles:
    # --- Phase 1: System foundation ---
    - role: timezone
      tags: [system, timezone]

    - role: locale
      tags: [system, locale]

    - role: hostname
      tags: [system, hostname]

    - role: hostctl
      tags: [system, hostctl]

    - role: vconsole
      tags: [system, vconsole]

    - role: ntp
      tags: [system, ntp]
      when: ntp_enabled | default(true)

    - role: ntp_audit
      tags: [system, ntp, ntp_audit]
      when: ntp_audit_enabled | default(true)

    - role: package_manager
      tags: [packages, pacman]

    - role: pam_hardening
      tags: [pam, security, hardening]

    - role: vm
      tags: [vm, vbox, vmware, hyperv]

    # --- Phase 1.5: Hardware & Kernel ---
    - role: gpu_drivers
      tags: [gpu, drivers, hardware]

    - role: sysctl
      tags: [sysctl, kernel, tuning]

    - role: power_management
      tags: [power, tlp, battery]

    # --- Phase 2: Package infrastructure ---
    - role: packages
      tags: [packages, install]

    # --- Phase 3: User & access ---
    - role: user
      tags: [user]

    - role: ssh_keys
      tags: [ssh_keys, security]

    - role: ssh
      tags: [ssh, security]

    - role: teleport
      tags: [teleport, security]
      when: teleport_enabled | default(false)

    - role: fail2ban
      tags: [fail2ban, security]
      when: fail2ban_enabled | default(true)

    # --- Phase 4: Development tools ---
    - role: git
      tags: [git]

    - role: shell
      tags: [shell]

    # --- Phase 5: Services ---
    - role: docker
      tags: [docker]

    - role: firewall
      tags: [firewall, security]

    - role: caddy
      tags: [caddy, proxy, security]

    - role: vaultwarden
      tags: [vaultwarden, security, secrets]

    # --- Phase 6: Desktop environment ---
    - role: xorg
      tags: [xorg, display]
      when: ansible_facts['os_family'] == 'Archlinux'

    - role: lightdm
      tags: [lightdm, display]

    - role: greeter
      tags: [greeter, display]

    - role: zen_browser
      tags: [zen_browser, browser]
      when: ansible_facts['os_family'] == 'Archlinux'

    # --- Phase 7: User dotfiles ---
    - role: chezmoi
      tags: [chezmoi, dotfiles]
