---
# === Деплой дотфайлов через chezmoi ===
# Установка, инициализация, применение

# ---- Resolve paths (нужно до install для script метода) ----

- name: Get user home directory
  ansible.builtin.getent:
    database: passwd
    key: "{{ chezmoi_user }}"
  tags: ['chezmoi', 'dotfiles']

- name: Set user home fact
  ansible.builtin.set_fact:
    _chezmoi_user_home: "{{ getent_passwd[chezmoi_user][4] }}"
  tags: ['chezmoi', 'dotfiles']

# ---- Установка chezmoi (OS-specific) ----

- name: Install chezmoi (OS-specific)
  ansible.builtin.include_tasks: "install-{{ ansible_facts['os_family'] | lower }}.yml"
  tags: ['chezmoi', 'dotfiles', 'install']

- name: Install chezmoi via official script
  become: true
  become_user: "{{ chezmoi_user }}"
  ansible.builtin.shell: |
    sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
  args:
    creates: "{{ chezmoi_user_home }}/.local/bin/chezmoi"
  when: chezmoi_install_method == 'script'
  tags: ['chezmoi', 'dotfiles', 'install']

# ---- Validate source ----

- name: Resolve chezmoi source directory
  ansible.builtin.stat:
    path: "{{ chezmoi_source_dir }}"
  register: chezmoi_source_stat
  tags: ['chezmoi', 'dotfiles']

- name: Assert chezmoi source directory exists
  ansible.builtin.assert:
    that:
      - _chezmoi_source_stat.stat.exists
      - _chezmoi_source_stat.stat.isdir
    fail_msg: "Директория с дотфайлами не найдена: {{ chezmoi_source_dir }}"
  tags: ['chezmoi', 'dotfiles']

# ---- Подготовка: обои ----

- name: Check wallpapers source directory
  ansible.builtin.stat:
    path: "{{ chezmoi_source_dir }}/wallpapers"
  register: chezmoi_wallpapers_dir
  tags: ['chezmoi', 'dotfiles']

- name: Ensure wallpapers directory exists
  ansible.builtin.file:
    path: "{{ chezmoi_user_home }}/.local/share/wallpapers"
    state: directory
    owner: "{{ chezmoi_user }}"
    group: "{{ chezmoi_user }}"
    mode: '0755'
  when: _chezmoi_wallpapers_dir.stat.exists
  tags: ['chezmoi', 'dotfiles']

- name: Deploy wallpapers
  ansible.builtin.copy:
    src: "{{ chezmoi_source_dir }}/wallpapers/"
    dest: "{{ chezmoi_user_home }}/.local/share/wallpapers/"
    owner: "{{ chezmoi_user }}"
    group: "{{ chezmoi_user }}"
    mode: '0644'
    remote_src: true
  when: _chezmoi_wallpapers_dir.stat.exists
  tags: ['chezmoi', 'dotfiles']

# ---- Инициализация и применение ----

- name: Initialize chezmoi from local source
  become: true
  become_user: "{{ chezmoi_user }}"
  ansible.builtin.command: >
    chezmoi init
    --source "{{ chezmoi_source_dir }}"
    --promptChoice "Choose color theme={{ chezmoi_theme_name }}"
    --apply
  args:
    chdir: "{{ chezmoi_user_home }}"
  register: chezmoi_apply
  changed_when: _chezmoi_apply.rc == 0
  tags: ['chezmoi', 'dotfiles']

- name: Verify no nested chezmoidata (guard against stale theme data)
  become: true
  become_user: "{{ chezmoi_user }}"
  ansible.builtin.command:
    cmd: find {{ chezmoi_user_home }}/.local/share/chezmoi -mindepth 2 -name '.chezmoidata' -type d
  register: chezmoi_nested_check
  changed_when: false
  failed_when: _chezmoi_nested_check.stdout | length > 0
  tags: ['chezmoi', 'dotfiles']

- name: Report chezmoi deployment
  ansible.builtin.debug:
    msg:
      - "Пользователь: {{ chezmoi_user }}"
      - "Источник: {{ chezmoi_source_dir }}"
      - "chezmoi init --apply выполнен"
  tags: ['chezmoi', 'dotfiles']
