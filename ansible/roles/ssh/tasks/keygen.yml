---
# === Генерация SSH-ключа ===
# Создание ключевой пары для целевого пользователя

- name: Get user home directory
  ansible.builtin.getent:
    database: passwd
    key: "{{ ssh_user }}"
  tags: ['ssh', 'keygen']

- name: Set user home fact
  ansible.builtin.set_fact:
    _ssh_user_home: "{{ getent_passwd[ssh_user][4] }}"
  tags: ['ssh', 'keygen']

- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: "{{ _ssh_user_home }}/.ssh"
    state: directory
    owner: "{{ ssh_user }}"
    group: "{{ ssh_user }}"
    mode: '0700'
  tags: ['ssh', 'keygen']

- name: Generate SSH key pair ({{ ssh_key_type }})
  community.crypto.openssh_keypair:
    path: "{{ _ssh_user_home }}/.ssh/id_{{ ssh_key_type }}"
    type: "{{ ssh_key_type }}"
    comment: "{{ ssh_key_comment }}"
    owner: "{{ ssh_user }}"
    group: "{{ ssh_user }}"
    mode: '0600'
  tags: ['ssh', 'keygen']
