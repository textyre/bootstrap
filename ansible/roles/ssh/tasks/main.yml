---
# === Настройка SSH ===
# Полный hardening sshd: ключи, конфиг, модули, баннер, сервис

# ROLE-003: Validate supported OS
- name: "Assert supported operating system"
  ansible.builtin.assert:
    that:
      - ansible_facts['os_family'] in _ssh_supported_os
    fail_msg: >-
      OS family '{{ ansible_facts['os_family'] }}' is not supported.
      Supported: {{ _ssh_supported_os | join(', ') }}
  tags: [ssh]

# ROLE-001: OS-specific variables
- name: "Include OS-specific variables"
  ansible.builtin.include_vars: "{{ ansible_facts['os_family'] | lower }}.yml"
  tags: [ssh]

# ---- Установка openssh (OS-specific) ----

- name: Install openssh (OS-specific)
  ansible.builtin.include_tasks: "install-{{ ansible_facts['os_family'] | lower }}.yml"
  tags: ['ssh', 'install']

# ---- Генерация SSH-ключа ----

- name: Generate SSH key pair
  ansible.builtin.include_tasks: keygen.yml
  when: ssh_generate_key
  tags: ['ssh', 'keygen']

# ---- Pre-flight: защита от блокировки ----

- name: Pre-flight lockout protection
  ansible.builtin.include_tasks: preflight.yml
  when: ssh_harden_sshd
  tags: ['ssh', 'security']

# ---- Hardening sshd ----

- name: Harden sshd configuration
  ansible.builtin.include_tasks: harden.yml
  when: ssh_harden_sshd
  tags: ['ssh', 'security']

# ---- Очистка DH-модулей (опционально) ----

- name: Clean up weak DH moduli
  ansible.builtin.include_tasks: moduli.yml
  when: ssh_moduli_cleanup
  tags: ['ssh', 'security', 'moduli']

# ---- SSH баннер (опционально) ----

- name: Deploy SSH banner
  ansible.builtin.include_tasks: banner.yml
  when: ssh_banner_enabled
  tags: ['ssh', 'banner']

# ---- Управление сервисом ----

- name: Manage sshd service
  ansible.builtin.include_tasks: service.yml
  tags: ['ssh', 'service']

# ---- Отчёт ----

- name: Report SSH configuration
  ansible.builtin.debug:
    msg:
      - "SSH hardening: {{ 'включён' if ssh_harden_sshd else 'выключен' }}"
      - "Порт: {{ ssh_port }}"
      - "PermitRootLogin: {{ ssh_permit_root_login }}"
      - "PasswordAuthentication: {{ ssh_password_authentication }}"
      - "AllowGroups: {{ ssh_allow_groups | join(', ') if ssh_allow_groups | length > 0 else 'все' }}"
      - "Модули DH: {{ 'очищены (<' ~ ssh_moduli_minimum_bits ~ ' бит)' if ssh_moduli_cleanup else 'не изменены' }}"
      - "Баннер: {{ 'включён' if ssh_banner_enabled else 'выключен' }}"
  tags: ['ssh']
