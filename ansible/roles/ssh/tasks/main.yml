---
# === Настройка SSH ===
# Генерация ключей, hardening sshd

# ---- Установка openssh (OS-specific) ----

- name: Install openssh (OS-specific)
  ansible.builtin.include_tasks: "install-{{ ansible_facts['os_family'] | lower }}.yml"
  tags: ['ssh', 'install']

# ---- Генерация SSH-ключа ----

- name: Get user home directory
  ansible.builtin.getent:
    database: passwd
    key: "{{ ssh_user }}"
  tags: ['ssh']

- name: Set user home fact
  ansible.builtin.set_fact:
    _ssh_user_home: "{{ getent_passwd[ssh_user][4] }}"
  tags: ['ssh']

- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: "{{ _ssh_user_home }}/.ssh"
    state: directory
    owner: "{{ ssh_user }}"
    group: "{{ ssh_user }}"
    mode: '0700'
  tags: ['ssh']

- name: Generate SSH key pair
  community.crypto.openssh_keypair:
    path: "{{ _ssh_user_home }}/.ssh/id_{{ ssh_key_type }}"
    type: "{{ ssh_key_type }}"
    comment: "{{ ssh_key_comment }}"
    owner: "{{ ssh_user }}"
    group: "{{ ssh_user }}"
    mode: '0600'
  when: ssh_generate_key
  tags: ['ssh']

# ---- Hardening sshd ----

- name: Harden sshd configuration
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
    validate: '/usr/sbin/sshd -t -f %s'
  loop:
    - { regexp: '^#?\s*PermitRootLogin', line: "PermitRootLogin {{ ssh_permit_root_login }}" }
    - { regexp: '^#?\s*PasswordAuthentication', line: "PasswordAuthentication {{ ssh_password_authentication }}" }
    - { regexp: '^#?\s*PubkeyAuthentication', line: "PubkeyAuthentication {{ ssh_pubkey_authentication }}" }
    - { regexp: '^#?\s*X11Forwarding', line: "X11Forwarding {{ ssh_x11_forwarding }}" }
    - { regexp: '^#?\s*MaxAuthTries', line: "MaxAuthTries {{ ssh_max_auth_tries }}" }
    - { regexp: '^#?\s*ClientAliveInterval', line: "ClientAliveInterval {{ ssh_client_alive_interval }}" }
    - { regexp: '^#?\s*ClientAliveCountMax', line: "ClientAliveCountMax {{ ssh_client_alive_count_max }}" }
    - { regexp: '^#?\s*LoginGraceTime', line: "LoginGraceTime {{ ssh_login_grace_time }}" }
    - { regexp: '^#?\s*MaxStartups', line: "MaxStartups {{ ssh_max_startups }}" }
    - { regexp: '^#?\s*Ciphers', line: "Ciphers {{ ssh_ciphers | join(',') }}" }
    - { regexp: '^#?\s*MACs', line: "MACs {{ ssh_macs | join(',') }}" }
    - { regexp: '^#?\s*KexAlgorithms', line: "KexAlgorithms {{ ssh_kex_algorithms | join(',') }}" }
  when: ssh_harden_sshd
  notify: Restart sshd
  tags: ['ssh', 'security']

- name: Restrict SSH access to specific groups
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?\s*AllowGroups'
    line: "AllowGroups {{ ssh_allow_groups | join(' ') }}"
    state: present
    validate: '/usr/sbin/sshd -t -f %s'
  when:
    - ssh_harden_sshd
    - ssh_allow_groups | length > 0
  notify: Restart sshd
  tags: ['ssh', 'security']

- name: Restrict SSH access to specific users
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?\s*AllowUsers'
    line: "AllowUsers {{ ssh_allow_users | join(' ') }}"
    state: present
    validate: '/usr/sbin/sshd -t -f %s'
  when:
    - ssh_harden_sshd
    - ssh_allow_users | length > 0
  notify: Restart sshd
  tags: ['ssh', 'security']

- name: Enable and start sshd
  ansible.builtin.service:
    name: sshd
    enabled: true
    state: started
  tags: ['ssh', 'service']
