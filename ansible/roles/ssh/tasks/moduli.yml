---
# === DH moduli hardening ===
# Remove weak Diffie-Hellman parameters below minimum bit size.
#
# ROLE-011 exception: Uses command + awk because the moduli file format
# is fixed-width columnar data with no Ansible module equivalent for
# column-based filtering. The awk approach is canonical (dev-sec.io,
# konstruktoid, Mozilla guidelines all use it).

- name: "Check if /etc/ssh/moduli exists"
  ansible.builtin.stat:
    path: /etc/ssh/moduli
  register: ssh_moduli_file
  tags: [ssh, security, moduli]

- name: "Count weak DH moduli (< {{ ssh_moduli_minimum_bits }} bits)"
  ansible.builtin.command:
    cmd: "awk '$5 < {{ ssh_moduli_minimum_bits }}' /etc/ssh/moduli"
  register: ssh_weak_moduli
  changed_when: false
  when: _ssh_moduli_file.stat.exists
  tags: [ssh, security, moduli]

- name: "Filter strong DH moduli (>= {{ ssh_moduli_minimum_bits }} bits)"
  ansible.builtin.command:
    cmd: "awk '$5 >= {{ ssh_moduli_minimum_bits }}' /etc/ssh/moduli"
  register: ssh_strong_moduli
  changed_when: false
  when:
    - _ssh_moduli_file.stat.exists
    - _ssh_weak_moduli.stdout_lines | length > 0
  tags: [ssh, security, moduli]

- name: "Deploy filtered moduli file"
  ansible.builtin.copy:
    content: "{{ ssh_strong_moduli.stdout }}\n"
    dest: /etc/ssh/moduli
    owner: root
    group: root
    mode: "0644"
    backup: true
  when:
    - _ssh_moduli_file.stat.exists
    - _ssh_weak_moduli.stdout_lines | default([]) | length > 0
    - _ssh_strong_moduli.stdout | default('') | length > 0
  notify: "Restart sshd"
  tags: [ssh, security, moduli]
