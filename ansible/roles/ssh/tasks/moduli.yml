---
# === Очистка DH-модулей ===
# Удаление слабых DH-модулей < ssh_moduli_minimum_bits (по умолчанию 3072)
# Рекомендация: dev-sec, konstruktoid, Mozilla Modern

- name: Check if /etc/ssh/moduli exists
  ansible.builtin.stat:
    path: /etc/ssh/moduli
  register: _ssh_moduli_file
  tags: ['ssh', 'security', 'moduli']

- name: Count weak DH moduli (< {{ ssh_moduli_minimum_bits }} bits)
  ansible.builtin.shell: >
    awk '$5 < {{ ssh_moduli_minimum_bits }}' /etc/ssh/moduli | wc -l
  args:
    executable: /bin/bash
  register: _ssh_weak_moduli_count
  changed_when: false
  when: _ssh_moduli_file.stat.exists
  tags: ['ssh', 'security', 'moduli']

- name: Filter out weak DH moduli (< {{ ssh_moduli_minimum_bits }} bits)
  ansible.builtin.shell: >
    awk '$5 >= {{ ssh_moduli_minimum_bits }}' /etc/ssh/moduli > /etc/ssh/moduli.safe &&
    mv /etc/ssh/moduli.safe /etc/ssh/moduli
  args:
    executable: /bin/bash
  when:
    - _ssh_moduli_file.stat.exists
    - _ssh_weak_moduli_count.stdout | default('0') | int > 0
  notify: Restart sshd
  tags: ['ssh', 'security', 'moduli']

- name: Set correct permissions on moduli
  ansible.builtin.file:
    path: /etc/ssh/moduli
    owner: root
    group: root
    mode: '0644'
  when: _ssh_moduli_file.stat.exists
  tags: ['ssh', 'security', 'moduli']
