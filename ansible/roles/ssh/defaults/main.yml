---
# === Настройка SSH ===
# Генерация ключей, клиентский конфиг, hardening sshd

# Целевой пользователь
ssh_user: "{{ ansible_facts['env']['SUDO_USER'] | default(ansible_facts['user_id']) }}"

# Генерация SSH-ключа
ssh_generate_key: true
ssh_key_type: ed25519
ssh_key_comment: "{{ ssh_user }}@{{ ansible_hostname }}"

# Hardening sshd
ssh_harden_sshd: true
ssh_permit_root_login: "no"
ssh_password_authentication: "no"
ssh_pubkey_authentication: "yes"
ssh_x11_forwarding: "no"
ssh_max_auth_tries: 3
ssh_client_alive_interval: 300
ssh_client_alive_count_max: 2
ssh_login_grace_time: 60

# Ограничение доступа
ssh_allow_groups: ["wheel"]    # Только члены этих групп могут подключаться (пустой = все)
ssh_allow_users: []            # Конкретные пользователи (пустой = по группам)

# DoS защита
ssh_max_startups: "10:30:60"   # После 10 неаутентиф. соединений дроп 30%, после 60 — все

# Криптографические ограничения
ssh_ciphers:
  - chacha20-poly1305@openssh.com
  - aes256-gcm@openssh.com
  - aes128-gcm@openssh.com
ssh_macs:
  - hmac-sha2-512-etm@openssh.com
  - hmac-sha2-256-etm@openssh.com
ssh_kex_algorithms:
  - curve25519-sha256
  - curve25519-sha256@libssh.org
  - diffie-hellman-group16-sha512
  - diffie-hellman-group18-sha512
