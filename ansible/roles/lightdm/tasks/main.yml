---
# === Конфигурация LightDM ===
# Display manager: конфиг, скрипт резолюции, сервис

- name: Resolve dotfiles source directory
  ansible.builtin.stat:
    path: "{{ lightdm_source_dir }}"
  register: _lightdm_source_stat
  tags: ['lightdm', 'display']

- name: Assert dotfiles source directory exists
  ansible.builtin.assert:
    that:
      - _lightdm_source_stat.stat.exists
      - _lightdm_source_stat.stat.isdir
    fail_msg: "Директория с исходниками не найдена: {{ lightdm_source_dir }}"
  tags: ['lightdm', 'display']

# ---- Создание директорий ----

- name: Create LightDM config directories
  ansible.builtin.file:
    path: "{{ item.dest | dirname }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop: "{{ lightdm_system_files }}"
  tags: ['lightdm', 'display']

# ---- Деплой конфигов ----

- name: Deploy LightDM configuration files
  ansible.builtin.copy:
    src: "{{ lightdm_source_dir }}/{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
    remote_src: true
  loop: "{{ lightdm_system_files }}"
  tags: ['lightdm', 'display']

# ---- ctOS Greeter: web-greeter.yml ----

- name: Deploy web-greeter.yml config
  ansible.builtin.template:
    src: web-greeter.yml.j2
    dest: /etc/lightdm/web-greeter.yml
    owner: root
    group: root
    mode: '0644'
  tags: ['lightdm', 'display', 'greeter']

# ---- ctOS Greeter: тема ----

- name: Resolve greeter dist directory
  ansible.builtin.stat:
    path: "{{ lightdm_greeter_dist_dir }}"
  register: _lightdm_greeter_dist_stat
  tags: ['lightdm', 'display', 'greeter']

- name: Assert greeter dist directory exists
  ansible.builtin.assert:
    that:
      - _lightdm_greeter_dist_stat.stat.exists
      - _lightdm_greeter_dist_stat.stat.isdir
    fail_msg: "Greeter dist не найден: {{ lightdm_greeter_dist_dir }}. Запустите 'task greeter:build'."
  tags: ['lightdm', 'display', 'greeter']

- name: Create ctOS theme directory
  ansible.builtin.file:
    path: "/usr/share/web-greeter/themes/{{ lightdm_greeter_theme }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags: ['lightdm', 'display', 'greeter']

- name: Deploy ctOS greeter theme files
  ansible.builtin.copy:
    src: "{{ lightdm_greeter_dist_dir }}/"
    dest: "/usr/share/web-greeter/themes/{{ lightdm_greeter_theme }}/"
    owner: root
    group: root
    mode: '0644'
    directory_mode: '0755'
    remote_src: true
  tags: ['lightdm', 'display', 'greeter']

- name: Deploy index.yml theme metadata
  ansible.builtin.copy:
    src: "{{ lightdm_greeter_index_yml }}"
    dest: "/usr/share/web-greeter/themes/{{ lightdm_greeter_theme }}/index.yml"
    owner: root
    group: root
    mode: '0644'
    remote_src: true
  tags: ['lightdm', 'display', 'greeter']

- name: Generate system-info.json for ctOS theme
  ansible.builtin.template:
    src: system-info.json.j2
    dest: "/usr/share/web-greeter/themes/{{ lightdm_greeter_theme }}/system-info.json"
    owner: root
    group: root
    mode: '0644'
  tags: ['lightdm', 'display', 'greeter']

- name: Fix ctOS theme file permissions
  ansible.builtin.shell: |
    chown -R root:root /usr/share/web-greeter/themes/{{ lightdm_greeter_theme }}
    find /usr/share/web-greeter/themes/{{ lightdm_greeter_theme }} -type d -exec chmod 755 {} +
    find /usr/share/web-greeter/themes/{{ lightdm_greeter_theme }} -type f -exec chmod 644 {} +
  changed_when: true
  tags: ['lightdm', 'display', 'greeter']

# ---- ctOS Greeter: обои ----

- name: Check wallpaper source directory exists
  ansible.builtin.stat:
    path: "{{ lightdm_wallpaper_source_dir }}"
  register: _lightdm_wallpaper_stat
  tags: ['lightdm', 'display', 'greeter']

- name: Create backgrounds directory
  ansible.builtin.file:
    path: /usr/share/backgrounds
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: _lightdm_wallpaper_stat.stat.exists | default(false)
  tags: ['lightdm', 'display', 'greeter']

- name: Copy wallpapers to system backgrounds
  ansible.builtin.copy:
    src: "{{ lightdm_wallpaper_source_dir }}/"
    dest: /usr/share/backgrounds/
    owner: root
    group: root
    mode: '0644'
    directory_mode: '0755'
    remote_src: true
  when: _lightdm_wallpaper_stat.stat.exists | default(false)
  tags: ['lightdm', 'display', 'greeter']

# ---- Сервис ----

- name: Enable and start LightDM service
  ansible.builtin.service:
    name: lightdm
    enabled: true
    state: started
  when: lightdm_enable_service
  tags: ['lightdm', 'display', 'service']

- name: Report LightDM configuration
  ansible.builtin.debug:
    msg:
      - "Файлов развёрнуто: {{ lightdm_system_files | length }}"
      - "Сервис: {{ 'enabled' if lightdm_enable_service else 'disabled' }}"
      - "Гритер: {{ lightdm_greeter_theme }}"
  tags: ['lightdm']
