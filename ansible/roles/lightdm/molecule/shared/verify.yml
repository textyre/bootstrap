---
- name: Verify LightDM role
  hosts: all
  become: true
  gather_facts: true

  tasks:

    # ---- Package installed ----

    - name: Gather package facts
      ansible.builtin.package_facts:
        manager: auto

    - name: Assert lightdm package is installed
      ansible.builtin.assert:
        that: "'lightdm' in ansible_facts.packages"
        fail_msg: "lightdm package not found"

    # ---- Config directory ----

    - name: Stat /etc/lightdm/lightdm.conf.d directory
      ansible.builtin.stat:
        path: /etc/lightdm/lightdm.conf.d
      register: lightdm_verify_confdir

    - name: Assert config directory exists
      ansible.builtin.assert:
        that:
          - lightdm_verify_confdir.stat.exists
          - lightdm_verify_confdir.stat.isdir
        fail_msg: "/etc/lightdm/lightdm.conf.d directory missing"

    # ---- 10-config.conf existence and permissions ----

    - name: Stat /etc/lightdm/lightdm.conf.d/10-config.conf
      ansible.builtin.stat:
        path: /etc/lightdm/lightdm.conf.d/10-config.conf
      register: lightdm_verify_config

    - name: Assert 10-config.conf exists with correct owner and mode
      ansible.builtin.assert:
        that:
          - lightdm_verify_config.stat.exists
          - lightdm_verify_config.stat.isreg
          - lightdm_verify_config.stat.pw_name == 'root'
          - lightdm_verify_config.stat.gr_name == 'root'
          - lightdm_verify_config.stat.mode == '0644'
        fail_msg: >-
          /etc/lightdm/lightdm.conf.d/10-config.conf missing or wrong permissions
          (expected root:root 0644, got {{ lightdm_verify_config.stat.pw_name | default('?') }}:{{ lightdm_verify_config.stat.gr_name | default('?') }} {{ lightdm_verify_config.stat.mode | default('?') }})

    # ---- 10-config.conf content ----

    - name: Read 10-config.conf content
      ansible.builtin.slurp:
        src: /etc/lightdm/lightdm.conf.d/10-config.conf
      register: lightdm_verify_config_raw

    - name: Set config text fact
      ansible.builtin.set_fact:
        lightdm_verify_config_text: "{{ lightdm_verify_config_raw.content | b64decode }}"

    - name: Assert config contains Seat section
      ansible.builtin.assert:
        that: "'[Seat:*]' in lightdm_verify_config_text"
        fail_msg: "'[Seat:*]' section header missing from 10-config.conf"

    - name: Assert config specifies greeter-session
      ansible.builtin.assert:
        that: "'greeter-session=' in lightdm_verify_config_text"
        fail_msg: "'greeter-session' directive missing from 10-config.conf"

    - name: Assert config specifies display-setup-script
      ansible.builtin.assert:
        that: "'display-setup-script=' in lightdm_verify_config_text"
        fail_msg: "'display-setup-script' directive missing from 10-config.conf"

    - name: Assert display-setup-script points to resolution script
      ansible.builtin.assert:
        that: "'add-and-set-resolution.sh' in lightdm_verify_config_text"
        fail_msg: "display-setup-script does not reference add-and-set-resolution.sh"

    # ---- add-and-set-resolution.sh existence and permissions ----

    - name: Stat add-and-set-resolution.sh
      ansible.builtin.stat:
        path: /etc/lightdm/lightdm.conf.d/add-and-set-resolution.sh
      register: lightdm_verify_script

    - name: Assert resolution script exists and is executable
      ansible.builtin.assert:
        that:
          - lightdm_verify_script.stat.exists
          - lightdm_verify_script.stat.isreg
          - lightdm_verify_script.stat.mode == '0755'
        fail_msg: >-
          add-and-set-resolution.sh missing or not executable
          (expected mode 0755, got {{ lightdm_verify_script.stat.mode | default('?') }})

    - name: Assert resolution script ownership (lightdm:lightdm)
      ansible.builtin.assert:
        that:
          - lightdm_verify_script.stat.pw_name == 'lightdm'
          - lightdm_verify_script.stat.gr_name == 'lightdm'
        fail_msg: >-
          add-and-set-resolution.sh ownership wrong
          (expected lightdm:lightdm, got {{ lightdm_verify_script.stat.pw_name | default('?') }}:{{ lightdm_verify_script.stat.gr_name | default('?') }}).
          The lightdm user/group may not exist if the lightdm package was not properly installed.
      when: "'lightdm' in ansible_facts.packages"

    # ---- add-and-set-resolution.sh content ----

    - name: Read resolution script content
      ansible.builtin.slurp:
        src: /etc/lightdm/lightdm.conf.d/add-and-set-resolution.sh
      register: lightdm_verify_script_raw

    - name: Set script text fact
      ansible.builtin.set_fact:
        lightdm_verify_script_text: "{{ lightdm_verify_script_raw.content | b64decode }}"

    - name: Assert script has bash shebang
      ansible.builtin.assert:
        that: "lightdm_verify_script_text is match('#!/bin/bash')"
        fail_msg: "Resolution script missing #!/bin/bash shebang"

    - name: Assert script uses xrandr
      ansible.builtin.assert:
        that: "'xrandr' in lightdm_verify_script_text"
        fail_msg: "Resolution script does not contain xrandr commands"

    - name: Assert script always exits 0 (prevents LightDM restart loop)
      ansible.builtin.assert:
        that: "'exit 0' in lightdm_verify_script_text"
        fail_msg: >-
          Resolution script does not contain 'exit 0'.
          Non-zero exit causes LightDM infinite restart loop.

    # ---- Service state (enabled only, NOT running) ----

    - name: Check lightdm service is enabled
      ansible.builtin.command: systemctl is-enabled lightdm.service
      register: lightdm_verify_svc_enabled
      changed_when: false
      failed_when: false

    - name: Assert lightdm service is enabled
      ansible.builtin.assert:
        that: lightdm_verify_svc_enabled.stdout == 'enabled'
        fail_msg: >-
          lightdm.service is not enabled (got '{{ lightdm_verify_svc_enabled.stdout }}').
          Note: the service is expected to be enabled but NOT running in test environments
          (no display server available).
      when: lightdm_enable_service | default(true)

    - name: Check lightdm service is NOT running (expected in headless test)
      ansible.builtin.command: systemctl is-active lightdm.service
      register: lightdm_verify_svc_active
      changed_when: false
      failed_when: false

    - name: Confirm service inactive is expected
      ansible.builtin.debug:
        msg: >-
          lightdm.service is '{{ lightdm_verify_svc_active.stdout }}' -- this is expected.
          LightDM requires a display server (X11/Wayland) which is not available in test environments.

    # ---- Summary ----

    - name: Show verify result
      ansible.builtin.debug:
        msg: >-
          LightDM role verify passed on
          {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}.
          Config files deployed: 10-config.conf (root:root 0644),
          add-and-set-resolution.sh (0755).
          Service enabled: {{ lightdm_verify_svc_enabled.stdout | default('unknown') }}.
          Service running: {{ lightdm_verify_svc_active.stdout | default('unknown') }} (expected: inactive).
