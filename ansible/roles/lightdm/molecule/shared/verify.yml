---
- name: Verify LightDM role
  hosts: all
  become: true
  gather_facts: true

  tasks:

    # ---- Пакет установлен ----

    - name: Gather package facts
      ansible.builtin.package_facts:
        manager: auto

    - name: Assert lightdm package is installed
      ansible.builtin.assert:
        that: "'lightdm' in ansible_facts.packages"
        fail_msg: "lightdm package not found"

    # ---- Директория конфигов ----

    - name: Stat /etc/lightdm/lightdm.conf.d directory
      ansible.builtin.stat:
        path: /etc/lightdm/lightdm.conf.d
      register: _lightdm_verify_confdir

    - name: Assert config directory exists
      ansible.builtin.assert:
        that:
          - _lightdm_verify_confdir.stat.exists
          - _lightdm_verify_confdir.stat.isdir
        fail_msg: "/etc/lightdm/lightdm.conf.d directory missing"

    # ---- 10-config.conf: существование и права ----

    - name: Stat /etc/lightdm/lightdm.conf.d/10-config.conf
      ansible.builtin.stat:
        path: /etc/lightdm/lightdm.conf.d/10-config.conf
      register: _lightdm_verify_config

    - name: Assert 10-config.conf exists with correct owner and mode
      ansible.builtin.assert:
        that:
          - _lightdm_verify_config.stat.exists
          - _lightdm_verify_config.stat.isreg
          - _lightdm_verify_config.stat.pw_name == 'root'
          - _lightdm_verify_config.stat.gr_name == 'root'
          - _lightdm_verify_config.stat.mode == '0644'
        fail_msg: >-
          /etc/lightdm/lightdm.conf.d/10-config.conf missing or wrong permissions
          (expected root:root 0644, got
          {{ _lightdm_verify_config.stat.pw_name | default('?') }}:{{ _lightdm_verify_config.stat.gr_name | default('?') }}
          {{ _lightdm_verify_config.stat.mode | default('?') }})

    # ---- 10-config.conf: содержимое ----

    - name: Read 10-config.conf content
      ansible.builtin.slurp:
        src: /etc/lightdm/lightdm.conf.d/10-config.conf
      register: _lightdm_verify_config_raw
      failed_when: false

    - name: Assert 10-config.conf was readable
      ansible.builtin.assert:
        that: "'content' in _lightdm_verify_config_raw"
        fail_msg: "Failed to read 10-config.conf"

    - name: Set config text fact
      ansible.builtin.set_fact:
        _lightdm_verify_config_text: "{{ _lightdm_verify_config_raw.content | b64decode }}"

    - name: Assert config contains Seat section
      ansible.builtin.assert:
        that: "'[Seat:*]' in _lightdm_verify_config_text"
        fail_msg: "'[Seat:*]' section header missing from 10-config.conf"

    - name: Assert config specifies greeter-session
      ansible.builtin.assert:
        that: >-
          _lightdm_verify_config_text is regex('greeter-session=\S+')
        fail_msg: "'greeter-session' directive missing or empty in 10-config.conf"

    - name: Assert config specifies display-setup-script
      ansible.builtin.assert:
        that: >-
          _lightdm_verify_config_text is regex('display-setup-script=\S+')
        fail_msg: "'display-setup-script' directive missing or empty in 10-config.conf"

    - name: Assert display-setup-script points to resolution script
      ansible.builtin.assert:
        that: "'add-and-set-resolution.sh' in _lightdm_verify_config_text"
        fail_msg: "display-setup-script does not reference add-and-set-resolution.sh"

    # ---- add-and-set-resolution.sh: существование и права ----

    - name: Stat add-and-set-resolution.sh
      ansible.builtin.stat:
        path: /etc/lightdm/lightdm.conf.d/add-and-set-resolution.sh
      register: _lightdm_verify_script

    - name: Assert resolution script exists and is executable
      ansible.builtin.assert:
        that:
          - _lightdm_verify_script.stat.exists
          - _lightdm_verify_script.stat.isreg
          - _lightdm_verify_script.stat.mode == '0755'
        fail_msg: >-
          add-and-set-resolution.sh missing or not executable
          (expected mode 0755, got {{ _lightdm_verify_script.stat.mode | default('?') }})

    - name: Assert resolution script ownership (lightdm:lightdm)
      ansible.builtin.assert:
        that:
          - _lightdm_verify_script.stat.pw_name == 'lightdm'
          - _lightdm_verify_script.stat.gr_name == 'lightdm'
        fail_msg: >-
          add-and-set-resolution.sh ownership wrong
          (expected lightdm:lightdm, got
          {{ _lightdm_verify_script.stat.pw_name | default('?') }}:{{ _lightdm_verify_script.stat.gr_name | default('?') }}).
          The lightdm user/group may not exist if the lightdm package was not properly installed.
      when: "'lightdm' in ansible_facts.packages"

    # ---- add-and-set-resolution.sh: содержимое ----

    - name: Read resolution script content
      ansible.builtin.slurp:
        src: /etc/lightdm/lightdm.conf.d/add-and-set-resolution.sh
      register: _lightdm_verify_script_raw
      failed_when: false

    - name: Assert resolution script was readable
      ansible.builtin.assert:
        that: "'content' in _lightdm_verify_script_raw"
        fail_msg: "Failed to read add-and-set-resolution.sh"

    - name: Set script text fact
      ansible.builtin.set_fact:
        _lightdm_verify_script_text: "{{ _lightdm_verify_script_raw.content | b64decode }}"

    - name: Assert script has bash shebang
      ansible.builtin.assert:
        that: >-
          _lightdm_verify_script_text is regex('^#!/bin/bash')
        fail_msg: "Resolution script missing #!/bin/bash shebang"

    - name: Assert script uses xrandr
      ansible.builtin.assert:
        that: "'xrandr' in _lightdm_verify_script_text"
        fail_msg: "Resolution script does not contain xrandr commands"

    - name: Assert script always exits 0 (prevents LightDM restart loop)
      ansible.builtin.assert:
        that: "'exit 0' in _lightdm_verify_script_text"
        fail_msg: >-
          Resolution script does not contain 'exit 0'.
          Non-zero exit causes LightDM infinite restart loop.

    # ---- Сервис (только вне Docker) ----

    - name: Check lightdm service is enabled
      ansible.builtin.command:
        cmd: systemctl is-enabled lightdm.service
      register: _lightdm_verify_svc_enabled
      changed_when: false
      failed_when: false
      when:
        - lightdm_enable_service | default(true) | bool
        - ansible_virtualization_type | default('') != 'docker'

    - name: Assert lightdm service is enabled
      ansible.builtin.assert:
        that: _lightdm_verify_svc_enabled.stdout is regex('^enabled')
        fail_msg: >-
          lightdm.service is not enabled
          (got '{{ _lightdm_verify_svc_enabled.stdout | default('') }}').
      when:
        - lightdm_enable_service | default(true) | bool
        - ansible_virtualization_type | default('') != 'docker'

    - name: Service check skipped info
      ansible.builtin.debug:
        msg: >-
          Service enabled/active checks skipped —
          {% if not (lightdm_enable_service | default(true) | bool) %}lightdm_enable_service is false{% endif %}
          {% if ansible_virtualization_type | default('') == 'docker' %}running inside Docker container{% endif %}
      when: >-
        not (lightdm_enable_service | default(true) | bool)
        or ansible_virtualization_type | default('') == 'docker'

    # ---- Итог ----

    - name: Show verify result
      ansible.builtin.debug:
        msg: >-
          LightDM role verify passed on
          {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}.
          Config files deployed: 10-config.conf (root:root 0644),
          add-and-set-resolution.sh (0755).
