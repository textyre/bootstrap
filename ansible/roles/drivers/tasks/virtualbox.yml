---
# === VirtualBox Guest Additions ===
# Install packages, enable service, check version match

# ---- Install packages ----

- name: "VirtualBox: Install guest packages"
  ansible.builtin.package:
    name: "{{ packages_virtualbox_guest }}"
    state: present
  when: packages_virtualbox_guest | length > 0
  tags: ['drivers', 'vbox']

# ---- Enable service ----

- name: "VirtualBox: Enable vboxservice"
  ansible.builtin.systemd:
    name: vboxservice
    enabled: true
    state: started
  tags: ['drivers', 'vbox']

# ---- Version matching ----

- name: "VirtualBox: Get guest additions version"
  ansible.builtin.command: VBoxControl --version
  register: _drivers_vbox_guest_version_raw
  changed_when: false
  failed_when: false
  when: drivers_vbox_version_check
  tags: ['drivers', 'vbox']

- name: "VirtualBox: Get host VirtualBox version"
  ansible.builtin.command: VBoxControl guestproperty get /VirtualBox/HostInfo/VBoxVer
  register: _drivers_vbox_host_version_raw
  changed_when: false
  failed_when: false
  when:
    - drivers_vbox_version_check
    - _drivers_vbox_guest_version_raw.rc | default(1) == 0
  tags: ['drivers', 'vbox']

- name: "VirtualBox: Parse versions"
  vars:
    _raw_host: "{{ _drivers_vbox_host_version_raw.stdout | default('') }}"
  ansible.builtin.set_fact:
    _drivers_vbox_guest_ver: >-
      {{ _drivers_vbox_guest_version_raw.stdout | default('')
         | regex_replace('[^0-9.].*', '') }}
    _drivers_vbox_host_ver: >-
      {{ _raw_host | regex_search('Value:\s*(.+)', '\1')
         | default(['unknown'], true) | first | trim }}
  when:
    - drivers_vbox_version_check
    - _drivers_vbox_guest_version_raw.rc | default(1) == 0
    - _drivers_vbox_host_version_raw.rc | default(1) == 0
  tags: ['drivers', 'vbox']

- name: "VirtualBox: WARN on version mismatch"
  ansible.builtin.debug:
    msg: >-
      WARNING: VirtualBox version MISMATCH!
      Guest additions: {{ _drivers_vbox_guest_ver }}.
      Host VirtualBox:  {{ _drivers_vbox_host_ver }}.
      Shared folders, clipboard, and display resize may not work correctly.
      Fix: install matching guest additions from VBoxGuestAdditions.iso
  when:
    - drivers_vbox_version_check
    - _drivers_vbox_guest_ver is defined
    - _drivers_vbox_host_ver is defined
    - _drivers_vbox_guest_ver != _drivers_vbox_host_ver
  tags: ['drivers', 'vbox']

- name: "VirtualBox: Version match OK"
  ansible.builtin.debug:
    msg: "VirtualBox versions match: guest={{ _drivers_vbox_guest_ver }}, host={{ _drivers_vbox_host_ver }}"
  when:
    - drivers_vbox_version_check
    - _drivers_vbox_guest_ver is defined
    - _drivers_vbox_host_ver is defined
    - _drivers_vbox_guest_ver == _drivers_vbox_host_ver
  tags: ['drivers', 'vbox']

- name: "VirtualBox: Version check skipped"
  ansible.builtin.debug:
    msg: >-
      VirtualBox version check skipped
      ({{ 'disabled by drivers_vbox_version_check=false' if not drivers_vbox_version_check
          else 'VBoxControl not available or failed' }})
  when: >-
    not drivers_vbox_version_check
    or (_drivers_vbox_guest_version_raw.rc | default(1) != 0)
  tags: ['drivers', 'vbox']
