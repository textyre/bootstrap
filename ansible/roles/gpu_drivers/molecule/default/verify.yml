---
- name: Verify
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Detect GPU for verification
      ansible.builtin.command: lspci -nn
      register: gpu_drivers_verify_lspci
      changed_when: false
      failed_when: false

    # lspci -nn format: "<slot> <class> [<class_id>]: <vendor> <device>"
    # Class label appears BEFORE vendor name on each line.
    - name: Set GPU vendor facts for verification
      ansible.builtin.set_fact:
        gpu_drivers_verify_has_nvidia: "{{ gpu_drivers_verify_lspci.stdout is search('(?:VGA|Display|3D).*NVIDIA') }}"
        gpu_drivers_verify_has_amd: "{{ gpu_drivers_verify_lspci.stdout is search('(?:VGA|Display|3D).*(?:AMD|ATI|Advanced Micro Devices)') }}"
        gpu_drivers_verify_has_intel: "{{ gpu_drivers_verify_lspci.stdout is search('(?:VGA|Display|3D).*Intel') }}"

    # ---- OS-specific package name resolution ----

    - name: Set OS-specific package names for verification
      ansible.builtin.set_fact:
        gpu_drivers_verify_nvidia_pkg: >-
          {% if ansible_facts['os_family'] == 'Debian' %}
          {{ 'nvidia-open-kernel-dkms' if gpu_drivers_nvidia_variant | default('proprietary') == 'open-kernel'
             else ('xserver-xorg-video-nouveau' if gpu_drivers_nvidia_variant | default('proprietary') == 'nouveau'
             else 'nvidia-driver') }}
          {% else %}
          {{ 'nvidia-open' if gpu_drivers_nvidia_variant | default('proprietary') == 'open-kernel'
             else ('xf86-video-nouveau' if gpu_drivers_nvidia_variant | default('proprietary') == 'nouveau'
             else 'nvidia') }}
          {% endif %}
        gpu_drivers_verify_amd_pkg: >-
          {{ 'mesa-vulkan-drivers' if ansible_facts['os_family'] == 'Debian' else 'vulkan-radeon' }}
        gpu_drivers_verify_intel_pkg: >-
          {{ 'intel-media-va-driver' if ansible_facts['os_family'] == 'Debian' else 'vulkan-intel' }}
        gpu_drivers_verify_vulkan_pkg: >-
          {{ 'libvulkan1' if ansible_facts['os_family'] == 'Debian' else 'vulkan-icd-loader' }}

    # ---- NVIDIA: variant-aware package check ----

    - name: Check NVIDIA driver package (variant-aware, OS-aware)
      ansible.builtin.package:
        name: "{{ gpu_drivers_verify_nvidia_pkg | trim }}"
        state: present
      check_mode: true
      register: gpu_drivers_verify_nvidia
      failed_when: gpu_drivers_verify_nvidia is changed
      when: gpu_drivers_verify_has_nvidia

    # ---- AMD / Intel package checks ----

    - name: Check AMD driver package
      ansible.builtin.package:
        name: "{{ gpu_drivers_verify_amd_pkg | trim }}"
        state: present
      check_mode: true
      register: gpu_drivers_verify_amd
      failed_when: gpu_drivers_verify_amd is changed
      when: gpu_drivers_verify_has_amd

    - name: Check Intel driver package
      ansible.builtin.package:
        name: "{{ gpu_drivers_verify_intel_pkg | trim }}"
        state: present
      check_mode: true
      register: gpu_drivers_verify_intel
      failed_when: gpu_drivers_verify_intel is changed
      when: gpu_drivers_verify_has_intel

    # ---- Vulkan ICD loader ----

    - name: Check Vulkan ICD loader is installed
      ansible.builtin.package:
        name: "{{ gpu_drivers_verify_vulkan_pkg | trim }}"
        state: present
      check_mode: true
      register: gpu_drivers_verify_vulkan
      failed_when: gpu_drivers_verify_vulkan is changed
      when: gpu_drivers_verify_has_nvidia or gpu_drivers_verify_has_amd or gpu_drivers_verify_has_intel

    # ---- NVIDIA modprobe.d files ----

    - name: Check NVIDIA DRM KMS modprobe config exists
      ansible.builtin.stat:
        path: /etc/modprobe.d/nvidia.conf
      register: gpu_drivers_verify_modprobe
      failed_when:
        - gpu_drivers_nvidia_kms | default(true)
        - gpu_drivers_nvidia_variant | default('proprietary') in ['proprietary', 'open-kernel']
        - not gpu_drivers_verify_modprobe.stat.exists
      when: gpu_drivers_verify_has_nvidia

    - name: Check nouveau blacklist config exists
      ansible.builtin.stat:
        path: /etc/modprobe.d/nvidia-blacklist.conf
      register: gpu_drivers_verify_blacklist
      failed_when:
        - gpu_drivers_nvidia_blacklist_nouveau | default(true)
        - gpu_drivers_nvidia_variant | default('proprietary') in ['proprietary', 'open-kernel']
        - not gpu_drivers_verify_blacklist.stat.exists
      when: gpu_drivers_verify_has_nvidia

    # ---- VA-API environment config ----

    - name: Check GPU VA-API environment config exists
      ansible.builtin.stat:
        path: /etc/environment.d/gpu.conf
      register: gpu_drivers_verify_env_conf
      failed_when:
        - gpu_drivers_vaapi | default(true)
        - not gpu_drivers_verify_env_conf.stat.exists
      when: gpu_drivers_verify_has_nvidia or gpu_drivers_verify_has_amd or gpu_drivers_verify_has_intel

    # ---- Summary ----

    - name: Show verification results
      ansible.builtin.debug:
        msg:
          - "=== GPU Driver Verification Passed ==="
          - "NVIDIA detected: {{ gpu_drivers_verify_has_nvidia }}"
          - "AMD detected:    {{ gpu_drivers_verify_has_amd }}"
          - "Intel detected:  {{ gpu_drivers_verify_has_intel }}"
          - "Variant: {{ gpu_drivers_nvidia_variant | default('proprietary') }}"
          - "OS family: {{ ansible_facts['os_family'] }}"
