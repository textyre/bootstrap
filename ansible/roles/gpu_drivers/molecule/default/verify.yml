---
- name: Verify
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/inventory/group_vars/all/vault.yml"

  tasks:
    - name: Detect GPU for verification
      ansible.builtin.command: lspci -nn
      register: _gpu_verify_lspci
      changed_when: false
      failed_when: false

    - name: Set GPU vendor facts for verification
      ansible.builtin.set_fact:
        _gpu_verify_has_nvidia: "{{ _gpu_verify_lspci.stdout is search('NVIDIA.*(?:VGA|Display)') }}"
        _gpu_verify_has_amd: "{{ _gpu_verify_lspci.stdout is search('(?:AMD|ATI).*(?:VGA|Display)') }}"
        _gpu_verify_has_intel: "{{ _gpu_verify_lspci.stdout is search('Intel Corporation.*(?:VGA|Display)') }}"

    - name: Check Vulkan ICD loader is installed
      ansible.builtin.package:
        name: vulkan-icd-loader
        state: present
      check_mode: true
      register: _gpu_verify_vulkan
      failed_when: _gpu_verify_vulkan is changed
      when: _gpu_verify_has_nvidia or _gpu_verify_has_amd or _gpu_verify_has_intel

    - name: Check NVIDIA packages (proprietary)
      ansible.builtin.package:
        name: nvidia
        state: present
      check_mode: true
      register: _gpu_verify_nvidia
      failed_when: _gpu_verify_nvidia is changed
      when: _gpu_verify_has_nvidia

    - name: Check AMD packages
      ansible.builtin.package:
        name: vulkan-radeon
        state: present
      check_mode: true
      register: _gpu_verify_amd
      failed_when: _gpu_verify_amd is changed
      when: _gpu_verify_has_amd

    - name: Check Intel packages
      ansible.builtin.package:
        name: vulkan-intel
        state: present
      check_mode: true
      register: _gpu_verify_intel
      failed_when: _gpu_verify_intel is changed
      when: _gpu_verify_has_intel

    - name: Check GPU environment config exists
      ansible.builtin.stat:
        path: /etc/environment.d/gpu.conf
      register: _gpu_verify_env_conf
      failed_when: not _gpu_verify_env_conf.stat.exists
      when: _gpu_verify_has_nvidia or _gpu_verify_has_amd or _gpu_verify_has_intel

    - name: Show test results
      ansible.builtin.debug:
        msg:
          - "All GPU driver checks passed!"
          - "NVIDIA detected: {{ _gpu_verify_has_nvidia }}"
          - "AMD detected: {{ _gpu_verify_has_amd }}"
          - "Intel detected: {{ _gpu_verify_has_intel }}"
          - "Vulkan and VA-API configured"
