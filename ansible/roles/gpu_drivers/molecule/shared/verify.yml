---
# Shared verify playbook for gpu_drivers molecule scenarios.
# Designed for the Intel vendor path (gpu_drivers_vendor: intel, pure Mesa, no DKMS).
# Asserts:
#   - Intel driver packages installed (OS-aware names)
#   - vulkan-tools installed
#   - /etc/environment.d/gpu.conf exists with correct content
#   - NVIDIA-specific configs are ABSENT
#   - /etc/environment.d/ directory exists with correct permissions

- name: Verify gpu_drivers role (Intel path)
  hosts: all
  become: true
  gather_facts: true
  vars:
    # Mirror the converge override â€” vendor facts derive from this
    gpu_drivers_vendor: intel
    gpu_drivers_vaapi: true
    gpu_drivers_vulkan_tools: true

  tasks:

    # ==========================================================
    # Phase 1: Determine what was configured
    # ==========================================================

    - name: Set vendor facts for verification
      ansible.builtin.set_fact:
        gpu_verify_has_nvidia: "{{ gpu_drivers_vendor == 'nvidia' }}"
        gpu_verify_has_amd: "{{ gpu_drivers_vendor == 'amd' }}"
        gpu_verify_has_intel: "{{ gpu_drivers_vendor == 'intel' }}"
        gpu_verify_has_any: "{{ gpu_drivers_vendor in ['nvidia', 'amd', 'intel'] }}"

    # ==========================================================
    # Phase 2: Package verification (OS-aware)
    # ==========================================================

    - name: Gather package facts
      ansible.builtin.package_facts:
        manager: auto

    # ---- Intel packages (Arch) ----

    - name: Set Intel verify package names (Arch)
      ansible.builtin.set_fact:
        gpu_verify_intel_packages:
          - mesa
          - vulkan-intel
          - intel-media-driver
          - vulkan-icd-loader
      when:
        - gpu_verify_has_intel
        - ansible_facts['os_family'] == 'Archlinux'

    # ---- Intel packages (Debian/Ubuntu) ----

    - name: Set Intel verify package names (Debian)
      ansible.builtin.set_fact:
        gpu_verify_intel_packages:
          - intel-media-va-driver
          - mesa-vulkan-drivers
          - libgl1-mesa-dri
      when:
        - gpu_verify_has_intel
        - ansible_facts['os_family'] == 'Debian'

    - name: Assert Intel driver packages are installed
      ansible.builtin.assert:
        that: "item in ansible_facts.packages"
        fail_msg: "Intel driver package '{{ item }}' not found in installed packages"
        success_msg: "Intel driver package '{{ item }}' is installed"
      loop: "{{ gpu_verify_intel_packages }}"
      when: gpu_verify_has_intel

    # ---- vulkan-tools ----

    - name: Assert vulkan-tools is installed (when enabled)
      ansible.builtin.assert:
        that: "'vulkan-tools' in ansible_facts.packages"
        fail_msg: "vulkan-tools not found in installed packages"
        success_msg: "vulkan-tools is installed"
      when: gpu_verify_has_any and gpu_drivers_vulkan_tools

    # ==========================================================
    # Phase 3: /etc/environment.d/ directory
    # ==========================================================

    - name: Stat /etc/environment.d directory
      ansible.builtin.stat:
        path: /etc/environment.d
      register: gpu_verify_env_dir

    - name: Assert /etc/environment.d exists and is a directory
      ansible.builtin.assert:
        that:
          - gpu_verify_env_dir.stat.exists
          - gpu_verify_env_dir.stat.isdir
        fail_msg: "/etc/environment.d does not exist or is not a directory"
        success_msg: "/etc/environment.d exists as a directory"

    # ==========================================================
    # Phase 4: VA-API environment config
    # ==========================================================

    - name: Stat /etc/environment.d/gpu.conf
      ansible.builtin.stat:
        path: /etc/environment.d/gpu.conf
      register: gpu_verify_env_conf

    - name: Assert gpu.conf exists with correct permissions (when VA-API enabled and GPU present)
      ansible.builtin.assert:
        that:
          - gpu_verify_env_conf.stat.exists
          - gpu_verify_env_conf.stat.mode == '0644'
          - gpu_verify_env_conf.stat.pw_name == 'root'
          - gpu_verify_env_conf.stat.gr_name == 'root'
        fail_msg: "/etc/environment.d/gpu.conf missing or has wrong permissions (expected root:root 0644)"
        success_msg: "/etc/environment.d/gpu.conf exists with correct permissions"
      when: gpu_drivers_vaapi and gpu_verify_has_any

    - name: Read gpu.conf content
      ansible.builtin.slurp:
        src: /etc/environment.d/gpu.conf
      register: gpu_verify_env_conf_content
      when: gpu_drivers_vaapi and gpu_verify_has_any

    - name: Assert gpu.conf contains correct LIBVA_DRIVER_NAME for Intel
      ansible.builtin.assert:
        that: "'LIBVA_DRIVER_NAME=iHD' in (gpu_verify_env_conf_content.content | b64decode)"
        fail_msg: >
          /etc/environment.d/gpu.conf does not contain 'LIBVA_DRIVER_NAME=iHD'.
          Content: {{ gpu_verify_env_conf_content.content | b64decode | trim }}
        success_msg: "gpu.conf contains LIBVA_DRIVER_NAME=iHD"
      when:
        - gpu_drivers_vaapi
        - gpu_verify_has_intel

    - name: Assert gpu.conf is absent when VA-API disabled or no GPU
      ansible.builtin.assert:
        that: not gpu_verify_env_conf.stat.exists
        fail_msg: "/etc/environment.d/gpu.conf exists but should be absent (VA-API disabled or no GPU)"
        success_msg: "/etc/environment.d/gpu.conf is correctly absent"
      when: not gpu_drivers_vaapi or not gpu_verify_has_any

    # ==========================================================
    # Phase 5: NVIDIA-specific configs must be ABSENT (Intel path)
    # ==========================================================

    - name: Stat /etc/modprobe.d/nvidia.conf
      ansible.builtin.stat:
        path: /etc/modprobe.d/nvidia.conf
      register: gpu_verify_nvidia_modprobe

    - name: Assert nvidia.conf is absent when vendor is not NVIDIA
      ansible.builtin.assert:
        that: not gpu_verify_nvidia_modprobe.stat.exists
        fail_msg: "/etc/modprobe.d/nvidia.conf exists but should be absent for non-NVIDIA vendor"
        success_msg: "/etc/modprobe.d/nvidia.conf is correctly absent"
      when: not gpu_verify_has_nvidia

    - name: Stat /etc/modprobe.d/nvidia-blacklist.conf
      ansible.builtin.stat:
        path: /etc/modprobe.d/nvidia-blacklist.conf
      register: gpu_verify_nvidia_blacklist

    - name: Assert nvidia-blacklist.conf is absent when vendor is not NVIDIA
      ansible.builtin.assert:
        that: not gpu_verify_nvidia_blacklist.stat.exists
        fail_msg: "/etc/modprobe.d/nvidia-blacklist.conf exists but should be absent for non-NVIDIA vendor"
        success_msg: "/etc/modprobe.d/nvidia-blacklist.conf is correctly absent"
      when: not gpu_verify_has_nvidia

    # ---- NVIDIA initramfs drop-ins (must be ABSENT for Intel) ----

    - name: Stat mkinitcpio NVIDIA drop-in
      ansible.builtin.stat:
        path: /etc/mkinitcpio.conf.d/nvidia.conf
      register: gpu_verify_mkinitcpio_nvidia

    - name: Assert mkinitcpio nvidia.conf is absent when vendor is not NVIDIA
      ansible.builtin.assert:
        that: not gpu_verify_mkinitcpio_nvidia.stat.exists
        fail_msg: "/etc/mkinitcpio.conf.d/nvidia.conf exists but should be absent for non-NVIDIA vendor"
        success_msg: "/etc/mkinitcpio.conf.d/nvidia.conf is correctly absent"
      when: not gpu_verify_has_nvidia

    - name: Stat dracut NVIDIA drop-in
      ansible.builtin.stat:
        path: /etc/dracut.conf.d/nvidia.conf
      register: gpu_verify_dracut_nvidia

    - name: Assert dracut nvidia.conf is absent when vendor is not NVIDIA
      ansible.builtin.assert:
        that: not gpu_verify_dracut_nvidia.stat.exists
        fail_msg: "/etc/dracut.conf.d/nvidia.conf exists but should be absent for non-NVIDIA vendor"
        success_msg: "/etc/dracut.conf.d/nvidia.conf is correctly absent"
      when: not gpu_verify_has_nvidia

    - name: Stat initramfs-tools NVIDIA hook
      ansible.builtin.stat:
        path: /etc/initramfs-tools/hooks/nvidia-ansible
      register: gpu_verify_initramfs_nvidia

    - name: Assert initramfs-tools nvidia hook is absent when vendor is not NVIDIA
      ansible.builtin.assert:
        that: not gpu_verify_initramfs_nvidia.stat.exists
        fail_msg: "/etc/initramfs-tools/hooks/nvidia-ansible exists but should be absent for non-NVIDIA vendor"
        success_msg: "/etc/initramfs-tools/hooks/nvidia-ansible is correctly absent"
      when: not gpu_verify_has_nvidia

    # ==========================================================
    # Summary
    # ==========================================================

    - name: Show verification summary
      ansible.builtin.debug:
        msg: >
          gpu_drivers verify complete.
          vendor={{ gpu_drivers_vendor }},
          has_intel={{ gpu_verify_has_intel }},
          has_nvidia={{ gpu_verify_has_nvidia }},
          has_amd={{ gpu_verify_has_amd }},
          vaapi={{ gpu_drivers_vaapi }}
