---
# === gpu_drivers / detect — GPU vendor detection ===
# SRP: only sets _gpu_drivers_has_* facts; never installs or configures.
# Supports manual override via gpu_drivers_vendor variable.

# ---- Manual override (gpu_drivers_vendor != 'auto') ----

- name: Apply manual vendor override
  ansible.builtin.set_fact:
    _gpu_drivers_has_nvidia: "{{ gpu_drivers_vendor == 'nvidia' }}"
    _gpu_drivers_has_amd:    "{{ gpu_drivers_vendor == 'amd' }}"
    _gpu_drivers_has_intel:  "{{ gpu_drivers_vendor == 'intel' }}"
  when: gpu_drivers_vendor != 'auto'
  tags: ['gpu', 'drivers']

# ---- Auto-detect via lspci ----

- name: Run lspci to detect GPU
  ansible.builtin.command: lspci -nn
  register: _gpu_drivers_lspci
  changed_when: false
  when: gpu_drivers_vendor == 'auto'
  tags: ['gpu', 'drivers']

- name: Detect NVIDIA GPU via lspci
  ansible.builtin.set_fact:
    _gpu_drivers_has_nvidia: "{{ _gpu_drivers_lspci.stdout is search('NVIDIA.*(?:VGA|Display|3D)') }}"
  when: gpu_drivers_vendor == 'auto'
  tags: ['gpu', 'drivers']

- name: Detect AMD GPU via lspci
  ansible.builtin.set_fact:
    _gpu_drivers_has_amd: "{{ _gpu_drivers_lspci.stdout is search('(?:AMD|ATI).*(?:VGA|Display|3D)') }}"
  when: gpu_drivers_vendor == 'auto'
  tags: ['gpu', 'drivers']

- name: Detect Intel GPU via lspci
  ansible.builtin.set_fact:
    _gpu_drivers_has_intel: "{{ _gpu_drivers_lspci.stdout is search('Intel Corporation.*(?:VGA|Display|3D)') }}"
  when: gpu_drivers_vendor == 'auto'
  tags: ['gpu', 'drivers']

# ---- Normalize: vendor 'none' — all false ----

- name: Set no-GPU facts when vendor is 'none'
  ansible.builtin.set_fact:
    _gpu_drivers_has_nvidia: false
    _gpu_drivers_has_amd:    false
    _gpu_drivers_has_intel:  false
  when: gpu_drivers_vendor == 'none'
  tags: ['gpu', 'drivers']

# ---- Summary ----

- name: Report detected GPU vendor
  ansible.builtin.debug:
    msg:
      - "GPU detection: {{ 'manual override' if gpu_drivers_vendor != 'auto' else 'auto (lspci)' }}"
      - "NVIDIA:  {{ _gpu_drivers_has_nvidia }}"
      - "AMD:     {{ _gpu_drivers_has_amd }}"
      - "Intel:   {{ _gpu_drivers_has_intel }}"
  tags: ['gpu', 'drivers']
