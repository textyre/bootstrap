---
# Arch Linux GPU driver installation

# ---- NVIDIA ----

- name: Install NVIDIA proprietary drivers (Arch)
  community.general.pacman:
    name: "{{ _gpu_drivers_nvidia_proprietary_packages }}"
    state: present
  when:
    - _gpu_drivers_has_nvidia
    - gpu_drivers_nvidia_variant == 'proprietary'
  tags: ['gpu', 'nvidia']

- name: Install NVIDIA proprietary multilib (Arch)
  community.general.pacman:
    name: "{{ _gpu_drivers_nvidia_proprietary_multilib }}"
    state: present
  when:
    - _gpu_drivers_has_nvidia
    - gpu_drivers_nvidia_variant == 'proprietary'
    - gpu_drivers_multilib
  tags: ['gpu', 'nvidia']

- name: Install NVIDIA open kernel modules (Arch)
  community.general.pacman:
    name: "{{ _gpu_drivers_nvidia_open_packages }}"
    state: present
  when:
    - _gpu_drivers_has_nvidia
    - gpu_drivers_nvidia_variant == 'open-kernel'
  tags: ['gpu', 'nvidia']

- name: Install NVIDIA open kernel multilib (Arch)
  community.general.pacman:
    name: "{{ _gpu_drivers_nvidia_proprietary_multilib }}"
    state: present
  when:
    - _gpu_drivers_has_nvidia
    - gpu_drivers_nvidia_variant == 'open-kernel'
    - gpu_drivers_multilib
  tags: ['gpu', 'nvidia']

- name: Install NVIDIA VA-API driver (Arch)
  community.general.pacman:
    name: "{{ _gpu_drivers_nvidia_vaapi_packages }}"
    state: present
  when:
    - _gpu_drivers_has_nvidia
    - gpu_drivers_nvidia_variant in ['proprietary', 'open-kernel']
    - gpu_drivers_vaapi
  tags: ['gpu', 'nvidia']

- name: Install NVIDIA nouveau drivers (Arch)
  community.general.pacman:
    name: "{{ _gpu_drivers_nvidia_nouveau_packages }}"
    state: present
  when:
    - _gpu_drivers_has_nvidia
    - gpu_drivers_nvidia_variant == 'nouveau'
  tags: ['gpu', 'nvidia']

- name: Install NVIDIA nouveau multilib (Arch)
  community.general.pacman:
    name: "{{ _gpu_drivers_nvidia_nouveau_multilib }}"
    state: present
  when:
    - _gpu_drivers_has_nvidia
    - gpu_drivers_nvidia_variant == 'nouveau'
    - gpu_drivers_multilib
  tags: ['gpu', 'nvidia']

# ---- AMD ----

- name: Install AMD drivers (Arch)
  community.general.pacman:
    name: "{{ _gpu_drivers_amd_packages }}"
    state: present
  when: _gpu_drivers_has_amd
  tags: ['gpu', 'amd']

- name: Install AMD multilib (Arch)
  community.general.pacman:
    name: "{{ _gpu_drivers_amd_multilib }}"
    state: present
  when:
    - _gpu_drivers_has_amd
    - gpu_drivers_multilib
  tags: ['gpu', 'amd']

# ---- Intel ----

- name: Install Intel drivers (Arch)
  community.general.pacman:
    name: "{{ _gpu_drivers_intel_packages }}"
    state: present
  when: _gpu_drivers_has_intel
  tags: ['gpu', 'intel']

- name: Install Intel multilib (Arch)
  community.general.pacman:
    name: "{{ _gpu_drivers_intel_multilib }}"
    state: present
  when:
    - _gpu_drivers_has_intel
    - gpu_drivers_multilib
  tags: ['gpu', 'intel']

# ---- Vulkan common ----

- name: Install Vulkan ICD loader (Arch)
  community.general.pacman:
    name: "{{ _gpu_drivers_vulkan_common }}"
    state: present
  when: _gpu_drivers_has_nvidia or _gpu_drivers_has_amd or _gpu_drivers_has_intel
  tags: ['gpu', 'vulkan']

- name: Install Vulkan ICD loader multilib (Arch)
  community.general.pacman:
    name: "{{ _gpu_drivers_vulkan_common_multilib }}"
    state: present
  when:
    - _gpu_drivers_has_nvidia or _gpu_drivers_has_amd or _gpu_drivers_has_intel
    - gpu_drivers_multilib
  tags: ['gpu', 'vulkan']

- name: Install Vulkan tools (Arch)
  community.general.pacman:
    name: "{{ _gpu_drivers_vulkan_tools_packages }}"
    state: present
  when:
    - _gpu_drivers_has_nvidia or _gpu_drivers_has_amd or _gpu_drivers_has_intel
    - gpu_drivers_vulkan_tools
  tags: ['gpu', 'vulkan']
