---
# === gpu_drivers / initramfs â€” Init-agnostic initramfs management ===
# SRP: only manages initramfs drop-in files and triggers regeneration.
# Supports: mkinitcpio (Arch Linux), dracut (runtime-detected), initramfs-tools (Debian/Ubuntu fallback).
# Handler: "regenerate initramfs" dispatches to the correct tool via listen:.

# ---- Detect initramfs tool ----

- name: Check if dracut is available (non-Arch systems)
  ansible.builtin.command: which dracut
  register: gpu_drivers_dracut_check
  changed_when: false
  failed_when: false
  when:
    - ansible_facts['os_family'] != 'Archlinux'
    - gpu_drivers_manage_initramfs
  tags: ['gpu', 'nvidia']

- name: Set initramfs tool fact
  ansible.builtin.set_fact:
    gpu_drivers_initramfs_tool: >-
      {{ 'mkinitcpio' if ansible_facts['os_family'] == 'Archlinux'
         else ('dracut' if (_gpu_drivers_dracut_check is not skipped
                           and _gpu_drivers_dracut_check.rc == 0)
         else 'initramfs-tools') }}
  when: gpu_drivers_manage_initramfs
  tags: ['gpu', 'nvidia']

# ---- mkinitcpio (Arch Linux) ----

- name: Ensure /etc/mkinitcpio.conf.d directory exists (Arch)
  ansible.builtin.file:
    path: /etc/mkinitcpio.conf.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  when:
    - gpu_drivers_has_nvidia
    - gpu_drivers_nvidia_variant in ['proprietary', 'open-kernel']
    - gpu_drivers_manage_initramfs
    - gpu_drivers_initramfs_tool is defined
    - gpu_drivers_initramfs_tool == 'mkinitcpio'
  tags: ['gpu', 'nvidia']

- name: Deploy mkinitcpio NVIDIA drop-in (Arch)
  ansible.builtin.template:
    src: mkinitcpio-nvidia.conf.j2
    dest: /etc/mkinitcpio.conf.d/nvidia.conf
    owner: root
    group: root
    mode: '0644'
  notify: regenerate initramfs
  when:
    - gpu_drivers_has_nvidia
    - gpu_drivers_nvidia_variant in ['proprietary', 'open-kernel']
    - gpu_drivers_manage_initramfs
    - gpu_drivers_initramfs_tool is defined
    - gpu_drivers_initramfs_tool == 'mkinitcpio'
  tags: ['gpu', 'nvidia']

# ---- dracut (runtime-detected) ----

- name: Ensure /etc/dracut.conf.d directory exists
  ansible.builtin.file:
    path: /etc/dracut.conf.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  when:
    - gpu_drivers_has_nvidia
    - gpu_drivers_nvidia_variant in ['proprietary', 'open-kernel']
    - gpu_drivers_manage_initramfs
    - gpu_drivers_initramfs_tool is defined
    - gpu_drivers_initramfs_tool == 'dracut'
  tags: ['gpu', 'nvidia']

- name: Deploy dracut NVIDIA drop-in
  ansible.builtin.template:
    src: dracut-nvidia.conf.j2
    dest: /etc/dracut.conf.d/nvidia.conf
    owner: root
    group: root
    mode: '0644'
  notify: regenerate initramfs
  when:
    - gpu_drivers_has_nvidia
    - gpu_drivers_nvidia_variant in ['proprietary', 'open-kernel']
    - gpu_drivers_manage_initramfs
    - gpu_drivers_initramfs_tool is defined
    - gpu_drivers_initramfs_tool == 'dracut'
  tags: ['gpu', 'nvidia']

# ---- initramfs-tools (Debian/Ubuntu fallback) ----

- name: Deploy initramfs-tools NVIDIA hook
  ansible.builtin.template:
    src: initramfs-tools-nvidia-modules.j2
    dest: /etc/initramfs-tools/hooks/nvidia-ansible
    owner: root
    group: root
    mode: '0755'
  notify: regenerate initramfs
  when:
    - gpu_drivers_has_nvidia
    - gpu_drivers_nvidia_variant in ['proprietary', 'open-kernel']
    - gpu_drivers_manage_initramfs
    - gpu_drivers_initramfs_tool is defined
    - gpu_drivers_initramfs_tool == 'initramfs-tools'
  tags: ['gpu', 'nvidia']

# ---- Cleanup: remove drop-ins when NVIDIA is not in use ----

- name: Remove mkinitcpio NVIDIA drop-in (not applicable)
  ansible.builtin.file:
    path: /etc/mkinitcpio.conf.d/nvidia.conf
    state: absent
  when: >-
    not gpu_drivers_has_nvidia
    or gpu_drivers_nvidia_variant == 'nouveau'
    or not gpu_drivers_manage_initramfs
  tags: ['gpu', 'nvidia']

- name: Remove dracut NVIDIA drop-in (not applicable)
  ansible.builtin.file:
    path: /etc/dracut.conf.d/nvidia.conf
    state: absent
  when: >-
    not gpu_drivers_has_nvidia
    or gpu_drivers_nvidia_variant == 'nouveau'
    or not gpu_drivers_manage_initramfs
  tags: ['gpu', 'nvidia']

- name: Remove initramfs-tools NVIDIA hook (not applicable)
  ansible.builtin.file:
    path: /etc/initramfs-tools/hooks/nvidia-ansible
    state: absent
  when: >-
    not gpu_drivers_has_nvidia
    or gpu_drivers_nvidia_variant == 'nouveau'
    or not gpu_drivers_manage_initramfs
  tags: ['gpu', 'nvidia']
