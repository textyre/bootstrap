---
# Debian GPU driver installation
# Supports: NVIDIA (proprietary, nouveau), AMD (firmware+Mesa), Intel (Mesa+VA-API)

# ---- NVIDIA ----

- name: Install NVIDIA proprietary drivers (Debian)
  ansible.builtin.apt:
    name:
      - nvidia-driver
    state: present
    update_cache: true
  when:
    - gpu_drivers_has_nvidia
    - gpu_drivers_nvidia_variant == 'proprietary'
  tags: ['gpu', 'nvidia']

- name: Install NVIDIA open kernel modules (Debian)
  ansible.builtin.apt:
    name:
      - nvidia-open-kernel-dkms
      - nvidia-driver
    state: present
    update_cache: true
  when:
    - gpu_drivers_has_nvidia
    - gpu_drivers_nvidia_variant == 'open-kernel'
  tags: ['gpu', 'nvidia']

# NOTE: nvidia-vaapi-driver is available in Debian Trixie (stable)
# and via backports on Bookworm. Requires non-free and contrib components.
- name: Install NVIDIA VA-API driver (Debian)
  ansible.builtin.apt:
    name: nvidia-vaapi-driver
    state: present
  when:
    - gpu_drivers_has_nvidia
    - gpu_drivers_nvidia_variant in ['proprietary', 'open-kernel']
    - gpu_drivers_vaapi
  tags: ['gpu', 'nvidia']

- name: Install NVIDIA nouveau drivers (Debian)
  ansible.builtin.apt:
    name:
      - xserver-xorg-video-nouveau
      - libgl1-mesa-dri
    state: present
  when:
    - gpu_drivers_has_nvidia
    - gpu_drivers_nvidia_variant == 'nouveau'
  tags: ['gpu', 'nvidia']

# ---- AMD ----

- name: Install AMD firmware and Mesa (Debian)
  ansible.builtin.apt:
    name:
      - firmware-amd-graphics
      - mesa-vulkan-drivers
      - libgl1-mesa-dri
    state: present
    update_cache: true
  when: gpu_drivers_has_amd
  tags: ['gpu', 'amd']

- name: Install AMD VA-API driver (Debian)
  ansible.builtin.apt:
    name: mesa-va-drivers
    state: present
  when:
    - gpu_drivers_has_amd
    - gpu_drivers_vaapi
  tags: ['gpu', 'amd']

# ---- Intel ----

- name: Install Intel Mesa and VA-API (Debian)
  ansible.builtin.apt:
    name:
      - intel-media-va-driver
      - mesa-vulkan-drivers
      - libgl1-mesa-dri
    state: present
    update_cache: true
  when: gpu_drivers_has_intel
  tags: ['gpu', 'intel']

# ---- Vulkan tools ----

- name: Install Vulkan tools (Debian)
  ansible.builtin.apt:
    name: vulkan-tools
    state: present
  when:
    - gpu_drivers_has_nvidia or gpu_drivers_has_amd or gpu_drivers_has_intel
    - gpu_drivers_vulkan_tools
  tags: ['gpu', 'vulkan']
