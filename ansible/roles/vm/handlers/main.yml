---
- name: Restart vboxservice
  ansible.builtin.systemd:
    name: vboxservice
    state: restarted
  failed_when: false
  when: ansible_facts['virtualization_type'] | default('') == 'virtualbox'

- name: Restart vboxadd-service
  ansible.builtin.systemd:
    name: vboxadd-service
    state: restarted
  failed_when: false
  when: ansible_facts['virtualization_type'] | default('') == 'virtualbox'

- name: Restart vmtoolsd
  ansible.builtin.systemd:
    name: vmtoolsd
    state: restarted
  when: ansible_facts['virtualization_type'] | default('') == 'VMware'

- name: Restart vgauthd
  ansible.builtin.systemd:
    name: vgauthd
    state: restarted
  when: ansible_facts['virtualization_type'] | default('') == 'VMware'

- name: Restart vmware-vmblock-fuse
  ansible.builtin.systemd:
    name: vmware-vmblock-fuse
    state: restarted
  failed_when: false
  when: ansible_facts['virtualization_type'] | default('') == 'VMware'

- name: Restart hyperv daemons
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: restarted
  loop:
    - hv_fcopy_daemon
    - hv_kvp_daemon
    - hv_vss_daemon
  failed_when: false
  when: ansible_facts['virtualization_type'] | default('') == 'hyperv'

- name: Regenerate initramfs
  ansible.builtin.command:
    cmd: mkinitcpio -P
  changed_when: true
  when: ansible_facts['os_family'] == 'Archlinux'
