---
# === Custom Facts Deployment ===
# Deploy vm_guest.fact script to /etc/ansible/facts.d

- name: "Facts: Create /etc/ansible/facts.d directory"
  ansible.builtin.file:
    path: /etc/ansible/facts.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags: ['vm', 'vm:facts']

- name: "Facts: Deploy vm_guest.fact script"
  ansible.builtin.copy:
    dest: /etc/ansible/facts.d/vm_guest.fact
    owner: root
    group: root
    mode: '0755'
    content: |
      #!/bin/bash
      # Custom fact: VM guest information
      # Generated by ansible role: vm
      VIRT=$(systemd-detect-virt 2>/dev/null || echo "none")
      KERNEL=$(uname -r)
      echo "{\"hypervisor\": \"$VIRT\", \"kernel_version\": \"$KERNEL\"}"
  tags: ['vm', 'vm:facts']

- name: "Facts: Report deployment"
  ansible.builtin.debug:
    msg: "Custom fact vm_guest.fact deployed to /etc/ansible/facts.d/"
  tags: ['vm', 'vm:facts']
