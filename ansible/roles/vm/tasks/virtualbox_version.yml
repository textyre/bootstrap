---
# ===================================================================
# VirtualBox Guest Additions - Version Detection & ISO Trigger
# ===================================================================
#
# Purpose:
#   Detect host and guest VirtualBox versions, compare them, and
#   trigger ISO installation when versions mismatch.
#
# Called from:
#   virtualbox.yml (when vm_vbox_version_check is true)
#
# Expected variables:
#   - vm_vbox_version_check: boolean (should already be checked by caller)
#   - _vm_vbox_iso_dirs_pre: result of find task for existing ISO dirs
#   - packages_virtualbox_guest: package list from group_vars
#
# Sets facts:
#   - _vm_vbox_host_ver: parsed host VirtualBox version
#   - _vm_vbox_guest_ver: parsed installed GA version
#
# Calls:
#   - virtualbox_iso_install.yml (when versions mismatch)
#
# ===================================================================

- name: "VirtualBox: Get host VirtualBox version"
  ansible.builtin.command:
    cmd: VBoxControl guestproperty get /VirtualBox/HostInfo/VBoxVer
  register: _vm_vbox_host_version_raw
  changed_when: false
  failed_when: false
  tags: ['vm', 'vbox', 'vm:verify']

- name: "VirtualBox: Get installed GA version"
  ansible.builtin.command:
    cmd: VBoxControl --version
  register: _vm_vbox_guest_version_raw
  changed_when: false
  failed_when: false
  tags: ['vm', 'vbox', 'vm:verify']

- name: "VirtualBox: Parse versions"
  ansible.builtin.set_fact:
    _vm_vbox_host_ver: >-
      {{ _vm_vbox_host_version_raw.stdout | default('')
         | regex_search('Value:\s*(.+)', '\1')
         | default(['unknown'], true) | first | trim }}
    _vm_vbox_guest_ver: >-
      {{ _vm_vbox_guest_version_raw.stdout | default('')
         | regex_replace('[^0-9.].*', '') }}
  when:
    - _vm_vbox_host_version_raw.rc | default(1) == 0
    - _vm_vbox_guest_version_raw.rc | default(1) == 0
  tags: ['vm', 'vbox', 'vm:verify']

- name: "VirtualBox: Report detected versions"
  ansible.builtin.debug:
    msg: "Detected versions - Host: {{ _vm_vbox_host_ver | default('unknown') }}, Guest: {{ _vm_vbox_guest_ver | default('unknown') }}"
  when:
    - _vm_vbox_host_ver is defined
    - _vm_vbox_guest_ver is defined
  tags: ['vm', 'vbox', 'vm:verify']

- name: "VirtualBox: Trigger ISO installation on version mismatch"
  ansible.builtin.include_tasks: virtualbox_iso_install.yml
  when:
    - _vm_vbox_host_ver is defined
    - _vm_vbox_guest_ver is defined
    - _vm_vbox_host_ver != 'unknown'
    - _vm_vbox_host_ver != _vm_vbox_guest_ver
  tags: ['vm', 'vbox', 'vm:install']
