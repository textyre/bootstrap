---
# === Hyper-V Guest Daemons ===
# Install packages, enable services, verify modules

# ---- Install packages with retries ----

- name: "Hyper-V: Install guest packages"
  ansible.builtin.package:
    name: "{{ packages_hyperv_guest }}"
    state: present
  when: packages_hyperv_guest | length > 0
  register: _vm_hyperv_pkg_install
  retries: 3
  delay: 5
  until: _vm_hyperv_pkg_install is succeeded
  tags: ['vm', 'hyperv', 'vm:install']

# ---- Enable and start services ----

- name: "Hyper-V: Enable guest daemons"
  tags: ['vm', 'hyperv', 'vm:service']
  block:
    - name: "Hyper-V: Enable daemons"
      ansible.builtin.service:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - hv_fcopy_daemon
        - hv_kvp_daemon
        - hv_vss_daemon
      register: _vm_hyperv_daemons
      failed_when: false

    - name: "Hyper-V: Check journald for daemon errors"
      ansible.builtin.command:
        cmd: journalctl -u {{ item }} -n 20 --no-pager
      loop:
        - hv_fcopy_daemon
        - hv_kvp_daemon
        - hv_vss_daemon
      register: _vm_hyperv_journals
      changed_when: false
      failed_when: false

    - name: "Hyper-V: Report daemon health"
      ansible.builtin.debug:
        msg: "Hyper-V guest daemons started successfully"
      when: _vm_hyperv_daemons is succeeded
  rescue:
    - name: "Hyper-V: Daemon start failed"
      ansible.builtin.fail:
        msg: >-
          Failed to start one or more Hyper-V daemons.
          Check journal output for details.

# ---- Verify kernel modules ----

- name: "Hyper-V: Check kernel modules loaded"
  ansible.builtin.command: lsmod
  register: _vm_hyperv_lsmod
  changed_when: false
  tags: ['vm', 'hyperv', 'vm:verify']

- name: "Hyper-V: Verify hv_vmbus module loaded"
  ansible.builtin.assert:
    that: "'hv_vmbus' in _vm_hyperv_lsmod.stdout"
    fail_msg: "hv_vmbus kernel module not loaded. Reboot may be required."
    success_msg: "hv_vmbus module loaded successfully"
  tags: ['vm', 'hyperv', 'vm:verify']

- name: "Hyper-V: Check additional modules"
  ansible.builtin.debug:
    msg:
      - "hv_storvsc: {{ 'loaded' if 'hv_storvsc' in _vm_hyperv_lsmod.stdout else 'not loaded' }}"
      - "hv_netvsc: {{ 'loaded' if 'hv_netvsc' in _vm_hyperv_lsmod.stdout else 'not loaded' }}"
      - "hv_utils: {{ 'loaded' if 'hv_utils' in _vm_hyperv_lsmod.stdout else 'not loaded' }}"
  tags: ['vm', 'hyperv', 'vm:verify']

# ---- Report ----

- name: "Hyper-V: Report configuration"
  ansible.builtin.debug:
    msg: "Hyper-V guest integration services installed and enabled"
  tags: ['vm', 'hyperv']
