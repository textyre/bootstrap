---
# === Hyper-V Guest Integration Services ===
#
# Daemons:
#   hv_fcopy_daemon  -- file copy between host and guest
#   hv_kvp_daemon    -- key-value pair exchange (network config, metadata)
#   hv_vss_daemon    -- Volume Shadow Copy (live backup support)
#
# Kernel modules:
#   hv_vmbus   -- VMBus communication layer (REQUIRED foundation)
#   hv_storvsc -- virtual storage controller
#   hv_netvsc  -- virtual network adapter
#   hv_utils   -- integration utilities (shutdown, heartbeat, time sync)

# ---- Install packages ----

- ansible.builtin.include_tasks:
    file: _install_packages.yml
  vars:
    _vm_pkg_list: "{{ _vm_hyperv_pkg_map[ansible_facts['os_family']] | default(packages_hyperv_guest) }}"
    _vm_pkg_label: "Hyper-V"
  tags: ['vm', 'hyperv']

# ---- Check time sync ----

- ansible.builtin.include_tasks:
    file: _check_timesync.yml
  vars:
    _vm_timesync_label: "Hyper-V"
    _vm_timesync_service: "hv_utils (via hv_vmbus)"
  tags: ['vm', 'hyperv']

# ---- Manage services ----

- ansible.builtin.include_tasks:
    file: _manage_services.yml
  vars:
    _vm_svc_list:
      - name: hv_fcopy_daemon
        description: "file copy between host and guest"
        required: true
      - name: hv_kvp_daemon
        description: "key-value pair exchange (network config, metadata)"
        required: true
      - name: hv_vss_daemon
        description: "Volume Shadow Copy (live backup support)"
        required: true
    _vm_svc_label: "Hyper-V"
  tags: ['vm', 'hyperv']

# ---- Verify kernel modules ----

- ansible.builtin.include_tasks:
    file: _verify_modules.yml
  vars:
    _vm_mod_list:
      - name: hv_vmbus
        description: "VMBus communication layer (REQUIRED foundation)"
        required: true
      - name: hv_storvsc
        description: "virtual storage controller"
        required: false
      - name: hv_netvsc
        description: "virtual network adapter"
        required: false
      - name: hv_utils
        description: "integration utilities (shutdown, heartbeat, time sync)"
        required: false
    _vm_mod_label: "Hyper-V"
  tags: ['vm', 'hyperv']

# ---- Version report ----

- ansible.builtin.include_tasks:
    file: _version_report.yml
  vars:
    _vm_ver_label: "Hyper-V"
    _vm_ver_command: "dmesg | grep -i 'hyper-v' | head -5"
  tags: ['vm', 'hyperv']

# ---- Check X11 integration ----

- ansible.builtin.include_tasks:
    file: _check_x11.yml
  vars:
    _vm_x11_label: "Hyper-V"
    _vm_x11_paths:
      - path: /usr/bin/xrdp
        description: "xrdp remote desktop (Enhanced Session)"
  tags: ['vm', 'hyperv']

# ---- Check reboot requirement ----

- ansible.builtin.include_tasks:
    file: _reboot_flag.yml
  vars:
    _vm_reboot_label: "Hyper-V"
    _vm_reboot_condition: "{{ (_vm_pkg_install_result is changed) and ('hv_vmbus' not in _vm_lsmod_output.stdout) }}"
  tags: ['vm', 'hyperv']
