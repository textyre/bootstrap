---
# === VirtualBox Guest Additions ===
#
# Services:
#   vboxservice / vboxadd-service -- guest service (time sync, clipboard, seamless mode)
#     (vboxservice = pacman install, vboxadd-service = ISO install)
#
# Kernel modules:
#   vboxguest  -- core guest integration module (REQUIRED)
#   vboxsf     -- shared folders support (REQUIRED for shared folder functionality)
#   vboxvideo  -- graphics driver (optional, may use VMSVGA instead)
#
# Version enforcement:
#   Guest Additions version MUST match host VirtualBox version.
#   Mismatch causes shared folders, clipboard, and display resize to break.
#   If mismatch detected, role downloads and installs from ISO automatically.

# ---- Phase 1: Pre-flight detection ----

- name: "VirtualBox: Check if VBoxControl is available"
  ansible.builtin.command:
    cmd: which VBoxControl
  register: vm_vbox_control_check
  changed_when: false
  failed_when: false
  tags: ['vm', 'vbox', 'vm:install']

- name: "VirtualBox: Check for existing ISO Guest Additions"
  ansible.builtin.find:
    paths: /opt
    patterns: 'VBoxGuestAdditions-*'
    file_type: directory
  register: vm_vbox_iso_dirs_pre
  changed_when: false
  failed_when: false
  tags: ['vm', 'vbox', 'vm:install']

# ---- Phase 2: Initial install for detection (only if VBoxControl missing) ----

- name: "VirtualBox: Install pacman GA for version detection"
  ansible.builtin.package:
    name: "{{ packages_virtualbox_guest }}"
    state: present
  when:
    - _vm_vbox_control_check.rc != 0
    - packages_virtualbox_guest | length > 0
  register: vm_vbox_initial_install
  retries: 3
  delay: 5
  until: _vm_vbox_initial_install is succeeded
  notify: "Restart virtualbox services"
  tags: ['vm', 'vbox', 'vm:install']

# ---- Phase 3: Version detection and ISO enforcement ----

- name: "VirtualBox: Version detection and ISO enforcement"
  ansible.builtin.include_tasks: virtualbox_version.yml
  when: vm_vbox_version_check
  tags: ['vm', 'vbox', 'vm:verify', 'vm:install']

# ---- Phase 4: Pacman path (versions match OR version check disabled) ----

- name: "VirtualBox: Ensure pacman GA packages (versions match)"
  ansible.builtin.package:
    name: "{{ packages_virtualbox_guest }}"
    state: present
  when:
    - packages_virtualbox_guest | length > 0
    - not (vm_vbox_iso_installed | default(false))
    - _vm_vbox_iso_dirs_pre.matched | default(0) == 0
    - >-
      not vm_vbox_version_check
      or (vm_vbox_host_ver | default('') == vm_vbox_guest_ver | default(''))
      or vm_vbox_host_ver | default('') == 'unknown'
  register: vm_vbox_pkg_install
  retries: 3
  delay: 5
  until: _vm_vbox_pkg_install is succeeded
  notify: "Restart virtualbox services"
  tags: ['vm', 'vbox', 'vm:install']

# ---- Phase 5: LTS kernel DKMS support (only for pacman path) ----

- name: "VirtualBox: LTS kernel DKMS support"
  ansible.builtin.include_tasks: virtualbox_lts_kernel.yml
  tags: ['vm', 'vbox', 'vm:install']

# ---- Phase 6: Determine active service name ----

- name: "VirtualBox: Determine active service name"
  ansible.builtin.set_fact:
    vm_vbox_service_name: >-
      {{ 'vboxadd-service' if (vm_vbox_iso_installed | default(false))
         or (_vm_vbox_iso_dirs_pre.matched | default(0) > 0)
         else 'vboxservice' }}
  tags: ['vm', 'vbox', 'vm:service']

# ---- Phase 7: Time sync conflict check ----

- name: "VirtualBox: Check time sync conflicts"
  ansible.builtin.include_tasks:
    file: _check_timesync.yml
  vars:
    vm_timesync_label: "VirtualBox"
    vm_timesync_service: "{{ vm_vbox_service_name }}"
  tags: ['vm', 'vbox']

# ---- Phase 8: Service management ----

- name: "VirtualBox: Manage guest services"
  ansible.builtin.include_tasks:
    file: _manage_services.yml
  vars:
    vm_svc_label: "VirtualBox"
    vm_svc_list:
      - name: "{{ vm_vbox_service_name }}"
        description: "guest service (time sync, clipboard, seamless mode)"
        required: true
  when: not (vm_vbox_iso_installed | default(false))
  tags: ['vm', 'vbox']

# ---- Phase 9: Module verification ----

- name: "VirtualBox: Verify kernel modules"
  ansible.builtin.include_tasks:
    file: _verify_modules.yml
  vars:
    vm_mod_label: "VirtualBox"
    vm_mod_list:
      - name: vboxguest
        description: "core guest integration module"
        required: true
      - name: vboxsf
        description: "shared folders support"
        required: true
      - name: vboxvideo
        description: "graphics driver (may use VMSVGA instead)"
        required: false
  tags: ['vm', 'vbox']

# ---- Phase 10: X11 autostart check ----

- name: "VirtualBox: Check desktop integration"
  ansible.builtin.include_tasks:
    file: _check_x11.yml
  vars:
    _vm_x11_label: "VirtualBox"
    vm_x11_paths:
      - path: /etc/xdg/autostart/vboxclient.desktop
        description: "VBoxClient X11 autostart (clipboard, seamless, display resize)"
        content: |
          [Desktop Entry]
          Type=Application
          Name=VBoxClient
          Exec=/usr/bin/VBoxClient-all
          X-GNOME-Autostart-enabled=true
  tags: ['vm', 'vbox']

# ---- Phase 11: Final version verification ----

- name: "VirtualBox: Report version"
  ansible.builtin.include_tasks:
    file: _version_report.yml
  vars:
    vm_ver_label: "VirtualBox"
    vm_ver_command: "VBoxControl --version"
  when: vm_vbox_version_check
  tags: ['vm', 'vbox']

# ---- Phase 12: Reboot flag ----

- name: "VirtualBox: Check reboot requirement"
  ansible.builtin.include_tasks:
    file: _reboot_flag.yml
  vars:
    vm_reboot_label: "VirtualBox"
    vm_reboot_condition: >-
      {{ ((_vm_vbox_pkg_install is defined and _vm_vbox_pkg_install is changed)
          or (vm_vbox_iso_installed | default(false)))
         and ('vboxguest' not in (_vm_lsmod_output.stdout | default(''))) }}
  tags: ['vm', 'vbox']
