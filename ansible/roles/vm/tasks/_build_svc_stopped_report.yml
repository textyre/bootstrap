---
# =========================================================================
# _build_svc_stopped_report.yml
# =========================================================================
# Build service report rows from _vm_svc_stop_result.
#
# Expected variables:
#   vm_pkg_label        (string)   - Hypervisor label
#   _vm_svc_stop_result  (register) - Per-service stop results
#
# Output:
#   vm_rpt_svc_rows (list) - Formatted table rows
# =========================================================================

- name: "{{ vm_pkg_label }}: Initialize service report"
  ansible.builtin.set_fact:
    vm_rpt_svc_rows: []
  tags: ['vm', 'vm:report']

- name: "{{ vm_pkg_label }}: Collect service results"
  ansible.builtin.set_fact:
    vm_rpt_svc_rows: "{{ vm_rpt_svc_rows + [row] }}"
  vars:
    failed: "{{ item.failed | default(false) | bool }}"
    common_rpt_status_mark: "{{ '- skipped' if failed else '+ stopped' }}"
    detail: "{{ (item.msg | default('not found')) | truncate(28, true, '..') if failed else 'disabled' }}"
    row: "| {{ '%-20s' | format(item.item | truncate(20, true, '..')) }} | {{ '%-10s' | format(_st) }} | {{ '%-28s' | format(detail) }} |"
  loop: "{{ vm_svc_stop_result.results | default([]) }}"
  loop_control:
    label: "{{ item.item }}"
  tags: ['vm', 'vm:report']
