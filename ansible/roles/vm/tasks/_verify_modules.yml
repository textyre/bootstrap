---
# =========================================================================
# _verify_modules.yml
# =========================================================================
# Common task file: Verify kernel modules are loaded
#
# This file extracts the "lsmod + assert" pattern used for kernel module
# verification across all hypervisor-specific task files.
#
# Usage:
#   - ansible.builtin.include_tasks: _verify_modules.yml
#     vars:
#       vm_mod_list:
#         - name: hv_vmbus
#           description: "Hyper-V VMBus driver"
#           required: true
#         - name: hv_storvsc
#           description: "Hyper-V storage driver"
#           required: false
#       vm_mod_label: "Hyper-V"
#
# Required parameters:
#   vm_mod_list (list of dicts) - Kernel modules to verify. Each dict must have:
#     - name (string)        - Kernel module name (as shown in lsmod output)
#     - description (string) - Human-readable description for error messages
#     - required (bool)      - If true, missing module will abort playbook.
#                              If false, status is logged but no failure.
#   vm_mod_label (string)   - Hypervisor name for task names
#
# Behavior:
#   - Checks each module is available on disk via modinfo (can be loaded)
#   - For required modules: asserts availability, fails if module not installed
#   - For optional modules: reports status without failure
#   - Also reports whether each module is currently loaded (informational)
#
# Exit conditions:
#   - Success: All required modules are available (installed on disk)
#   - Failure: Any required module is missing from the system
# =========================================================================

- name: "Check module availability ({{ vm_mod_label }})"
  ansible.builtin.command: "modinfo {{ item.name }}"
  register: vm_modinfo_results
  loop: "{{ vm_mod_list }}"
  loop_control:
    label: "{{ item.name }}"
  changed_when: false
  failed_when: false
  tags: ['vm', 'vm:verify']

- name: "Verify required modules available ({{ vm_mod_label }})"
  ansible.builtin.assert:
    that: "item.rc == 0"
    fail_msg: "{{ item.item.name }} kernel module ({{ item.item.description }}) not installed. Guest additions may need reinstalling."
    success_msg: "{{ item.item.name }} module available"
  loop: "{{ vm_modinfo_results.results | selectattr('item.required', 'equalto', true) | list }}"
  loop_control:
    label: "{{ item.item.name }}"
  tags: ['vm', 'vm:verify']

- name: "Check loaded status ({{ vm_mod_label }})"
  ansible.builtin.command: lsmod
  register: _vm_lsmod_output
  changed_when: false
  tags: ['vm', 'vm:verify']

- name: "Report module status ({{ vm_mod_label }})"
  ansible.builtin.debug:
    msg: "{{ item.name }} ({{ item.description }}): {{ 'loaded' if item.name in _vm_lsmod_output.stdout else 'available (not loaded)' }}"
  loop: "{{ vm_mod_list }}"
  loop_control:
    label: "{{ item.name }}"
  tags: ['vm', 'vm:verify', 'vm:report']
