---
# =========================================================================
# _remove_guest_tools.yml
# =========================================================================
# Orchestrator: stop services, remove packages, remove facts, display report.
#
# Expected variables (set by main.yml detection phase):
#   vm_is_guest    (bool)   - Whether running as guest
#   _vm_virt_type   (string) - Virtualization type
#   _vm_virt_role   (string) - Virtualization role
# =========================================================================

# ---- Stop services and remove packages ----

- name: "Stop services: All hypervisors"
  ansible.builtin.include_tasks: _stop_services.yml
  vars:
    vm_pkg_label: "All hypervisors"
    vm_svc_list:
      # VirtualBox
      - vboxservice        # guest service from package manager (time sync, clipboard, seamless)
      - vboxadd-service    # guest service from ISO install (same role as vboxservice)
      # VMware
      - vmtoolsd           # core VMware Tools daemon (status, time sync, display resize)
      - vgauthd            # guest authentication for vSphere operations
      - vmware-vmblock-fuse  # drag-and-drop via FUSE (optional, desktop only)
      # Hyper-V
      - hv_fcopy_daemon    # file copy between host and guest
      - hv_kvp_daemon      # key-value pair exchange (network config, metadata)
      - hv_vss_daemon      # Volume Shadow Copy (live backup support)
      # KVM
      - qemu-guest-agent   # QEMU Guest Agent (filesystem freeze, shutdown, exec)
  tags: ['vm', 'vm:service']

- name: "Remove packages: All hypervisors"
  ansible.builtin.include_tasks: _remove_packages.yml
  vars:
    vm_pkg_label: "All hypervisors"
    vm_pkg_list: >-
      {{ packages_virtualbox_guest + packages_vmware_guest
         + (vm_hyperv_packages | default(packages_hyperv_guest))
         + (vm_kvm_packages | default(packages_kvm_guest)) }}
  tags: ['vm', 'vm:install']

- name: "Report: Remove guest tools"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_phase.yml
  vars:
    common_rpt_fact: "_vm_phases"
    common_rpt_phase: "Remove guest tools"
    common_rpt_detail: "state=absent"
  tags: ['vm']

# ---- Remove persisted facts ----

- name: Remove VM guest facts
  ansible.builtin.file:
    path: /etc/ansible/facts.d/vm_guest.fact
    state: absent
  tags: ['vm']

- name: "Report: Remove custom facts"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_phase.yml
  vars:
    common_rpt_fact: "_vm_phases"
    common_rpt_phase: "Remove custom facts"
    common_rpt_detail: "vm_guest.fact"
  tags: ['vm']

# ---- Removal report ----

- name: "Build service stopped report: All hypervisors"
  ansible.builtin.include_tasks: _build_svc_stopped_report.yml
  vars:
    vm_pkg_label: "All hypervisors"
  tags: ['vm', 'vm:report']

- name: "Build package removed report: All hypervisors"
  ansible.builtin.include_tasks: _build_pkg_removed_report.yml
  vars:
    vm_pkg_label: "All hypervisors"
  tags: ['vm', 'vm:report']

- name: "Display removal report: All hypervisors"
  ansible.builtin.include_tasks: _display_removal.yml
  vars:
    vm_pkg_label: "All hypervisors"
  tags: ['vm', 'vm:report']
