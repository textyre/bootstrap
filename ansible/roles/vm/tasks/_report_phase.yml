---
# =========================================================================
# _report_phase.yml
# =========================================================================
# Append a formatted row to the VM role execution report table.
#
# Usage:
#   - ansible.builtin.include_tasks: _report_phase.yml
#     vars:
#       _vm_rpt_phase: "Install packages"
#       _vm_rpt_detail: "open-vm-tools"
#
#   - ansible.builtin.include_tasks: _report_phase.yml
#     vars:
#       _vm_rpt_phase: "Remove guest tools"
#       _vm_rpt_status: "skip"
#       _vm_rpt_detail: "state=present"
#
# Parameters:
#   _vm_rpt_phase  (string) - Phase name (max 26 chars)
#   _vm_rpt_status (string) - done / skip / fail (default: done)
#   _vm_rpt_detail (string) - Payload info (default: '')
#
# Table format: | Phase(26) | Status(10) | Details(24) |
# Total width: 70 chars (fits 80-col terminal)
# =========================================================================

- name: "Report: {{ _vm_rpt_phase }}"
  ansible.builtin.set_fact:
    _vm_phases: "{{ (_vm_phases | default([])) + [_row] }}"
  vars:
    _st: "{{ _vm_rpt_status | default('done') }}"
    _mk: "{{ '+' if _st == 'done' else ('-' if _st == 'skip' else '!') }}"
    _row: "| {{ '%-26s' | format(_vm_rpt_phase) }} | {{ '%-10s' | format(_mk ~ ' ' ~ _st) }} | {{ '%-24s' | format(_vm_rpt_detail | default('')) }} |"
  tags: ['vm', 'vm:report']
