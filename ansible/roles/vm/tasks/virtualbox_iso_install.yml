---
# ===================================================================
# VirtualBox Guest Additions - ISO Installation with Recovery
# ===================================================================
#
# Purpose:
#   Install VirtualBox Guest Additions from ISO when host/guest
#   versions mismatch. Includes full block/rescue/always recovery.
#
# Called from:
#   virtualbox_version.yml (only when versions mismatch)
#
# Expected variables:
#   - vm_vbox_host_ver: target version to install (from version check)
#   - vm_vbox_iso_dirs_pre: find result for existing ISO dirs
#   - vm_packages_virtualbox_guest: package list from group_vars
#
# Sets facts:
#   - vm_vbox_iso_installed: true (on success)
#
# Recovery guarantee:
#   On failure, automatically reverts to pacman GA packages.
#   If recovery also fails, playbook fails with diagnostics.
#
# ===================================================================

- name: "VirtualBox: Enforce version match via ISO"
  tags: ['vm', 'vbox', 'vm:install']
  block:
    - name: "VirtualBox: Detect kernel type for ISO build"
      ansible.builtin.command:
        cmd: uname -r
      register: vm_vbox_kernel_for_iso
      changed_when: false

    - name: "VirtualBox: Download VBoxGuestAdditions ISO"
      ansible.builtin.get_url:
        url: "https://download.virtualbox.org/virtualbox/{{ vm_vbox_host_ver }}/VBoxGuestAdditions_{{ vm_vbox_host_ver }}.iso"
        dest: "/tmp/VBoxGuestAdditions_{{ vm_vbox_host_ver }}.iso"
        mode: '0644'

    - name: "VirtualBox: Install build dependencies"
      ansible.builtin.package:
        name: "{{ ['gcc', 'make', 'perl'] + (['linux-lts-headers'] if '-lts' in _vm_vbox_kernel_for_iso.stdout else ['linux-headers']) }}"
        state: present
      retries: 3
      delay: 5
      until: _vm_vbox_build_deps is succeeded
      register: vm_vbox_build_deps

    - name: "VirtualBox: Stop vboxservice"
      ansible.builtin.service:
        name: vboxservice
        state: stopped
      failed_when: false

    - name: "VirtualBox: Stop vboxadd-service"
      ansible.builtin.service:
        name: vboxadd-service
        state: stopped
      failed_when: false

    - name: "VirtualBox: Remove pacman GA packages"
      ansible.builtin.package:
        name: "{{ vm_packages_virtualbox_guest }}"
        state: absent
      when: vm_packages_virtualbox_guest | length > 0

    - name: "VirtualBox: Remove existing ISO Guest Additions"
      ansible.builtin.command:
        cmd: "{{ item.path }}/uninstall.sh"
      loop: "{{ vm_vbox_iso_dirs_pre.files }}"
      when: vm_vbox_iso_dirs_pre.matched > 0
      register: vm_vbox_old_iso_uninstall
      changed_when: vm_vbox_old_iso_uninstall.rc | default(1) == 0
      failed_when: false

    - name: "VirtualBox: Create ISO mount point"
      ansible.builtin.file:
        path: /mnt/vbox_iso
        state: directory
        mode: '0755'

    - name: "VirtualBox: Mount GA ISO"  # noqa: command-instead-of-module
      ansible.builtin.command:
        cmd: "mount -o loop,ro /tmp/VBoxGuestAdditions_{{ vm_vbox_host_ver }}.iso /mnt/vbox_iso"
      changed_when: true

    - name: "VirtualBox: Run VBoxLinuxAdditions.run"
      ansible.builtin.command:
        cmd: /mnt/vbox_iso/VBoxLinuxAdditions.run --nox11
      register: vm_vbox_iso_install_result
      changed_when: true
      failed_when: false

    - name: "VirtualBox: Show ISO installer output"
      ansible.builtin.debug:
        msg: "{{ vm_vbox_iso_install_result.stdout_lines | default([]) }}"
      tags: ['vm', 'vbox', 'vm:install', 'vm:report']

    - name: "VirtualBox: Load vboxguest module"
      ansible.builtin.command:
        cmd: modprobe vboxguest
      changed_when: true
      failed_when: false

    - name: "VirtualBox: Create systemd service file for ISO GA"
      ansible.builtin.copy:
        dest: /usr/lib/systemd/system/vboxadd-service.service
        content: |
          [Unit]
          Description=VirtualBox Guest Additions Service
          ConditionVirtualization=oracle
          After=network.target

          [Service]
          Type=simple
          ExecStart=/usr/bin/VBoxService -f
          Restart=on-failure

          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      notify: "Reload systemd daemon"

    - name: "VirtualBox: Reload systemd daemon"
      ansible.builtin.systemd:
        daemon_reload: true

    - name: "VirtualBox: Enable vboxadd-service"
      ansible.builtin.systemd:
        name: vboxadd-service
        enabled: true
        state: started
      failed_when: false

    - name: "VirtualBox: Mark ISO installation complete"
      ansible.builtin.set_fact:
        vm_vbox_iso_installed: true

  rescue:
    - name: "VirtualBox: RECOVERY - Re-install pacman GA packages"
      ansible.builtin.package:
        name: "{{ vm_packages_virtualbox_guest }}"
        state: present
      register: vm_vbox_recovery
      failed_when: false

    - name: "VirtualBox: RECOVERY - Re-enable vboxservice"
      ansible.builtin.service:
        name: vboxservice
        enabled: true
        state: started
      when: vm_vbox_recovery is succeeded
      failed_when: false

    - name: "VirtualBox: Collect failure diagnostics"
      ansible.builtin.shell:
        cmd: "{{ item }}"
      loop:
        - "uname -r"
        - "ls -la /opt/VBoxGuestAdditions-* 2>/dev/null || echo 'No ISO GA found'"
        - "lsmod | grep vbox || echo 'No vbox modules'"
      register: vm_vbox_iso_diag
      changed_when: false
      failed_when: false

    - name: "VirtualBox: CRITICAL - ISO install and recovery both failed"
      ansible.builtin.fail:
        msg: >-
          Failed to install VBoxGuestAdditions {{ vm_vbox_host_ver }} from ISO, and pacman recovery also failed.
          Diagnostics: {{ vm_vbox_iso_diag.results | map(attribute='stdout') | list }}
      when: vm_vbox_recovery is failed

    - name: "VirtualBox: ISO install failed, reverted to pacman"
      ansible.builtin.debug:
        msg: >-
          WARNING: ISO GA install failed. Reverted to pacman packages ({{ vm_vbox_guest_ver }}).
          Version mismatch persists (host={{ vm_vbox_host_ver }}).
      when: vm_vbox_recovery is succeeded
      tags: ['vm', 'vbox', 'vm:install', 'vm:report']

  always:
    - name: "VirtualBox: Unmount ISO"
      ansible.builtin.command:
        cmd: umount /mnt/vbox_iso
      changed_when: false
      failed_when: false

    - name: "VirtualBox: Remove ISO mount point"
      ansible.builtin.file:
        path: /mnt/vbox_iso
        state: absent

    - name: "VirtualBox: Remove downloaded ISO"
      ansible.builtin.file:
        path: "/tmp/VBoxGuestAdditions_{{ vm_vbox_host_ver }}.iso"
        state: absent
