---
# =========================================================================
# _manage_services.yml
# =========================================================================
# Common task file: Enable, start, and verify VM guest services
#
# This file extracts the "enable service + start + journal check + report"
# pattern that is duplicated across all hypervisor-specific task files.
#
# Usage:
#   - ansible.builtin.include_tasks: _manage_services.yml
#     vars:
#       vm_svc_list:
#         - name: vgauthd
#           description: "VMware Guest Authentication Service"
#           required: true
#         - name: vmware-vmblock-fuse
#           description: "VMware Shared Folders FUSE Service"
#           required: false
#       vm_svc_label: "VMware"
#
# Required parameters:
#   vm_svc_list (list of dicts) - Services to manage. Each dict must have:
#     - name (string)        - systemd service name
#     - description (string) - Human-readable description for reporting
#     - required (bool)      - If true, failure will abort playbook.
#                              If false, failure is logged but ignored.
#   vm_svc_label (string)   - Hypervisor name for task names
#
# Behavior:
#   - Loops over all services and enables + starts each
#   - For required services: failure will abort the playbook
#   - For optional services: uses failed_when=false, logs status
#   - Checks journald logs (last 20 lines) for each required service
#   - Reports overall success status
#
# Exit conditions:
#   - Success: All required services started successfully
#   - Failure: Any required service failed to start
# =========================================================================

- name: "Enable and start services ({{ vm_svc_label }})"
  ansible.builtin.service:
    name: "{{ item.name }}"
    enabled: true
    state: started
  loop: "{{ vm_svc_list }}"
  loop_control:
    label: "{{ item.name }} ({{ 'required' if item.required else 'optional' }})"
  register: _vm_svc_result
  failed_when:
    - _vm_svc_result is failed
    - item.required
  tags: ['vm', 'vm:service']

- name: "Check journald for service errors ({{ vm_svc_label }})"
  ansible.builtin.command:
    cmd: journalctl -u {{ item.name }} -n 20 --no-pager
  loop: "{{ vm_svc_list | selectattr('required', 'equalto', true) | list }}"
  loop_control:
    label: "{{ item.name }}"
  register: vm_svc_journal
  changed_when: false
  failed_when: false
  when: vm_service_manager | default('systemd') == 'systemd'
  tags: ['vm', 'vm:service']

- name: "Report service status ({{ vm_svc_label }})"
  ansible.builtin.debug:
    msg: "{{ item.name }} ({{ item.description }}): {{ 'started' if (_vm_svc_result.results[idx].state | default('unknown')) == 'started' else 'unavailable' }}"
  loop: "{{ vm_svc_list }}"
  loop_control:
    label: "{{ item.name }}"
    index_var: idx
  tags: ['vm', 'vm:service', 'vm:report']
