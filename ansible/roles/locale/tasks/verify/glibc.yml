---
# Проверка локалей (glibc)
# Soft-fail: выставляет _locale_verify_ok (bool) и _locale_verify_missing (list).
# НЕ крашит плей — main.yml читает _locale_verify_ok для репорта и configure.

- name: Get available locales
  ansible.builtin.command: locale -a
  register: locale_check
  changed_when: false
  tags: ['locale']

- name: Check each requested locale is available
  ansible.builtin.set_fact:
    _locale_verify_ok: "{{ (_locale_verify_ok | default(true)) and (_locale_normalized in _available_list) }}"
    _locale_verify_missing: >-
      {{ (_locale_verify_missing | default([])) +
         ([] if _locale_normalized in _available_list else [item]) }}
  vars:
    _locale_normalized: "{{ item | lower | regex_replace('[\\-\\.]', '') }}"
    _available_list: "{{ locale_check.stdout_lines | map('lower') | map('regex_replace', '[\\-\\.]', '') | list }}"
  loop: "{{ locale_list }}"
  tags: ['locale']

- name: Warn on missing locales
  ansible.builtin.debug:
    msg: >-
      WARNING: locale verify failed —
      missing: {{ locale_verify_missing | join(', ') }}
  when: not (_locale_verify_ok | default(true))
  tags: ['locale']
