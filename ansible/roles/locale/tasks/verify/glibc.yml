---
# Проверка локалей (glibc)
# Soft-fail: выставляет locale_verify_ok (bool) и locale_verify_missing (list).
# НЕ крашит плей — main.yml читает locale_verify_ok для репорта и configure.

- name: Get available locales
  ansible.builtin.command: locale -a
  register: locale_check
  changed_when: false
  tags: ['locale']

- name: Check each requested locale is available
  ansible.builtin.set_fact:
    locale_verify_ok: "{{ (locale_verify_ok | default(true)) and (locale_normalized in available_list) }}"
    locale_verify_missing: >-
      {{ (locale_verify_missing | default([])) +
         ([] if locale_normalized in available_list else [item]) }}
  vars:
    locale_normalized: "{{ item | lower | regex_replace('[\\-\\.]', '') }}"
    available_list: "{{ locale_check.stdout_lines | map('lower') | map('regex_replace', '[\\-\\.]', '') | list }}"
  loop: "{{ locale_list }}"
  tags: ['locale']

- name: Warn on missing locales
  ansible.builtin.debug:
    msg: >-
      WARNING: locale verify failed —
      missing: {{ locale_verify_missing | join(', ') }}
  when: not (locale_verify_ok | default(true))
  tags: ['locale']
