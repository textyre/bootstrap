---
- name: Verify
  hosts: all
  become: true
  gather_facts: true

  vars:
    test_locales:
      - "en_US.UTF-8"
      - "ru_RU.UTF-8"
    test_locale: "en_US.UTF-8"
    test_lc_overrides:
      LC_TIME: "ru_RU.UTF-8"

  tasks:
    - name: Get available locales
      ansible.builtin.command: locale -a
      register: locale_verify_locales
      changed_when: false

    - name: Assert all test locales are generated
      ansible.builtin.assert:
        that:
          - locale_normalized in available_list
        fail_msg: "{{ item }} locale not found in locale -a output"
      vars:
        locale_normalized: "{{ item | lower | regex_replace('[\\-\\.]', '') }}"
        available_list: "{{ locale_verify_locales.stdout_lines | map('lower') | map('regex_replace', '[\\-\\.]', '') | list }}"
      loop: "{{ test_locales }}"

    - name: Read locale.conf
      ansible.builtin.slurp:
        src: /etc/locale.conf
      register: locale_verify_locale_conf

    - name: Assert locale.conf contains LANG
      ansible.builtin.assert:
        that:
          - "'LANG={{ test_locale }}' in (locale_verify_locale_conf.content | b64decode)"
        fail_msg: "LANG={{ test_locale }} not found in /etc/locale.conf"

    - name: Assert locale.conf contains LC_* overrides
      ansible.builtin.assert:
        that:
          - "'{{ item.key }}={{ item.value }}' in (locale_verify_locale_conf.content | b64decode)"
        fail_msg: "{{ item.key }}={{ item.value }} not found in /etc/locale.conf"
      loop: "{{ test_lc_overrides | dict2items }}"

    - name: Show result
      ansible.builtin.debug:
        msg:
          - "Locale check passed!"
          - "Locales generated: {{ test_locales | join(', ') }}"
          - "LC overrides: {{ test_lc_overrides | to_nice_yaml | trim }}"

    - name: Run locale command (smoke test)
      ansible.builtin.command: locale
      register: locale_verify_locale_cmd
      changed_when: false
      environment: >-
        {{
          {'LANG': test_locale} |
          combine(test_lc_overrides)
        }}

    - name: Assert LANG is active in locale output
      ansible.builtin.assert:
        that:
          - "'LANG=' ~ test_locale in locale_verify_locale_cmd.stdout"
        fail_msg: >
          LANG={{ test_locale }} not found in 'locale' output:
          {{ locale_verify_locale_cmd.stdout }}

    - name: Assert LC_* overrides are active in locale output
      ansible.builtin.assert:
        that:
          - "item.key ~ '=' ~ item.value in locale_verify_locale_cmd.stdout"
        fail_msg: >
          {{ item.key }}={{ item.value }} not found in 'locale' output:
          {{ locale_verify_locale_cmd.stdout }}
      loop: "{{ test_lc_overrides | dict2items }}"
