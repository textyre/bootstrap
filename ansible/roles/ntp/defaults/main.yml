---
# === NTP — синхронизация времени ===
# chrony как универсальный NTP-демон (все дистро, все init-системы)

ntp_enabled: true

# NTP-серверы — список объектов {host, nts, iburst}
# Три независимых провайдера с поддержкой NTS (RFC 8915)
ntp_servers:
  - { host: "time.cloudflare.com", nts: true, iburst: true }
  - { host: "time.nist.gov", nts: true, iburst: true }
  - { host: "ptbtime1.ptb.de", nts: true, iburst: true }
  - { host: "ptbtime2.ptb.de", nts: true, iburst: true }

# Коррекция часов при запуске chrony
# Прыжок если расхождение > threshold сек, только в первые limit обновлений
ntp_makestep_threshold: 1.0
ntp_makestep_limit: 3

# Минимум согласующихся источников для обновления системных часов
# Защищает от одиночного испорченного сервера
ntp_minsources: 2

# Пути к файлам chrony
ntp_driftfile: "/var/lib/chrony/drift"
ntp_dumpdir: "/var/lib/chrony"     # история измерений — ускоряет старт после перезагрузки

# Каталог для лог-файлов chrony (читается Promtail/Loki)
ntp_logdir: "/var/log/chrony"

# Синхронизация аппаратных часов (RTC) с системными
ntp_rtcsync: true

# Логировать изменения часов > N секунд в syslog
ntp_logchange: 0.5

# Детальное логирование замеров для Loki
# Пишет measurements.log, statistics.log, tracking.log в ntp_logdir
ntp_log_tracking: true

# Pool-type NTP sources (pool directive — DNS round-robin with auto-rotation)
# Distinct from server: pool = multiple servers behind one hostname
# Example: [{host: "pool.ntp.org", iburst: true, maxsources: 4}]
ntp_pools: []

# ACL для NTP server mode (allow directive)
# Пустой список = только клиент, не раздаёт время
# Example: ["192.168.1.0/24", "10.0.0.0/8"]
ntp_allow: []

# NTS cookie cache directory (ускоряет повторное NTS-рукопожатие после перезапуска)
# chrony сохраняет NTS session cookies, при рестарте пропускает полный TLS handshake
ntp_ntsdumpdir: "/var/lib/chrony/nts-data"

# === Environment detection ===
# When true, reads ansible_facts['virtualization_type'] and adapts chrony config:
#   refclock PHC, makestep, rtcsync per hypervisor
# Set false to use ntp_refclocks manually.
ntp_auto_detect: true

# Manual refclock directives (list of raw chrony refclock strings).
# Populated automatically from detected environment when ntp_auto_detect: true.
# Override to force specific refclocks regardless of detected environment.
# Example: ["refclock PHC /dev/ptp0 poll 3 dpoll -2 offset 0 stratum 2"]
ntp_refclocks: []

# Stop and disable ntpd and openntpd if found (in addition to systemd-timesyncd).
ntp_disable_competitors: true

# On VMware guests: run `vmware-toolbox-cmd timesync disable` to stop periodic sync.
# One-off sync events (vMotion, snapshot restore) are left enabled — they are safe.
# Has no effect on non-VMware systems.
ntp_vmware_disable_periodic_sync: true
