---
- name: Verify
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/inventory/group_vars/all/vault.yml"

  tasks:

    # ---- Pre-condition: internet access ----

    - name: Check internet connectivity (NTP requires external access)
      ansible.builtin.include_role:
        name: common
        tasks_from: check_internet.yml
      vars:
        common_check_internet_host: "time.cloudflare.com"
        common_check_internet_port: 123

    # ---- chrony installed ----

    - name: Check chrony is installed
      ansible.builtin.command:
        cmd: command -v chronyd
      register: ntp_verify_chrony
      changed_when: false
      failed_when: ntp_verify_chrony.rc != 0

    # ---- service running ----

    - name: Check chronyd service is running (systemd)
      ansible.builtin.service_facts:
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Assert chronyd is active (systemd)
      ansible.builtin.assert:
        that:
          - "'chronyd.service' in ansible_facts.services"
          - "ansible_facts.services['chronyd.service'].state == 'running'"
        fail_msg: "chronyd is not running"
      when: ansible_facts['service_mgr'] == 'systemd'

    # ---- functional ----

    - name: Verify chrony is functional
      ansible.builtin.command:
        cmd: chronyc tracking
      register: ntp_verify_ntp_tracking
      changed_when: false
      failed_when: ntp_verify_ntp_tracking.rc != 0

    - name: Assert chrony daemon responds correctly
      ansible.builtin.assert:
        that:
          - "'Stratum' in ntp_verify_ntp_tracking.stdout"
          - "'System time' in ntp_verify_ntp_tracking.stdout"
        fail_msg: "chronyc tracking output invalid"

    - name: Verify chrony has NTP sources
      ansible.builtin.command:
        cmd: chronyc sources
      register: ntp_verify_ntp_sources
      changed_when: false
      failed_when: false

    - name: Assert chrony has at least one source
      ansible.builtin.assert:
        that:
          - ntp_verify_ntp_sources.stdout_lines | length > 2
        fail_msg: "chrony has no NTP sources configured"

    # ---- actual sync (requires internet) ----

    - name: Verify chrony has a synced source
      ansible.builtin.command:
        cmd: chronyc -n sources
      register: ntp_verify_ntp_synced
      changed_when: false
      failed_when: false

    - name: Assert at least one source is synced (^* marker)
      ansible.builtin.assert:
        that:
          - ntp_verify_ntp_synced.stdout_lines | select('match', '^\^\*') | list | length > 0
        fail_msg: >-
          No synchronized NTP source (no '^*' marker in chronyc -n sources).
          Chrony is running but not synced — internet connectivity may be missing.

    # ---- NTS authentication ----

    - name: Verify NTS sources are active
      ansible.builtin.command:
        cmd: chronyc ntssources
      register: ntp_verify_nts_sources
      changed_when: false
      failed_when: false

    - name: Assert at least one NTS source is present
      ansible.builtin.assert:
        that:
          - ntp_verify_nts_sources.stdout_lines | length > 1
        fail_msg: >-
          No NTS sources found (chronyc ntssources returned no entries).
          Check NTS server reachability and NTS handshake logs.

    # ---- config content ----

    - name: Verify chrony.conf is deployed by Ansible
      ansible.builtin.stat:
        path: /etc/chrony.conf
      register: ntp_verify_chrony_conf

    - name: Assert chrony.conf exists and is a regular file
      ansible.builtin.assert:
        that:
          - ntp_verify_chrony_conf.stat.exists
          - ntp_verify_chrony_conf.stat.isreg
        fail_msg: "/etc/chrony.conf is missing"

    - name: Read chrony.conf content
      ansible.builtin.slurp:
        src: /etc/chrony.conf
      register: ntp_verify_chrony_conf_content

    - name: Decode chrony.conf content
      ansible.builtin.set_fact:
        ntp_verify_chrony_conf_text: "{{ ntp_verify_chrony_conf_content.content | b64decode }}"

    - name: Assert NTS flag present in at least one server line
      ansible.builtin.assert:
        that:
          - "'nts' in ntp_verify_chrony_conf_text"
        fail_msg: "No NTS servers found in /etc/chrony.conf"

    - name: Assert minsources directive present
      ansible.builtin.assert:
        that:
          - "'minsources' in ntp_verify_chrony_conf_text"
        fail_msg: "minsources directive missing from /etc/chrony.conf"

    - name: Assert driftfile directive present
      ansible.builtin.assert:
        that:
          - "'driftfile' in ntp_verify_chrony_conf_text"
        fail_msg: "driftfile directive missing from /etc/chrony.conf"

    - name: Assert dumpdir directive present
      ansible.builtin.assert:
        that:
          - "'dumpdir' in ntp_verify_chrony_conf_text"
        fail_msg: "dumpdir directive missing from /etc/chrony.conf"

    - name: Assert ntsdumpdir directive present
      ansible.builtin.assert:
        that:
          - "'ntsdumpdir' in ntp_verify_chrony_conf_text"
        fail_msg: "ntsdumpdir directive missing from /etc/chrony.conf"

    - name: Assert log tracking directive present
      ansible.builtin.assert:
        that:
          - "'log measurements statistics tracking' in ntp_verify_chrony_conf_text"
        fail_msg: "log tracking directive missing from /etc/chrony.conf"

    # ---- directories ----

    - name: Check ntp_logdir exists
      ansible.builtin.stat:
        path: /var/log/chrony
      register: ntp_verify_logdir

    - name: Assert ntp_logdir exists with correct ownership
      ansible.builtin.assert:
        that:
          - ntp_verify_logdir.stat.exists
          - ntp_verify_logdir.stat.isdir
          - ntp_verify_logdir.stat.pw_name == 'chrony'
        fail_msg: "/var/log/chrony does not exist or is not owned by chrony"

    - name: Check ntp_ntsdumpdir exists
      ansible.builtin.stat:
        path: /var/lib/chrony/nts-data
      register: ntp_verify_ntsdumpdir

    - name: Assert ntp_ntsdumpdir exists with correct ownership
      ansible.builtin.assert:
        that:
          - ntp_verify_ntsdumpdir.stat.exists
          - ntp_verify_ntsdumpdir.stat.isdir
          - ntp_verify_ntsdumpdir.stat.pw_name == 'chrony'
        fail_msg: "/var/lib/chrony/nts-data does not exist or is not owned by chrony"

    # ---- environment detection ----

    - name: Assert environment comment present in chrony.conf
      ansible.builtin.assert:
        that:
          - "'# Environment:' in ntp_verify_chrony_conf_text"
        fail_msg: "chrony.conf missing environment detection comment — template not updated"

    # ---- competitor services ----

    - name: Assert systemd-timesyncd is stopped/disabled
      ansible.builtin.assert:
        that: >-
          ansible_facts.services['systemd-timesyncd.service'].state | default('') != 'running'
        fail_msg: "systemd-timesyncd is still running — should be disabled by ntp role"
      when:
        - ansible_facts['service_mgr'] == 'systemd'
        - "'systemd-timesyncd.service' in ansible_facts.services"

    # ---- KVM refclock (only on KVM guests) ----

    - name: Check ptp_kvm module loaded (KVM only)
      ansible.builtin.command:
        cmd: lsmod
      register: verify_lsmod
      changed_when: false
      when: ansible_facts['virtualization_type'] | default('') == 'kvm'

    - name: Assert ptp_kvm loaded on KVM
      ansible.builtin.assert:
        that:
          - "'ptp_kvm' in verify_lsmod.stdout"
        fail_msg: "ptp_kvm module not loaded on KVM guest"
      when: ansible_facts['virtualization_type'] | default('') == 'kvm'

    - name: Assert refclock present in chrony.conf on KVM
      ansible.builtin.assert:
        that:
          - "'refclock PHC' in ntp_verify_chrony_conf_text"
        fail_msg: "refclock PHC missing from chrony.conf on KVM guest"
      when: ansible_facts['virtualization_type'] | default('') == 'kvm'

    - name: Assert refclock present in chrony.conf on Hyper-V
      ansible.builtin.assert:
        that:
          - "'refclock PHC /dev/ptp_hyperv' in ntp_verify_chrony_conf_text"
        fail_msg: "refclock PHC /dev/ptp_hyperv missing from chrony.conf on Hyper-V guest"
      when: ansible_facts['virtualization_type'] | default('') == 'hyperv'

    - name: Show result
      ansible.builtin.debug:
        msg: "NTP check passed: chrony installed, running, synced, NTS active, env detection, directories correct"
