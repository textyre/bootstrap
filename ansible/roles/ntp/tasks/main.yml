---
# === NTP — синхронизация времени ===
# chrony как универсальный NTP-демон (все дистро, все init-системы)
# validate → Env detect → Конкуренты → Установка → Конфигурация → Директории → Запуск → Проверка → Логирование

- name: NTP role
  when: ntp_enabled | bool
  tags: ['ntp']
  block:

    # ======================================================================
    # ---- Валидация ----
    # ======================================================================

    - name: Validate NTP configuration
      ansible.builtin.include_tasks: validate.yml
      tags: ['ntp']

    # ======================================================================
    # ---- Определение среды ----
    # ======================================================================

    - name: Include environment variable mappings
      ansible.builtin.include_vars: environments.yml
      tags: ['ntp']

    - name: Detect virtualization environment
      ansible.builtin.include_tasks: detect_environment.yml
      when: ntp_auto_detect | bool
      tags: ['ntp']

    # Set defaults when auto-detect is disabled
    - name: Set default environment facts (auto-detect disabled)
      ansible.builtin.set_fact:
        _ntp_virt_type: "none"
        _ntp_env: "{{ _ntp_env_defaults }}"
        _ntp_active_refclocks: "{{ ntp_refclocks }}"
      when: not (ntp_auto_detect | bool)
      tags: ['ntp']

    # ======================================================================
    # ---- KVM: загрузка модуля ptp_kvm ----
    # ======================================================================

    - name: Load ptp_kvm module (KVM only)
      ansible.builtin.include_tasks: load_ptp_kvm.yml
      when: _ntp_virt_type == 'kvm'
      tags: ['ntp']

    # ======================================================================
    # ---- Отключение конфликтующих демонов ----
    # ======================================================================

    - name: Disable competing time sync daemons (init-specific)
      ansible.builtin.include_tasks: "{{ item }}"
      with_first_found:
        - files:
            - "disable_{{ ansible_facts['service_mgr'] }}.yml"
          skip: true
      tags: ['ntp']

    - name: Disable ntpd (all systems)
      ansible.builtin.include_tasks: disable_ntpd.yml
      when: ntp_disable_competitors | bool
      tags: ['ntp']

    - name: Disable openntpd (all systems)
      ansible.builtin.include_tasks: disable_openntpd.yml
      when: ntp_disable_competitors | bool
      tags: ['ntp']

    - name: Disable VMware periodic time sync
      ansible.builtin.include_tasks: vmware_disable_timesync.yml
      when:
        - _ntp_virt_type == 'vmware'
        - ntp_vmware_disable_periodic_sync | bool
      tags: ['ntp']

    # ======================================================================
    # ---- Установка ----
    # ======================================================================

    - name: Install NTP daemon (chrony)
      ansible.builtin.package:
        name: "{{ _ntp_package[ansible_facts['os_family']] | default('chrony') }}"
        state: present
      tags: ['ntp']

    # ======================================================================
    # ---- Директории ----
    # ======================================================================

    - name: Ensure chrony directories exist
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ _ntp_user[ansible_facts['os_family']] | default('chrony') }}"
        group: "{{ _ntp_user[ansible_facts['os_family']] | default('chrony') }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "{{ ntp_logdir }}", mode: "0755" }
        - { path: "{{ ntp_dumpdir }}", mode: "0750" }
        - { path: "{{ ntp_ntsdumpdir }}", mode: "0700" }
      tags: ['ntp']

    # ======================================================================
    # ---- Конфигурация ----
    # ======================================================================

    - name: Deploy chrony configuration
      ansible.builtin.template:
        src: chrony.conf.j2
        dest: /etc/chrony.conf
        owner: root
        group: root
        mode: "0644"
      notify: restart ntp
      tags: ['ntp']

    # ======================================================================
    # ---- Запуск chrony ----
    # ======================================================================

    - name: Enable and start chronyd
      ansible.builtin.service:
        name: "{{ _ntp_service[ansible_facts['service_mgr']] | default('chronyd') }}"
        enabled: true
        state: started
      tags: ['ntp', 'ntp:state']

    # ======================================================================
    # ---- Проверка ----
    # ======================================================================

    - name: Verify NTP
      ansible.builtin.include_tasks: verify.yml
      tags: ['ntp']

    # ======================================================================
    # ---- Логирование ----
    # ======================================================================

    - name: "Report: NTP"
      ansible.builtin.include_role:
        name: common
        tasks_from: report_phase.yml
      vars:
        common_rpt_fact: "_ntp_phases"
        common_rpt_phase: "Configure NTP"
        common_rpt_detail: >-
          chrony ({{ _ntp_service[ansible_facts['service_mgr']] | default('chronyd') }})
          env={{ _ntp_virt_type | default('unknown') }}
          refclocks={{ _ntp_active_refclocks | default([]) | length }}
      tags: ['ntp', 'report']

    - name: "ntp — Execution Report"
      ansible.builtin.include_role:
        name: common
        tasks_from: report_render.yml
      vars:
        common_rpt_fact: "_ntp_phases"
        common_rpt_title: "ntp"
      tags: ['ntp', 'report']
