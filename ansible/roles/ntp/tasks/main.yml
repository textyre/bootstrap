---
# === NTP — синхронизация времени ===
# chrony как универсальный NTP-демон (все дистро, все init-системы)
# validate → Установка → Конфигурация → Директории → Запуск → Проверка → Логирование

- name: NTP role
  when: ntp_enabled | bool
  tags: ['ntp']
  block:

    # ======================================================================
    # ---- Валидация ----
    # ======================================================================

    - name: Validate NTP configuration
      ansible.builtin.include_tasks: validate.yml
      tags: ['ntp']

    # ======================================================================
    # ---- Установка ----
    # ======================================================================

    - name: Install NTP daemon (chrony)
      ansible.builtin.package:
        name: "{{ _ntp_package[ansible_facts['os_family']] | default('chrony') }}"
        state: present
      tags: ['ntp']

    # ======================================================================
    # ---- Отключение конфликтующих демонов ----
    # ======================================================================

    - name: Disable conflicting time sync daemons
      ansible.builtin.include_tasks: "{{ item }}"
      with_first_found:
        - files:
            - "disable_{{ ansible_facts['service_mgr'] }}.yml"
          skip: true
      tags: ['ntp']

    # ======================================================================
    # ---- Директории ----
    # ======================================================================

    - name: Ensure chrony directories exist
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ _ntp_user[ansible_facts['os_family']] | default('chrony') }}"
        group: "{{ _ntp_user[ansible_facts['os_family']] | default('chrony') }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "{{ ntp_logdir }}",     mode: "0755" }
        - { path: "{{ ntp_dumpdir }}",    mode: "0750" }
        - { path: "{{ ntp_ntsdumpdir }}", mode: "0700" }
      tags: ['ntp']

    # ======================================================================
    # ---- Конфигурация ----
    # ======================================================================

    - name: Deploy chrony configuration
      ansible.builtin.template:
        src: chrony.conf.j2
        dest: /etc/chrony.conf
        owner: root
        group: root
        mode: "0644"
      notify: restart ntp
      tags: ['ntp']

    # ======================================================================
    # ---- Запуск chrony ----
    # ======================================================================

    - name: Enable and start chronyd
      ansible.builtin.service:
        name: "{{ _ntp_service[ansible_facts['service_mgr']] | default('chronyd') }}"
        enabled: true
        state: started
      tags: ['ntp', 'ntp:state']

    # ======================================================================
    # ---- Проверка ----
    # ======================================================================

    - name: Verify NTP
      ansible.builtin.include_tasks: verify.yml
      tags: ['ntp']

    # ======================================================================
    # ---- Логирование ----
    # ======================================================================

    - name: "Report: NTP"
      ansible.builtin.include_role:
        name: common
        tasks_from: report_phase.yml
      vars:
        _rpt_fact: "_ntp_phases"
        _rpt_phase: "Configure NTP"
        _rpt_detail: "chrony ({{ _ntp_service[ansible_facts['service_mgr']] | default('chronyd') }})"
      tags: ['ntp', 'report']

    - name: "ntp — Execution Report"
      ansible.builtin.include_role:
        name: common
        tasks_from: report_render.yml
      vars:
        _rpt_fact: "_ntp_phases"
        _rpt_title: "ntp"
      tags: ['ntp', 'report']
