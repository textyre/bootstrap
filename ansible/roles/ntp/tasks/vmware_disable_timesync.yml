---
# Disable VMware Tools periodic time synchronization.
# Periodic sync (every 60s) conflicts with chrony â€” disable it.
# One-off sync on vMotion/snapshot restore is left enabled (safe with chrony).
# Reference: https://knowledge.broadcom.com/external/article/310053

- name: "VMware: Check if vmware-toolbox-cmd is available"
  ansible.builtin.command:
    cmd: which vmware-toolbox-cmd
  register: ntp_vmware_toolbox_check
  changed_when: false
  failed_when: false
  tags: ['ntp']

- name: "VMware: Check current timesync status"
  ansible.builtin.command:
    cmd: vmware-toolbox-cmd timesync status
  register: ntp_vmware_timesync_status
  changed_when: false
  failed_when: false
  when: ntp_vmware_toolbox_check.rc == 0
  tags: ['ntp']

- name: "VMware: Disable periodic timesync"
  ansible.builtin.command:
    cmd: vmware-toolbox-cmd timesync disable
  when:
    - ntp_vmware_toolbox_check.rc == 0
    - ntp_vmware_timesync_status.stdout | default('') != 'Disabled'
  changed_when: true
  tags: ['ntp']
