---
# === NTP environment detection ===
# Reads ansible_facts['virtualization_type'] and sets:
#   _ntp_virt_type        — normalized virt type (hyperv/kvm/vmware/virtualbox/none)
#   _ntp_env              — merged config dict from _ntp_env_map
#   _ntp_active_refclocks — final list of refclock strings for chrony.conf

- name: "NTP env: Determine virtualization type"
  ansible.builtin.set_fact:
    _ntp_virt_type: >-
      {{ ansible_facts['virtualization_type'] | default('none')
         if (ansible_facts['virtualization_role'] | default('') == 'guest')
         else 'none' }}
  tags: ['ntp']

- name: "NTP env: Load environment config"
  ansible.builtin.set_fact:
    _ntp_env: >-
      {{ _ntp_env_defaults | combine(_ntp_env_map[_ntp_virt_type] | default({})) }}
  tags: ['ntp']

# VMware: check if /dev/ptp0 actually exists before adding refclock.
# ptp_vmw requires vSphere 7.0 U2+ and Precision Clock device added to VM.
- name: "NTP env: Check VMware PTP device presence"
  ansible.builtin.stat:
    path: /dev/ptp0
  register: _ntp_vmware_ptp_stat
  when: _ntp_virt_type == 'vmware'
  tags: ['ntp']

- name: "NTP env: Set VMware refclock if PTP device present"
  ansible.builtin.set_fact:
    _ntp_env: >-
      {{ _ntp_env | combine({
           'refclocks': ['refclock PHC /dev/ptp0 poll 0 delay 0.0004 stratum 1']
         }) }}
  when:
    - _ntp_virt_type == 'vmware'
    - _ntp_vmware_ptp_stat.stat.exists | default(false)
  tags: ['ntp']

# Final refclock list: user-supplied ntp_refclocks takes priority over auto-detected.
- name: "NTP env: Resolve final refclock list"
  ansible.builtin.set_fact:
    _ntp_active_refclocks: >-
      {{ ntp_refclocks if (ntp_refclocks | length > 0)
         else _ntp_env.refclocks | default([]) }}
  tags: ['ntp']

- name: "NTP env: Report detected environment"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_phase.yml
  vars:
    _rpt_fact: "_ntp_phases"
    _rpt_phase: "Detect environment"
    _rpt_detail: >-
      virt={{ _ntp_virt_type }}
      refclocks={{ _ntp_active_refclocks | length }}
      rtcsync={{ _ntp_env.rtcsync }}
  tags: ['ntp']
