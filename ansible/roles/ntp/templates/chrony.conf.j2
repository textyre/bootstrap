# Managed by Ansible — do not edit manually
# Role: ntp | Template: chrony.conf.j2
# Environment: {{ _ntp_virt_type | default('unknown') }}

{% for server in ntp_servers %}
server {{ server.host }}{% if server.iburst | default(true) %} iburst{% endif %}{% if server.nts | default(false) %} nts{% endif %}

{% endfor %}
{% for pool in ntp_pools %}
pool {{ pool.host }}{% if pool.iburst | default(true) %} iburst{% endif %}{% if pool.maxsources is defined %} maxsources {{ pool.maxsources }}{% endif %}

{% endfor %}
{% if _ntp_active_refclocks | default([]) | length > 0 %}
# PTP hardware clock reference ({{ _ntp_virt_type | default('auto') }})
{% for refclock in _ntp_active_refclocks %}
{{ refclock }}
{% endfor %}

{% endif %}
# Clock stability
driftfile {{ ntp_driftfile }}
{% if ntp_dumpdir %}
dumpdir {{ ntp_dumpdir }}
{% endif %}
{% if ntp_ntsdumpdir %}
ntsdumpdir {{ ntp_ntsdumpdir }}
{% endif %}
makestep {{ (_ntp_env | default({})).makestep_threshold | default(ntp_makestep_threshold) }} {{ (_ntp_env | default({})).makestep_limit | default(ntp_makestep_limit) }}
minsources {{ ntp_minsources }}

{% if (_ntp_env | default({})).rtcsync | default(ntp_rtcsync) %}
# Sync hardware RTC to system clock
rtcsync
{% endif %}

# Leap seconds from system timezone database
leapsectz right/UTC

# Logging
logdir {{ ntp_logdir }}
logchange {{ ntp_logchange }}
{% if ntp_log_tracking %}
log measurements statistics tracking
{% endif %}
{% if ntp_allow | length > 0 %}
# NTP server mode — allow these networks to query this host
{% for cidr in ntp_allow %}
allow {{ cidr }}
{% endfor %}
{% endif %}
