#!/usr/sbin/nft -f
# {{ ansible_managed }}
# Базовый firewall для рабочей станции

flush ruleset

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Разрешить loopback
        iifname "lo" accept

        # Отбросить пакеты с невалидным состоянием
        ct state invalid drop

        # Разрешить установленные соединения
        ct state established,related accept

        # Разрешить ICMP с rate limiting (защита от flood)
        ip protocol icmp limit rate 10/second accept
        ip6 nexthdr icmpv6 limit rate 10/second accept

{% if firewall_allow_ssh %}
        # SSH с rate limiting (защита от brute-force)
        tcp dport 22 ct state new limit rate 4/minute accept
        tcp dport 22 ct state new log prefix "[nftables] ssh-rate: " drop
{% endif %}
{% for port in firewall_allow_tcp_ports %}
        tcp dport {{ port }} accept
{% endfor %}
{% for port in firewall_allow_udp_ports %}
        udp dport {{ port }} accept
{% endfor %}

        # Логировать и отбросить остальное
        log prefix "[nftables] drop: " counter drop
    }

    chain forward {
        type filter hook forward priority 0; policy drop;

        # Docker bridge forwarding
        ct state established,related accept
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }
}
