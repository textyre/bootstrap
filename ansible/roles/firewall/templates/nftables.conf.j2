#!/usr/sbin/nft -f
# {{ ansible_managed }}
# Базовый firewall для рабочей станции

flush ruleset

table inet filter {
{% if firewall_allow_ssh and firewall_ssh_rate_limit_enabled %}
    set ssh_ratelimit {
        type ipv4_addr
        flags dynamic,timeout
        timeout 1m
    }
{% endif %}

    chain input {
        type filter hook input priority 0; policy drop;

        # Разрешить loopback
        iifname "lo" accept

        # Отбросить пакеты с невалидным состоянием
        ct state invalid drop

        # Разрешить установленные соединения
        ct state established,related accept

        # Разрешить ICMP с rate limiting (защита от flood)
        ip protocol icmp limit rate 10/second accept
        ip6 nexthdr icmpv6 limit rate 10/second accept

{% if firewall_allow_ssh %}
{% if firewall_ssh_rate_limit_enabled %}
        # SSH с per-source-IP rate limiting (защита от brute-force)
        tcp dport 22 ct state new add @ssh_ratelimit { ip saddr limit rate over {{ firewall_ssh_rate_limit }} burst {{ firewall_ssh_rate_limit_burst }} packets } log prefix "[nftables] ssh-rate: " drop
{% endif %}
        # SSH — разрешить
        tcp dport 22 ct state new accept
{% endif %}
{% for port in firewall_allow_tcp_ports %}
        tcp dport {{ port }} accept
{% endfor %}
{% for port in firewall_allow_udp_ports %}
        udp dport {{ port }} accept
{% endfor %}

        # Логировать и отбросить остальное
        log prefix "[nftables] drop: " counter drop
    }

    chain forward {
        type filter hook forward priority 0; policy drop;

        # Docker bridge forwarding
        ct state established,related accept
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }
}
