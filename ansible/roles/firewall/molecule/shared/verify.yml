---
- name: Verify firewall role
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - ../../defaults/main.yml
  vars:
    firewall_expected_tcp_ports: [8080, 9090]
    firewall_expected_udp_ports: [53]

  tasks:

    # ---- Environment detection ----

    - name: Detect container environment
      ansible.builtin.set_fact:
        _firewall_verify_in_docker: "{{ ansible_virtualization_type | default('') == 'docker' }}"

    # ---- Package installed ----

    - name: Gather package facts
      ansible.builtin.package_facts:
        manager: auto

    - name: Assert nftables package is installed
      ansible.builtin.assert:
        that: "'nftables' in ansible_facts.packages"
        fail_msg: "nftables package not found"

    # ---- Configuration file ----

    - name: Stat /etc/nftables.conf
      ansible.builtin.stat:
        path: /etc/nftables.conf
      register: _firewall_verify_conf

    - name: Assert nftables.conf exists with correct owner and mode
      ansible.builtin.assert:
        that:
          - _firewall_verify_conf.stat.exists
          - _firewall_verify_conf.stat.isreg
          - _firewall_verify_conf.stat.pw_name == 'root'
          - _firewall_verify_conf.stat.gr_name == 'root'
          - _firewall_verify_conf.stat.mode == '0644'
        fail_msg: "/etc/nftables.conf missing or wrong permissions (expected root:root 0644)"

    - name: Read nftables.conf content
      ansible.builtin.slurp:
        src: /etc/nftables.conf
      register: _firewall_verify_conf_raw

    - name: Set nftables.conf text fact
      ansible.builtin.set_fact:
        _firewall_verify_conf_text: "{{ _firewall_verify_conf_raw.content | b64decode }}"

    # ---- Core structure assertions ----

    - name: Assert config contains inet filter table
      ansible.builtin.assert:
        that: "'table inet filter' in _firewall_verify_conf_text"
        fail_msg: "'table inet filter' not found in /etc/nftables.conf"

    - name: Assert input chain has drop policy
      ansible.builtin.assert:
        that: "'policy drop' in _firewall_verify_conf_text"
        fail_msg: "Input chain default policy is not 'drop'"

    - name: Assert loopback is accepted
      ansible.builtin.assert:
        that: "'iifname \"lo\" accept' in _firewall_verify_conf_text"
        fail_msg: "Loopback accept rule missing"

    - name: Assert established/related connections accepted
      ansible.builtin.assert:
        that: "'ct state established,related accept' in _firewall_verify_conf_text"
        fail_msg: "Established/related accept rule missing"

    - name: Assert invalid packets dropped
      ansible.builtin.assert:
        that: "'ct state invalid drop' in _firewall_verify_conf_text"
        fail_msg: "Invalid state drop rule missing"

    - name: Assert ICMP rate limiting present (IPv4)
      ansible.builtin.assert:
        that: "'ip protocol icmp limit rate' in _firewall_verify_conf_text"
        fail_msg: "ICMP rate limit rule missing for IPv4"

    - name: Assert ICMP rate limiting present (IPv6)
      ansible.builtin.assert:
        that: "'ip6 nexthdr icmpv6 limit rate' in _firewall_verify_conf_text"
        fail_msg: "ICMP rate limit rule missing for IPv6"

    # ---- SSH rules ----

    - name: Assert SSH accept rule present
      ansible.builtin.assert:
        that: "'tcp dport 22 ct state new accept' in _firewall_verify_conf_text"
        fail_msg: "SSH accept rule missing from nftables.conf"
      when: firewall_allow_ssh

    - name: Assert SSH accept rule NOT present when disabled
      ansible.builtin.assert:
        that: "'tcp dport 22' not in _firewall_verify_conf_text"
        fail_msg: "SSH rule found in config but firewall_allow_ssh is false"
      when: not firewall_allow_ssh

    # ---- CRIT-01: per-source-IP rate limiting — IPv4 ----

    - name: Assert ssh_ratelimit IPv4 dynamic set defined
      ansible.builtin.assert:
        that:
          - "'set ssh_ratelimit' in _firewall_verify_conf_text"
          - "'type ipv4_addr' in _firewall_verify_conf_text"
          - "'flags dynamic' in _firewall_verify_conf_text"
        fail_msg: >-
          CRIT-01: ssh_ratelimit dynamic set (IPv4) not found in config.
          Per-source-IP rate limiting requires a named set with type ipv4_addr and flags dynamic.
      when: firewall_allow_ssh and firewall_ssh_rate_limit_enabled

    - name: Assert SSH rate limit rule uses per-source-IP pattern — IPv4
      ansible.builtin.assert:
        that: "'add @ssh_ratelimit { ip saddr limit rate over' in _firewall_verify_conf_text"
        fail_msg: >-
          CRIT-01: SSH IPv4 rate limit rule does not use per-source-IP pattern.
          Expected 'add @ssh_ratelimit { ip saddr limit rate over ...' but not found.
      when: firewall_allow_ssh and firewall_ssh_rate_limit_enabled

    # ---- CRIT-01: per-source-IP rate limiting — IPv6 ----

    - name: Assert ssh6_ratelimit IPv6 dynamic set defined
      ansible.builtin.assert:
        that:
          - "'set ssh6_ratelimit' in _firewall_verify_conf_text"
          - "'type ipv6_addr' in _firewall_verify_conf_text"
        fail_msg: >-
          CRIT-01: ssh6_ratelimit dynamic set (IPv6) not found in config.
          IPv6 SSH brute-force protection requires a separate set with type ipv6_addr.
      when: firewall_allow_ssh and firewall_ssh_rate_limit_enabled

    - name: Assert SSH rate limit rule uses per-source-IP pattern — IPv6
      ansible.builtin.assert:
        that: "'add @ssh6_ratelimit { ip6 saddr limit rate over' in _firewall_verify_conf_text"
        fail_msg: >-
          CRIT-01: SSH IPv6 rate limit rule does not use per-source-IP pattern.
          Expected 'add @ssh6_ratelimit { ip6 saddr limit rate over ...' but not found.
      when: firewall_allow_ssh and firewall_ssh_rate_limit_enabled

    - name: Assert SSH rate limit values match configuration
      ansible.builtin.assert:
        that:
          - "firewall_ssh_rate_limit in _firewall_verify_conf_text"
          - "('burst ' ~ firewall_ssh_rate_limit_burst | string ~ ' packets') in _firewall_verify_conf_text"
        fail_msg: >-
          SSH rate limit values not found in config.
          Expected rate '{{ firewall_ssh_rate_limit }}' and burst '{{ firewall_ssh_rate_limit_burst }}'.
      when: firewall_allow_ssh and firewall_ssh_rate_limit_enabled

    - name: Assert ssh_ratelimit sets NOT present when rate limiting disabled
      ansible.builtin.assert:
        that:
          - "'set ssh_ratelimit' not in _firewall_verify_conf_text"
          - "'set ssh6_ratelimit' not in _firewall_verify_conf_text"
        fail_msg: "ssh_ratelimit sets found in config but firewall_ssh_rate_limit_enabled is false"
      when: not firewall_ssh_rate_limit_enabled

    # ---- Custom TCP/UDP ports ----

    - name: Assert custom TCP ports are present in config
      ansible.builtin.assert:
        that: "('tcp dport ' ~ item ~ ' accept') in _firewall_verify_conf_text"
        fail_msg: "TCP port {{ item }} not found in nftables.conf (expected from firewall_allow_tcp_ports)"
      loop: "{{ firewall_expected_tcp_ports }}"
      when: firewall_expected_tcp_ports | length > 0

    - name: Assert custom UDP ports are present in config
      ansible.builtin.assert:
        that: "('udp dport ' ~ item ~ ' accept') in _firewall_verify_conf_text"
        fail_msg: "UDP port {{ item }} not found in nftables.conf (expected from firewall_allow_udp_ports)"
      loop: "{{ firewall_expected_udp_ports }}"
      when: firewall_expected_udp_ports | length > 0

    # ---- Forward chain ----

    - name: Assert forward chain exists
      ansible.builtin.assert:
        that: "'chain forward' in _firewall_verify_conf_text"
        fail_msg: "Forward chain missing from nftables.conf"

    - name: Assert Docker forward rules present when docker enabled
      ansible.builtin.assert:
        that: "'iifname \"docker0\"' in _firewall_verify_conf_text"
        fail_msg: "Docker forward rule missing but firewall_docker_enabled is true"
      when: firewall_docker_enabled | default(false)

    - name: Assert Docker forward rules NOT present when docker disabled
      ansible.builtin.assert:
        that: "'iifname \"docker0\"' not in _firewall_verify_conf_text"
        fail_msg: "Docker forward rule found but firewall_docker_enabled is false"
      when: not (firewall_docker_enabled | default(false))

    # ---- Output chain ----

    - name: Assert output chain exists
      ansible.builtin.assert:
        that: "'chain output' in _firewall_verify_conf_text"
        fail_msg: "Output chain missing from nftables.conf"

    # ---- Catch-all log + drop ----

    - name: Assert catch-all log and drop rule present
      ansible.builtin.assert:
        that: "'log prefix' in _firewall_verify_conf_text"
        fail_msg: "Catch-all log+drop rule missing"

    # ---- Ansible managed marker ----

    - name: Assert Ansible managed marker present
      ansible.builtin.assert:
        that: "'Ansible' in _firewall_verify_conf_text"
        fail_msg: "Ansible managed marker not found -- config may not be template-generated"

    # ---- Service enabled state ----

    - name: Check nftables service is enabled
      ansible.builtin.command: systemctl is-enabled nftables.service
      register: _firewall_verify_svc_enabled
      changed_when: false
      failed_when: false

    - name: Assert nftables service is enabled
      ansible.builtin.assert:
        that: "'enabled' in _firewall_verify_svc_enabled.stdout"
        fail_msg: >-
          nftables.service is not enabled (got '{{ _firewall_verify_svc_enabled.stdout }}').
      when: firewall_enable_service | bool

    # ---- Service active state (skip in Docker -- nftables needs kernel nf_tables) ----

    - name: Check nftables service is active
      ansible.builtin.command: systemctl is-active nftables.service
      register: _firewall_verify_svc_active
      changed_when: false
      failed_when: false
      when: not _firewall_verify_in_docker

    - name: Assert nftables service is active
      ansible.builtin.assert:
        that: _firewall_verify_svc_active.stdout | trim == 'active'
        fail_msg: >-
          nftables.service is not active (got '{{ _firewall_verify_svc_active.stdout | trim }}').
      when:
        - not _firewall_verify_in_docker
        - firewall_enable_service | bool
        - firewall_start_service | default(true) | bool

    # ---- Runtime rules loaded ----

    - name: List loaded nftables tables
      ansible.builtin.command: nft list tables
      register: _firewall_verify_nft_tables
      changed_when: false
      failed_when: false
      when: not _firewall_verify_in_docker

    - name: Assert inet filter table loaded in runtime
      ansible.builtin.assert:
        that: "'inet filter' in _firewall_verify_nft_tables.stdout"
        fail_msg: >-
          inet filter table not loaded in nftables runtime.
          nft list tables returned: {{ _firewall_verify_nft_tables.stdout }}
          stderr: {{ _firewall_verify_nft_tables.stderr | default('') }}
      when:
        - not _firewall_verify_in_docker
        - _firewall_verify_nft_tables.rc == 0

    - name: Warn if nft command failed
      ansible.builtin.debug:
        msg: >-
          WARNING: 'nft list tables' failed (rc={{ _firewall_verify_nft_tables.rc }}).
          Runtime rule verification skipped.
      when:
        - not _firewall_verify_in_docker
        - _firewall_verify_nft_tables.rc != 0

    # ---- Runtime: CRIT-01 dynamic sets ----

    - name: List ssh_ratelimit IPv4 set in runtime
      ansible.builtin.command: nft list set inet filter ssh_ratelimit
      register: _firewall_verify_nft_set_v4
      changed_when: false
      failed_when: false
      when:
        - not _firewall_verify_in_docker
        - firewall_allow_ssh
        - firewall_ssh_rate_limit_enabled
        - _firewall_verify_nft_tables is not skipped
        - _firewall_verify_nft_tables.rc == 0

    - name: Assert ssh_ratelimit IPv4 set exists in runtime
      ansible.builtin.assert:
        that:
          - _firewall_verify_nft_set_v4.rc == 0
          - "'ssh_ratelimit' in _firewall_verify_nft_set_v4.stdout"
        fail_msg: >-
          CRIT-01 runtime: ssh_ratelimit (IPv4) set not loaded.
          nft returned: {{ _firewall_verify_nft_set_v4.stderr | default('') }}
      when:
        - not _firewall_verify_in_docker
        - firewall_allow_ssh
        - firewall_ssh_rate_limit_enabled
        - _firewall_verify_nft_tables is not skipped
        - _firewall_verify_nft_tables.rc == 0

    - name: List ssh6_ratelimit IPv6 set in runtime
      ansible.builtin.command: nft list set inet filter ssh6_ratelimit
      register: _firewall_verify_nft_set_v6
      changed_when: false
      failed_when: false
      when:
        - not _firewall_verify_in_docker
        - firewall_allow_ssh
        - firewall_ssh_rate_limit_enabled
        - _firewall_verify_nft_tables is not skipped
        - _firewall_verify_nft_tables.rc == 0

    - name: Assert ssh6_ratelimit IPv6 set exists in runtime
      ansible.builtin.assert:
        that:
          - _firewall_verify_nft_set_v6.rc == 0
          - "'ssh6_ratelimit' in _firewall_verify_nft_set_v6.stdout"
        fail_msg: >-
          CRIT-01 runtime: ssh6_ratelimit (IPv6) set not loaded.
          nft returned: {{ _firewall_verify_nft_set_v6.stderr | default('') }}
      when:
        - not _firewall_verify_in_docker
        - firewall_allow_ssh
        - firewall_ssh_rate_limit_enabled
        - _firewall_verify_nft_tables is not skipped
        - _firewall_verify_nft_tables.rc == 0

    # ---- Diagnostic: dump full ruleset ----

    - name: Diagnostic -- full nftables ruleset
      ansible.builtin.command: nft list ruleset
      register: _firewall_verify_ruleset_diag
      changed_when: false
      failed_when: false
      when: not _firewall_verify_in_docker

    - name: Show nftables ruleset (diagnostic)
      ansible.builtin.debug:
        var: _firewall_verify_ruleset_diag.stdout_lines
      when:
        - not _firewall_verify_in_docker
        - _firewall_verify_ruleset_diag.rc == 0

    # ---- Docker info ----

    - name: Show Docker-specific skip notice
      ansible.builtin.debug:
        msg: >-
          Running in Docker container -- service active check, runtime nft rule
          verification, and ruleset dump were skipped (no kernel nf_tables module).
          Config file deployment and service enabled state were verified.
      when: _firewall_verify_in_docker

    # ---- Summary ----

    - name: Show verify result
      ansible.builtin.debug:
        msg: >-
          Firewall verify passed: nftables installed, /etc/nftables.conf deployed
          (root:root 0644), inet filter table with drop policy, lo/established/invalid
          rules OK, ICMP rate limiting OK, SSH per-source-IP rate limiting IPv4+IPv6
          (CRIT-01 validated{{ ' in config' if _firewall_verify_in_docker else ' in config + runtime' }}),
          custom TCP ports={{ firewall_expected_tcp_ports }},
          custom UDP ports={{ firewall_expected_udp_ports }},
          service enabled{{ ' (active check skipped in Docker)' if _firewall_verify_in_docker else ' and active' }}.
