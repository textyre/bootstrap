---
- name: Verify
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/inventory/group_vars/all/vault.yml"

  tasks:
    - name: Check nftables is installed
      ansible.builtin.package:
        name: nftables
        state: present
      check_mode: true
      register: firewall_verify_nftables
      failed_when: firewall_verify_nftables is changed

    - name: Check /etc/nftables.conf exists
      ansible.builtin.stat:
        path: /etc/nftables.conf
      register: firewall_verify_nftables_conf
      failed_when: not firewall_verify_nftables_conf.stat.exists

    - name: Check nftables config contains filter table
      ansible.builtin.command: grep 'table inet filter' /etc/nftables.conf
      register: firewall_verify_nftables_table
      changed_when: false
      failed_when: firewall_verify_nftables_table.rc != 0

    - name: Check nftables service is enabled
      ansible.builtin.service:
        name: nftables
        enabled: true
      check_mode: true
      register: firewall_verify_service
      failed_when: firewall_verify_service is changed

    - name: Check nftables rules are loaded
      ansible.builtin.command: nft list tables
      register: firewall_verify_rules
      changed_when: false
      failed_when: "'inet filter' not in firewall_verify_rules.stdout"

    - name: Show test results
      ansible.builtin.debug:
        msg:
          - "All checks passed!"
          - "nftables installed"
          - "Configuration deployed with filter table"
          - "nftables service enabled, rules loaded"
