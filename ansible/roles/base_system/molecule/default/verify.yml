---
# Molecule verify playbook for base_system role
# Проверяет: таймзона, локаль, hostname, keymap, NTP (chrony)

- name: Verify
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/inventory/group_vars/all/vault.yml"

  tasks:
    - name: Check timezone is set
      ansible.builtin.command: timedatectl show --property=Timezone --value
      register: _verify_timezone
      changed_when: false
      failed_when: _verify_timezone.stdout | length == 0

    - name: Check locale.conf exists and valid
      ansible.builtin.slurp:
        src: /etc/locale.conf
      register: _verify_locale
      failed_when: "'LANG=' not in (_verify_locale.content | b64decode)"

    - name: Check hostname is set
      ansible.builtin.slurp:
        src: /etc/hostname
      register: _verify_hostname
      failed_when: (_verify_hostname.content | b64decode | trim) | length == 0

    - name: Check /etc/hosts contains hostname entry
      ansible.builtin.command: grep '127.0.1.1' /etc/hosts
      register: _verify_hosts
      changed_when: false
      failed_when: _verify_hosts.rc != 0

    - name: Check vconsole.conf exists (systemd keymap)
      ansible.builtin.slurp:
        src: /etc/vconsole.conf
      register: _verify_keymap
      failed_when: "'KEYMAP=' not in (_verify_keymap.content | b64decode)"
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Check chrony is installed
      ansible.builtin.command: which chronyd
      register: _verify_chrony
      changed_when: false
      failed_when: _verify_chrony.rc != 0

    - name: Check chronyd service is running
      ansible.builtin.service_facts:

    - name: Verify chronyd is active
      ansible.builtin.assert:
        that:
          - "'chronyd.service' in ansible_facts.services"
          - "ansible_facts.services['chronyd.service'].state == 'running'"
        fail_msg: "chronyd is not running"
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Show test results
      ansible.builtin.debug:
        msg:
          - "All base_system checks passed!"
          - "Timezone: {{ _verify_timezone.stdout }}"
          - "Hostname: {{ _verify_hostname.content | b64decode | trim }}"
          - "Locale: valid"
          - "Keymap: valid"
          - "NTP (chrony): installed and running"
