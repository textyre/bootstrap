---
# === Locale для musl-систем ===
# Alpine Linux (musl libc — нет locale.gen)
# Действие → Проверка → Логирование

- name: Install musl-locales (Alpine)
  ansible.builtin.package:
    name: musl-locales
    state: present
  tags: ['system', 'locale']

- name: Set locale via profile.d (Alpine)
  ansible.builtin.template:
    src: locale-alpine.sh.j2
    dest: /etc/profile.d/10-locale.sh
    owner: root
    group: root
    mode: '0755'
  tags: ['system', 'locale']

# ---- Проверка ----

- name: Verify musl-locales package installed (Alpine)
  ansible.builtin.command: apk info -e musl-locales
  register: _base_system_musl_check
  changed_when: false
  failed_when: _base_system_musl_check.rc != 0
  tags: ['system', 'locale']

- name: Verify profile.d locale script exists (Alpine)
  ansible.builtin.stat:
    path: /etc/profile.d/10-locale.sh
  register: _base_system_profiled_check
  tags: ['system', 'locale']

- name: Assert locale profile.d script is valid (Alpine)
  ansible.builtin.assert:
    that:
      - _base_system_profiled_check.stat.exists
      - _base_system_profiled_check.stat.mode == '0755'
    fail_msg: "/etc/profile.d/10-locale.sh missing or wrong permissions"
    quiet: true
  tags: ['system', 'locale']
