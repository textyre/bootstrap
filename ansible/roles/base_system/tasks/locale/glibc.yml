---
# === Locale для glibc-систем ===
# Arch Linux, Debian, Ubuntu, Fedora, Void (glibc)
# Действие → Проверка → Логирование

# ---- Генерация локалей ----

# Arch / Debian / Ubuntu: community.general.locale_gen
- name: Generate locales (Arch/Debian)
  community.general.locale_gen:
    name: "{{ item }}"
    state: present
  loop: "{{ base_system_locales }}"
  when: ansible_facts['os_family'] in ['Archlinux', 'Debian']
  tags: ['system', 'locale']

# Void Linux: /etc/default/libc-locales + xbps-reconfigure
- name: Enable locales in libc-locales (Void)
  ansible.builtin.lineinfile:
    path: /etc/default/libc-locales
    regexp: '^#?\s*{{ item }}'
    line: "{{ item }} UTF-8"
    state: present
  loop: "{{ base_system_locales }}"
  when: ansible_facts['distribution'] == 'Void'
  notify: Reconfigure glibc-locales (Void)
  tags: ['system', 'locale']

# ---- Установка системной локали ----

# /etc/locale.conf для всех glibc-систем (template поддерживает LC_* overrides)
- name: Set default locale (locale.conf)
  ansible.builtin.template:
    src: locale.conf.j2
    dest: /etc/locale.conf
    owner: root
    group: root
    mode: '0644'
  tags: ['system', 'locale']

# ---- Проверка ----

- name: Verify generated locales
  ansible.builtin.command: locale -a
  register: _base_system_locale_check
  changed_when: false
  tags: ['system', 'locale']

- name: Assert all requested locales are available
  ansible.builtin.assert:
    that:
      - _locale_normalized in _available_normalized
    fail_msg: "Locale {{ item }} was not generated (available: {{ _base_system_locale_check.stdout_lines | length }} locales)"
    quiet: true
  vars:
    _locale_normalized: "{{ item | lower | regex_replace('[\\-\\.]', '') }}"
    _available_normalized: "{{ _base_system_locale_check.stdout | lower | regex_replace('[\\-\\.]', '') }}"
  loop: "{{ base_system_locales }}"
  tags: ['system', 'locale']
