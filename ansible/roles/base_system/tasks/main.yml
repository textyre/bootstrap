---
# === Базовая настройка системы ===
# Кроссплатформенные задачи: локаль, таймзона, hostname
# OS-специфичные задачи: tasks/<os_family>.yml

# ---- Таймзона ----

- name: Set timezone
  community.general.timezone:
    name: "{{ base_system_timezone }}"
  tags: ['system', 'timezone']

# ---- Локаль ----

- name: Uncomment locale in locale.gen
  ansible.builtin.lineinfile:
    path: /etc/locale.gen
    regexp: '^#?\s*{{ base_system_locale }}'
    line: "{{ base_system_locale }} UTF-8"
    state: present
  notify: Generate locale
  tags: ['system', 'locale']

- name: Set default locale
  ansible.builtin.copy:
    dest: /etc/locale.conf
    content: "LANG={{ base_system_locale }}\n"
    owner: root
    group: root
    mode: '0644'
  tags: ['system', 'locale']

# ---- Hostname ----

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ base_system_hostname }}"
  tags: ['system', 'hostname']

- name: Ensure /etc/hosts contains hostname
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "127.0.1.1\t{{ base_system_hostname }}"
    state: present
  tags: ['system', 'hostname']

# ---- OS-специфичная конфигурация ----

- name: Include OS-specific configuration
  ansible.builtin.include_tasks: "{{ ansible_os_family | lower }}.yml"
  when: ansible_os_family in _base_system_supported_os
  tags: ['system']

# ---- Отчёт ----

- name: Report base system configuration
  ansible.builtin.debug:
    msg:
      - "OS: {{ ansible_os_family }}"
      - "Таймзона: {{ base_system_timezone }}"
      - "Локаль: {{ base_system_locale }}"
      - "Hostname: {{ base_system_hostname }}"
  tags: ['system']
