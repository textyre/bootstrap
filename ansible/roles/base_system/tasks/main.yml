---
# === Базовая настройка системы ===
# Идентичность машины: таймзона, локаль, hostname, keymap, NTP
# Дистро-агностик, инит-агностик

# ---- Таймзона ----

- name: Install tzdata (Alpine)
  ansible.builtin.package:
    name: tzdata
    state: present
  when: ansible_facts['os_family'] == 'Alpine'
  tags: ['system', 'timezone']

- name: Set timezone
  community.general.timezone:
    name: "{{ base_system_timezone }}"
  tags: ['system', 'timezone']

# ---- Локаль ----

- name: Configure locale
  ansible.builtin.include_tasks: "locale/{{ 'musl' if ansible_facts['os_family'] == 'Alpine' else 'glibc' }}.yml"
  tags: ['system', 'locale']

# ---- Hostname ----

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ base_system_hostname }}"
    use: "{{ _base_system_hostname_strategy[ansible_facts['os_family']] | default('systemd') }}"
  tags: ['system', 'hostname']

- name: Ensure /etc/hosts contains hostname
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "127.0.1.1\t{{ base_system_hostname }}"
    state: present
  tags: ['system', 'hostname']

# ---- Console keymap ----

- name: Configure console keymap
  ansible.builtin.include_tasks: keymap/main.yml
  tags: ['system', 'keymap']

# ---- NTP ----

- name: Configure NTP
  ansible.builtin.include_tasks: ntp.yml
  when: base_system_ntp_enabled
  tags: ['system', 'ntp']

# ---- Отчёт ----

- name: Report base system configuration
  ansible.builtin.debug:
    msg:
      - "OS: {{ ansible_facts['os_family'] }} ({{ ansible_facts['distribution'] | default('unknown') }})"
      - "Init: {{ ansible_facts['service_mgr'] | default('unknown') }}"
      - "Timezone: {{ base_system_timezone }}"
      - "Locale: {{ base_system_locale }}"
      - "Hostname: {{ base_system_hostname }}"
      - "Keymap: {{ base_system_keymap }}"
      - "NTP: {{ base_system_ntp_daemon if base_system_ntp_enabled else 'disabled' }}"
  tags: ['system']
