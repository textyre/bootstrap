---
# === NTP — синхронизация времени ===
# chrony как универсальный NTP-демон (все дистро, все init-системы)
# Действие → Проверка → Логирование

# ---- Установка ----

- name: Install NTP daemon (chrony)
  ansible.builtin.package:
    name: "{{ _base_system_ntp_package[ansible_facts['os_family']] | default('chrony') }}"
    state: present
  tags: ['system', 'ntp']

# ---- Отключение systemd-timesyncd (заменяется chrony) ----

- name: Disable systemd-timesyncd (replaced by chrony)
  ansible.builtin.service:
    name: systemd-timesyncd
    enabled: false
    state: stopped
  when: ansible_facts['service_mgr'] == 'systemd'
  register: _base_system_timesyncd
  failed_when:
    - _base_system_timesyncd is failed
    - "'could not be found' not in (_base_system_timesyncd.msg | default(''))"
  tags: ['system', 'ntp']

# ---- Запуск chrony ----

- name: Enable and start chronyd
  ansible.builtin.service:
    name: "{{ _base_system_ntp_service[ansible_facts['service_mgr']] | default('chronyd') }}"
    enabled: true
    state: started
  tags: ['system', 'ntp']

# ---- Проверка ----

- name: Verify chronyd is running
  ansible.builtin.command: chronyc tracking
  register: _base_system_ntp_check
  changed_when: false
  failed_when: _base_system_ntp_check.rc != 0
  tags: ['system', 'ntp']

- name: Assert NTP synchronization is active
  ansible.builtin.assert:
    that:
      - "'Reference ID' in _base_system_ntp_check.stdout"
    fail_msg: "chronyc tracking failed — NTP not synchronizing"
    quiet: true
  tags: ['system', 'ntp']

# ---- Логирование ----

- name: "Report: NTP"
  ansible.builtin.include_tasks: _report_phase.yml
  vars:
    _rpt_phase: "Configure NTP"
    _rpt_detail: "chrony ({{ _base_system_ntp_service[ansible_facts['service_mgr']] | default('chronyd') }})"
  tags: ['system', 'ntp', 'report']
