---
# === NTP — синхронизация времени ===
# chrony как универсальный NTP-демон (все дистро, все init-системы)
# Действие → Проверка → Логирование

# ---- Установка ----

- name: Install NTP daemon (chrony)
  ansible.builtin.package:
    name: "{{ _base_system_ntp_package[ansible_facts['os_family']] | default('chrony') }}"
    state: present
  tags: ['system', 'ntp']

# ---- Отключение systemd-timesyncd (заменяется chrony) ----

- name: Disable systemd-timesyncd (replaced by chrony)
  ansible.builtin.service:
    name: systemd-timesyncd
    enabled: false
    state: stopped
  when: ansible_facts['service_mgr'] == 'systemd'
  register: _base_system_timesyncd
  failed_when:
    - _base_system_timesyncd is failed
    - "'could not be found' not in (_base_system_timesyncd.msg | default(''))"
  tags: ['system', 'ntp']

# ---- Запуск chrony ----

- name: Enable and start chronyd
  ansible.builtin.service:
    name: "{{ _base_system_ntp_service[ansible_facts['service_mgr']] | default('chronyd') }}"
    enabled: true
    state: started
  tags: ['system', 'ntp']

# ---- Проверка ----

- name: Verify chronyd is running
  ansible.builtin.command: chronyc tracking
  register: _base_system_ntp_check
  changed_when: false
  failed_when: _base_system_ntp_check.rc != 0
  tags: ['system', 'ntp']

- name: Assert chrony daemon is functional
  ansible.builtin.assert:
    that:
      - "'Stratum' in _base_system_ntp_check.stdout"
      - "'System time' in _base_system_ntp_check.stdout"
    fail_msg: "chronyc tracking output invalid — chrony may not be configured correctly"
    quiet: true
  tags: ['system', 'ntp']

- name: Check chrony has NTP sources
  ansible.builtin.command: chronyc sources
  register: _base_system_ntp_sources
  changed_when: false
  tags: ['system', 'ntp']

- name: Assert chrony has at least one source configured
  ansible.builtin.assert:
    that:
      - _base_system_ntp_sources.stdout_lines | length > 2
    fail_msg: "chrony has no NTP sources configured"
    quiet: true
  tags: ['system', 'ntp']

# ---- Логирование ----

- name: "Report: NTP"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_phase.yml
  vars:
    _rpt_fact: "_base_system_phases"
    _rpt_phase: "Configure NTP"
    _rpt_detail: "chrony ({{ _base_system_ntp_service[ansible_facts['service_mgr']] | default('chronyd') }})"
  tags: ['system', 'ntp', 'report']
