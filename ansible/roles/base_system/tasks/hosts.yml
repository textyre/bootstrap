---
# === /etc/hosts management ===
# Базовый hostname entry + опциональный hostctl для профилей
# Действие → Проверка → Логирование

# ---- Базовый hostname entry (всегда) ----

- name: Ensure /etc/hosts contains hostname
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "127.0.1.1\t{{ base_system_hostname }}"
    insertafter: '^127\.0\.0\.1'
    state: present
  tags: ['system', 'hostname']

# ---- Проверка hostname resolve ----

- name: Verify hostname resolves via /etc/hosts
  ansible.builtin.command: getent hosts {{ base_system_hostname }}
  register: _base_system_hosts_check
  changed_when: false
  failed_when: _base_system_hosts_check.rc != 0
  tags: ['system', 'hostname']

# ---- hostctl (opt-in) ----

- name: Install hostctl (AUR)
  kewlfft.aur.aur:
    name: hostctl-bin
    use: yay
    state: present
  become: true
  become_user: "{{ yay_build_user | default('aur_builder') }}"
  when:
    - base_system_hostctl_enabled
    - ansible_facts['os_family'] == 'Archlinux'
  tags: ['system', 'hostctl']

- name: Create hostctl profile directory
  ansible.builtin.file:
    path: /etc/hostctl
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: base_system_hostctl_enabled
  tags: ['system', 'hostctl']

- name: Deploy hostctl profile files
  ansible.builtin.template:
    src: hostctl_profile.j2
    dest: "/etc/hostctl/{{ item.key }}.hosts"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ base_system_hostctl_profiles | dict2items }}"
  when: base_system_hostctl_enabled
  notify: Apply hostctl profiles
  tags: ['system', 'hostctl']

# ---- Проверка hostctl ----

- name: Verify hostctl is installed
  ansible.builtin.command: which hostctl
  register: _base_system_hostctl_check
  changed_when: false
  failed_when: _base_system_hostctl_check.rc != 0
  when: base_system_hostctl_enabled
  tags: ['system', 'hostctl']

# ---- Логирование ----

- name: "Report: Hosts"
  ansible.builtin.include_tasks: _report_phase.yml
  vars:
    _rpt_phase: "Configure /etc/hosts"
    _rpt_detail: "{{ 'hostctl profiles: ' ~ (base_system_hostctl_profiles | length) if base_system_hostctl_enabled else base_system_hostname }}"
  tags: ['system', 'hostname', 'report']
