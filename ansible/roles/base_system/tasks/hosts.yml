---
# === /etc/hosts management ===
# Базовый hostname entry + hostctl для профилей
# Действие → Проверка → Логирование

# ---- Базовый hostname entry (всегда) ----

- name: Build hostname line for /etc/hosts
  ansible.builtin.set_fact:
    _base_system_hosts_line: >-
      {{ '127.0.1.1' ~ '\t' ~
         ((base_system_domain | default(''))
           | ternary(base_system_hostname ~ '.' ~ base_system_domain ~ '\t' ~ base_system_hostname,
                     base_system_hostname)) }}
  tags: ['system', 'hostname']

- name: Ensure /etc/hosts contains hostname
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "{{ _base_system_hosts_line }}"
    insertafter: '^127\.0\.0\.1'
    state: present
  tags: ['system', 'hostname']

# ---- Проверка hostname resolve ----

- name: Verify hostname is present in /etc/hosts
  ansible.builtin.command: grep -q '{{ base_system_hostname }}' /etc/hosts
  register: _base_system_hosts_check
  changed_when: false
  failed_when: _base_system_hosts_check.rc != 0
  tags: ['system', 'hostname']

# ---- hostctl — установка (дистро-агностик) ----

- name: Install hostctl via package manager
  ansible.builtin.package:
    name: hostctl
    state: present
  when:
    - base_system_hostctl_enabled
    - ansible_facts['os_family'] not in ['Archlinux']
  register: _base_system_hostctl_pkg
  ignore_errors: true
  tags: ['system', 'hostctl']

- name: Warn if hostctl package install failed
  ansible.builtin.debug:
    msg: "hostctl package install failed: {{ _base_system_hostctl_pkg.msg | default('unknown error') }}. Will try GitHub fallback."
  when:
    - _base_system_hostctl_pkg is defined
    - _base_system_hostctl_pkg is failed
  tags: ['system', 'hostctl']

- name: Install hostctl via AUR (Arch Linux)
  kewlfft.aur.aur:
    name: hostctl-bin
    use: yay
    state: present
  become: true
  become_user: "{{ yay_build_user | default('aur_builder') }}"
  when:
    - base_system_hostctl_enabled
    - ansible_facts['os_family'] == 'Archlinux'
  tags: ['system', 'hostctl']

# Fallback: бинарник с GitHub releases если package manager не смог
- name: Check if hostctl is available after package install
  ansible.builtin.command: command -v hostctl
  register: _base_system_hostctl_which
  changed_when: false
  failed_when: false
  when: base_system_hostctl_enabled
  tags: ['system', 'hostctl']

- name: Install hostctl from GitHub releases (fallback)
  ansible.builtin.include_tasks: hostctl_download.yml
  when:
    - base_system_hostctl_enabled
    - _base_system_hostctl_which.rc | default(1) != 0
    - not ansible_check_mode
  tags: ['system', 'hostctl']

- name: "Note: hostctl download skipped in check mode"
  ansible.builtin.debug:
    msg: "hostctl GitHub download skipped — running in check mode"
  when:
    - base_system_hostctl_enabled
    - _base_system_hostctl_which.rc | default(1) != 0
    - ansible_check_mode
  tags: ['system', 'hostctl']

# ---- hostctl — профили ----

- name: Create hostctl profile directory
  ansible.builtin.file:
    path: /etc/hostctl
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: base_system_hostctl_enabled
  tags: ['system', 'hostctl']

- name: Deploy hostctl profile files
  ansible.builtin.template:
    src: hostctl_profile.j2
    dest: "/etc/hostctl/{{ item.key }}.hosts"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ base_system_hostctl_profiles | dict2items }}"
  when: base_system_hostctl_enabled
  notify: Apply hostctl profiles
  tags: ['system', 'hostctl']

# ---- Проверка hostctl ----

- name: Verify hostctl is installed
  ansible.builtin.command: hostctl --version
  register: _base_system_hostctl_check
  changed_when: false
  failed_when: _base_system_hostctl_check.rc != 0
  when: base_system_hostctl_enabled
  tags: ['system', 'hostctl']

# ---- Логирование ----

- name: "Report: Hosts"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_phase.yml
  vars:
    _rpt_fact: "_base_system_phases"
    _rpt_phase: "Configure /etc/hosts"
    _rpt_detail: "hostctl {{ _base_system_hostctl_check.stdout | default('') | regex_search('v[\\d.]+') | default('installed') }}{{ ', profiles: ' ~ (base_system_hostctl_profiles | length) if base_system_hostctl_profiles else '' }}"
  when: base_system_hostctl_enabled
  tags: ['system', 'hostname', 'report']

- name: "Report: Hosts (no hostctl)"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_phase.yml
  vars:
    _rpt_fact: "_base_system_phases"
    _rpt_phase: "Configure /etc/hosts"
    _rpt_detail: "{{ base_system_hostname }} (lineinfile)"
  when: not base_system_hostctl_enabled
  tags: ['system', 'hostname', 'report']
