---
# === /etc/hosts management ===
# Базовый hostname entry + hostctl для профилей
# Действие → Проверка → Логирование

# ---- Базовый hostname entry (всегда) ----

- name: Ensure /etc/hosts contains hostname
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "127.0.1.1\t{{ base_system_hostname }}"
    insertafter: '^127\.0\.0\.1'
    state: present
  tags: ['system', 'hostname']

# ---- Проверка hostname resolve ----

- name: Verify hostname resolves via /etc/hosts
  ansible.builtin.command: getent hosts {{ base_system_hostname }}
  register: _base_system_hosts_check
  changed_when: false
  failed_when: _base_system_hosts_check.rc != 0
  tags: ['system', 'hostname']

# ---- hostctl — установка (дистро-агностик) ----

- name: Install hostctl via package manager
  ansible.builtin.package:
    name: hostctl
    state: present
  when:
    - base_system_hostctl_enabled
    - ansible_facts['os_family'] not in ['Archlinux']
  failed_when: false
  register: _base_system_hostctl_pkg
  tags: ['system', 'hostctl']

- name: Install hostctl via AUR (Arch Linux)
  kewlfft.aur.aur:
    name: hostctl-bin
    use: yay
    state: present
  become: true
  become_user: "{{ yay_build_user | default('aur_builder') }}"
  when:
    - base_system_hostctl_enabled
    - ansible_facts['os_family'] == 'Archlinux'
  tags: ['system', 'hostctl']

# Fallback: бинарник с GitHub releases если package manager не смог
- name: Check if hostctl is available after package install
  ansible.builtin.command: which hostctl
  register: _base_system_hostctl_which
  changed_when: false
  failed_when: false
  when: base_system_hostctl_enabled
  tags: ['system', 'hostctl']

- name: Install hostctl from GitHub releases (fallback)
  when:
    - base_system_hostctl_enabled
    - _base_system_hostctl_which.rc | default(1) != 0
  tags: ['system', 'hostctl']
  block:
    - name: Determine system architecture
      ansible.builtin.set_fact:
        _hostctl_arch: "{{ 'amd64' if ansible_facts['architecture'] == 'x86_64' else 'arm64' }}"

    - name: Download hostctl binary
      ansible.builtin.get_url:
        url: "https://github.com/guumaster/hostctl/releases/download/v1.1.4/hostctl_{{ _hostctl_arch }}.tar.gz"
        dest: /tmp/hostctl.tar.gz
        mode: '0644'

    - name: Extract and install hostctl
      ansible.builtin.unarchive:
        src: /tmp/hostctl.tar.gz
        dest: /usr/local/bin
        remote_src: true
        extra_opts: ['--wildcards', '*/hostctl', '--strip-components=1']
        mode: '0755'

    - name: Clean up hostctl archive
      ansible.builtin.file:
        path: /tmp/hostctl.tar.gz
        state: absent

# ---- hostctl — профили ----

- name: Create hostctl profile directory
  ansible.builtin.file:
    path: /etc/hostctl
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: base_system_hostctl_enabled
  tags: ['system', 'hostctl']

- name: Deploy hostctl profile files
  ansible.builtin.template:
    src: hostctl_profile.j2
    dest: "/etc/hostctl/{{ item.key }}.hosts"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ base_system_hostctl_profiles | dict2items }}"
  when: base_system_hostctl_enabled
  notify: Apply hostctl profiles
  tags: ['system', 'hostctl']

# ---- Проверка hostctl ----

- name: Verify hostctl is installed
  ansible.builtin.command: hostctl --version
  register: _base_system_hostctl_check
  changed_when: false
  failed_when: _base_system_hostctl_check.rc != 0
  when: base_system_hostctl_enabled
  tags: ['system', 'hostctl']

# ---- Логирование ----

- name: "Report: Hosts"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_phase.yml
  vars:
    _rpt_fact: "_base_system_phases"
    _rpt_phase: "Configure /etc/hosts"
    _rpt_detail: "hostctl {{ _base_system_hostctl_check.stdout | default('') | regex_search('v[\\d.]+') | default('installed') }}{{ ', profiles: ' ~ (base_system_hostctl_profiles | length) if base_system_hostctl_profiles else '' }}"
  when: base_system_hostctl_enabled
  tags: ['system', 'hostname', 'report']

- name: "Report: Hosts (no hostctl)"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_phase.yml
  vars:
    _rpt_fact: "_base_system_phases"
    _rpt_phase: "Configure /etc/hosts"
    _rpt_detail: "{{ base_system_hostname }} (lineinfile)"
  when: not base_system_hostctl_enabled
  tags: ['system', 'hostname', 'report']
