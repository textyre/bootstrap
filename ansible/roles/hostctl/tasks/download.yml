---
# === hostctl â€” download binary from GitHub releases ===
# Fallback when package manager did not install hostctl.
# Uses block/always to guarantee cleanup of temp files on success and failure.

- name: Install hostctl from GitHub releases
  block:

    # ---- Resolve version ----

    - name: Query latest hostctl release from GitHub API
      ansible.builtin.uri:
        url: "{{ hostctl_github_api }}/repos/{{ hostctl_github_repo }}/releases/latest"
        return_content: true
        headers:
          Accept: application/vnd.github.v3+json
      register: hostctl_release
      when: hostctl_version == "latest"

    - name: Query specific hostctl release from GitHub API
      ansible.builtin.uri:
        url: "{{ hostctl_github_api }}/repos/{{ hostctl_github_repo }}/releases/tags/v{{ hostctl_version | regex_replace('^v', '') }}"
        return_content: true
        headers:
          Accept: application/vnd.github.v3+json
      register: hostctl_release_pinned
      when: hostctl_version != "latest"

    - name: Set hostctl release facts
      ansible.builtin.set_fact:
        hostctl_release_data: "{{ (hostctl_version == 'latest') | ternary(hostctl_release, hostctl_release_pinned) }}"

    # ---- Map architecture ----

    - name: Map system architecture to hostctl naming
      ansible.builtin.set_fact:
        hostctl_arch: "{{ hostctl_arch_map[ansible_facts['architecture']] | default(omit) }}"

    - name: Fail on unsupported architecture
      ansible.builtin.fail:
        msg: >-
          Unsupported architecture '{{ ansible_facts['architecture'] }}' for hostctl.
          Supported: x86_64, aarch64, armv7l.
      when: hostctl_arch is not defined

    # ---- Find asset URLs ----

    - name: Find tarball asset URL
      ansible.builtin.set_fact:
        hostctl_tarball_url: >
          {{ hostctl_release_data.json.assets
             | selectattr('name', 'match', '.*linux_' ~ hostctl_arch ~ '\.tar\.gz$')
             | map(attribute='browser_download_url')
             | first }}
        hostctl_tarball_name: >
          {{ hostctl_release_data.json.assets
             | selectattr('name', 'match', '.*linux_' ~ hostctl_arch ~ '\.tar\.gz$')
             | map(attribute='name')
             | first }}

    - name: Find checksums asset URL
      ansible.builtin.set_fact:
        hostctl_checksums_url: >
          {{ hostctl_release_data.json.assets
             | selectattr('name', 'match', '.*checksum.*')
             | map(attribute='browser_download_url')
             | first | default('') }}

    # ---- Checksum verification ----

    - name: Fail if checksum required but unavailable
      ansible.builtin.fail:
        msg: >-
          hostctl_verify_checksum is true but no checksum file found in release assets.
          Set hostctl_verify_checksum: false to skip verification.
      when:
        - hostctl_verify_checksum
        - hostctl_checksums_url | length == 0

    - name: Download checksums file
      ansible.builtin.uri:
        url: "{{ hostctl_checksums_url }}"
        return_content: true
      register: hostctl_checksums
      when: hostctl_checksums_url | length > 0

    - name: Extract SHA256 checksum for target asset
      ansible.builtin.set_fact:
        hostctl_checksum: >
          sha256:{{ hostctl_checksums.content
             | regex_search('([a-f0-9]{64})\s+' ~ hostctl_tarball_name, '\1')
             | first }}
      when: hostctl_checksums is not skipped

    # ---- Download archive ----

    - name: Download hostctl archive (with checksum)
      ansible.builtin.get_url:
        url: "{{ hostctl_tarball_url }}"
        dest: /tmp/hostctl.tar.gz
        checksum: "{{ hostctl_checksum }}"
        mode: '0644'
      when: hostctl_checksum is defined

    - name: Download hostctl archive (no checksum available)
      ansible.builtin.get_url:
        url: "{{ hostctl_tarball_url }}"
        dest: /tmp/hostctl.tar.gz
        mode: '0644'
      when: hostctl_checksum is not defined

    - name: Verify archive was downloaded
      ansible.builtin.stat:
        path: /tmp/hostctl.tar.gz
      register: hostctl_archive_stat

    - name: Assert archive exists
      ansible.builtin.assert:
        that: hostctl_archive_stat.stat.exists
        fail_msg: "hostctl archive /tmp/hostctl.tar.gz was not downloaded successfully"

    # ---- Extract and install ----

    - name: Create temporary extraction directory
      ansible.builtin.tempfile:
        state: directory
        prefix: hostctl_
      register: hostctl_tmpdir

    - name: Extract hostctl archive
      ansible.builtin.unarchive:
        src: /tmp/hostctl.tar.gz
        dest: "{{ hostctl_tmpdir.path }}"
        remote_src: true

    - name: Verify binary was extracted
      ansible.builtin.stat:
        path: "{{ hostctl_tmpdir.path }}/hostctl"
      register: hostctl_bin_stat

    - name: Assert binary exists after extraction
      ansible.builtin.assert:
        that:
          - hostctl_bin_stat.stat.exists
        fail_msg: "hostctl binary was not found after extraction"

    - name: Install hostctl binary
      ansible.builtin.copy:
        src: "{{ hostctl_tmpdir.path }}/hostctl"
        dest: "{{ hostctl_install_dir }}/hostctl"
        remote_src: true
        owner: root
        group: root
        mode: '0755'

    - name: Verify hostctl installation
      ansible.builtin.command: "{{ hostctl_install_dir }}/hostctl --version"
      register: hostctl_install_verify
      changed_when: false
      failed_when: hostctl_install_verify.rc != 0

  always:
    - name: Cleanup hostctl temporary files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/hostctl.tar.gz
        - "{{ hostctl_tmpdir.path | default('') }}"
      when: item | length > 0
