---
# Handlers for hostctl role
# Uses hostctl remove + hostctl add domains to apply profiles idempotently.
# hostctl add domains [profile] [hosts...] --ip IP is the correct API for
# adding IP-hostname entries (hostctl replace/add --from file do not work
# for adding entries â€” they only create empty section markers).

- name: Apply hostctl profiles
  ansible.builtin.shell: |
    hostctl remove {{ item.key }} 2>/dev/null || true
    {% for entry in item.value %}
    hostctl add domains {{ item.key }} {{ entry.host }} --ip {{ entry.ip }}
    {% endfor %}
  loop: "{{ hostctl_profiles | dict2items }}"
  listen: "apply hostctl profiles"
  changed_when: true
  when: hostctl_profiles | length > 0
