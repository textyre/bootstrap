---
# Shared hostctl verification tasks.
# Included via ansible.builtin.include_tasks from a scenario verify.yml.
#
# Required caller variables:
#   verify_binary    — full path to hostctl binary (e.g. /usr/local/bin/hostctl)
#   verify_profiles  — list of {name: "foo", entries: ["host1", "host2"]}
#
# Optional caller variables:
#   verify_version_string — if defined, assert this string appears in --version stdout

# ---- Binary version check ----

- name: Verify hostctl --version exits 0
  ansible.builtin.command: "{{ verify_binary }} --version"
  register: hostctl_verify_version
  changed_when: false
  failed_when: hostctl_verify_version.rc != 0

- name: Assert hostctl --version returns output
  ansible.builtin.assert:
    that: hostctl_verify_version.stdout | length > 0
    fail_msg: "hostctl --version returned empty output"

- name: Assert hostctl version matches expected
  ansible.builtin.assert:
    that: "verify_version_string in hostctl_verify_version.stdout"
    fail_msg: "Expected '{{ verify_version_string }}' in hostctl --version output: {{ hostctl_verify_version.stdout }}"
  when: verify_version_string is defined

# ---- Profile file existence ----

- name: Verify profile file exists
  ansible.builtin.stat:
    path: "/etc/hostctl/{{ item.name }}.hosts"
  loop: "{{ verify_profiles }}"
  register: hostctl_verify_profile_stats

- name: Assert profile files exist
  ansible.builtin.assert:
    that: item.stat.exists
    fail_msg: "/etc/hostctl/{{ item.item.name }}.hosts was not deployed"
  loop: "{{ hostctl_verify_profile_stats.results }}"

# ---- Profile file content ----

- name: Verify profile file contains expected entry
  ansible.builtin.command: "grep -q '{{ item.1 }}' /etc/hostctl/{{ item.0.name }}.hosts"
  loop: "{{ verify_profiles | subelements('entries') }}"
  loop_control:
    label: "{{ item.0.name }}.hosts → {{ item.1 }}"
  changed_when: false
  failed_when: hostctl_verify_file_entry.rc != 0
  register: hostctl_verify_file_entry

# ---- /etc/hosts integration ----

- name: Verify profile entry is applied to /etc/hosts
  ansible.builtin.command: "grep -q '{{ item.1 }}' /etc/hosts"
  loop: "{{ verify_profiles | subelements('entries') }}"
  loop_control:
    label: "/etc/hosts → {{ item.1 }}"
  changed_when: false
  failed_when: hostctl_verify_hosts_entry.rc != 0
  register: hostctl_verify_hosts_entry

- name: Verify base /etc/hosts entries not overwritten
  ansible.builtin.command: grep -q "127.0.0.1" /etc/hosts
  changed_when: false
  register: hostctl_verify_hosts_base
  failed_when: hostctl_verify_hosts_base.rc != 0

# ---- Summary ----

- name: Show verification results
  ansible.builtin.debug:
    msg:
      - "hostctl version: {{ hostctl_verify_version.stdout }}"
      - "Profiles verified: {{ verify_profiles | map(attribute='name') | join(', ') }}"
      - "Base 127.0.0.1 entry in /etc/hosts: intact"
