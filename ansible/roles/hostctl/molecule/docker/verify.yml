---
- name: Verify
  hosts: all
  become: true
  gather_facts: false

  vars:
    verify_binary: /usr/local/bin/hostctl
    verify_version_string: "1.1.4"
    verify_profiles:
      - name: dev
        entries:
          - app.local
          - api.local
      - name: registry
        entries:
          - registry.local

  tasks:
    # ---- Docker-specific: binary permissions ----

    - name: Verify hostctl binary exists at install path
      ansible.builtin.stat:
        path: "{{ verify_binary }}"
      register: hostctl_verify_bin

    - name: Assert hostctl binary has correct permissions
      ansible.builtin.assert:
        that:
          - hostctl_verify_bin.stat.exists
          - hostctl_verify_bin.stat.mode == '0755'
          - hostctl_verify_bin.stat.executable
        fail_msg: >-
          hostctl binary missing or wrong permissions at {{ verify_binary }}
          (exists={{ hostctl_verify_bin.stat.exists | default(false) }},
          mode={{ hostctl_verify_bin.stat.mode | default('N/A') }})

    # ---- Docker-specific: profile directory ----

    - name: Verify /etc/hostctl directory exists
      ansible.builtin.stat:
        path: /etc/hostctl
      register: hostctl_verify_dir

    - name: Assert /etc/hostctl is a directory
      ansible.builtin.assert:
        that:
          - hostctl_verify_dir.stat.exists
          - hostctl_verify_dir.stat.isdir
        fail_msg: "/etc/hostctl does not exist or is not a directory"

    # ---- Shared verification ----

    - name: Run shared hostctl verification
      ansible.builtin.include_tasks: ../resource/verify_tasks.yml
