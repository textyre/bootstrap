---
- name: Converge
  hosts: all
  become: true
  gather_facts: true

  roles:
    - role: hostctl
      vars:
        hostctl_version: "1.1.4"
        hostctl_verify_checksum: true
        yay_build_user: "root"
        hostctl_profiles:
          dev:
            - { ip: "127.0.0.1", host: "app.local" }
            - { ip: "127.0.0.1", host: "api.local" }
          registry:
            - { ip: "172.17.0.1", host: "registry.local" }

  post_tasks:
    - name: DEBUG - try hostctl add domains from file
      ansible.builtin.command: hostctl add domains dev --from /etc/hostctl/dev.hosts
      register: dbg_domains
      changed_when: false
      failed_when: false

    - name: DEBUG - hostctl add domains --help
      ansible.builtin.command: hostctl add domains --help
      register: dbg_domains_help
      changed_when: false
      failed_when: false

    - name: DEBUG - show /etc/hosts after domains
      ansible.builtin.command: cat /etc/hosts
      register: dbg_hosts
      changed_when: false

    - name: DEBUG - hostctl list
      ansible.builtin.command: hostctl list
      register: dbg_list
      changed_when: false

    - name: DEBUG output
      ansible.builtin.debug:
        msg:
          - "add domains rc={{ dbg_domains.rc }} stdout={{ dbg_domains.stdout_lines }} stderr={{ dbg_domains.stderr_lines }}"
          - "add domains help: {{ dbg_domains_help.stdout_lines }}"
          - "/etc/hosts: {{ dbg_hosts.stdout_lines }}"
          - "hostctl list: {{ dbg_list.stdout_lines }}"
