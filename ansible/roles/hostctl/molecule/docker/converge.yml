---
- name: Converge
  hosts: all
  become: true
  gather_facts: true

  roles:
    - role: hostctl
      vars:
        hostctl_version: "1.1.4"
        hostctl_verify_checksum: true
        yay_build_user: "root"
        hostctl_profiles:
          dev:
            - { ip: "127.0.0.1", host: "app.local" }
            - { ip: "127.0.0.1", host: "api.local" }
          registry:
            - { ip: "172.17.0.1", host: "registry.local" }

  post_tasks:
    - name: DEBUG - test direct echo write to /etc/hosts
      ansible.builtin.shell: echo "127.0.0.1 echotest.local" >> /etc/hosts
      changed_when: true
      failed_when: false
      register: dbg_echo

    - name: DEBUG - try hostctl add with explicit --ip
      ansible.builtin.command: hostctl add dev --ip 127.0.0.1 app.local api.local
      register: dbg_add_ip
      changed_when: false
      failed_when: false

    - name: DEBUG - show /etc/hosts after both tests
      ansible.builtin.command: cat /etc/hosts
      register: dbg_hosts
      changed_when: false

    - name: DEBUG - hostctl list
      ansible.builtin.command: hostctl list
      register: dbg_list
      changed_when: false

    - name: DEBUG - hostctl help for add
      ansible.builtin.command: hostctl add --help
      register: dbg_help
      changed_when: false
      failed_when: false

    - name: DEBUG output
      ansible.builtin.debug:
        msg:
          - "echo rc={{ dbg_echo.rc }}"
          - "add --ip rc={{ dbg_add_ip.rc }} stdout={{ dbg_add_ip.stdout_lines }} stderr={{ dbg_add_ip.stderr_lines }}"
          - "/etc/hosts: {{ dbg_hosts.stdout_lines }}"
          - "hostctl list: {{ dbg_list.stdout_lines }}"
          - "add help: {{ dbg_help.stdout_lines }}"
