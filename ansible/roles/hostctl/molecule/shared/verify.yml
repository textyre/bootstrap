---
- name: Verify
  hosts: all
  become: true
  gather_facts: false

  vars:
    verify_binary: /usr/local/bin/hostctl
    verify_version_string: "1.1.4"
    verify_profiles:
      - name: dev
        entries:
          - app.local
          - api.local
      - name: registry
        entries:
          - registry.local

  tasks:

    # ---- Binary ----

    - name: Verify hostctl binary exists at install path
      ansible.builtin.stat:
        path: "{{ verify_binary }}"
      register: hostctl_verify_bin

    - name: Assert hostctl binary has correct permissions
      ansible.builtin.assert:
        that:
          - hostctl_verify_bin.stat.exists
          - hostctl_verify_bin.stat.mode == '0755'
          - hostctl_verify_bin.stat.executable

    # ---- Profile directory ----

    - name: Verify /etc/hostctl directory exists
      ansible.builtin.stat:
        path: /etc/hostctl
      register: hostctl_verify_dir

    - name: Assert /etc/hostctl is a directory
      ansible.builtin.assert:
        that:
          - hostctl_verify_dir.stat.exists
          - hostctl_verify_dir.stat.isdir

    # ---- Version ----

    - name: Run hostctl --version
      ansible.builtin.command: "{{ verify_binary }} --version"
      register: hostctl_verify_version
      changed_when: false

    - name: Assert hostctl version matches expected
      ansible.builtin.assert:
        that: verify_version_string in hostctl_verify_version.stdout
        fail_msg: "Expected '{{ verify_version_string }}' in: {{ hostctl_verify_version.stdout }}"

    # ---- Profile files ----

    - name: Verify profile file exists
      ansible.builtin.stat:
        path: "/etc/hostctl/{{ item.name }}.hosts"
      loop: "{{ verify_profiles }}"
      register: hostctl_verify_profile_stats

    - name: Assert profile files exist
      ansible.builtin.assert:
        that: item.stat.exists
        fail_msg: "/etc/hostctl/{{ item.item.name }}.hosts was not deployed"
      loop: "{{ hostctl_verify_profile_stats.results }}"

    - name: Verify profile file contains expected entry
      ansible.builtin.command: "grep -q '{{ item.1 }}' /etc/hostctl/{{ item.0.name }}.hosts"
      loop: "{{ verify_profiles | subelements('entries') }}"
      loop_control:
        label: "{{ item.0.name }}.hosts → {{ item.1 }}"
      changed_when: false

    # ---- /etc/hosts integration ----

    - name: Verify profile entry is applied to /etc/hosts
      ansible.builtin.command: "grep -q '{{ item.1 }}' /etc/hosts"
      loop: "{{ verify_profiles | subelements('entries') }}"
      loop_control:
        label: "/etc/hosts → {{ item.1 }}"
      changed_when: false

    - name: Verify base /etc/hosts entries not overwritten
      ansible.builtin.command: grep -q "127.0.0.1" /etc/hosts
      changed_when: false

    # ---- Summary ----

    - name: Show verification results
      ansible.builtin.debug:
        msg:
          - "hostctl version: {{ hostctl_verify_version.stdout }}"
          - "Profiles verified: {{ verify_profiles | map(attribute='name') | join(', ') }}"
          - "Base 127.0.0.1 entry in /etc/hosts: intact"
