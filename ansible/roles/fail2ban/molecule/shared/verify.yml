---
- name: Verify fail2ban role
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - ../../defaults/main.yml

  tasks:

    # ---- Package installed ----

    - name: Gather package facts
      ansible.builtin.package_facts:
        manager: auto

    - name: Assert fail2ban package is installed
      ansible.builtin.assert:
        that: "'fail2ban' in ansible_facts.packages"
        fail_msg: "fail2ban package not found in installed packages"

    - name: Verify fail2ban-client is available
      ansible.builtin.command:
        cmd: fail2ban-client --version
      register: f2b_verify_version
      changed_when: false
      failed_when: f2b_verify_version.rc != 0

    # ---- Configuration file: existence and permissions ----

    - name: Stat /etc/fail2ban/jail.d/sshd.conf
      ansible.builtin.stat:
        path: /etc/fail2ban/jail.d/sshd.conf
      register: f2b_verify_jail_conf

    - name: Assert jail config exists with correct owner and mode
      ansible.builtin.assert:
        that:
          - f2b_verify_jail_conf.stat.exists
          - f2b_verify_jail_conf.stat.isreg
          - f2b_verify_jail_conf.stat.pw_name == 'root'
          - f2b_verify_jail_conf.stat.gr_name == 'root'
          - f2b_verify_jail_conf.stat.mode == '0644'
        fail_msg: >-
          /etc/fail2ban/jail.d/sshd.conf missing or wrong permissions
          (expected root:root 0644, got {{ f2b_verify_jail_conf.stat.pw_name | default('?') }}:{{
          f2b_verify_jail_conf.stat.gr_name | default('?') }} {{
          f2b_verify_jail_conf.stat.mode | default('?') }})

    # ---- Configuration file: content ----

    - name: Read jail config content
      ansible.builtin.slurp:
        src: /etc/fail2ban/jail.d/sshd.conf
      register: f2b_verify_jail_raw

    - name: Set jail config text fact
      ansible.builtin.set_fact:
        f2b_verify_jail_text: "{{ f2b_verify_jail_raw.content | b64decode }}"

    - name: Assert Ansible managed marker present
      ansible.builtin.assert:
        that: "'Ansible' in f2b_verify_jail_text"
        fail_msg: "Ansible managed marker not found -- config may not be template-generated"

    - name: Assert sshd jail section present
      ansible.builtin.assert:
        that: "'[sshd]' in f2b_verify_jail_text"
        fail_msg: "[sshd] section not found in jail config"

    - name: Assert jail is enabled
      ansible.builtin.assert:
        that: "'enabled = true' in f2b_verify_jail_text"
        fail_msg: "sshd jail is not enabled in config"
      when: fail2ban_sshd_enabled | bool

    - name: Assert maxretry matches converge value
      ansible.builtin.assert:
        that: "'maxretry = 3' in f2b_verify_jail_text"
        fail_msg: "maxretry not set to 3 (converge override value)"

    - name: Assert bantime matches converge value
      ansible.builtin.assert:
        that: "'bantime = 600' in f2b_verify_jail_text"
        fail_msg: "bantime not set to 600 (converge override value)"

    - name: Assert findtime is present
      ansible.builtin.assert:
        that: "'findtime =' in f2b_verify_jail_text"
        fail_msg: "findtime directive missing from jail config"

    - name: Assert backend is present
      ansible.builtin.assert:
        that: "'backend =' in f2b_verify_jail_text"
        fail_msg: "backend directive missing from jail config"

    - name: Assert bantime.increment is configured
      ansible.builtin.assert:
        that: "'bantime.increment = true' in f2b_verify_jail_text"
        fail_msg: "bantime.increment not enabled (expected progressive ban escalation)"
      when: fail2ban_sshd_bantime_increment | bool

    - name: Assert bantime.maxtime is configured
      ansible.builtin.assert:
        that: "'bantime.maxtime =' in f2b_verify_jail_text"
        fail_msg: "bantime.maxtime directive missing (required when bantime.increment is true)"
      when: fail2ban_sshd_bantime_increment | bool

    - name: Assert ignoreip whitelist is present
      ansible.builtin.assert:
        that: "'ignoreip =' in f2b_verify_jail_text"
        fail_msg: "ignoreip whitelist missing from jail config"
      when: fail2ban_ignoreip | length > 0

    - name: Assert localhost is in ignoreip
      ansible.builtin.assert:
        that: "'127.0.0.1/8' in f2b_verify_jail_text"
        fail_msg: "127.0.0.1/8 not in ignoreip whitelist"
      when: "'127.0.0.1/8' in fail2ban_ignoreip"

    # ---- Service state ----

    - name: Check fail2ban service is enabled
      ansible.builtin.command: systemctl is-enabled fail2ban.service
      register: f2b_verify_svc_enabled
      changed_when: false
      failed_when: false
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Assert fail2ban service is enabled
      ansible.builtin.assert:
        that: f2b_verify_svc_enabled.stdout == 'enabled'
        fail_msg: >-
          fail2ban.service is not enabled
          (got '{{ f2b_verify_svc_enabled.stdout | default("unknown") }}')
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Check fail2ban service is active
      ansible.builtin.command: systemctl is-active fail2ban.service
      register: f2b_verify_svc_active
      changed_when: false
      failed_when: false
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Assert fail2ban service is active
      ansible.builtin.assert:
        that: f2b_verify_svc_active.stdout == 'active'
        fail_msg: >-
          fail2ban.service is not active
          (got '{{ f2b_verify_svc_active.stdout | default("unknown") }}')
      when: ansible_facts['service_mgr'] == 'systemd'

    # ---- fail2ban-client runtime checks ----

    - name: Check fail2ban-client status
      ansible.builtin.command: fail2ban-client status
      register: f2b_verify_client_status
      changed_when: false
      failed_when: false

    - name: Assert fail2ban-client reports healthy
      ansible.builtin.assert:
        that: f2b_verify_client_status.rc == 0
        fail_msg: >-
          fail2ban-client status failed (rc={{ f2b_verify_client_status.rc }}).
          stderr: {{ f2b_verify_client_status.stderr | default('') }}

    - name: Assert sshd jail is listed
      ansible.builtin.assert:
        that: "'sshd' in f2b_verify_client_status.stdout"
        fail_msg: >-
          sshd jail not listed in fail2ban-client status output.
          stdout: {{ f2b_verify_client_status.stdout }}
      when: fail2ban_sshd_enabled | bool

    - name: Check fail2ban-client status sshd
      ansible.builtin.command: fail2ban-client status sshd
      register: f2b_verify_sshd_status
      changed_when: false
      failed_when: false
      when: fail2ban_sshd_enabled | bool

    - name: Assert sshd jail is active
      ansible.builtin.assert:
        that:
          - f2b_verify_sshd_status.rc == 0
          - "'sshd' in f2b_verify_sshd_status.stdout"
        fail_msg: >-
          fail2ban sshd jail status check failed.
          rc={{ f2b_verify_sshd_status.rc }},
          stdout: {{ f2b_verify_sshd_status.stdout | default('') }}
      when: fail2ban_sshd_enabled | bool

    # ---- Diagnostic (informational, no assertions) ----

    - name: Diagnostic -- fail2ban-client status output
      ansible.builtin.debug:
        var: f2b_verify_client_status.stdout_lines
      when: f2b_verify_client_status.rc == 0

    - name: Diagnostic -- sshd jail status output
      ansible.builtin.debug:
        var: f2b_verify_sshd_status.stdout_lines
      when:
        - fail2ban_sshd_enabled | bool
        - f2b_verify_sshd_status.rc == 0

    - name: Show verify result
      ansible.builtin.debug:
        msg: >-
          fail2ban verify passed: package installed, jail config deployed
          (root:root 0644) with correct directives, service enabled and active,
          fail2ban-client reports sshd jail active.
