---
- name: Verify fail2ban role
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - ../../defaults/main.yml

  tasks:

    # ---- Package installed ----

    - name: Gather package facts
      ansible.builtin.package_facts:
        manager: auto

    - name: Assert fail2ban package is installed
      ansible.builtin.assert:
        that: "'fail2ban' in ansible_facts.packages"
        fail_msg: "fail2ban package not found in installed packages"

    - name: Verify fail2ban-client is available
      ansible.builtin.command:
        cmd: fail2ban-client --version
      register: _fail2ban_verify_version
      changed_when: false
      failed_when: _fail2ban_verify_version.rc != 0

    # ---- Configuration file: existence and permissions ----

    - name: Stat /etc/fail2ban/jail.d/sshd.conf
      ansible.builtin.stat:
        path: /etc/fail2ban/jail.d/sshd.conf
      register: _fail2ban_verify_jail_conf

    - name: Assert jail config exists with correct owner and mode
      ansible.builtin.assert:
        that:
          - _fail2ban_verify_jail_conf.stat.exists
          - _fail2ban_verify_jail_conf.stat.isreg
          - _fail2ban_verify_jail_conf.stat.pw_name == 'root'
          - _fail2ban_verify_jail_conf.stat.gr_name == 'root'
          - _fail2ban_verify_jail_conf.stat.mode == '0644'
        fail_msg: >-
          /etc/fail2ban/jail.d/sshd.conf missing or wrong permissions
          (expected root:root 0644, got {{ _fail2ban_verify_jail_conf.stat.pw_name | default('?') }}:{{
          _fail2ban_verify_jail_conf.stat.gr_name | default('?') }} {{
          _fail2ban_verify_jail_conf.stat.mode | default('?') }})

    # ---- Configuration file: content ----

    - name: Read jail config content
      ansible.builtin.slurp:
        src: /etc/fail2ban/jail.d/sshd.conf
      register: _fail2ban_verify_jail_raw

    - name: Assert slurp returned content
      ansible.builtin.assert:
        that: "'content' in _fail2ban_verify_jail_raw"
        fail_msg: "slurp did not return content for jail config"

    - name: Set jail config text fact
      ansible.builtin.set_fact:
        _fail2ban_verify_jail_text: "{{ _fail2ban_verify_jail_raw.content | b64decode }}"

    - name: Assert Ansible managed marker present
      ansible.builtin.assert:
        that: "'Ansible' in _fail2ban_verify_jail_text"
        fail_msg: "Ansible managed marker not found -- config may not be template-generated"

    - name: Assert sshd jail section present
      ansible.builtin.assert:
        that: "'[sshd]' in _fail2ban_verify_jail_text"
        fail_msg: "[sshd] section not found in jail config"

    - name: Assert jail is enabled
      ansible.builtin.assert:
        that: "'enabled = true' in _fail2ban_verify_jail_text"
        fail_msg: "sshd jail is not enabled in config"
      when: fail2ban_sshd_enabled | bool

    - name: Assert maxretry matches converge value
      ansible.builtin.assert:
        that: _fail2ban_verify_jail_text is regex('(?m)^maxretry = 3$')
        fail_msg: "maxretry not set to 3 (converge override value)"

    - name: Assert bantime matches converge value
      ansible.builtin.assert:
        that: _fail2ban_verify_jail_text is regex('(?m)^bantime = 600$')
        fail_msg: "bantime not set to 600 (converge override value)"

    - name: Assert findtime is present
      ansible.builtin.assert:
        that: _fail2ban_verify_jail_text is regex('(?m)^findtime = ')
        fail_msg: "findtime directive missing from jail config"

    - name: Assert backend is present
      ansible.builtin.assert:
        that: _fail2ban_verify_jail_text is regex('(?m)^backend = ')
        fail_msg: "backend directive missing from jail config"

    - name: Assert bantime.increment is configured
      ansible.builtin.assert:
        that: "'bantime.increment = true' in _fail2ban_verify_jail_text"
        fail_msg: "bantime.increment not enabled (expected progressive ban escalation)"
      when: fail2ban_sshd_bantime_increment | bool

    - name: Assert bantime.maxtime is configured
      ansible.builtin.assert:
        that: _fail2ban_verify_jail_text is regex('(?m)^bantime\.maxtime = ')
        fail_msg: "bantime.maxtime directive missing (required when bantime.increment is true)"
      when: fail2ban_sshd_bantime_increment | bool

    - name: Assert ignoreip whitelist is present
      ansible.builtin.assert:
        that: _fail2ban_verify_jail_text is regex('(?m)^ignoreip = ')
        fail_msg: "ignoreip whitelist missing from jail config"
      when: fail2ban_ignoreip | length > 0

    - name: Assert localhost is in ignoreip
      ansible.builtin.assert:
        that: "'127.0.0.1/8' in _fail2ban_verify_jail_text"
        fail_msg: "127.0.0.1/8 not in ignoreip whitelist"
      when: "'127.0.0.1/8' in fail2ban_ignoreip"

    # ---- Service state ----

    - name: Check fail2ban service is enabled
      ansible.builtin.command: systemctl is-enabled fail2ban.service
      register: _fail2ban_verify_svc_enabled
      changed_when: false
      failed_when: false
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Assert fail2ban service is enabled
      ansible.builtin.assert:
        that: "'enabled' in _fail2ban_verify_svc_enabled.stdout"
        fail_msg: >-
          fail2ban.service is not enabled
          (got '{{ _fail2ban_verify_svc_enabled.stdout | default("unknown") }}')
      when: ansible_facts['service_mgr'] == 'systemd'

    # ---- Runtime checks (guarded for Docker) ----
    # fail2ban-client requires the server to be running.
    # In Docker, the service may fail to start due to missing
    # iptables kernel modules or log sources.

    - name: Check fail2ban service is active
      ansible.builtin.command: systemctl is-active fail2ban.service
      register: _fail2ban_verify_svc_active
      changed_when: false
      failed_when: false
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Assert fail2ban service is active
      ansible.builtin.assert:
        that: _fail2ban_verify_svc_active.stdout == 'active'
        fail_msg: >-
          fail2ban.service is not active
          (got '{{ _fail2ban_verify_svc_active.stdout | default("unknown") }}')
      when:
        - ansible_facts['service_mgr'] == 'systemd'
        - ansible_virtualization_type | default('') != 'docker'

    - name: Warn if fail2ban not active in Docker
      ansible.builtin.debug:
        msg: >-
          WARNING: fail2ban.service is not active
          (got '{{ _fail2ban_verify_svc_active.stdout | default("unknown") }}').
          This may be expected in Docker -- iptables backend needs kernel netfilter modules.
      when:
        - ansible_facts['service_mgr'] == 'systemd'
        - ansible_virtualization_type | default('') == 'docker'
        - _fail2ban_verify_svc_active.stdout | default('') != 'active'

    - name: Check fail2ban-client status
      ansible.builtin.command: fail2ban-client status
      register: _fail2ban_verify_client_status
      changed_when: false
      failed_when: false
      when: ansible_virtualization_type | default('') != 'docker'

    - name: Assert fail2ban-client reports healthy
      ansible.builtin.assert:
        that: _fail2ban_verify_client_status.rc == 0
        fail_msg: >-
          fail2ban-client status failed (rc={{ _fail2ban_verify_client_status.rc }}).
          stderr: {{ _fail2ban_verify_client_status.stderr | default('') }}
      when: ansible_virtualization_type | default('') != 'docker'

    - name: Assert sshd jail is listed
      ansible.builtin.assert:
        that: "'sshd' in _fail2ban_verify_client_status.stdout"
        fail_msg: >-
          sshd jail not listed in fail2ban-client status output.
          stdout: {{ _fail2ban_verify_client_status.stdout }}
      when:
        - fail2ban_sshd_enabled | bool
        - ansible_virtualization_type | default('') != 'docker'

    - name: Check fail2ban-client status sshd
      ansible.builtin.command: fail2ban-client status sshd
      register: _fail2ban_verify_sshd_status
      changed_when: false
      failed_when: false
      when:
        - fail2ban_sshd_enabled | bool
        - ansible_virtualization_type | default('') != 'docker'

    - name: Assert sshd jail is active
      ansible.builtin.assert:
        that:
          - _fail2ban_verify_sshd_status.rc == 0
          - "'sshd' in _fail2ban_verify_sshd_status.stdout"
        fail_msg: >-
          fail2ban sshd jail status check failed.
          rc={{ _fail2ban_verify_sshd_status.rc }},
          stdout: {{ _fail2ban_verify_sshd_status.stdout | default('') }}
      when:
        - fail2ban_sshd_enabled | bool
        - ansible_virtualization_type | default('') != 'docker'

    # ---- Docker-safe runtime check ----
    # In Docker, try fail2ban-client ping to check if server is reachable.
    # If it responds, run additional checks.

    - name: Try fail2ban-client ping (Docker)
      ansible.builtin.command: fail2ban-client ping
      register: _fail2ban_verify_ping
      changed_when: false
      failed_when: false
      when: ansible_virtualization_type | default('') == 'docker'

    - name: Check fail2ban-client status (Docker, server reachable)
      ansible.builtin.command: fail2ban-client status
      register: _fail2ban_verify_client_status_docker
      changed_when: false
      failed_when: false
      when:
        - ansible_virtualization_type | default('') == 'docker'
        - _fail2ban_verify_ping.rc | default(1) == 0

    - name: Assert fail2ban-client reports healthy (Docker, server reachable)
      ansible.builtin.assert:
        that: _fail2ban_verify_client_status_docker.rc == 0
        fail_msg: >-
          fail2ban-client status failed in Docker despite server being reachable.
          stderr: {{ _fail2ban_verify_client_status_docker.stderr | default('') }}
      when:
        - ansible_virtualization_type | default('') == 'docker'
        - _fail2ban_verify_ping.rc | default(1) == 0

    - name: Warn if fail2ban server unreachable in Docker
      ansible.builtin.debug:
        msg: >-
          WARNING: fail2ban-server not reachable in Docker (ping rc={{ _fail2ban_verify_ping.rc | default('?') }}).
          Runtime checks skipped. Config file assertions still valid.
      when:
        - ansible_virtualization_type | default('') == 'docker'
        - _fail2ban_verify_ping.rc | default(1) != 0

    # ---- Diagnostic (informational, no assertions) ----

    - name: Diagnostic -- fail2ban-client status output
      ansible.builtin.debug:
        var: _fail2ban_verify_client_status.stdout_lines
      when:
        - ansible_virtualization_type | default('') != 'docker'
        - _fail2ban_verify_client_status.rc | default(1) == 0

    - name: Diagnostic -- sshd jail status output
      ansible.builtin.debug:
        var: _fail2ban_verify_sshd_status.stdout_lines
      when:
        - fail2ban_sshd_enabled | bool
        - ansible_virtualization_type | default('') != 'docker'
        - _fail2ban_verify_sshd_status.rc | default(1) == 0

    - name: Show verify result
      ansible.builtin.debug:
        msg: >-
          fail2ban verify passed: package installed, jail config deployed
          (root:root 0644) with correct directives (maxretry, bantime, findtime,
          backend, bantime.increment, ignoreip), service enabled{{ (ansible_virtualization_type | default('') != 'docker')
          | ternary(' and active, fail2ban-client reports sshd jail active',
          ' (runtime checks guarded for Docker)') }}.
