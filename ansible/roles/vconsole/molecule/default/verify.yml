---
- name: Verify
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/inventory/group_vars/all/vault.yml"

  vars:
    vconsole_console: "us"
    vconsole_console_font: "ter-v16n"
    vconsole_console_font_package: "terminus-font"
    vconsole_gpm_enabled: true

  tasks:
    - name: Check vconsole.conf exists and has KEYMAP (systemd)
      ansible.builtin.slurp:
        src: /etc/vconsole.conf
      register: _verify_vconsole
      failed_when: "'KEYMAP=' not in (_verify_vconsole.content | b64decode)"
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Verify keymap via localectl (systemd)
      ansible.builtin.command: localectl status
      register: _verify_localectl
      changed_when: false
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Assert keymap is set (systemd)
      ansible.builtin.assert:
        that:
          - "vconsole_console in _verify_localectl.stdout"
        fail_msg: "Keymap '{{ vconsole_console }}' not found in localectl status"
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Assert font is set in vconsole.conf (systemd)
      ansible.builtin.assert:
        that:
          - "'FONT=' + vconsole_console_font in (_verify_vconsole.content | b64decode)"
        fail_msg: "FONT={{ vconsole_console_font }} not found in /etc/vconsole.conf"
      when:
        - ansible_facts['service_mgr'] == 'systemd'
        - vconsole_console_font | default('') | length > 0

    - name: Check terminus-font is installed (systemd)
      ansible.builtin.package_facts:
        manager: auto
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Assert font package installed (systemd)
      ansible.builtin.assert:
        that:
          - "vconsole_console_font_package in ansible_facts.packages"
        fail_msg: "{{ vconsole_console_font_package }} package not found"
      when:
        - ansible_facts['service_mgr'] == 'systemd'
        - vconsole_console_font | default('') | length > 0

    - name: Check keymap config (openrc)
      ansible.builtin.command: grep -i 'keymap=' /etc/conf.d/keymaps
      register: _verify_keymap_openrc
      changed_when: false
      failed_when: _verify_keymap_openrc.rc != 0
      when: ansible_facts['service_mgr'] == 'openrc'

    - name: Check keymap config (runit)
      ansible.builtin.command: grep -i 'KEYMAP=' /etc/rc.conf
      register: _verify_keymap_runit
      changed_when: false
      failed_when: _verify_keymap_runit.rc != 0
      when: ansible_facts['service_mgr'] == 'runit'

    - name: Gather service facts
      ansible.builtin.service_facts:
      when: vconsole_gpm_enabled

    - name: Assert GPM service is running (systemd)
      ansible.builtin.assert:
        that:
          - "'gpm.service' in ansible_facts.services"
          - "ansible_facts.services['gpm.service'].state == 'running'"
        fail_msg: "GPM service is not running"
      when:
        - vconsole_gpm_enabled
        - ansible_facts['service_mgr'] == 'systemd'

    - name: Show result
      ansible.builtin.debug:
        msg: "Keymap check passed: {{ vconsole_console }} ({{ ansible_facts['service_mgr'] }})"
