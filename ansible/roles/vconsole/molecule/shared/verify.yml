---
- name: Verify
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Set OS-specific verify variables
      ansible.builtin.set_fact:
        _vconsole_verify_font_package: >-
          {{ 'terminus-font' if ansible_facts['os_family'] == 'Archlinux'
             else 'console-setup' }}
        _vconsole_verify_font: >-
          {{ 'ter-v16n' if ansible_facts['os_family'] == 'Archlinux'
             else '' }}

  vars:
    _vconsole_verify_keymap: "us"
    _vconsole_verify_gpm_enabled: false

  tasks:

    # ---- systemd: /etc/vconsole.conf ----

    - name: Stat /etc/vconsole.conf
      ansible.builtin.stat:
        path: /etc/vconsole.conf
      register: _vconsole_verify_stat
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Assert /etc/vconsole.conf exists with correct permissions
      ansible.builtin.assert:
        that:
          - _vconsole_verify_stat.stat.exists
          - _vconsole_verify_stat.stat.isreg or _vconsole_verify_stat.stat.islnk
          - _vconsole_verify_stat.stat.pw_name == 'root'
          - _vconsole_verify_stat.stat.gr_name == 'root'
          - _vconsole_verify_stat.stat.islnk or _vconsole_verify_stat.stat.mode == '0644'
        fail_msg: "/etc/vconsole.conf missing or wrong permissions (expected root:root 0644)"
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Slurp /etc/vconsole.conf
      ansible.builtin.slurp:
        src: /etc/vconsole.conf
      register: _vconsole_verify_slurp
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Assert slurp /etc/vconsole.conf succeeded
      ansible.builtin.assert:
        that:
          - "'content' in _vconsole_verify_slurp"
        fail_msg: "Failed to read /etc/vconsole.conf content"
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Set vconsole.conf content fact
      ansible.builtin.set_fact:
        _vconsole_verify_content: "{{ _vconsole_verify_slurp.content | b64decode }}"
      when:
        - ansible_facts['service_mgr'] == 'systemd'
        - "'content' in _vconsole_verify_slurp"

    - name: Assert KEYMAP is set correctly
      ansible.builtin.assert:
        that:
          - _vconsole_verify_content is regex('^KEYMAP=' + _vconsole_verify_keymap + '$', multiline=True)
        fail_msg: "KEYMAP={{ _vconsole_verify_keymap }} not found in /etc/vconsole.conf. Content: {{ _vconsole_verify_content }}"
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Assert FONT is set correctly
      ansible.builtin.assert:
        that:
          - _vconsole_verify_content is regex('^FONT=' + _vconsole_verify_font + '$', multiline=True)
        fail_msg: "FONT={{ _vconsole_verify_font }} not found in /etc/vconsole.conf. Content: {{ _vconsole_verify_content }}"
      when:
        - ansible_facts['service_mgr'] == 'systemd'
        - _vconsole_verify_font | default('') | length > 0

    - name: Assert FONT_MAP is set correctly
      ansible.builtin.assert:
        that: "'FONT_MAP=8859-2' in _vconsole_verify_content"
        fail_msg: "FONT_MAP=8859-2 not found in /etc/vconsole.conf"
      when:
        - ansible_facts['service_mgr'] == 'systemd'
        - ansible_facts['os_family'] == 'Archlinux'

    # ---- Font package ----

    - name: Gather package facts
      ansible.builtin.package_facts:
        manager: auto
      when: _vconsole_verify_font | default('') | length > 0

    - name: Assert console font package is installed
      ansible.builtin.assert:
        that:
          - _vconsole_verify_font_package in ansible_facts.packages
        fail_msg: "{{ _vconsole_verify_font_package }} package not installed"
      when: _vconsole_verify_font | default('') | length > 0

    # ---- OpenRC: /etc/conf.d/keymaps ----

    - name: Slurp /etc/conf.d/keymaps
      ansible.builtin.slurp:
        src: /etc/conf.d/keymaps
      register: _vconsole_verify_openrc
      when: ansible_facts['service_mgr'] == 'openrc'

    - name: Assert slurp /etc/conf.d/keymaps succeeded
      ansible.builtin.assert:
        that:
          - "'content' in _vconsole_verify_openrc"
        fail_msg: "Failed to read /etc/conf.d/keymaps"
      when: ansible_facts['service_mgr'] == 'openrc'

    - name: Assert keymap is set (openrc)
      ansible.builtin.assert:
        that:
          - (_vconsole_verify_openrc.content | b64decode) is regex('^keymap="' + _vconsole_verify_keymap + '"$', multiline=True)
        fail_msg: "keymap=\"{{ _vconsole_verify_keymap }}\" not found in /etc/conf.d/keymaps"
      when:
        - ansible_facts['service_mgr'] == 'openrc'
        - "'content' in _vconsole_verify_openrc"

    - name: Stat /etc/conf.d/keymaps (openrc)
      ansible.builtin.stat:
        path: /etc/conf.d/keymaps
      register: vconsole_verify_stat_openrc
      when: ansible_facts['service_mgr'] == 'openrc'

    - name: Assert /etc/conf.d/keymaps permissions (openrc)
      ansible.builtin.assert:
        that:
          - vconsole_verify_stat_openrc.stat.exists
          - vconsole_verify_stat_openrc.stat.pw_name == 'root'
          - vconsole_verify_stat_openrc.stat.mode == '0644'
        fail_msg: "/etc/conf.d/keymaps wrong permissions"
      when: ansible_facts['service_mgr'] == 'openrc'

    # ---- Runit: /etc/rc.conf ----

    - name: Slurp /etc/rc.conf
      ansible.builtin.slurp:
        src: /etc/rc.conf
      register: _vconsole_verify_runit
      when: ansible_facts['service_mgr'] == 'runit'

    - name: Assert slurp /etc/rc.conf succeeded
      ansible.builtin.assert:
        that:
          - "'content' in _vconsole_verify_runit"
        fail_msg: "Failed to read /etc/rc.conf"
      when: ansible_facts['service_mgr'] == 'runit'

    - name: Assert KEYMAP is set (runit)
      ansible.builtin.assert:
        that:
          - (_vconsole_verify_runit.content | b64decode) is regex('^KEYMAP=' + _vconsole_verify_keymap + '$', multiline=True)
        fail_msg: "KEYMAP={{ _vconsole_verify_keymap }} not found in /etc/rc.conf"
      when:
        - ansible_facts['service_mgr'] == 'runit'
        - "'content' in _vconsole_verify_runit"

    - name: Stat /etc/rc.conf (runit)
      ansible.builtin.stat:
        path: /etc/rc.conf
      register: vconsole_verify_stat_runit
      when: ansible_facts['service_mgr'] == 'runit'

    - name: Assert /etc/rc.conf permissions (runit)
      ansible.builtin.assert:
        that:
          - vconsole_verify_stat_runit.stat.exists
          - vconsole_verify_stat_runit.stat.pw_name == 'root'
          - vconsole_verify_stat_runit.stat.mode == '0644'
        fail_msg: "/etc/rc.conf wrong permissions"
      when: ansible_facts['service_mgr'] == 'runit'

    # ---- Summary ----

    - name: Show verify result
      ansible.builtin.debug:
        msg: >-
          vconsole verify passed:
          keymap={{ _vconsole_verify_keymap }},
          font={{ _vconsole_verify_font | default('none') }},
          gpm={{ _vconsole_verify_gpm_enabled }},
          init={{ ansible_facts['service_mgr'] }}
