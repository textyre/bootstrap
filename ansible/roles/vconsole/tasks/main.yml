---
# === Console keymap — диспетчер по init-системе ===
# validate → Настройка → Проверка → Логирование
# Диспатч через with_first_found (без when для выбора init)

# ---- Валидация ----

- name: Validate vconsole configuration
  ansible.builtin.include_tasks: validate/main.yml
  tags: ['vconsole']

# ---- Custom keymap file ----

- name: Prepare custom keymap file
  ansible.builtin.include_tasks: map.yml
  tags: ['vconsole']

# ---- Font package ----

- name: Install console font
  ansible.builtin.include_tasks: font.yml
  tags: ['vconsole']

# ---- Настройка keymap ----

- name: Configure console keymap ({{ ansible_facts['service_mgr'] }})
  ansible.builtin.include_tasks: "{{ item }}"
  with_first_found:
    - files:
        - "init/{{ ansible_facts['service_mgr'] }}.yml"
      skip: true
  tags: ['vconsole']

- name: Warn about unsupported init system for keymap
  ansible.builtin.debug:
    msg: >-
      WARNING: Console keymap skipped — init system
      '{{ ansible_facts['service_mgr'] }}' not supported.
      Supported: {{ vconsole_supported_inits | join(', ') }}.
  when: ansible_facts['service_mgr'] not in vconsole_supported_inits
  tags: ['vconsole']

# ---- GPM ----

- name: Configure GPM (mouse in TTY)
  ansible.builtin.include_tasks: gpm.yml
  when: vconsole_gpm_enabled
  tags: ['vconsole']

# ---- Проверка ----

- name: Verify console keymap
  ansible.builtin.include_tasks: "{{ item }}"
  with_first_found:
    - files:
        - "verify/{{ ansible_facts['service_mgr'] }}.yml"
      skip: true
  tags: ['vconsole']

# ---- Логирование ----

- name: "Report: Console keymap"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_phase.yml
  vars:
    common_rpt_fact: "_vconsole_phases"
    common_rpt_phase: "Console keymap"
    common_rpt_status: "{{ 'done' if ansible_facts['service_mgr'] in vconsole_supported_inits else 'skip' }}"
    common_rpt_detail: "{{ vconsole_console }} ({{ ansible_facts['service_mgr'] }})"
  tags: ['vconsole', 'report']

- name: "Vconsole — Execution Report"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_render.yml
  vars:
    common_rpt_fact: "_vconsole_phases"
    common_rpt_title: "vconsole"
  tags: ['vconsole', 'report']
