---
- name: Verify
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/inventory/group_vars/all/vault.yml"

  tasks:
    # ---- git installed ----

    - name: Verify git is installed
      ansible.builtin.command:
        cmd: git --version
      register: git_verify_installed
      changed_when: false
      failed_when: git_verify_installed.rc != 0

    # ---- base config ----

    - name: Check git user.name  # noqa: command-instead-of-module
      become: true
      become_user: "{{ git_owner.name }}"
      ansible.builtin.command: git config --global --get user.name
      register: git_verify_username
      changed_when: false
      failed_when: git_verify_username.stdout != git_owner.user_name

    - name: Check git user.email  # noqa: command-instead-of-module
      become: true
      become_user: "{{ git_owner.name }}"
      ansible.builtin.command: git config --global --get user.email
      register: git_verify_email
      changed_when: false
      failed_when: git_verify_email.stdout != git_owner.user_email

    - name: Check git init.defaultBranch  # noqa: command-instead-of-module
      become: true
      become_user: "{{ git_owner.name }}"
      ansible.builtin.command: git config --global --get init.defaultBranch
      register: git_verify_branch
      changed_when: false
      failed_when: git_verify_branch.stdout != 'main'

    - name: Check git core.editor  # noqa: command-instead-of-module
      become: true
      become_user: "{{ git_owner.name }}"
      ansible.builtin.command: git config --global --get core.editor
      register: git_verify_editor
      changed_when: false
      failed_when: git_verify_editor.stdout != 'vim'

    - name: Check git pull.rebase  # noqa: command-instead-of-module
      become: true
      become_user: "{{ git_owner.name }}"
      ansible.builtin.command: git config --global --get pull.rebase
      register: git_verify_rebase
      changed_when: false
      failed_when: git_verify_rebase.stdout != 'true'

    - name: Check git push.autoSetupRemote  # noqa: command-instead-of-module
      become: true
      become_user: "{{ git_owner.name }}"
      ansible.builtin.command: git config --global --get push.autoSetupRemote
      register: git_verify_autosetup
      changed_when: false
      failed_when: git_verify_autosetup.stdout != 'true'

    - name: Check git core.autocrlf  # noqa: command-instead-of-module
      become: true
      become_user: "{{ git_owner.name }}"
      ansible.builtin.command: git config --global --get core.autocrlf
      register: git_verify_autocrlf
      changed_when: false
      failed_when: git_verify_autocrlf.stdout != 'input'

    # ---- extra config ----

    - name: Check color.ui  # noqa: command-instead-of-module
      become: true
      become_user: "{{ git_owner.name }}"
      ansible.builtin.command: git config --global --get color.ui
      register: git_verify_color_ui
      changed_when: false
      failed_when: git_verify_color_ui.stdout != 'auto'

    - name: Check diff.colorMoved  # noqa: command-instead-of-module
      become: true
      become_user: "{{ git_owner.name }}"
      ansible.builtin.command: git config --global --get diff.colorMoved
      register: git_verify_colormoved
      changed_when: false
      failed_when: git_verify_colormoved.stdout != 'zebra'

    # ---- safe.directory ----

    - name: Check safe.directory entries  # noqa: command-instead-of-module
      become: true
      become_user: "{{ git_owner.name }}"
      ansible.builtin.command: git config --global --get-all safe.directory
      register: git_verify_safe_dirs
      changed_when: false
      failed_when: "'/tmp/test-safe-dir' not in git_verify_safe_dirs.stdout_lines"

    # ---- aliases ----

    - name: Check alias.st exists  # noqa: command-instead-of-module
      become: true
      become_user: "{{ git_owner.name }}"
      ansible.builtin.command: git config --global --get alias.st
      register: git_verify_alias_st
      changed_when: false
      failed_when: git_verify_alias_st.stdout != 'status'

    - name: Check alias.lg exists  # noqa: command-instead-of-module
      become: true
      become_user: "{{ git_owner.name }}"
      ansible.builtin.command: git config --global --get alias.lg
      register: git_verify_alias_lg
      changed_when: false
      failed_when: git_verify_alias_lg.rc != 0

    # ---- credential helper ----

    - name: Check credential.helper  # noqa: command-instead-of-module
      become: true
      become_user: "{{ git_owner.name }}"
      ansible.builtin.command: git config --global --get credential.helper
      register: git_verify_credential
      changed_when: false
      failed_when: "'cache' not in git_verify_credential.stdout"

    # ---- git-lfs ----

    - name: Check git-lfs is installed
      ansible.builtin.command:
        cmd: git lfs version
      register: git_verify_lfs
      changed_when: false
      failed_when: git_verify_lfs.rc != 0

    # ---- hooks directory ----

    - name: Check hooks directory exists
      ansible.builtin.stat:
        path: /tmp/test-git-hooks
      register: git_verify_hooks

    - name: Assert hooks directory exists
      ansible.builtin.assert:
        that:
          - git_verify_hooks.stat.exists
          - git_verify_hooks.stat.isdir
        fail_msg: "Global hooks directory /tmp/test-git-hooks does not exist"

    # ---- report ----

    - name: Show verify results
      ansible.builtin.debug:
        msg:
          - "All git role checks passed!"
          - "user.name = {{ git_verify_username.stdout }}"
          - "user.email = {{ git_verify_email.stdout }}"
          - "init.defaultBranch = {{ git_verify_branch.stdout }}"
          - "core.editor = {{ git_verify_editor.stdout }}"
          - "pull.rebase = {{ git_verify_rebase.stdout }}"
          - "alias.st = {{ git_verify_alias_st.stdout }}"
          - "color.ui = {{ git_verify_color_ui.stdout }}"
          - "diff.colorMoved = {{ git_verify_colormoved.stdout }}"
          - "safe.directory = {{ git_verify_safe_dirs.stdout_lines }}"
          - "credential.helper = {{ git_verify_credential.stdout }}"
          - "git-lfs = installed"
          - "hooks dir = /tmp/test-git-hooks exists"
