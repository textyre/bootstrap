# ansible/roles/ssh_keys/tasks/keygen.yml
---
# === Generate SSH keypairs on target machines ===
# Moved from ssh role â€” generates user-side keys (not host keys).

- name: "Generate SSH keypairs for present users"
  block:
    - name: "Get user home directory"
      ansible.builtin.getent:
        database: passwd
        key: "{{ item.name }}"
      loop: >-
        {{ ssh_keys_users
           | selectattr('state', 'defined')
           | selectattr('state', 'equalto', 'present')
           | list }}
      loop_control:
        label: "{{ item.name }}"
      register: ssh_keys_user_info
      tags: [ssh_keys]

    - name: "Ensure .ssh directory exists"
      ansible.builtin.file:
        path: "{{ getent_passwd[item.name][4] }}/.ssh"
        state: directory
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: "0700"
      loop: >-
        {{ ssh_keys_users
           | selectattr('state', 'defined')
           | selectattr('state', 'equalto', 'present')
           | list }}
      loop_control:
        label: "{{ item.name }}"
      tags: [ssh_keys]

    - name: "Generate SSH key pair ({{ ssh_keys_key_type }})"
      community.crypto.openssh_keypair:
        path: "{{ getent_passwd[item.name][4] }}/.ssh/id_{{ ssh_keys_key_type }}"
        type: "{{ ssh_keys_key_type }}"
        comment: "{{ item.name }}@{{ ansible_hostname }}"
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: "0600"
      loop: >-
        {{ ssh_keys_users
           | selectattr('state', 'defined')
           | selectattr('state', 'equalto', 'present')
           | list }}
      loop_control:
        label: "{{ item.name }}"
      tags: [ssh_keys]
