# ansible/roles/ssh_keys/molecule/default/verify.yml
---
- name: Verify ssh_keys role
  hosts: all
  become: true
  tasks:
    - name: "Verify .ssh directory exists"
      ansible.builtin.stat:
        path: "/home/{{ ansible_user_id }}/.ssh"
      register: ssh_keys_verify_ssh_dir

    - name: "Assert .ssh directory has 0700 permissions"
      ansible.builtin.assert:
        that:
          - ssh_keys_verify_ssh_dir.stat.exists
          - ssh_keys_verify_ssh_dir.stat.mode == '0700'

    - name: "Verify authorized_keys exists"
      ansible.builtin.stat:
        path: "/home/{{ ansible_user_id }}/.ssh/authorized_keys"
      register: ssh_keys_verify_authkeys

    - name: "Assert authorized_keys exists and has correct permissions"
      ansible.builtin.assert:
        that:
          - ssh_keys_verify_authkeys.stat.exists
          - ssh_keys_verify_authkeys.stat.mode == '0600'

    - name: "Check authorized_keys contains test key"
      ansible.builtin.command:
        cmd: "grep -c 'test@molecule' /home/{{ ansible_user_id }}/.ssh/authorized_keys"
      register: ssh_keys_verify_key_content
      changed_when: false
      failed_when: ssh_keys_verify_key_content.rc != 0
