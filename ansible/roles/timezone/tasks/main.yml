---
# === Таймзона ===
# Установка системной таймзоны
# Дистро-агностик, инит-агностик
# Действие → Проверка → Логирование

# ======================================================================
# ---- Установка tzdata ----
# ======================================================================

- name: Install tzdata
  ansible.builtin.package:
    name: "{{ timezone_packages_tzdata[ansible_facts['os_family']] | default(timezone_packages_tzdata.get('default', 'tzdata')) }}"
    state: present
  when: timezone_packages_tzdata is defined
  tags: ['timezone']

# ======================================================================
# ---- Установка таймзоны ----
# ======================================================================

- name: Set timezone
  community.general.timezone:
    name: "{{ timezone_name }}"
  notify: restart cron
  tags: ['timezone']

# ======================================================================
# ---- Проверка ----
# ======================================================================

- name: Verify timezone symlink
  ansible.builtin.command: readlink -f /etc/localtime
  register: timezone_check
  changed_when: false
  tags: ['timezone']

- name: Assert timezone matches expected value
  ansible.builtin.assert:
    that: timezone_name in timezone_check.stdout
    fail_msg: "Timezone mismatch: got '{{ timezone_check.stdout }}', expected '{{ timezone_name }}'"
    quiet: true
  tags: ['timezone']

# ======================================================================
# ---- Отчёт ----
# ======================================================================

- name: "Report: Set timezone"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_phase.yml
  vars:
    common_rpt_fact: "_timezone_phases"
    common_rpt_phase: "Set timezone"
    common_rpt_detail: "{{ timezone_name }}"
  tags: ['timezone', 'report']

- name: "Timezone — Execution Report"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_render.yml
  vars:
    common_rpt_fact: "_timezone_phases"
    common_rpt_title: "timezone"
  tags: ['timezone', 'report']
