---
# === Таймзона ===
# Установка системной таймзоны
# Дистро-агностик, инит-агностик
# Действие → Проверка → Логирование

# ======================================================================
# ---- Установка tzdata ----
# ======================================================================

- name: Install tzdata
  ansible.builtin.package:
    name: "{{ packages_tzdata[ansible_facts['os_family']] | default(packages_tzdata['default']) }}"
    state: present
  when: packages_tzdata is defined
  tags: ['timezone']

# ======================================================================
# ---- Установка таймзоны ----
# ======================================================================

- name: Set timezone
  community.general.timezone:
    name: "{{ timezone_name }}"
  notify: restart cron
  tags: ['timezone']

# ======================================================================
# ---- Проверка ----
# ======================================================================

- name: Verify timezone
  ansible.builtin.include_tasks:
    file: "verify/{{ 'systemd' if ansible_facts['service_mgr'] == 'systemd' else 'generic' }}.yml"
  tags: ['timezone']

# ======================================================================
# ---- Отчёт ----
# ======================================================================

- name: "Report: Set timezone"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_phase.yml
  vars:
    _rpt_fact: "_timezone_phases"
    _rpt_phase: "Set timezone"
    _rpt_detail: "{{ timezone_name }}"
  tags: ['timezone', 'report']

- name: "timezone — Execution Report"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_render.yml
  vars:
    _rpt_fact: "_timezone_phases"
    _rpt_title: "timezone"
  tags: ['timezone', 'report']
