---
# === AUR package installation via kewlfft.aur ===
# Uses yay backend â€” handles deps, caching, and resolution.
# Requires NOPASSWD sudoers for pacman (configured in configure-sudoers.yml).

- name: Build combined official package list (for conflict validation)
  ansible.builtin.set_fact:
    _yay_packages_all: >-
      {{ packages_base
         + packages_editors
         + packages_docker
         + packages_xorg
         + packages_wm
         + packages_filemanager
         + packages_network
         + packages_media
         + packages_desktop
         + packages_graphics
         + packages_session
         + packages_terminal
         + packages_fonts
         + packages_theming
         + packages_search
         + packages_viewers
         + (packages_distro[ansible_facts['os_family']] | default([])) }}
  tags: ['install', 'aur']

- name: Remove packages conflicting with AUR replacements
  community.general.pacman:
    name: "{{ packages_aur_remove_conflicts }}"
    state: absent
  when: packages_aur_remove_conflicts | length > 0
  tags: ['install', 'aur']

- name: Validate AUR packages don't conflict with official packages
  ansible.builtin.script:
    cmd: validate-aur-conflicts.sh
  environment:
    AUR_PACKAGES: "{{ packages_aur | join('\n') }}"
    OFFICIAL_PACKAGES: "{{ _yay_packages_all | join('\n') }}"
    CONFLICT_EXCEPTIONS: "{{ packages_aur_remove_conflicts | join('\n') }}"
  changed_when: false
  tags: ['install', 'aur']

- name: Install AUR packages
  kewlfft.aur.aur:
    name: "{{ packages_aur }}"
    use: yay
    state: present
  become: true
  become_user: "{{ yay_build_user }}"
  tags: ['install', 'aur']
