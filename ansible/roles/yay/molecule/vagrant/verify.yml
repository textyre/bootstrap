---
- name: Verify yay role
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - ../../defaults/main.yml

  tasks:

    - name: Skip verify on non-Arch systems (yay is AUR helper for Arch only)
      ansible.builtin.meta: end_host
      when: ansible_facts['os_family'] != 'Archlinux'

    # ---- aur_builder user ----

    - name: Check that aur_builder user exists
      ansible.builtin.getent:
        database: passwd
        key: "{{ yay_builder_user }}"
      register: yay_verify_aur_builder

    - name: Assert aur_builder has nologin shell
      ansible.builtin.assert:
        that:
          - yay_verify_aur_builder.ansible_facts.getent_passwd[yay_builder_user][5] == '/usr/bin/nologin'
        fail_msg: >-
          aur_builder shell is '{{ yay_verify_aur_builder.ansible_facts.getent_passwd[yay_builder_user][5] }}',
          expected '/usr/bin/nologin'

    - name: Assert aur_builder is a system user (UID < 1000)
      ansible.builtin.assert:
        that:
          - yay_verify_aur_builder.ansible_facts.getent_passwd[yay_builder_user][1] | int < 1000
        fail_msg: >-
          aur_builder UID is {{ yay_verify_aur_builder.ansible_facts.getent_passwd[yay_builder_user][1] }},
          expected < 1000 (system user)

    # ---- sudoers ----

    - name: Stat sudoers drop-in file
      ansible.builtin.stat:
        path: "/etc/sudoers.d/{{ yay_builder_sudoers_file }}"
      register: yay_verify_sudoers

    - name: Assert sudoers file exists
      ansible.builtin.assert:
        that: yay_verify_sudoers.stat.exists
        fail_msg: "/etc/sudoers.d/{{ yay_builder_sudoers_file }} does not exist"

    - name: Assert sudoers file has correct permissions
      ansible.builtin.assert:
        that:
          - yay_verify_sudoers.stat.mode == '0440'
          - yay_verify_sudoers.stat.pw_name == 'root'
          - yay_verify_sudoers.stat.gr_name == 'root'
        fail_msg: >-
          /etc/sudoers.d/{{ yay_builder_sudoers_file }} permissions incorrect:
          mode={{ yay_verify_sudoers.stat.mode }} owner={{ yay_verify_sudoers.stat.pw_name }}
          group={{ yay_verify_sudoers.stat.gr_name }} (expected 0440 root:root)

    - name: Validate sudoers syntax
      ansible.builtin.command: /usr/sbin/visudo -cf "/etc/sudoers.d/{{ yay_builder_sudoers_file }}"
      changed_when: false

    - name: Read sudoers file content
      ansible.builtin.slurp:
        src: "/etc/sudoers.d/{{ yay_builder_sudoers_file }}"
      register: yay_verify_sudoers_raw

    - name: Assert sudoers grants NOPASSWD pacman only
      ansible.builtin.assert:
        that:
          - "'NOPASSWD: /usr/bin/pacman' in (yay_verify_sudoers_raw.content | b64decode)"
          - "yay_builder_user in (yay_verify_sudoers_raw.content | b64decode)"
        fail_msg: >-
          Sudoers content does not match expected pattern.
          Expected '{{ yay_builder_user }} ALL=(root) NOPASSWD: /usr/bin/pacman'

    # ---- build dependencies ----

    - name: Check that build dependencies are installed
      ansible.builtin.package:
        name: "{{ item }}"
        state: present
      check_mode: true
      register: yay_verify_dep_check
      failed_when: yay_verify_dep_check is changed
      loop: "{{ yay_build_deps }}"

    # ---- yay binary ----

    - name: Check that yay binary exists
      ansible.builtin.command: which yay
      changed_when: false
      register: yay_verify_path

    - name: Assert yay is at /usr/bin/yay
      ansible.builtin.assert:
        that: "'/usr/bin/yay' in yay_verify_path.stdout"
        fail_msg: "yay binary not at expected path /usr/bin/yay (got: {{ yay_verify_path.stdout }})"

    - name: Check that yay is executable and reports version
      ansible.builtin.command: yay --version
      changed_when: false
      register: yay_verify_version

    - name: Assert yay version output is valid
      ansible.builtin.assert:
        that: "'yay' in yay_verify_version.stdout"
        fail_msg: "yay --version did not produce expected output: {{ yay_verify_version.stdout }}"

    - name: Check that yay has no broken shared libs
      ansible.builtin.command: ldd /usr/bin/yay
      changed_when: false
      register: yay_verify_ldd
      failed_when: "'not found' in yay_verify_ldd.stdout"

    # ---- build cleanup ----

    - name: Check that temp build directories were cleaned up
      ansible.builtin.find:
        paths: /tmp
        patterns: "yay_build_*"
        file_type: directory
      register: yay_verify_build_dirs

    - name: Assert no leftover build directories
      ansible.builtin.assert:
        that: yay_verify_build_dirs.matched == 0
        fail_msg: >-
          Found {{ yay_verify_build_dirs.matched }} leftover build directories in /tmp:
          {{ yay_verify_build_dirs.files | map(attribute='path') | list }}

    # ---- AUR packages (conditional -- only when yay_packages_aur is set) ----

    - name: Check that AUR packages are installed
      ansible.builtin.command: "pacman -Q {{ item }}"
      loop: "{{ yay_packages_aur }}"
      changed_when: false
      when: yay_packages_aur | default([]) | length > 0

    # ---- aur_builder can execute yay (functional test) ----

    - name: Verify aur_builder can run yay --version
      ansible.builtin.command: yay --version
      become: true
      become_user: "{{ yay_builder_user }}"
      changed_when: false
      register: yay_verify_builder_exec

    - name: Assert aur_builder yay execution succeeded
      ansible.builtin.assert:
        that: yay_verify_builder_exec.rc == 0
        fail_msg: >-
          aur_builder cannot execute yay (rc={{ yay_verify_builder_exec.rc }}).
          This may indicate permission or PATH issues.

    # ---- summary ----

    - name: Show verify results
      ansible.builtin.debug:
        msg:
          - "All yay role checks passed!"
          - "aur_builder: user exists, UID < 1000, shell=/usr/bin/nologin"
          - "sudoers: /etc/sudoers.d/{{ yay_builder_sudoers_file }} (0440, root:root, valid syntax)"
          - "yay binary: {{ yay_verify_path.stdout }}"
          - "yay version: {{ yay_verify_version.stdout }}"
          - "yay ldd: OK (no broken shared libs)"
          - "Build deps: {{ yay_build_deps | join(', ') }} installed"
          - "Temp build dirs: cleaned up (0 found)"
          - "AUR packages: {{ yay_packages_aur | default([]) | join(', ') | default('(none -- skipped)', true) }}"
          - "aur_builder can execute yay: yes"
