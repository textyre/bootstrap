---
- name: Verify zen_browser role
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "../../defaults/main.yml"

  tasks:

    # ---- Platform guard ----

    - name: Assert we are on Arch Linux
      ansible.builtin.assert:
        that: ansible_facts['os_family'] == 'Archlinux'
        fail_msg: "zen_browser verify requires Arch Linux"

    # ---- Binary exists ----

    - name: Check zen-browser binary exists
      ansible.builtin.command: which zen-browser
      register: _zen_verify_bin
      changed_when: false

    - name: Assert zen-browser binary is in PATH
      ansible.builtin.assert:
        that: _zen_verify_bin.rc == 0
        fail_msg: "zen-browser binary not found in PATH"

    - name: Assert zen-browser binary is at expected path
      ansible.builtin.assert:
        that: _zen_verify_bin.stdout == '/usr/bin/zen-browser'
        fail_msg: >-
          zen-browser found at '{{ _zen_verify_bin.stdout }}'
          but expected '/usr/bin/zen-browser'

    # ---- Package registered with pacman ----

    - name: Check zen-browser-bin package is installed
      ansible.builtin.command: "pacman -Qi {{ zen_browser_aur_package }}"
      register: _zen_verify_pkg
      changed_when: false

    - name: Assert package is registered with pacman
      ansible.builtin.assert:
        that: _zen_verify_pkg.rc == 0
        fail_msg: "{{ zen_browser_aur_package }} package not registered with pacman"

    # ---- Desktop entry file exists ----

    - name: Stat desktop entry file
      ansible.builtin.stat:
        path: "/usr/share/applications/{{ zen_browser_desktop_file }}"
      register: _zen_verify_desktop

    - name: Assert desktop entry file exists
      ansible.builtin.assert:
        that:
          - _zen_verify_desktop.stat.exists
          - _zen_verify_desktop.stat.isreg
        fail_msg: >-
          Desktop entry /usr/share/applications/{{ zen_browser_desktop_file }}
          does not exist

    # ---- Desktop entry file content ----

    - name: Read desktop entry file
      ansible.builtin.slurp:
        src: "/usr/share/applications/{{ zen_browser_desktop_file }}"
      register: _zen_verify_desktop_raw

    - name: Set desktop entry text fact
      ansible.builtin.set_fact:
        _zen_verify_desktop_text: "{{ _zen_verify_desktop_raw.content | b64decode }}"

    - name: Assert desktop entry contains required keys
      ansible.builtin.assert:
        that:
          - "'[Desktop Entry]' in _zen_verify_desktop_text"
          - "'Type=Application' in _zen_verify_desktop_text"
          - "'Exec=' in _zen_verify_desktop_text"
          - "'Name=' in _zen_verify_desktop_text"
        fail_msg: >-
          Desktop entry file is missing required keys
          ([Desktop Entry], Type, Exec, Name)

    # ---- SUDO_ASKPASS helper cleaned up ----

    - name: Stat temporary SUDO_ASKPASS helper
      ansible.builtin.stat:
        path: /tmp/.ansible_sudo_askpass_zen
      register: _zen_verify_askpass

    - name: Assert SUDO_ASKPASS helper was removed
      ansible.builtin.assert:
        that: not _zen_verify_askpass.stat.exists
        fail_msg: >-
          Temporary SUDO_ASKPASS helper /tmp/.ansible_sudo_askpass_zen
          was not cleaned up (security risk)

    # ---- Summary ----

    - name: Show verify result
      ansible.builtin.debug:
        msg:
          - "All zen_browser checks passed!"
          - "zen-browser binary: {{ _zen_verify_bin.stdout }}"
          - "{{ zen_browser_aur_package }} package: installed"
          - "Desktop entry: /usr/share/applications/{{ zen_browser_desktop_file }}"
          - "SUDO_ASKPASS cleanup: verified"
