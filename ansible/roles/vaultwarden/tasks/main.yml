---
# === Vaultwarden (Self-hosted Bitwarden) ===
# Менеджер паролей и секретов

# ---- Директории ----

- name: Create Vaultwarden base directory
  ansible.builtin.file:
    path: "{{ vaultwarden_base_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: vaultwarden_enabled
  tags: ['vaultwarden', 'secrets']

- name: Create Vaultwarden data directory
  ansible.builtin.file:
    path: "{{ vaultwarden_base_dir }}/data"
    state: directory
    owner: root
    group: root
    mode: '0700'
  when: vaultwarden_enabled
  tags: ['vaultwarden', 'secrets']

- name: Create Vaultwarden backup directory
  ansible.builtin.file:
    path: "{{ vaultwarden_backup_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: vaultwarden_enabled
  tags: ['vaultwarden', 'secrets']

# ---- DNS (локальный доступ) ----

- name: Add Vaultwarden domain to /etc/hosts
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '.*\s{{ vaultwarden_domain | regex_escape }}$'
    line: "127.0.0.1 {{ vaultwarden_domain }}"
    state: present
  when: vaultwarden_enabled
  tags: ['vaultwarden', 'secrets']

# ---- Admin token (генерация при первом запуске) ----

- name: Check if admin token file exists
  ansible.builtin.stat:
    path: "{{ vaultwarden_base_dir }}/.admin_token"
  register: vaultwarden_token_file
  when: vaultwarden_enabled and vaultwarden_admin_enabled
  tags: ['vaultwarden', 'secrets']

- name: Generate admin token
  ansible.builtin.shell:
    cmd: openssl rand -base64 48 > {{ vaultwarden_base_dir }}/.admin_token
    creates: "{{ vaultwarden_base_dir }}/.admin_token"
  when: vaultwarden_enabled and vaultwarden_admin_enabled and not (_vaultwarden_token_file.stat.exists | default(false))
  tags: ['vaultwarden', 'secrets']

- name: Restrict admin token file permissions
  ansible.builtin.file:
    path: "{{ vaultwarden_base_dir }}/.admin_token"
    owner: root
    group: root
    mode: '0600'
  when: vaultwarden_enabled and vaultwarden_admin_enabled
  tags: ['vaultwarden', 'secrets']

- name: Read admin token
  ansible.builtin.slurp:
    src: "{{ vaultwarden_base_dir }}/.admin_token"
  register: vaultwarden_admin_token_raw
  when: vaultwarden_enabled and vaultwarden_admin_enabled
  tags: ['vaultwarden', 'secrets']

- name: Set admin token fact
  ansible.builtin.set_fact:
    vaultwarden_admin_token: "{{ vaultwarden_admin_token_raw.content | b64decode | trim }}"
  when: vaultwarden_enabled and vaultwarden_admin_enabled
  tags: ['vaultwarden', 'secrets']

# ---- Docker Compose ----

- name: Deploy Vaultwarden docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ vaultwarden_base_dir }}/docker-compose.yml"
    owner: root
    group: root
    mode: '0644'
  notify: Restart vaultwarden
  when: vaultwarden_enabled
  tags: ['vaultwarden', 'secrets']

# ---- Caddy site config ----

- name: Deploy Vaultwarden Caddy site config
  ansible.builtin.template:
    src: vault.caddy.j2
    dest: "{{ caddy_base_dir | default('/opt/caddy') }}/sites/vault.caddy"
    owner: root
    group: root
    mode: '0644'
  notify: Reload caddy
  when: vaultwarden_enabled
  tags: ['vaultwarden', 'secrets']

# ---- Запуск ----

- name: Start Vaultwarden containers
  community.docker.docker_compose_v2:
    project_src: "{{ vaultwarden_base_dir }}"
    state: present
  when: vaultwarden_enabled
  tags: ['vaultwarden', 'secrets']

# ---- Бэкап ----

- name: Deploy Vaultwarden backup script
  ansible.builtin.template:
    src: vaultwarden-backup.sh.j2
    dest: "{{ vaultwarden_base_dir }}/backup.sh"
    owner: root
    group: root
    mode: '0700'
  when: vaultwarden_enabled and vaultwarden_backup_enabled
  tags: ['vaultwarden', 'secrets']

- name: Ensure cronie service is enabled
  ansible.builtin.service:
    name: cronie
    enabled: true
    state: started
  when: vaultwarden_enabled and vaultwarden_backup_enabled
  tags: ['vaultwarden', 'secrets']

- name: Configure Vaultwarden backup cron job
  ansible.builtin.cron:
    name: "Vaultwarden backup"
    hour: "{{ vaultwarden_backup_cron_hour }}"
    minute: "{{ vaultwarden_backup_cron_minute }}"
    job: "{{ vaultwarden_base_dir }}/backup.sh"
    user: root
  when: vaultwarden_enabled and vaultwarden_backup_enabled
  tags: ['vaultwarden', 'secrets']
