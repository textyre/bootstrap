---
- name: Prepare Vagrant VM
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Update pacman package cache
      community.general.pacman:
        update_cache: true

    - name: Install Docker and prerequisites
      community.general.pacman:
        name:
          - docker
          - docker-compose
          - openssl
          - cronie
          - sqlite3
        state: present

    - name: Enable and start Docker service
      ansible.builtin.service:
        name: docker
        enabled: true
        state: started

    - name: Wait for Docker daemon to be ready
      ansible.builtin.command:
        cmd: docker info
      register: _prepare_docker_info
      retries: 10
      delay: 3
      until: _prepare_docker_info.rc == 0
      changed_when: false

    - name: Create Docker proxy network
      community.docker.docker_network:
        name: proxy
        state: present
