---
# === Arch Linux: конфигурация pacman ===

- name: Assert external cache config is valid
  ansible.builtin.assert:
    that:
      - package_manager_pacman_cache_root | length > 0
    msg: "package_manager_pacman_cache_root must be set when package_manager_pacman_external_cache is true"
  when: package_manager_pacman_external_cache
  tags: ['packages', 'pacman']

- name: Deploy pacman.conf from template
  ansible.builtin.template:
    src: archlinux/pacman.conf.j2
    dest: /etc/pacman.conf
    owner: root
    group: root
    mode: '0644'
    backup: true
  tags: ['packages', 'pacman']

- name: Setup external pacman cache
  when: package_manager_pacman_external_cache and package_manager_pacman_cache_root | length > 0
  tags: ['packages', 'pacman-cache']
  block:
    - name: Create pacman cache directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      loop:
        - "{{ package_manager_pacman_cache_root }}/var/lib/pacman/sync"
        - "{{ package_manager_pacman_cache_root }}/var/cache/pacman/pkg"
        - "{{ package_manager_pacman_cache_root }}/etc/pacman.d"

    - name: Check if alpm user exists
      ansible.builtin.getent:
        database: passwd
        key: alpm
      register: package_manager_alpm_user
      failed_when: false

    - name: Set alpm ownership on pacman cache dirs
      ansible.builtin.file:
        path: "{{ item }}"
        owner: root
        group: alpm
        state: directory
        mode: '2775'
      loop:
        - "{{ package_manager_pacman_cache_root }}/var/lib/pacman/sync"
        - "{{ package_manager_pacman_cache_root }}/var/cache/pacman/pkg"
        - "{{ package_manager_pacman_cache_root }}/etc/pacman.d"
      when: >
        package_manager_alpm_user.ansible_facts.getent_passwd is defined
        and 'alpm' in package_manager_alpm_user.ansible_facts.getent_passwd
