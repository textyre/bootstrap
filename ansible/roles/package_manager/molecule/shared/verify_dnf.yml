---
# ---- dnf.conf ----

- name: Stat /etc/dnf/dnf.conf
  ansible.builtin.stat:
    path: /etc/dnf/dnf.conf
  register: pm_verify_dnf_stat

- name: Assert /etc/dnf/dnf.conf exists with correct permissions
  ansible.builtin.assert:
    that:
      - pm_verify_dnf_stat.stat.exists
      - pm_verify_dnf_stat.stat.mode == '0644'
      - pm_verify_dnf_stat.stat.pw_name == 'root'
    fail_msg: "/etc/dnf/dnf.conf missing or wrong permissions"

- name: Read /etc/dnf/dnf.conf
  ansible.builtin.slurp:
    src: /etc/dnf/dnf.conf
  register: pm_verify_dnf_raw

- name: Set dnf.conf text fact
  ansible.builtin.set_fact:
    pm_verify_dnf_text: "{{ pm_verify_dnf_raw.content | b64decode }}"

- name: Assert dnf.conf managed by Ansible
  ansible.builtin.assert:
    that: "'Managed by Ansible' in pm_verify_dnf_text"
    fail_msg: "/etc/dnf/dnf.conf missing Ansible marker"

- name: Assert max_parallel_downloads value matches variable
  ansible.builtin.assert:
    that: >-
      'max_parallel_downloads=' ~ package_manager_dnf_parallel_downloads
      in pm_verify_dnf_text
    fail_msg: "max_parallel_downloads not set to {{ package_manager_dnf_parallel_downloads }}"

- name: Assert installonly_limit value matches variable
  ansible.builtin.assert:
    that: >-
      'installonly_limit=' ~ package_manager_dnf_installonly_limit
      in pm_verify_dnf_text
    fail_msg: "installonly_limit not set to {{ package_manager_dnf_installonly_limit }}"

- name: Assert fastestmirror setting present
  ansible.builtin.assert:
    that: "'fastestmirror=' in pm_verify_dnf_text"
    fail_msg: "fastestmirror directive missing from /etc/dnf/dnf.conf"
