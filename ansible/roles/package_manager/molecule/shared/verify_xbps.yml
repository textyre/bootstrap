---
# ---- xbps.conf ----

- name: Stat /etc/xbps.d/ansible.conf
  ansible.builtin.stat:
    path: /etc/xbps.d/ansible.conf
  register: pm_verify_xbps_stat

- name: Assert /etc/xbps.d/ansible.conf exists with correct permissions
  ansible.builtin.assert:
    that:
      - pm_verify_xbps_stat.stat.exists
      - pm_verify_xbps_stat.stat.mode == '0644'
      - pm_verify_xbps_stat.stat.pw_name == 'root'
    fail_msg: "/etc/xbps.d/ansible.conf missing or wrong permissions"

# ---- cache cleanup cron (when enabled) ----

- name: Read crontab for root (xbps cache cleanup)
  ansible.builtin.command:
    cmd: crontab -l -u root
  register: pm_verify_xbps_crontab
  changed_when: false
  failed_when: false
  when: package_manager_xbps_cache_cleanup_enabled | bool

- name: Assert xbps cache cleanup cron entry present
  ansible.builtin.assert:
    that: "'xbps-remove -O' in pm_verify_xbps_crontab.stdout"
    fail_msg: "xbps cache cleanup cron job not found in root crontab"
  when: package_manager_xbps_cache_cleanup_enabled | bool
