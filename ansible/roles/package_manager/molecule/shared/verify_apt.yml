---
# ---- apt parallel config ----

- name: Stat /etc/apt/apt.conf.d/10-ansible-parallel.conf
  ansible.builtin.stat:
    path: /etc/apt/apt.conf.d/10-ansible-parallel.conf
  register: pm_verify_apt_parallel_stat

- name: Assert apt parallel config exists with correct permissions
  ansible.builtin.assert:
    that:
      - pm_verify_apt_parallel_stat.stat.exists
      - pm_verify_apt_parallel_stat.stat.mode == '0644'
      - pm_verify_apt_parallel_stat.stat.pw_name == 'root'
    fail_msg: "/etc/apt/apt.conf.d/10-ansible-parallel.conf missing or wrong permissions"

- name: Read /etc/apt/apt.conf.d/10-ansible-parallel.conf
  ansible.builtin.slurp:
    src: /etc/apt/apt.conf.d/10-ansible-parallel.conf
  register: pm_verify_apt_parallel_raw

- name: Set apt parallel config text fact
  ansible.builtin.set_fact:
    pm_verify_apt_parallel_text: "{{ pm_verify_apt_parallel_raw.content | b64decode }}"

- name: Assert apt parallel config managed by Ansible
  ansible.builtin.assert:
    that: "'Managed by Ansible' in pm_verify_apt_parallel_text"
    fail_msg: "10-ansible-parallel.conf missing Ansible marker"

- name: Assert Queue-Mode directive present
  ansible.builtin.assert:
    that: "'Queue-Mode' in pm_verify_apt_parallel_text"
    fail_msg: "Queue-Mode directive missing from 10-ansible-parallel.conf"

- name: Assert Retries directive present
  ansible.builtin.assert:
    that: "'Retries' in pm_verify_apt_parallel_text"
    fail_msg: "Retries directive missing from 10-ansible-parallel.conf"

# ---- dpkg options ----

- name: Stat /etc/apt/apt.conf.d/20-ansible-dpkg.conf
  ansible.builtin.stat:
    path: /etc/apt/apt.conf.d/20-ansible-dpkg.conf
  register: pm_verify_dpkg_stat

- name: Assert dpkg config exists with correct permissions
  ansible.builtin.assert:
    that:
      - pm_verify_dpkg_stat.stat.exists
      - pm_verify_dpkg_stat.stat.mode == '0644'
      - pm_verify_dpkg_stat.stat.pw_name == 'root'
    fail_msg: "/etc/apt/apt.conf.d/20-ansible-dpkg.conf missing or wrong permissions"

- name: Read /etc/apt/apt.conf.d/20-ansible-dpkg.conf
  ansible.builtin.slurp:
    src: /etc/apt/apt.conf.d/20-ansible-dpkg.conf
  register: pm_verify_dpkg_raw

- name: Assert dpkg force-confdef option present (when enabled)
  ansible.builtin.assert:
    that: "'--force-confdef' in (pm_verify_dpkg_raw.content | b64decode)"
    fail_msg: "--force-confdef missing from 20-ansible-dpkg.conf"
  when: package_manager_apt_dpkg_force_confdef | bool

- name: Assert dpkg force-confold option present (when enabled)
  ansible.builtin.assert:
    that: "'--force-confold' in (pm_verify_dpkg_raw.content | b64decode)"
    fail_msg: "--force-confold missing from 20-ansible-dpkg.conf"
  when: package_manager_apt_dpkg_force_confold | bool
