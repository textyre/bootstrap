---
- name: Verify
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/inventory/group_vars/all/vault.yml"

  tasks:
    - name: Check web-greeter.yml exists
      ansible.builtin.stat:
        path: /etc/lightdm/web-greeter.yml
      register: greeter_verify_webgreeter
      failed_when: not _greeter_verify_webgreeter.stat.exists

    - name: Check ctOS theme directory exists
      ansible.builtin.stat:
        path: /usr/share/web-greeter/themes/ctos
      register: greeter_verify_theme_dir
      failed_when: not _greeter_verify_theme_dir.stat.exists

    - name: Check system-info.json exists
      ansible.builtin.stat:
        path: /usr/share/web-greeter/themes/ctos/system-info.json
      register: greeter_verify_sysinfo
      failed_when: not _greeter_verify_sysinfo.stat.exists

    - name: Validate system-info.json is valid JSON
      ansible.builtin.command: python3 -m json.tool /usr/share/web-greeter/themes/ctos/system-info.json
      changed_when: false

    - name: Check index.yml exists
      ansible.builtin.stat:
        path: /usr/share/web-greeter/themes/ctos/index.yml
      register: greeter_verify_index
      failed_when: not _greeter_verify_index.stat.exists

    - name: Show test results
      ansible.builtin.debug:
        msg:
          - "All checks passed!"
          - "web-greeter.yml deployed"
          - "ctOS theme directory exists"
          - "system-info.json valid"
          - "index.yml deployed"
