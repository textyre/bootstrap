---
# === System-level shell environment ===
# validate → install → chsh → xdg → global → verify → report

- name: Shell role
  tags: ['shell']
  block:

    # ======================================================================
    # ---- Resolve user home ----
    # ======================================================================

    - name: Get user home directory
      ansible.builtin.getent:
        database: passwd
        key: "{{ shell_user }}"
      tags: ['shell']

    - name: Set user home fact
      ansible.builtin.set_fact:
        shell_user_home: "{{ getent_passwd[shell_user][4] }}"
      tags: ['shell']

    # ======================================================================
    # ---- Load OS-specific vars ----
    # ======================================================================

    - name: Include OS-specific variables
      ansible.builtin.include_vars: "{{ ansible_facts['os_family'] | lower }}.yml"
      tags: ['shell']

    # ======================================================================
    # ---- Validation ----
    # ======================================================================

    - name: Validate shell configuration
      ansible.builtin.include_tasks: validate.yml
      tags: ['shell']

    # ======================================================================
    # ---- Install ----
    # ======================================================================

    - name: Install shell package
      ansible.builtin.include_tasks: install.yml
      tags: ['shell']

    # ======================================================================
    # ---- Login shell ----
    # ======================================================================

    - name: Set login shell
      ansible.builtin.include_tasks: chsh.yml
      tags: ['shell']

    # ======================================================================
    # ---- XDG directories ----
    # ======================================================================

    - name: Create XDG directories
      ansible.builtin.include_tasks: xdg.yml
      tags: ['shell']

    # ======================================================================
    # ---- Global config ----
    # ======================================================================

    - name: Deploy global shell configuration
      ansible.builtin.include_tasks: global.yml
      tags: ['shell']

    # ======================================================================
    # ---- Verification ----
    # ======================================================================

    - name: Verify shell configuration
      ansible.builtin.include_tasks: verify.yml
      tags: ['shell']

    # ======================================================================
    # ---- Report ----
    # ======================================================================

    - name: "shell — Execution Report"
      ansible.builtin.include_role:
        name: common
        tasks_from: report_render.yml
      vars:
        common_rpt_fact: "_shell_phases"
        common_rpt_title: "shell"
      tags: ['shell', 'report']
