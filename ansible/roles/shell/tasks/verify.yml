---
# === Shell â€” in-role verification (ROLE-005) ===

# ---- Login shell ----

- name: Get current login shell for {{ shell_user }}
  ansible.builtin.getent:
    database: passwd
    key: "{{ shell_user }}"
  tags: ['shell']

- name: Assert login shell is correct
  ansible.builtin.assert:
    that:
      - getent_passwd[shell_user][5] == _shell_bin[shell_type]
    fail_msg: >-
      Login shell for {{ shell_user }} is '{{ getent_passwd[shell_user][5] }}'
      but expected '{{ shell_bin[shell_type] }}'.
    quiet: true
  when: shell_set_login | bool
  tags: ['shell']

# ---- XDG directories ----

- name: Verify XDG directories exist
  ansible.builtin.stat:
    path: "{{ shell_user_home }}/{{ item }}"
  register: shell_verify_xdg
  loop: "{{ shell_xdg_dirs }}"
  tags: ['shell']

- name: Assert all XDG directories exist
  ansible.builtin.assert:
    that:
      - item.stat.exists
      - item.stat.isdir
    fail_msg: >-
      XDG directory '{{ item.item }}' does not exist or is not a directory.
    quiet: true
  loop: "{{ shell_verify_xdg.results }}"
  loop_control:
    label: "{{ item.item }}"
  tags: ['shell']

# ---- Global config: /etc/profile.d/ ----

- name: Verify /etc/profile.d/dev-paths.sh exists
  ansible.builtin.stat:
    path: /etc/profile.d/dev-paths.sh
  register: shell_verify_profiled
  when: shell_type in ['bash', 'zsh']
  tags: ['shell']

- name: Assert /etc/profile.d/dev-paths.sh exists
  ansible.builtin.assert:
    that:
      - shell_verify_profiled.stat.exists
    fail_msg: "/etc/profile.d/dev-paths.sh not found"
    quiet: true
  when: shell_type in ['bash', 'zsh']
  tags: ['shell']

# ---- Global config: /etc/zsh/zshenv ----

- name: Verify /etc/zsh/zshenv exists
  ansible.builtin.stat:
    path: /etc/zsh/zshenv
  register: shell_verify_zshenv
  when: shell_type == 'zsh'
  tags: ['shell']

- name: Assert /etc/zsh/zshenv exists
  ansible.builtin.assert:
    that:
      - shell_verify_zshenv.stat.exists
    fail_msg: "/etc/zsh/zshenv not found"
    quiet: true
  when: shell_type == 'zsh'
  tags: ['shell']

# ---- Global config: /etc/fish/conf.d/ ----

- name: Verify /etc/fish/conf.d/dev-paths.fish exists
  ansible.builtin.stat:
    path: /etc/fish/conf.d/dev-paths.fish
  register: shell_verify_fish
  when: shell_type == 'fish'
  tags: ['shell']

- name: Assert /etc/fish/conf.d/dev-paths.fish exists
  ansible.builtin.assert:
    that:
      - shell_verify_fish.stat.exists
    fail_msg: "/etc/fish/conf.d/dev-paths.fish not found"
    quiet: true
  when: shell_type == 'fish'
  tags: ['shell']

# ---- Report ----

- name: "Report: Verification"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_phase.yml
  vars:
    common_rpt_fact: "_shell_phases"
    common_rpt_phase: "Verify shell"
    common_rpt_detail: "all checks passed"
  tags: ['shell', 'report']
