---
# === Управление пользователем ===
# Создание/настройка пользователя, sudo, группы

- name: Install sudo (OS-specific)
  ansible.builtin.include_tasks: "install-{{ ansible_facts['os_family'] | lower }}.yml"
  tags: ['user', 'sudo', 'install']

- name: Ensure user exists with correct shell and groups
  ansible.builtin.user:
    name: "{{ user_name }}"
    shell: "{{ user_shell }}"
    groups: "{{ user_groups }}"
    append: true
    create_home: true
  tags: ['user']

- name: Ensure wheel group has sudo access with hardening
  ansible.builtin.copy:
    dest: /etc/sudoers.d/wheel
    content: |
      # Managed by Ansible
      %wheel ALL=(ALL:ALL) ALL
      Defaults timestamp_timeout=5
      Defaults use_pty
      Defaults logfile="/var/log/sudo.log"
    owner: root
    group: root
    mode: '0440'
    validate: '/usr/sbin/visudo -cf %s'
  when: user_create_sudo_rule
  tags: ['user', 'sudo', 'security']

- name: Report user configuration
  ansible.builtin.debug:
    msg:
      - "Пользователь: {{ user_name }}"
      - "Shell: {{ user_shell }}"
      - "Группы: {{ user_groups | join(', ') }}"
  tags: ['user']
