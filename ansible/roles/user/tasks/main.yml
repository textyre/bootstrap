---
# === Управление пользователем ===
# Создание/настройка пользователя, sudo, группы

- name: Install sudo (OS-specific)
  ansible.builtin.include_tasks: "install-{{ ansible_facts['os_family'] | lower }}.yml"
  tags: ['user', 'sudo', 'install']

- name: Ensure user exists with correct shell and groups
  ansible.builtin.user:
    name: "{{ user_name }}"
    shell: "{{ user_shell }}"
    groups: "{{ user_groups }}"
    append: true
    create_home: true
  tags: ['user']

- name: Deploy sudoers hardening configuration
  ansible.builtin.template:
    src: sudoers_hardening.j2
    dest: "/etc/sudoers.d/{{ user_sudo_group }}"
    owner: root
    group: root
    mode: '0440'
    validate: '/usr/sbin/visudo -cf %s'
  when: user_create_sudo_rule
  tags: ['user', 'sudo', 'security']

- name: Configure logrotate for sudo log
  ansible.builtin.template:
    src: sudo_logrotate.j2
    dest: /etc/logrotate.d/sudo
    owner: root
    group: root
    mode: '0644'
  when:
    - user_create_sudo_rule
    - user_sudo_logrotate_enabled
    - user_sudo_logfile | length > 0
  tags: ['user', 'sudo', 'security']

- name: Report user configuration
  ansible.builtin.debug:
    msg:
      - "Пользователь: {{ user_name }}"
      - "Shell: {{ user_shell }}"
      - "Группы: {{ user_groups | join(', ') }}"
  tags: ['user']
