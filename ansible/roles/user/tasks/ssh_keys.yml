---
# === SSH authorized_keys management ===

- name: "Ensure .ssh directory exists for users with SSH keys"
  ansible.builtin.file:
    path: "{{ '/root' if item.name == 'root' else '/home/' + item.name }}/.ssh"
    state: directory
    owner: "{{ item.name }}"
    mode: "0700"
  loop: "{{ [user_owner] + user_additional_users }}"
  when:
    - user_manage_ssh_keys | bool
    - item.ssh_keys is defined
    - item.ssh_keys | length > 0
  tags: [user, ssh]

- name: "Add SSH authorized keys"
  ansible.posix.authorized_key:
    user: "{{ item.0.name }}"
    key: "{{ item.1 }}"
    manage_dir: true
    state: present
  with_subelements:
    - "{{ [user_owner] + user_additional_users }}"
    - ssh_keys
    - skip_missing: true
  no_log: true
  when: user_manage_ssh_keys | bool
  tags: [user, ssh]
