---
# Molecule verify playbook
# Проверяет что роль правильно применилась к системе

- name: Verify
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/inventory/group_vars/all/vault.yml"

  tasks:
    - name: Check that reflector is installed
      ansible.builtin.package:
        name: reflector
        state: present
      check_mode: true
      register: _reflector_installed
      failed_when: _reflector_installed is changed

    - name: Check that reflector config exists
      ansible.builtin.stat:
        path: /etc/xdg/reflector/reflector.conf
      register: _reflector_conf
      failed_when: not _reflector_conf.stat.exists

    - name: Validate reflector config content
      ansible.builtin.slurp:
        src: /etc/xdg/reflector/reflector.conf
      register: __reflector_conf_content
      failed_when: >
        '--save' not in (__reflector_conf_content.content | b64decode) or
        '--protocol' not in (__reflector_conf_content.content | b64decode)

    - name: Check that timer override exists
      ansible.builtin.stat:
        path: /etc/systemd/system/reflector.timer.d/override.conf
      register: _reflector_timer_override
      failed_when: not _reflector_timer_override.stat.exists

    - name: Check that reflector.timer is enabled
      ansible.builtin.systemd:
        name: reflector.timer
        enabled: true
      check_mode: true
      register: _reflector_timer_enabled
      failed_when: _reflector_timer_enabled is changed

    - name: Check that reflector.timer is active
      ansible.builtin.systemd:
        name: reflector.timer
      register: _reflector_timer_status
      failed_when: _reflector_timer_status.status.ActiveState != 'active'

    - name: Check that mirrorlist exists and is not empty
      ansible.builtin.stat:
        path: /etc/pacman.d/mirrorlist
      register: _reflector_mirrorlist
      failed_when: >
        not _reflector_mirrorlist.stat.exists or
        _reflector_mirrorlist.stat.size == 0

    - name: Validate mirrorlist contains Server entries
      ansible.builtin.command: grep -c '^Server = ' /etc/pacman.d/mirrorlist
      register: _reflector_server_count
      changed_when: false
      failed_when: _reflector_server_count.stdout | int < 1

    - name: Show test results
      ansible.builtin.debug:
        msg:
          - "✅ All checks passed!"
          - "✓ reflector package installed"
          - "✓ reflector.conf exists and valid"
          - "✓ timer override configured"
          - "✓ reflector.timer enabled and active"
          - "✓ mirrorlist updated with {{ _reflector_server_count.stdout }} servers"
