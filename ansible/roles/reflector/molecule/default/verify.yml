---
# Molecule verify playbook
# Проверяет что роль правильно применилась к системе

- name: Verify
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/inventory/group_vars/all/vault.yml"

  tasks:
    - name: Check that reflector is installed
      ansible.builtin.package:
        name: reflector
        state: present
      check_mode: true
      register: reflector_installed
      failed_when: reflector_installed is changed

    - name: Check that reflector config exists
      ansible.builtin.stat:
        path: /etc/xdg/reflector/reflector.conf
      register: reflector_conf
      failed_when: not reflector_conf.stat.exists

    - name: Validate reflector config content
      ansible.builtin.slurp:
        src: /etc/xdg/reflector/reflector.conf
      register: reflector_conf_content
      failed_when: >
        '--save' not in (reflector_conf_content.content | b64decode) or
        '--protocol' not in (reflector_conf_content.content | b64decode)

    - name: Check that timer override exists
      ansible.builtin.stat:
        path: /etc/systemd/system/reflector.timer.d/override.conf
      register: reflector_timer_override
      failed_when: not reflector_timer_override.stat.exists

    - name: Check that reflector.timer is enabled
      ansible.builtin.systemd:
        name: reflector.timer
        enabled: true
      check_mode: true
      register: reflector_timer_enabled
      failed_when: reflector_timer_enabled is changed

    - name: Check that reflector.timer is active
      ansible.builtin.systemd:
        name: reflector.timer
      register: reflector_timer_status
      failed_when: reflector_timer_status.status.ActiveState != 'active'

    - name: Check that mirrorlist exists and is not empty
      ansible.builtin.stat:
        path: /etc/pacman.d/mirrorlist
      register: reflector_mirrorlist
      failed_when: >
        not reflector_mirrorlist.stat.exists or
        reflector_mirrorlist.stat.size == 0

    - name: Validate mirrorlist contains Server entries
      ansible.builtin.command: grep -c '^Server = ' /etc/pacman.d/mirrorlist
      register: reflector_server_count
      changed_when: false
      failed_when: reflector_server_count.stdout | int < 1

    - name: Check that pacman hooks directory exists
      ansible.builtin.stat:
        path: /etc/pacman.d/hooks
      register: reflector_hooks_dir
      failed_when: not reflector_hooks_dir.stat.exists

    - name: Check that pacman hook file exists
      ansible.builtin.stat:
        path: /etc/pacman.d/hooks/reflector-mirrorlist.hook
      register: reflector_hook
      failed_when: not reflector_hook.stat.exists

    - name: Validate hook file content references pacman-mirrorlist and --config
      ansible.builtin.slurp:
        src: /etc/pacman.d/hooks/reflector-mirrorlist.hook
      register: reflector_hook_content
      failed_when: >
        'pacman-mirrorlist' not in (reflector_hook_content.content | b64decode) or
        '--config' not in (reflector_hook_content.content | b64decode)

    - name: Validate timer drop-in contains RandomizedDelaySec
      ansible.builtin.slurp:
        src: /etc/systemd/system/reflector.timer.d/override.conf
      register: reflector_dropin_content
      failed_when: >
        'RandomizedDelaySec' not in (reflector_dropin_content.content | b64decode)

    - name: Count mirrorlist backup files
      ansible.builtin.find:
        paths: /etc/pacman.d
        patterns: "mirrorlist.bak.*"
      register: reflector_verify_backups

    - name: Validate backup count does not exceed reflector_backup_keep
      ansible.builtin.assert:
        that:
          - reflector_verify_backups.matched <= reflector_backup_keep | int
        fail_msg: >
          Found {{ reflector_verify_backups.matched }} backup files,
          expected <= {{ reflector_backup_keep }}

    - name: Validate mirrorlist contains at least 3 Server entries
      ansible.builtin.command: grep -c '^Server = ' /etc/pacman.d/mirrorlist
      register: reflector_verify_server_count
      changed_when: false
      failed_when: reflector_verify_server_count.stdout | int < 3

    - name: Show test results
      ansible.builtin.debug:
        msg:
          - "✅ All checks passed!"
          - "✓ reflector package installed"
          - "✓ reflector.conf exists and valid"
          - "✓ timer override configured with RandomizedDelaySec"
          - "✓ reflector.timer enabled and active"
          - "✓ mirrorlist updated with {{ reflector_verify_server_count.stdout }} servers (>= 3)"
          - "✓ pacman hook deployed at /etc/pacman.d/hooks/reflector-mirrorlist.hook"
          - "✓ backup count within limit: {{ reflector_verify_backups.matched }} <= {{ reflector_backup_keep }}"
