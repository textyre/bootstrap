---
# === ntp_audit â€” assert a scheduler is active ===
# Fails explicitly if neither systemd timer nor cron job is available.
# Note: uses systemctl directly instead of service_facts because
# service_facts does not reliably include .timer units on all distros/containers.

- name: Check ntp-audit timer is enabled (systemd)
  ansible.builtin.command:
    cmd: systemctl is-enabled ntp-audit.timer
  register: ntp_audit_timer_is_enabled
  changed_when: false
  when: ansible_facts['service_mgr'] == 'systemd'
  tags: ['ntp_audit', 'ntp_audit_scheduler']

- name: Assert ntp-audit.timer is enabled
  ansible.builtin.assert:
    that:
      - ntp_audit_timer_is_enabled.stdout | trim == 'enabled'
    fail_msg: >-
      ntp-audit.timer is not enabled after deploy.
      Run: systemctl status ntp-audit.timer
  when: ansible_facts['service_mgr'] == 'systemd'
  tags: ['ntp_audit', 'ntp_audit_scheduler']

- name: Check ntp-audit timer is active (systemd)
  ansible.builtin.command:
    cmd: systemctl is-active ntp-audit.timer
  register: ntp_audit_timer_is_active
  changed_when: false
  when: ansible_facts['service_mgr'] == 'systemd'
  tags: ['ntp_audit', 'ntp_audit_scheduler']

- name: Assert ntp-audit.timer is active
  ansible.builtin.assert:
    that:
      - ntp_audit_timer_is_active.stdout | trim == 'active'
    fail_msg: >-
      ntp-audit.timer is not active after deploy.
      Run: systemctl status ntp-audit.timer
  when: ansible_facts['service_mgr'] == 'systemd'
  tags: ['ntp_audit', 'ntp_audit_scheduler']

- name: Check cron entry exists (non-systemd)
  ansible.builtin.command:
    cmd: crontab -l -u root
  register: ntp_audit_cron_list
  changed_when: false
  failed_when: false
  when: ansible_facts['service_mgr'] != 'systemd'
  tags: ['ntp_audit', 'ntp_audit_scheduler']

- name: Assert cron entry present (non-systemd)
  ansible.builtin.assert:
    that:
      - "'ntp-audit' in ntp_audit_cron_list.stdout"
    fail_msg: >-
      ntp-audit cron job not found in root's crontab.
      Non-systemd host detected but cron deploy failed.
  when: ansible_facts['service_mgr'] != 'systemd'
  tags: ['ntp_audit', 'ntp_audit_scheduler']
