---
- name: Converge
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Ensure chrony is installed (ntp_audit depends on chronyc)
      ansible.builtin.package:
        name: chrony
        state: present

    - name: Set chrony service name per distribution
      ansible.builtin.set_fact:
        _ntp_audit_chrony_service: >-
          {{ 'chrony' if ansible_facts['os_family'] == 'Debian' else 'chronyd' }}

    - name: Ensure chrony is running
      ansible.builtin.service:
        name: "{{ _ntp_audit_chrony_service }}"
        state: started
        enabled: true

    - name: Wait for chronyd socket to be ready
      ansible.builtin.wait_for:
        path: /run/chrony/chronyd.sock
        state: present
        timeout: 30

  roles:
    - role: ntp_audit
