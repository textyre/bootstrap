---
- name: Verify ntp_audit
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/inventory/group_vars/all/vault.yml"

  tasks:

    - name: Assert ntp-audit zipapp exists and is executable
      ansible.builtin.stat:
        path: /usr/local/bin/ntp-audit
      register: ntp_audit_verify_script

    - name: Verify ntp-audit zipapp
      ansible.builtin.assert:
        that:
          - ntp_audit_verify_script.stat.exists
          - ntp_audit_verify_script.stat.executable
        fail_msg: "/usr/local/bin/ntp-audit missing or not executable"

    - name: Assert Python source staging directory exists
      ansible.builtin.stat:
        path: /usr/local/src/ntp-audit
      register: ntp_audit_verify_src

    - name: Verify staging directory
      ansible.builtin.assert:
        that:
          - ntp_audit_verify_src.stat.exists
          - ntp_audit_verify_src.stat.isdir
        fail_msg: "/usr/local/src/ntp-audit staging directory missing"

    - name: Assert audit log directory exists
      ansible.builtin.stat:
        path: /var/log/ntp-audit
      register: ntp_audit_verify_logdir

    - name: Verify log directory
      ansible.builtin.assert:
        that:
          - ntp_audit_verify_logdir.stat.exists
          - ntp_audit_verify_logdir.stat.isdir
        fail_msg: "/var/log/ntp-audit directory missing"

    - name: Assert audit log file written after first run
      ansible.builtin.stat:
        path: /var/log/ntp-audit/audit.log
      register: ntp_audit_verify_logfile

    - name: Verify audit log not empty
      ansible.builtin.assert:
        that:
          - ntp_audit_verify_logfile.stat.exists
          - ntp_audit_verify_logfile.stat.size > 0
        fail_msg: "audit.log missing or empty â€” first run failed"

    - name: Read last line of audit log
      ansible.builtin.command:
        cmd: tail -1 /var/log/ntp-audit/audit.log
      register: ntp_audit_verify_last_line
      changed_when: false

    - name: Assert audit log contains valid JSON with required keys
      ansible.builtin.assert:
        that:
          - (ntp_audit_verify_last_line.stdout | from_json).timestamp is defined
          - (ntp_audit_verify_last_line.stdout | from_json).sync_status is defined
          - (ntp_audit_verify_last_line.stdout | from_json).stratum is defined
          - (ntp_audit_verify_last_line.stdout | from_json).current_correction is defined
          - (ntp_audit_verify_last_line.stdout | from_json).ntp_conflict is defined
          - (ntp_audit_verify_last_line.stdout | from_json).ntp_phc_status is defined
        fail_msg: "audit.log missing required JSON keys"

    - name: Assert logrotate config deployed
      ansible.builtin.stat:
        path: /etc/logrotate.d/ntp-audit
      register: ntp_audit_verify_logrotate

    - name: Verify logrotate config
      ansible.builtin.assert:
        that:
          - ntp_audit_verify_logrotate.stat.exists
          - ntp_audit_verify_logrotate.stat.size > 0
        fail_msg: "/etc/logrotate.d/ntp-audit missing"

    - name: Collect service facts (systemd)
      ansible.builtin.service_facts:
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Verify ntp-audit.timer is enabled and active
      ansible.builtin.assert:
        that:
          - "'ntp-audit.timer' in ansible_facts.services"
          - ansible_facts.services['ntp-audit.timer'].status == 'enabled'
          - ansible_facts.services['ntp-audit.timer'].state == 'active'
        fail_msg: "ntp-audit.timer not enabled or not active"
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: Assert Alloy config fragment deployed
      ansible.builtin.stat:
        path: /etc/alloy/conf.d/ntp-audit.alloy
      register: ntp_audit_verify_alloy

    - name: Verify Alloy fragment
      ansible.builtin.assert:
        that:
          - ntp_audit_verify_alloy.stat.exists
          - ntp_audit_verify_alloy.stat.size > 0
        fail_msg: "Alloy config fragment missing"

    - name: Assert Loki rules deployed
      ansible.builtin.stat:
        path: /etc/loki/rules/fake/ntp-audit-rules.yaml
      register: ntp_audit_verify_loki

    - name: Verify Loki rules
      ansible.builtin.assert:
        that:
          - ntp_audit_verify_loki.stat.exists
          - ntp_audit_verify_loki.stat.size > 0
        fail_msg: "Loki alert rules missing"

    - name: Show result
      ansible.builtin.debug:
        msg: >-
          ntp_audit verify passed: zipapp, timer, log written with correct JSON keys,
          logrotate, alloy config, loki rules all present.
