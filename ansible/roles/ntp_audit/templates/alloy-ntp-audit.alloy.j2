// ntp-audit — Grafana Alloy configuration fragment
// Managed by Ansible (role: ntp_audit). Do not edit manually.
// Requires: loki.write.default and prometheus.remote_write.default defined elsewhere.

// NTP audit JSON log → JSON processor → Loki
loki.source.file "ntp_audit" {
  targets = [{
    __path__ = "{{ ntp_audit_log_file }}",
    job      = "ntp-audit",
    host     = constants.hostname,
  }]
  // FIX: forward to processor, not directly to write
  forward_to = [loki.process.ntp_audit_json.receiver]
}

// Parse JSON fields; promote key fields to Loki stream labels
loki.process "ntp_audit_json" {
  forward_to = [loki.write.default.receiver]

  stage.json {
    expressions = {
      ntp_sync_status = "sync_status",
      ntp_conflict    = "ntp_conflict",
      ntp_phc_status  = "ntp_phc_status",
      ntp_stratum     = "stratum",
      ntp_offset      = "current_correction",
    }
  }

  stage.labels {
    values = {
      ntp_sync_status = "",
      ntp_conflict    = "",
      ntp_phc_status  = "",
    }
  }
}

// chrony native logs → Loki (for NtpClockStep alert)
loki.source.file "chrony_logs" {
  targets = [{
    __path__ = "{{ ntp_audit_chrony_log_dir }}/*.log",
    job      = "chrony",
    host     = constants.hostname,
  }]
  forward_to = [loki.write.default.receiver]
}

// Kernel timex metrics → Prometheus (high-precision, independent of script)
prometheus.exporter.unix "ntp_timex" {
  enable_collectors = ["timex"]
}

prometheus.scrape "ntp_timex" {
  targets    = prometheus.exporter.unix.ntp_timex.targets
  forward_to = [prometheus.remote_write.default.receiver]
  job_name   = "ntp-timex"
}
