#!/usr/bin/env bash
# ntp-audit â€” NTP health and conflict audit
# Managed by Ansible (role: ntp_audit). Do not edit manually.
# Output: JSON to {{ ntp_audit_log_file }} + syslog via logger(1)

set -euo pipefail

LOG_FILE="{{ ntp_audit_log_file }}"
TIMESTAMP="$(date --iso-8601=seconds)"

# ---- chrony tracking ----
TRACKING_RAW="$(chronyc tracking 2>/dev/null || echo '')"

_extract() {
  echo "$TRACKING_RAW" | awk -F': ' "/^${1}/ {gsub(/ .*/, \"\", \$2); print \$2}"
}

if [ -z "$TRACKING_RAW" ]; then
  NTP_STRATUM="unknown"
  NTP_REFERENCE="unknown"
  NTP_OFFSET="unknown"
  NTP_FREQ_ERROR="unknown"
  NTP_SYNC_STATUS="error"
else
  NTP_STRATUM="$(_extract 'Stratum')"
  NTP_STRATUM="${NTP_STRATUM:-unknown}"
  NTP_REFERENCE="$(_extract 'Reference ID' | awk '{print $1}')"
  NTP_REFERENCE="${NTP_REFERENCE:-unknown}"
  NTP_OFFSET="$(echo "$TRACKING_RAW" | awk '/System time/ {print $4}')"
  NTP_OFFSET="${NTP_OFFSET:-unknown}"
  NTP_FREQ_ERROR="$(echo "$TRACKING_RAW" | awk '/Frequency/ {print $3}')"
  NTP_FREQ_ERROR="${NTP_FREQ_ERROR:-unknown}"

  if echo "$TRACKING_RAW" | grep -q 'Not synchronised'; then
    NTP_SYNC_STATUS="unsynchronised"
  else
    NTP_SYNC_STATUS="ok"
  fi
fi

# ---- competing services ----
NTP_CONFLICT="none"
if command -v systemctl > /dev/null 2>&1; then
{% for svc in ntp_audit_competitor_services %}
  if systemctl is-active --quiet {{ svc }} 2>/dev/null; then
    NTP_CONFLICT="{{ svc }}_active"
  fi
{% endfor %}
fi

# ---- PHC devices ----
NTP_PHC_STATUS="n/a"
NTP_PHC_DEVICE="none"
{% for dev in ntp_audit_phc_devices %}
if [ -c "{{ dev }}" ]; then
  NTP_PHC_STATUS="ok"
  NTP_PHC_DEVICE="{{ dev }}"
fi
{% endfor %}

# ---- kernel modules ----
NTP_MODULES_STATUS="n/a"
{% if ntp_audit_kernel_modules | length > 0 %}
NTP_MODULES_STATUS="ok"
{% for mod in ntp_audit_kernel_modules %}
if ! lsmod 2>/dev/null | grep -q "^{{ mod }}"; then
  NTP_MODULES_STATUS="{{ mod }}_missing"
fi
{% endfor %}
{% endif %}

# ---- compose JSON ----
JSON=$(cat <<'ENDJSON'
{
  "timestamp": "TIMESTAMP_PLACEHOLDER",
  "ntp_stratum": "STRATUM_PLACEHOLDER",
  "ntp_reference": "REFERENCE_PLACEHOLDER",
  "ntp_offset_s": "OFFSET_PLACEHOLDER",
  "ntp_freq_error_ppm": "FREQ_PLACEHOLDER",
  "ntp_sync_status": "SYNC_PLACEHOLDER",
  "ntp_conflict": "CONFLICT_PLACEHOLDER",
  "ntp_phc_status": "PHC_STATUS_PLACEHOLDER",
  "ntp_phc_device": "PHC_DEVICE_PLACEHOLDER",
  "ntp_modules_status": "MODULES_PLACEHOLDER"
}
ENDJSON
)

# Replace placeholders with actual values
JSON="${JSON/TIMESTAMP_PLACEHOLDER/$TIMESTAMP}"
JSON="${JSON/STRATUM_PLACEHOLDER/$NTP_STRATUM}"
JSON="${JSON/REFERENCE_PLACEHOLDER/$NTP_REFERENCE}"
JSON="${JSON/OFFSET_PLACEHOLDER/$NTP_OFFSET}"
JSON="${JSON/FREQ_PLACEHOLDER/$NTP_FREQ_ERROR}"
JSON="${JSON/SYNC_PLACEHOLDER/$NTP_SYNC_STATUS}"
JSON="${JSON/CONFLICT_PLACEHOLDER/$NTP_CONFLICT}"
JSON="${JSON/PHC_STATUS_PLACEHOLDER/$NTP_PHC_STATUS}"
JSON="${JSON/PHC_DEVICE_PLACEHOLDER/$NTP_PHC_DEVICE}"
JSON="${JSON/MODULES_PLACEHOLDER/$NTP_MODULES_STATUS}"

# ---- write JSON log ----
echo "$JSON" >> "$LOG_FILE"

# ---- syslog notification (works on all init systems) ----
SUMMARY="ntp_sync=${NTP_SYNC_STATUS} stratum=${NTP_STRATUM} conflict=${NTP_CONFLICT} phc=${NTP_PHC_STATUS}"
logger -t ntp-audit -p daemon.info "$SUMMARY"

# ---- exit non-zero on detected problems ----
if [ "$NTP_SYNC_STATUS" = "unsynchronised" ] || [ "$NTP_CONFLICT" != "none" ] || [ "$NTP_PHC_STATUS" = "missing" ]; then
  logger -t ntp-audit -p daemon.warning "WARN: ${SUMMARY}"
fi

exit 0
