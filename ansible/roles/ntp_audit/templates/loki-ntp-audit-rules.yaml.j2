# ntp-audit — Loki ruler alert rules
# Managed by Ansible (role: ntp_audit). Do not edit manually.
# Deploy path: {{ ntp_audit_loki_rules_dir }}/ntp-audit-rules.yaml

groups:
  - name: ntp-audit
    interval: 5m
    rules:

      - alert: NtpCompetingDaemon
        expr: |
          count_over_time(
            {job="ntp-audit", ntp_conflict!="none"} [10m]
          ) > 0
        for: 0m
        labels:
          severity: warning
          team: ops
        annotations:
          summary: "Competing time sync daemon active alongside chrony"
          description: >-
            Host {{ "{{ $labels.host }}" }}: competing NTP daemon running
            (ntp_conflict={{ "{{ $labels.ntp_conflict }}" }}).
            Stop the competing daemon to prevent clock discipline conflicts.

      - alert: NtpPHCMissing
        # FIX: 'missing' status is now reachable (Python checkers.py fix)
        expr: |
          count_over_time(
            {job="ntp-audit", ntp_phc_status="missing"} [10m]
          ) > 0
        for: 0m
        labels:
          severity: warning
          team: ops
        annotations:
          summary: "PTP hardware clock device missing on VM"
          description: >-
            Host {{ "{{ $labels.host }}" }}: PHC device expected but not present.
            Check hypervisor guest tools and kernel module (ptp_kvm / hv_utils).

      - alert: NtpUnsynchronised
        expr: |
          count_over_time(
            {job="ntp-audit", ntp_sync_status="unsynchronised"} [10m]
          ) > 0
        for: 2m
        labels:
          severity: critical
          team: ops
        annotations:
          summary: "chrony is not synchronised"
          description: >-
            Host {{ "{{ $labels.host }}" }}: chrony unsynchronised for > 10 minutes.
            Check internet connectivity and NTP server reachability.

      - alert: NtpHighOffset
        # FIX: check both positive and negative offset (current_correction is signed)
        expr: |
          (
            {job="ntp-audit"} | json
              | ntp_offset | float > {{ ntp_audit_alert_offset_threshold }}
          ) or (
            {job="ntp-audit"} | json
              | ntp_offset | float < -{{ ntp_audit_alert_offset_threshold }}
          )
        for: 10m
        labels:
          severity: warning
          team: ops
        annotations:
          summary: "NTP clock offset exceeds ±{{ ntp_audit_alert_offset_threshold }}s"
          description: >-
            Host {{ "{{ $labels.host }}" }}: |offset| > {{ ntp_audit_alert_offset_threshold }}s.
            May indicate VM clock disruption or degraded NTP source.

      - alert: NtpClockStep
        expr: |
          count_over_time(
            {job="chrony"} |= "System clock was stepped" [5m]
          ) > 0
        for: 0m
        labels:
          severity: info
          team: ops
        annotations:
          summary: "chrony performed a clock step"
          description: >-
            Host {{ "{{ $labels.host }}" }}: large time correction applied (makestep).
            Normal after VM resume or first sync. Investigate if recurring.

      - alert: NtpHighStratum
        expr: |
          {job="ntp-audit"} | json | ntp_stratum | int > {{ ntp_audit_alert_stratum_max }}
        for: 15m
        labels:
          severity: warning
          team: ops
        annotations:
          summary: "NTP stratum too high (> {{ ntp_audit_alert_stratum_max }})"
          description: >-
            Host {{ "{{ $labels.host }}" }}: stratum {{ "{{ $labels.ntp_stratum }}" }}.
            NTP source quality is degraded.
