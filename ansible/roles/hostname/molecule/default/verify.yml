---
- name: Verify
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/inventory/group_vars/all/vault.yml"

  tasks:
    - name: Check hostname is set
      ansible.builtin.command: hostname
      register: _verify_hostname
      changed_when: false

    - name: Assert hostname is not empty
      ansible.builtin.assert:
        that:
          - _verify_hostname.stdout | length > 0
        fail_msg: "Hostname is empty"

    - name: Verify hostname is present in /etc/hosts
      ansible.builtin.command: grep -q '{{ _verify_hostname.stdout }}' /etc/hosts
      register: _verify_hosts_resolve
      changed_when: false
      failed_when: _verify_hosts_resolve.rc != 0

    - name: Check /etc/hosts contains 127.0.1.1 entry
      ansible.builtin.command: grep '127.0.1.1' /etc/hosts
      register: _verify_hosts
      changed_when: false
      failed_when: _verify_hosts.rc != 0

    - name: Show result
      ansible.builtin.debug:
        msg:
          - "Hostname check passed!"
          - "Hostname: {{ _verify_hostname.stdout }}"
          - "/etc/hosts: 127.0.1.1 entry present"
