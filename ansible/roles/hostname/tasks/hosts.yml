---
# === /etc/hosts management ===
# Базовый hostname entry + hostctl для профилей
# Действие → Проверка → Логирование

# ---- Базовый hostname entry (всегда) ----

- name: Build hostname line for /etc/hosts
  ansible.builtin.set_fact:
    _hostname_hosts_line: >-
      {{ '127.0.1.1' ~ '\t' ~
         ((hostname_domain | default(''))
           | ternary(hostname_name ~ '.' ~ hostname_domain ~ '\t' ~ hostname_name,
                     hostname_name)) }}
  tags: ['hostname']

- name: Ensure /etc/hosts contains hostname
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "{{ _hostname_hosts_line }}"
    insertafter: '^127\.0\.0\.1'
    state: present
  tags: ['hostname']

# ---- Проверка hostname resolve ----

- name: Verify hostname is present in /etc/hosts
  ansible.builtin.command: grep -q '{{ hostname_name }}' /etc/hosts
  register: _hostname_hosts_check
  changed_when: false
  failed_when: _hostname_hosts_check.rc != 0
  tags: ['hostname']

# ---- hostctl — установка ----

- name: Install and configure hostctl
  ansible.builtin.include_tasks: hostctl.yml
  when: hostname_hostctl_enabled
  tags: ['hostname', 'hostctl']

# ---- Логирование ----

- name: "Report: Hosts (with hostctl)"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_phase.yml
  vars:
    _rpt_fact: "_hostname_phases"
    _rpt_phase: "Configure /etc/hosts"
    _rpt_detail: "hostctl {{ _hostname_hostctl_check.stdout | default('') | regex_search('v[\\d.]+') | default('installed') }}{{ ', profiles: ' ~ (hostname_hostctl_profiles | length) if hostname_hostctl_profiles else '' }}"
  when: hostname_hostctl_enabled
  tags: ['hostname', 'report']

- name: "Report: Hosts (no hostctl)"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_phase.yml
  vars:
    _rpt_fact: "_hostname_phases"
    _rpt_phase: "Configure /etc/hosts"
    _rpt_detail: "{{ hostname_name }} (lineinfile)"
  when: not hostname_hostctl_enabled
  tags: ['hostname', 'report']
