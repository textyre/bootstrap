---
# === /etc/hosts management ===
# Базовый hostname entry
# Действие → Проверка → Логирование

# ---- Базовый hostname entry (всегда) ----

- name: Build hostname line for /etc/hosts
  ansible.builtin.set_fact:
    hostname_hosts_line: >-
      {{ '127.0.1.1' ~ '\t' ~
         ((hostname_domain | default(''))
           | ternary(hostname_name ~ '.' ~ hostname_domain ~ '\t' ~ hostname_name,
                     hostname_name)) }}
  tags: ['hostname']

- name: Ensure /etc/hosts contains hostname
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "{{ hostname_hosts_line }}"
    insertafter: '^127\.0\.0\.1'
    state: present
  tags: ['hostname']

# ---- Проверка hostname resolve ----

- name: Verify hostname is present in /etc/hosts
  ansible.builtin.command: grep -q '{{ hostname_name }}' /etc/hosts
  register: hostname_hosts_check
  changed_when: false
  failed_when: hostname_hosts_check.rc != 0
  tags: ['hostname']

# ---- Логирование ----

- name: "Report: Hosts"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_phase.yml
  vars:
    common_rpt_fact: "_hostname_phases"
    common_rpt_phase: "Configure /etc/hosts"
    common_rpt_detail: "127.0.1.1 {{ hostname_name }}{{ ('.' ~ hostname_domain ~ ' ' ~ hostname_name) if hostname_domain else '' }}"
  tags: ['hostname', 'report']
