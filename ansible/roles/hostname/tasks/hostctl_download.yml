---
# === hostctl — скачивание бинарника с GitHub ===
# Fallback когда package manager не смог установить hostctl
# Поддержка: x86_64 (amd64), aarch64 (arm64)
# Busybox-совместимо (без GNU tar флагов)

# ---- Определение версии ----

- name: Query latest hostctl release from GitHub API
  ansible.builtin.uri:
    url: https://api.github.com/repos/guumaster/hostctl/releases/latest
    return_content: true
    headers:
      Accept: application/vnd.github.v3+json
  register: _hostctl_release
  when: hostname_hostctl_version == "latest"

- name: Query specific hostctl release from GitHub API
  ansible.builtin.uri:
    url: "https://api.github.com/repos/guumaster/hostctl/releases/tags/v{{ hostname_hostctl_version | regex_replace('^v', '') }}"
    return_content: true
    headers:
      Accept: application/vnd.github.v3+json
  register: _hostctl_release_pinned
  when: hostname_hostctl_version != "latest"

- name: Set hostctl release facts
  ansible.builtin.set_fact:
    _hostctl_release_data: "{{ (hostname_hostctl_version == 'latest') | ternary(_hostctl_release, _hostctl_release_pinned) }}"

# ---- Определение архитектуры ----

- name: Map system architecture to hostctl naming
  ansible.builtin.set_fact:
    _hostctl_arch: "{{ _arch_map[ansible_facts['architecture']] | default(omit) }}"
  vars:
    _arch_map:
      x86_64: amd64
      aarch64: arm64
      armv7l: armv6

- name: Fail on unsupported architecture
  ansible.builtin.fail:
    msg: >-
      Unsupported architecture '{{ ansible_facts['architecture'] }}' for hostctl.
      Supported: x86_64, aarch64, armv7l.
  when: _hostctl_arch is not defined

# ---- Поиск asset URL из release ----

- name: Find tarball asset URL
  ansible.builtin.set_fact:
    _hostctl_tarball_url: >-
      {{ _hostctl_release_data.json.assets
         | selectattr('name', 'match', '.*linux_' ~ _hostctl_arch ~ '\.tar\.gz$')
         | map(attribute='browser_download_url')
         | first }}
    _hostctl_tarball_name: >-
      {{ _hostctl_release_data.json.assets
         | selectattr('name', 'match', '.*linux_' ~ _hostctl_arch ~ '\.tar\.gz$')
         | map(attribute='name')
         | first }}

# ---- Checksum верификация ----

- name: Find checksums asset URL
  ansible.builtin.set_fact:
    _hostctl_checksums_url: >-
      {{ _hostctl_release_data.json.assets
         | selectattr('name', 'match', '.*checksum.*')
         | map(attribute='browser_download_url')
         | first | default('') }}

- name: Download checksums file
  ansible.builtin.uri:
    url: "{{ _hostctl_checksums_url }}"
    return_content: true
  register: _hostctl_checksums
  when: _hostctl_checksums_url | length > 0

- name: Extract SHA256 checksum for target asset
  ansible.builtin.set_fact:
    _hostctl_checksum: >-
      sha256:{{ _hostctl_checksums.content
         | regex_search('([a-f0-9]{64})\s+' ~ _hostctl_tarball_name, '\1')
         | first }}
  when: _hostctl_checksums is not skipped

# ---- Скачивание ----

- name: Download hostctl archive (with checksum)
  ansible.builtin.get_url:
    url: "{{ _hostctl_tarball_url }}"
    dest: /tmp/hostctl.tar.gz
    checksum: "{{ _hostctl_checksum }}"
    mode: '0644'
  when: _hostctl_checksum is defined

- name: Download hostctl archive (no checksum available)
  ansible.builtin.get_url:
    url: "{{ _hostctl_tarball_url }}"
    dest: /tmp/hostctl.tar.gz
    mode: '0644'
  when: _hostctl_checksum is not defined

# ---- Установка (busybox-совместимо) ----

- name: Create temporary extraction directory
  ansible.builtin.tempfile:
    state: directory
    prefix: hostctl_
  register: _hostctl_tmpdir

- name: Extract hostctl archive
  ansible.builtin.unarchive:
    src: /tmp/hostctl.tar.gz
    dest: "{{ _hostctl_tmpdir.path }}"
    remote_src: true

- name: Install hostctl binary
  ansible.builtin.copy:
    src: "{{ _hostctl_tmpdir.path }}/hostctl"
    dest: /usr/local/bin/hostctl
    remote_src: true
    owner: root
    group: root
    mode: '0755'

# ---- Cleanup ----

- name: Clean up hostctl temporary files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/hostctl.tar.gz
    - "{{ _hostctl_tmpdir.path }}"
