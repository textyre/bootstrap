---
# === Hostname + /etc/hosts ===
# Имя машины, /etc/hosts
# Каждый блок: Действие → Проверка → Логирование

# ---- Input validation ----

- name: Assert hostname_name is provided and valid
  ansible.builtin.assert:
    that:
      - hostname_name is defined
      - hostname_name | length > 0
      - hostname_name is match('^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?$')
    fail_msg: >-
      hostname_name is required and must be a valid hostname
      (letters, digits, hyphens only; max 63 chars; no leading/trailing hyphen).
      Set it in group_vars, host_vars, or playbook vars.
  tags: ['hostname']

# ======================================================================
# ---- Hostname ----
# ======================================================================

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ hostname_name }}"
    use: "{{ _hostname_strategy[ansible_facts['os_family']] | default('systemd') }}"
  tags: ['hostname']

# Проверка
- name: Verify hostname is set
  ansible.builtin.command: hostname
  register: _hostname_check
  changed_when: false
  tags: ['hostname']

- name: Assert hostname matches expected value
  ansible.builtin.assert:
    that:
      - _hostname_check.stdout == hostname_name
    fail_msg: "Hostname mismatch: got '{{ _hostname_check.stdout }}', expected '{{ hostname_name }}'"
    quiet: true
  tags: ['hostname']

# Логирование
- name: "Report: Hostname"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_phase.yml
  vars:
    common_rpt_fact: "_hostname_phases"
    common_rpt_phase: "Set hostname"
    common_rpt_detail: "{{ hostname_name }}"
  tags: ['hostname', 'report']

# ======================================================================
# ---- /etc/hosts ----
# ======================================================================

- name: Configure /etc/hosts
  ansible.builtin.include_tasks: hosts.yml
  tags: ['hostname']

# ======================================================================
# ---- Итоговый отчёт ----
# ======================================================================

- name: "hostname — Execution Report"
  ansible.builtin.include_role:
    name: common
    tasks_from: report_render.yml
  vars:
    common_rpt_fact: "_hostname_phases"
    common_rpt_title: "hostname"
    common_rpt_footer_rows:
      - "| {{ '%-26s' | format('OS') }} | {{ '%-10s' | format(ansible_facts['os_family']) }} | {{ '%-24s' | format(ansible_facts['distribution'] | default('unknown')) }} |"
  tags: ['hostname', 'report']
