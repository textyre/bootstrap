---
# === sysctl — kernel parameter tuning ===
# Управление параметрами ядра через /etc/sysctl.d/99-ansible.conf

# Supported OS families
_sysctl_supported_os:
  - Archlinux
  - Debian

# ---- VM / Memory ----
sysctl_vm_swappiness: 10
# Security note: Kicksecure использует 1 для минимизации записи sensitive данных в swap.
# Dev workstation: 10 (производительность). Production/sensitive: 1.
sysctl_vm_vfs_cache_pressure: 50
sysctl_vm_dirty_ratio: 10
sysctl_vm_dirty_background_ratio: 5

# ---- Filesystem ----
sysctl_fs_inotify_max_user_watches: 524288
sysctl_fs_inotify_max_user_instances: 1024
sysctl_fs_file_max: 2097152

# ---- Network ----
sysctl_net_core_somaxconn: 4096
sysctl_net_ipv4_tcp_fastopen: 3
# ВАЖНО: tcp_tw_reuse требует tcp_timestamps=1 для безопасной работы.
# При tcp_timestamps=0 (security default) ДОЛЖНО быть 0.
# Ref: https://vincent.bernat.ch/en/blog/2014-tcp-time-wait-state-linux
sysctl_net_ipv4_tcp_tw_reuse: 0

# ---- Kernel ----
# kernel.unprivileged_userns_clone существует ТОЛЬКО в Arch linux-hardened ядре.
# Отсутствует в стандартном upstream ядре. Игнорируется если не поддерживается (sysctl -e).
sysctl_kernel_unprivileged_userns_clone: 1

# ---- Security ----
sysctl_security_enabled: true

# Per-feature toggles (позволяют отключить отдельные группы параметров)
sysctl_security_kernel_hardening: true
sysctl_security_network_hardening: true
sysctl_security_filesystem_hardening: true
sysctl_security_ipv6_disable: false       # ОСТОРОЖНО: может сломать DNS, Docker, Happy Eyeballs

# ---- Security: Kernel hardening ----

# ASLR: рандомизация адресного пространства. KSPP=yes (DISA STIG)
sysctl_kernel_randomize_va_space: 2

# Скрыть адреса ядра из /proc/kallsyms и других интерфейсов. KSPP=yes
sysctl_kernel_kptr_restrict: 2

# Ограничить dmesg для непривилегированных пользователей. KSPP=yes
sysctl_kernel_dmesg_restrict: 1

# ptrace: 1=только child-процессы (dev, gdb ./app работает)
# ptrace: 2=только root (ломает gdb --pid=, strace -p, perf record -p)
sysctl_kernel_yama_ptrace_scope: 1

# Ограничить доступ к perf counters (Spectre side-channel). KSPP=yes. DISA STIG V-258076
sysctl_kernel_perf_event_paranoid: 3

# Заблокировать непривилегированный bpf(). KSPP=yes. CVE-2021-3490, CVE-2022-23222
sysctl_kernel_unprivileged_bpf_disabled: 1

# Ограничить загрузку TTY line disciplines до CAP_SYS_MODULE.
# Закрывает класс CVE-2017-2636. KSPP=yes. Kernel 4.7+.
sysctl_kernel_tty_ldisc_autoload: 0

# Ограничить userfaultfd() syscall до CAP_SYS_PTRACE.
# Снижает риск heap spray атак (use-after-free). KSPP=yes. Kernel 5.11+.
sysctl_vm_unprivileged_userfaultfd: 0

# Минимальный адрес mmap(): защита от null pointer dereference эксплуатации.
# Атакующий не может замапить код на NULL адрес. KSPP=yes.
sysctl_vm_mmap_min_addr: 65536

# ---- Security: Network hardening ----

# BPF JIT compiler hardening: constant blinding против JIT spray атак. KSPP=yes.
# 0=off, 1=только unprivileged, 2=все пользователи (рекомендуется)
sysctl_net_core_bpf_jit_harden: 2

# Reverse path filtering (source validation). Предотвращает IP spoofing. CVE-2019-14899.
sysctl_net_ipv4_rp_filter: 1

# SYN flood protection (SYN cookies). KSPP=yes (CONFIG_SYN_COOKIES=y).
sysctl_net_ipv4_tcp_syncookies: 1

# Защита TIME_WAIT сокетов от RST атак (TIME_WAIT Assassination). RFC 1337.
sysctl_net_ipv4_tcp_rfc1337: 1

# Блокировать ICMP redirect. Предотвращает MITM атаки.
sysctl_net_ipv4_accept_redirects: 0

# Не отправлять ICMP redirect.
sysctl_net_ipv4_send_redirects: 0

# Блокировать IPv4 source routing.
sysctl_net_ipv4_accept_source_route: 0

# Логировать spoofed/martian пакеты (невозможные source/dest адреса).
sysctl_net_ipv4_log_martians: 1

# Игнорировать broadcast ICMP echo (Smurf attack mitigation).
sysctl_net_ipv4_icmp_echo_ignore_broadcasts: 1

# Игнорировать bogus ICMP error responses.
sysctl_net_ipv4_icmp_ignore_bogus_error_responses: 1

# Отключить TCP timestamps (скрыть uptime от fingerprinting). CIS 3.3.10.
# ВНИМАНИЕ: при tcp_timestamps=0 необходимо tcp_tw_reuse=0 (см. выше).
sysctl_net_ipv4_tcp_timestamps: 0

# ARP hardening — защита от ARP spoofing и cache poisoning
# arp_filter: не отвечать на ARP через "чужой" интерфейс.
sysctl_net_ipv4_arp_filter: 1
# arp_ignore=1: отвечать только если target IP принадлежит принимающему интерфейсу.
# Значение 2 (строже) ломает Docker bridge networking, Kubernetes VIP, multi-IP VM.
# Kicksecure сам откатил arp_ignore=2→1 (PR #290). Для bare-metal без Docker: 2.
sysctl_net_ipv4_arp_ignore: 1
# Отбрасывать gratuitous ARP — основной вектор ARP cache poisoning.
# ВНИМАНИЕ: значение 1 ломает keepalived/VRRP HA failover и WireGuard IP-change announcements.
# На HA-серверах с keepalived оставить 0.
sysctl_net_ipv4_drop_gratuitous_arp: 0

# IPv6 anti-spoofing
# Блокировать ICMPv6 redirect.
sysctl_net_ipv6_accept_redirects: 0
# Блокировать IPv6 source routing.
sysctl_net_ipv6_accept_source_route: 0
# Router Advertisements: 1=принимать (ядерный default, SLAAC работает).
# Установить в 0 только если используется DHCPv6 stateful или статический IPv6.
# accept_ra=0 на SLAAC-сети: потеря IPv6 connectivity + DNS fallback latency на каждом HTTPS.
sysctl_net_ipv6_accept_ra: 1

# ---- Security: Filesystem protection ----
sysctl_fs_protected_hardlinks: 1
sysctl_fs_protected_symlinks: 1
# Запретить запись в FIFO в world-writable sticky директориях если не владелец.
# TOCTOU race mitigation. KSPP=yes.
sysctl_fs_protected_fifos: 2
# Запретить запись в regular файлы в sticky директориях если не владелец. KSPP=yes.
sysctl_fs_protected_regular: 2
# Запретить core dump SUID-бинарников. KSPP=yes. CIS 1.6.4, DISA STIG V-230462.
sysctl_fs_suid_dumpable: 0

# ---- Custom parameters ----
# List of dicts: [{name: "kernel.param", value: "1"}]
sysctl_custom_params: []
