---
# === sysctl â€” kernel parameter tuning ===

# ---- Ensure sysctl.d directory exists ----

- name: Ensure /etc/sysctl.d directory exists
  ansible.builtin.file:
    path: /etc/sysctl.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags: ['sysctl', 'kernel']

# ---- Deploy sysctl configuration ----

- name: Deploy sysctl drop-in configuration
  ansible.builtin.template:
    src: sysctl.conf.j2
    dest: /etc/sysctl.d/99-ansible.conf
    owner: root
    group: root
    mode: '0644'
  notify: Apply sysctl settings
  tags: ['sysctl', 'kernel']

# ---- OS-specific tasks ----

- name: Include OS-specific tasks
  ansible.builtin.include_tasks: "{{ ansible_facts['os_family'] | lower }}.yml"
  when: ansible_facts['os_family'] in _sysctl_supported_os
  tags: ['sysctl']

# ---- Report ----

- name: Report sysctl configuration
  ansible.builtin.debug:
    msg:
      - "sysctl drop-in: /etc/sysctl.d/99-ansible.conf"
      - "vm.swappiness={{ sysctl_vm_swappiness }}"
      - "fs.inotify.max_user_watches={{ sysctl_fs_inotify_max_user_watches }}"
      - "net.core.somaxconn={{ sysctl_net_core_somaxconn }}"
      - "Custom params: {{ sysctl_custom_params | length }}"
  tags: ['sysctl', 'kernel']
