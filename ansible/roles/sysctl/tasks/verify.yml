---
# === sysctl: verify ===
# Post-apply: читает live значения ключевых параметров и сообщает о статусе.
# failed_when: false — параметр может отсутствовать на данном ядре (distro-agnostic)

- name: Read live sysctl security parameter values
  ansible.builtin.command: "sysctl -n {{ item.param }}"
  register: _sysctl_verify_security
  changed_when: false
  failed_when: false
  loop:
    - { param: "kernel.randomize_va_space",      expected: "2",     label: "ASLR" }
    - { param: "kernel.kptr_restrict",            expected: "2",     label: "kernel pointer restrict" }
    - { param: "kernel.dmesg_restrict",           expected: "1",     label: "dmesg restrict" }
    - { param: "fs.protected_hardlinks",          expected: "1",     label: "hardlink protection" }
    - { param: "fs.protected_symlinks",           expected: "1",     label: "symlink protection" }
    - { param: "net.ipv4.tcp_syncookies",         expected: "1",     label: "SYN cookies" }
    - { param: "net.ipv4.tcp_timestamps",         expected: "0",     label: "TCP timestamps disabled" }
    - { param: "net.ipv4.tcp_tw_reuse",           expected: "0",     label: "TIME_WAIT reuse disabled" }
    - { param: "net.core.bpf_jit_harden",        expected: "2",     label: "BPF JIT hardening" }
  tags: ['sysctl', 'verify']

- name: Report live sysctl parameter status
  ansible.builtin.debug:
    msg: >-
      [sysctl verify] {{ item.item.label }}:
      {% if item.rc != 0 %}NOT SUPPORTED on this kernel (skipped)
      {%- elif item.stdout | string == item.item.expected | string %}OK ({{ item.stdout }})
      {%- else %}MISMATCH — expected={{ item.item.expected }} got={{ item.stdout }}{% endif %}
  loop: "{{ _sysctl_verify_security.results }}"
  tags: ['sysctl', 'verify']
