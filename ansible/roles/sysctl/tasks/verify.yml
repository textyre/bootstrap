---
# === sysctl: verify ===
# Post-apply: читает live значения ключевых параметров и сообщает о статусе.
# failed_when: item.rc not in [0, 255] — rc=0 успех, rc=255 параметр не поддерживается ядром.
# Реальные ошибки (permission denied, command not found) не маскируются.

- name: Read live sysctl security parameter values
  ansible.builtin.command: "sysctl -n {{ item.param }}"
  register: sysctl_verify_security
  changed_when: false
  failed_when: item.rc is defined and item.rc not in [0, 255]
  loop:
    - { param: "kernel.randomize_va_space", expected: "2", label: "ASLR" }
    - { param: "kernel.kptr_restrict", expected: "2", label: "kernel pointer restrict" }
    - { param: "kernel.dmesg_restrict", expected: "1", label: "dmesg restrict" }
    - { param: "kernel.perf_event_paranoid", expected: "3", label: "perf event paranoid" }
    - { param: "kernel.unprivileged_bpf_disabled", expected: "1", label: "unprivileged BPF disabled" }
    - { param: "dev.tty.ldisc_autoload", expected: "0", label: "TTY ldisc autoload restricted (kernel 4.7+)" }
    - { param: "vm.unprivileged_userfaultfd", expected: "0", label: "unprivileged userfaultfd restricted (kernel 5.11+)" }
    - { param: "fs.protected_hardlinks", expected: "1", label: "hardlink protection" }
    - { param: "fs.protected_symlinks", expected: "1", label: "symlink protection" }
    - { param: "fs.suid_dumpable", expected: "0", label: "SUID core dump disabled" }
    - { param: "net.ipv4.tcp_syncookies", expected: "1", label: "SYN cookies" }
    - { param: "net.ipv4.tcp_timestamps", expected: "0", label: "TCP timestamps disabled" }
    - { param: "net.ipv4.tcp_tw_reuse", expected: "0", label: "TIME_WAIT reuse disabled" }
    - { param: "net.core.bpf_jit_harden", expected: "2", label: "BPF JIT hardening" }
  tags: ['sysctl', 'verify']

- name: Report live sysctl parameter status
  ansible.builtin.debug:
    msg: "[sysctl verify] {{ item.item.label }}: {% if item.rc == 255 %}NOT SUPPORTED on this kernel (skipped){%- elif item.rc != 0 %}ERROR (rc={{ item.rc }}){%- elif item.stdout | string == item.item.expected | string %}OK ({{ item.stdout }}){%- else %}MISMATCH — expected={{ item.item.expected }} got={{ item.stdout }}{% endif %}"  # yamllint disable-line rule:line-length
  loop: "{{ sysctl_verify_security.results }}"
  tags: ['sysctl', 'verify']
