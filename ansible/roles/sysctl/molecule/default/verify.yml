---
- name: Verify
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Check sysctl drop-in file exists
      ansible.builtin.stat:
        path: /etc/sysctl.d/99-ansible.conf
      register: _sysctl_verify_conf
      failed_when: not _sysctl_verify_conf.stat.exists

    - name: Check sysctl config contains swappiness setting
      ansible.builtin.command: grep 'vm.swappiness' /etc/sysctl.d/99-ansible.conf
      register: _sysctl_verify_swappiness
      changed_when: false
      failed_when: _sysctl_verify_swappiness.rc != 0

    - name: Check live sysctl value for vm.swappiness matches role variable
      ansible.builtin.command: sysctl -n vm.swappiness
      register: _sysctl_verify_live_swappiness
      changed_when: false
      failed_when: _sysctl_verify_live_swappiness.stdout | int != sysctl_vm_swappiness | default(10) | int

    - name: Check live sysctl value for fs.inotify.max_user_watches matches role variable
      ansible.builtin.command: sysctl -n fs.inotify.max_user_watches
      register: _sysctl_verify_live_inotify
      changed_when: false
      failed_when: _sysctl_verify_live_inotify.stdout | int != sysctl_fs_inotify_max_user_watches | default(524288) | int

    - name: Check live sysctl value for net.core.somaxconn matches role variable
      ansible.builtin.command: sysctl -n net.core.somaxconn
      register: _sysctl_verify_live_somaxconn
      changed_when: false
      failed_when: _sysctl_verify_live_somaxconn.stdout | int != sysctl_net_core_somaxconn | default(4096) | int

    - name: Verify security sysctl parameters are live
      ansible.builtin.command: "sysctl -n {{ item.param }}"
      register: _sysctl_verify_security
      changed_when: false
      # rc=255: параметр не поддерживается данным ядром (kernel version guard)
      # Реальные ошибки (permission denied, sysctl not found) имеют другие rc
      failed_when: item.rc is defined and item.rc not in [0, 255]
      loop:
        - { param: "kernel.randomize_va_space",       expected: "2" }
        - { param: "kernel.kptr_restrict",             expected: "2" }
        - { param: "fs.protected_hardlinks",           expected: "1" }
        - { param: "fs.protected_symlinks",            expected: "1" }
        - { param: "fs.suid_dumpable",                 expected: "0" }
        - { param: "net.ipv4.tcp_syncookies",          expected: "1" }
        - { param: "net.ipv4.tcp_timestamps",          expected: "0" }
        - { param: "net.ipv4.tcp_tw_reuse",            expected: "0" }
        - { param: "net.core.bpf_jit_harden",         expected: "2" }

    - name: Assert security parameters match expected values
      ansible.builtin.assert:
        that: item.stdout == item.item.expected
        fail_msg: >-
          SECURITY PARAM MISMATCH: {{ item.item.param }}
          expected={{ item.item.expected }} got={{ item.stdout }}
        success_msg: "OK: {{ item.item.param }}={{ item.stdout }}"
      loop: "{{ _sysctl_verify_security.results }}"
      when: item.rc == 0

    - name: Show test results
      ansible.builtin.debug:
        msg:
          - "All sysctl checks passed!"
          - "Drop-in file deployed to /etc/sysctl.d/99-ansible.conf"
          - "Live kernel parameters verified"
