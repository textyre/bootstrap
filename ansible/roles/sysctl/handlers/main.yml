---
# Handlers for sysctl role

- name: Apply sysctl settings
  listen: "reload sysctl"
  # -e = игнорировать ошибки неизвестных параметров (например kernel.unprivileged_userns_clone
  #      отсутствует на стандартном upstream ядре — distro-agnostic поведение)
  # -p = применить ТОЛЬКО наш файл. Имя 99-z-ansible.conf выбрано намеренно:
  #      'z' > 's' лексикографически, поэтому файл сортируется ПОСЛЕ Ubuntu's
  #      99-sysctl.conf → /etc/sysctl.conf и выигрывает при sysctl --system
  #      (systemd-sysctl при загрузке).
  # changed_when: false — изменение репортит template-таск (notify), не handler
  # when: пропустить в Docker — kernel params read-only (EPERM) даже с privileged:true.
  #       Tier 2 / Tier 2b verify тоже пропускает live-checks в контейнерах.
  ansible.builtin.command: sysctl -e -p /etc/sysctl.d/99-z-ansible.conf
  changed_when: false
  when: ansible_virtualization_type | default('') != 'docker'
