---
# Handlers for sysctl role

- name: Apply sysctl settings
  listen: "reload sysctl"
  # -e = игнорировать ошибки неизвестных параметров (например kernel.unprivileged_userns_clone
  #      отсутствует на стандартном upstream ядре — distro-agnostic поведение)
  # --system = читает все /etc/sysctl.d/*.conf (не зависит от init, но применяется
  #            systemd-sysctl.service при boot на Arch/Debian)
  # changed_when: false — изменение репортит template-таск (notify), не handler
  # when: пропустить в Docker — kernel params read-only (EPERM) даже с privileged:true.
  #       Tier 2 verify тоже пропускает live-checks в контейнерах.
  ansible.builtin.command: sysctl -e --system
  changed_when: false
  when: ansible_virtualization_type | default('') != 'docker'
