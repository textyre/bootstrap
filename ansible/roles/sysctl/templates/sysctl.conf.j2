# Managed by Ansible — do not edit manually
# Role: sysctl
# Drop-in: /etc/sysctl.d/99-ansible.conf

# ---- VM / Memory ----
vm.swappiness = {{ sysctl_vm_swappiness }}
vm.vfs_cache_pressure = {{ sysctl_vm_vfs_cache_pressure }}
vm.dirty_ratio = {{ sysctl_vm_dirty_ratio }}
vm.dirty_background_ratio = {{ sysctl_vm_dirty_background_ratio }}

# ---- Filesystem ----
fs.inotify.max_user_watches = {{ sysctl_fs_inotify_max_user_watches }}
fs.inotify.max_user_instances = {{ sysctl_fs_inotify_max_user_instances }}
fs.file-max = {{ sysctl_fs_file_max }}

# ---- Network ----
net.core.somaxconn = {{ sysctl_net_core_somaxconn }}
net.ipv4.tcp_fastopen = {{ sysctl_net_ipv4_tcp_fastopen }}
net.ipv4.tcp_tw_reuse = {{ sysctl_net_ipv4_tcp_tw_reuse }}

# ---- Kernel ----
kernel.unprivileged_userns_clone = {{ sysctl_kernel_unprivileged_userns_clone }}

{% if sysctl_security_enabled and sysctl_security_kernel_hardening %}
# ---- Security: Kernel hardening ----
# ASLR: рандомизация адресного пространства (CIS, DISA STIG)
kernel.randomize_va_space = {{ sysctl_kernel_randomize_va_space }}
# Скрыть адреса ядра из /proc/kallsyms
kernel.kptr_restrict = {{ sysctl_kernel_kptr_restrict }}
# Ограничить dmesg для непривилегированных пользователей
kernel.dmesg_restrict = {{ sysctl_kernel_dmesg_restrict }}
# ptrace: 1=child only (dev), 2=root only (server), 3=никто
kernel.yama.ptrace_scope = {{ sysctl_kernel_yama_ptrace_scope }}
# Ограничить perf counters (защита от Spectre side-channel, DISA STIG V-258076)
kernel.perf_event_paranoid = {{ sysctl_kernel_perf_event_paranoid }}
# Блокировать непривилегированный bpf() (CVE-2021-3490, CVE-2022-23222)
kernel.unprivileged_bpf_disabled = {{ sysctl_kernel_unprivileged_bpf_disabled }}
{% endif %}

{% if sysctl_security_enabled and sysctl_security_network_hardening %}
# ---- Security: Network anti-spoofing (IPv4) ----
net.ipv4.conf.all.rp_filter = {{ sysctl_net_ipv4_rp_filter }}
net.ipv4.conf.default.rp_filter = {{ sysctl_net_ipv4_rp_filter }}
net.ipv4.tcp_syncookies = {{ sysctl_net_ipv4_tcp_syncookies }}
net.ipv4.conf.all.accept_redirects = {{ sysctl_net_ipv4_accept_redirects }}
net.ipv4.conf.default.accept_redirects = {{ sysctl_net_ipv4_accept_redirects }}
net.ipv4.conf.all.send_redirects = {{ sysctl_net_ipv4_send_redirects }}
net.ipv4.conf.default.send_redirects = {{ sysctl_net_ipv4_send_redirects }}
net.ipv4.conf.all.accept_source_route = {{ sysctl_net_ipv4_accept_source_route }}
net.ipv4.conf.default.accept_source_route = {{ sysctl_net_ipv4_accept_source_route }}
net.ipv4.conf.all.log_martians = {{ sysctl_net_ipv4_log_martians }}
net.ipv4.icmp_echo_ignore_broadcasts = {{ sysctl_net_ipv4_icmp_echo_ignore_broadcasts }}
net.ipv4.icmp_ignore_bogus_error_responses = {{ sysctl_net_ipv4_icmp_ignore_bogus_error_responses }}
# Отключить TCP timestamps (скрыть uptime, CIS 3.3.10)
net.ipv4.tcp_timestamps = {{ sysctl_net_ipv4_tcp_timestamps }}

# ---- Security: Network anti-spoofing (IPv6) ----
net.ipv6.conf.all.accept_redirects = {{ sysctl_net_ipv6_accept_redirects }}
net.ipv6.conf.default.accept_redirects = {{ sysctl_net_ipv6_accept_redirects }}
net.ipv6.conf.all.accept_source_route = {{ sysctl_net_ipv6_accept_source_route }}
net.ipv6.conf.default.accept_source_route = {{ sysctl_net_ipv6_accept_source_route }}
{% endif %}

{% if sysctl_security_enabled and sysctl_security_ipv6_disable %}
# ---- Security: Disable IPv6 ----
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
{% endif %}

{% if sysctl_security_enabled and sysctl_security_filesystem_hardening %}
# ---- Security: Filesystem protection ----
fs.protected_hardlinks = {{ sysctl_fs_protected_hardlinks }}
fs.protected_symlinks = {{ sysctl_fs_protected_symlinks }}
# Запретить core dump SUID-бинарников (CIS 1.6.4, DISA STIG V-230462)
fs.suid_dumpable = {{ sysctl_fs_suid_dumpable }}
{% endif %}

{% if sysctl_custom_params | length > 0 %}
# ---- Custom parameters ----
{% for param in sysctl_custom_params %}
{{ param.name }} = {{ param.value }}
{% endfor %}
{% endif %}
