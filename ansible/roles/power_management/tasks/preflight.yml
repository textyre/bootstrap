---
# === power_management / preflight ===
# Pre-deploy safety assertions

# ---- Hibernate requires swap ----

- name: Set hibernate-in-use flag
  ansible.builtin.set_fact:
    power_management_hibernate_in_use: >-
      {{ power_management_lid_switch_action in ['hibernate', 'hybrid-sleep']
         or power_management_lid_switch_ac_action in ['hibernate', 'hybrid-sleep']
         or power_management_idle_action in ['hibernate', 'hybrid-sleep']
         or power_management_hibernate_key_action == 'hibernate' }}
  tags: ['power', 'preflight']

# /proc/swaps lists active swap devices; a non-header line means swap is present.
- name: Read active swap entries from /proc/swaps
  ansible.builtin.slurp:
    src: /proc/swaps
  register: power_management_swap_check
  failed_when: false
  when: power_management_hibernate_in_use | bool
  tags: ['power', 'preflight']

- name: Assert swap is available for hibernate
  ansible.builtin.assert:
    that:
      - (power_management_swap_check.content | b64decode).splitlines() | length > 1
    fail_msg: >-
      Hibernate requires active swap (swap partition or swapfile).
      No swap detected via /proc/swaps. Either enable swap
      or change logind actions that reference 'hibernate' / 'hybrid-sleep'
      to 'suspend' or 'ignore'.
    success_msg: "Swap detected, hibernate is viable"
  when:
    - power_management_hibernate_in_use | bool
    - "'content' in power_management_swap_check"
  tags: ['power', 'preflight']

# ---- SSH lockout warning for idle suspend/hibernate ----

- name: Warn about SSH lockout with idle suspend/hibernate
  ansible.builtin.debug:
    msg: >-
      WARNING: power_management_idle_action={{ power_management_idle_action }}
      is configured over a non-local connection ({{ ansible_connection }}).
      The system may suspend/hibernate during SSH sessions, causing
      connection loss. Consider setting power_management_idle_action=ignore
      for remotely managed systems.
  when:
    - power_management_idle_action in ['suspend', 'hibernate']
    - ansible_connection | default('ssh') != 'local'
  tags: ['power', 'preflight']
