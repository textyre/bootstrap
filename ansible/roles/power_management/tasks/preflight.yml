---
# === power_management / preflight ===
# Pre-deploy safety assertions

# ---- Hibernate requires swap ----

- name: Set hibernate-in-use flag
  ansible.builtin.set_fact:
    _pm_hibernate_in_use: >-
      {{ power_management_lid_switch_action in ['hibernate', 'hybrid-sleep']
         or power_management_lid_switch_ac_action in ['hibernate', 'hybrid-sleep']
         or power_management_idle_action in ['hibernate', 'hybrid-sleep']
         or power_management_hibernate_key_action == 'hibernate' }}
  tags: ['power', 'preflight']

- name: Check swap availability for hibernate
  ansible.builtin.command: swapon --show --noheadings
  register: pm_swap_check
  changed_when: false
  failed_when: false
  when: _pm_hibernate_in_use | bool
  tags: ['power', 'preflight']

- name: Assert swap is available for hibernate
  ansible.builtin.assert:
    that:
      - _pm_swap_check.stdout | length > 0
    fail_msg: >-
      Hibernate requires active swap (swap partition or swapfile).
      No swap detected via 'swapon --show'. Either enable swap
      or change logind actions that reference 'hibernate' / 'hybrid-sleep'
      to 'suspend' or 'ignore'.
    success_msg: "Swap detected, hibernate is viable"
  when: _pm_hibernate_in_use | bool
  tags: ['power', 'preflight']

# ---- SSH lockout warning for idle suspend/hibernate ----

- name: Warn about SSH lockout with idle suspend/hibernate
  ansible.builtin.debug:
    msg: >-
      WARNING: power_management_idle_action={{ power_management_idle_action }}
      is configured over a non-local connection ({{ ansible_connection }}).
      The system may suspend/hibernate during SSH sessions, causing
      connection loss. Consider setting power_management_idle_action=ignore
      for remotely managed systems.
  when:
    - power_management_idle_action in ['suspend', 'hibernate']
    - ansible_connection | default('ssh') != 'local'
  tags: ['power', 'preflight']
