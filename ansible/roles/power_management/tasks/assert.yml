---
# === power_management / assert ===
# Post-deploy effectiveness checks

# ---- TLP active (laptop + systemd) ----

- name: Assert TLP service is active
  ansible.builtin.command: systemctl is-active tlp
  register: pm_assert_tlp
  changed_when: false
  failed_when: false
  when:
    - power_management_is_laptop
    - power_management_init == 'systemd'
  tags: ['power', 'assert']

- name: Verify TLP is running
  ansible.builtin.assert:
    that:
      - _pm_assert_tlp.rc == 0
    fail_msg: >-
      TLP service is NOT active. Run 'systemctl status tlp' and
      'journalctl -u tlp' to diagnose. Check package installation
      and /etc/tlp.conf syntax with 'tlp-stat -c'.
    success_msg: "TLP service is active"
  when:
    - power_management_assert_strict
    - power_management_is_laptop
    - power_management_init == 'systemd'
  tags: ['power', 'assert']

# ---- power-profiles-daemon masked (laptop + systemd) ----

- name: Check power-profiles-daemon is masked
  ansible.builtin.command: systemctl is-enabled power-profiles-daemon
  register: pm_assert_ppd
  changed_when: false
  failed_when: false
  when:
    - power_management_is_laptop
    - power_management_init == 'systemd'
  tags: ['power', 'assert']

- name: Verify power-profiles-daemon is masked or absent
  ansible.builtin.assert:
    that:
      - _pm_assert_ppd.stdout | default('') in ['masked', '']
        or _pm_assert_ppd.rc != 0
    fail_msg: >-
      power-profiles-daemon is NOT masked (status: {{ pm_assert_ppd.stdout | default('unknown') }}).
      It conflicts with TLP. Run 'systemctl mask power-profiles-daemon'.
    success_msg: "power-profiles-daemon is masked or absent"
  when:
    - power_management_assert_strict
    - power_management_is_laptop
    - power_management_init == 'systemd'
  tags: ['power', 'assert']

# ---- CPU governor matches expected (laptop — TLP managed) ----

- name: Verify CPU governor is in expected set (laptop — TLP managed)
  ansible.builtin.assert:
    that:
      - power_management_status.governor in [power_management_tlp_cpu_governor_ac, power_management_tlp_cpu_governor_bat, 'unknown']
    fail_msg: >-
      CPU governor '{{ power_management_status.governor }}' is not one of TLP's configured
      values (AC: {{ power_management_tlp_cpu_governor_ac }}, BAT: {{ power_management_tlp_cpu_governor_bat }}).
      Check 'tlp-stat -g' to see what TLP applied.
    success_msg: "CPU governor '{{ power_management_status.governor }}' (TLP-managed)"
  when:
    - power_management_assert_strict
    - power_management_is_laptop
  tags: ['power', 'assert']

# ---- CPU governor matches expected (desktop) ----

- name: Verify CPU governor matches expected value (desktop)
  ansible.builtin.assert:
    that:
      - power_management_status.governor == power_management_cpu_governor
        or power_management_status.governor == 'unknown'
    fail_msg: >-
      CPU governor is '{{ power_management_status.governor }}', expected
      '{{ power_management_cpu_governor }}'. Check 'cpupower frequency-info'
      and verify no conflicting services (power-profiles-daemon) override the governor.
    success_msg: "CPU governor is '{{ power_management_cpu_governor }}'"
  when:
    - power_management_assert_strict
    - not power_management_is_laptop
  tags: ['power', 'assert']

# ---- sleep.conf HibernateMode ----

- name: Check sleep.conf HibernateMode
  ansible.builtin.command: grep -E '^HibernateMode=' /etc/systemd/sleep.conf
  register: pm_assert_hibernate
  changed_when: false
  failed_when: false
  when: power_management_init == 'systemd'
  tags: ['power', 'assert']

- name: Verify HibernateMode in sleep.conf
  ansible.builtin.assert:
    that:
      - _pm_assert_hibernate.stdout == 'HibernateMode=' + power_management_hibernate_mode
    fail_msg: >-
      sleep.conf HibernateMode does not match. Expected 'HibernateMode={{ power_management_hibernate_mode }}'
      but found '{{ pm_assert_hibernate.stdout | default('not found') }}'.
    success_msg: "sleep.conf HibernateMode={{ power_management_hibernate_mode }}"
  when:
    - power_management_assert_strict
    - power_management_init == 'systemd'
  tags: ['power', 'assert']

# ---- Validate sleep.conf via systemd-analyze ----

- name: Validate sleep.conf is accepted by systemd
  ansible.builtin.command: systemd-analyze cat-config systemd/sleep.conf
  changed_when: false
  failed_when: false
  register: pm_assert_sleep_analyze
  when: power_management_init == 'systemd'
  tags: ['power', 'assert']

- name: Log sleep.conf validation result
  ansible.builtin.debug:
    msg: "sleep.conf validation: {{ 'OK' if _pm_assert_sleep_analyze.rc == 0 else 'WARNING: ' + _pm_assert_sleep_analyze.stderr }}"
  when: power_management_init == 'systemd'
  tags: ['power', 'assert']

# ---- logind.conf HandleLidSwitch ----

- name: Check logind.conf HandleLidSwitch
  ansible.builtin.command: grep -E '^HandleLidSwitch=' /etc/systemd/logind.conf
  register: pm_assert_lid
  changed_when: false
  failed_when: false
  when: power_management_init == 'systemd'
  tags: ['power', 'assert']

- name: Verify HandleLidSwitch in logind.conf
  ansible.builtin.assert:
    that:
      - _pm_assert_lid.stdout == 'HandleLidSwitch=' + power_management_lid_switch_action
    fail_msg: >-
      logind.conf HandleLidSwitch does not match. Expected 'HandleLidSwitch={{ power_management_lid_switch_action }}'
      but found '{{ pm_assert_lid.stdout | default('not found') }}'.
      Check /etc/systemd/logind.conf for manual edits.
    success_msg: "logind.conf HandleLidSwitch={{ power_management_lid_switch_action }}"
  when:
    - power_management_assert_strict
    - power_management_init == 'systemd'
  tags: ['power', 'assert']

# ---- Charge thresholds applied ----

- name: Verify charge thresholds applied
  ansible.builtin.assert:
    that:
      - power_management_status.battery.charge_start_threshold != 'N/A'
    fail_msg: >-
      Battery charge thresholds were configured (bat0_charge_start={{ power_management_tlp_bat0_charge_start }})
      but not detected in /sys/class/power_supply/BAT0/charge_control_start_threshold.
      This may indicate unsupported hardware. Check 'tlp-stat -b'.
    success_msg: "Charge threshold start={{ power_management_status.battery.charge_start_threshold }}"
  when:
    - power_management_assert_strict
    - power_management_tlp_bat0_charge_start | string | length > 0
  tags: ['power', 'assert']
