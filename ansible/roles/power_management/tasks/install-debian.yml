---
# === power_management / install-debian ===
# Debian/Ubuntu package installation

# ---- TLP ----

- name: Install TLP (laptop)
  ansible.builtin.apt:
    name:
      - tlp
      - tlp-rdw
    state: present
  when: _power_management_is_laptop
  tags: ['power', 'install']

# ---- cpupower (kernel-versioned) ----

- name: Get running kernel version
  ansible.builtin.command: uname -r
  register: _pm_kernel_version
  changed_when: false
  tags: ['power', 'install']

- name: Install linux-tools for cpupower (kernel-versioned)
  ansible.builtin.apt:
    name: "linux-tools-{{ _pm_kernel_version.stdout }}"
    state: present
  register: _pm_linux_tools_result
  failed_when: false
  tags: ['power', 'install']

- name: Install linux-cpupower as fallback (custom kernel)
  ansible.builtin.apt:
    name:
      - linux-tools-common
      - linux-cpupower
    state: present
  when: _pm_linux_tools_result is failed or _pm_linux_tools_result.rc | default(0) != 0
  tags: ['power', 'install']

- name: Install linux-tools-common (cpupower helpers)
  ansible.builtin.apt:
    name: linux-tools-common
    state: present
  when: _pm_linux_tools_result is not failed
  tags: ['power', 'install']
