---
# === power_management / install-debian ===
# Debian/Ubuntu package installation

# ---- TLP ----

- name: Install TLP (laptop)
  ansible.builtin.apt:
    name:
      - tlp
      - tlp-rdw
    state: present
  when: power_management_is_laptop
  tags: ['power', 'install']

# ---- cpupower (kernel-versioned) ----
# ansible_kernel is gathered by setup/gather_facts and contains the running
# kernel version string (e.g. "6.1.0-21-amd64"), avoiding a command: uname -r.

- name: Install linux-tools for cpupower (kernel-versioned)
  ansible.builtin.apt:
    name: "linux-tools-{{ ansible_kernel }}"
    state: present
  register: power_management_linux_tools_result
  failed_when: false
  tags: ['power', 'install']

- name: Install linux-cpupower as fallback (custom kernel)
  ansible.builtin.apt:
    name:
      - linux-tools-common
      - linux-cpupower
    state: present
  when: power_management_linux_tools_result is failed or power_management_linux_tools_result.rc | default(0) != 0
  tags: ['power', 'install']

- name: Install linux-tools-common (cpupower helpers)
  ansible.builtin.apt:
    name: linux-tools-common
    state: present
  when: power_management_linux_tools_result is not failed
  tags: ['power', 'install']
