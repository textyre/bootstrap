---
# === power_management / detect ===
# DMI chassis type, CPU vendor, init system detection

# ---- DMI chassis type ----

- name: Read DMI chassis type
  ansible.builtin.slurp:
    src: /sys/class/dmi/id/chassis_type
  register: power_management_chassis_raw
  failed_when: false
  tags: ['power', 'detect']

- name: Set device type fact
  ansible.builtin.set_fact:
    power_management_is_laptop: >-
      {{
        (power_management_device_type == 'laptop') or
        (power_management_device_type == 'auto' and
         power_management_chassis_raw is succeeded and
         (power_management_chassis_raw.content | b64decode | trim) in power_management_laptop_chassis_types)
      }}
  tags: ['power', 'detect']

# ---- Init system detection ----

- name: Detect init system
  ansible.builtin.set_fact:
    power_management_init: "{{ ansible_service_mgr | default('unknown') }}"
  tags: ['power', 'detect']

# ---- CPU vendor detection ----

- name: Read CPU vendor from /proc/cpuinfo
  ansible.builtin.slurp:
    src: /proc/cpuinfo
  register: power_management_cpuinfo_raw
  failed_when: false
  tags: ['power', 'detect']

- name: Set CPU vendor facts
  ansible.builtin.set_fact:
    power_management_cpu_is_intel: "{{ 'GenuineIntel' in (power_management_cpuinfo_raw.content | b64decode | default('')) }}"
    power_management_cpu_is_amd: "{{ 'AuthenticAMD' in (power_management_cpuinfo_raw.content | b64decode | default('')) }}"
  tags: ['power', 'detect']

# ---- Report ----

- name: Report detected hardware
  ansible.builtin.debug:
    msg: >-
      Device: {{ 'laptop' if power_management_is_laptop else 'desktop' }}
      (config: {{ power_management_device_type }}),
      Init: {{ power_management_init }},
      CPU: {{ 'Intel' if power_management_cpu_is_intel else ('AMD' if power_management_cpu_is_amd else 'other') }}
  tags: ['power', 'detect']
