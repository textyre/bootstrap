---
- name: Prepare
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Install Python on Arch (raw â€” arch-base ships Python, but explicit bootstrap is safe)
      ansible.builtin.raw: pacman -Sy --noconfirm python
      when: inventory_hostname == 'arch-vm'
      changed_when: true

    - name: Gather facts
      ansible.builtin.setup:

    - name: Refresh Arch keyring (SigLevel=Never trick)
      ansible.builtin.shell: |
        pacman -Sy --noconfirm --config <(sed 's/SigLevel.*/SigLevel = Never/' /etc/pacman.conf) archlinux-keyring
        pacman-key --populate archlinux
      when: ansible_facts['os_family'] == 'Archlinux'
      changed_when: true

    - name: Full system upgrade (Arch)
      community.general.pacman:
        upgrade: true
        update_cache: true
      when: ansible_facts['os_family'] == 'Archlinux'

    - name: Fix DNS after pacman -Syu (systemd stub replaced resolv.conf)
      ansible.builtin.copy:
        content: "nameserver 8.8.8.8\nnameserver 1.1.1.1\n"
        dest: /etc/resolv.conf
        mode: '0644'
        unsafe_writes: true
      when: ansible_facts['os_family'] == 'Archlinux'

    - name: Update apt cache (Ubuntu)
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_facts['os_family'] == 'Debian'

    - name: Load acpi-cpufreq kernel module (VM may not expose cpufreq by default)
      ansible.builtin.command: modprobe acpi-cpufreq
      failed_when: false
      changed_when: false

    - name: Load cpufreq_schedutil kernel module
      ansible.builtin.command: modprobe cpufreq_schedutil
      failed_when: false
      changed_when: false
