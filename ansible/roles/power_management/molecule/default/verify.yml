---
- name: Verify
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/inventory/group_vars/all/vault.yml"

  tasks:
    # ---- Package checks ----

    - name: Check cpupower is installed
      ansible.builtin.package:
        name: cpupower
        state: present
      check_mode: true
      register: _power_verify_cpupower
      failed_when: _power_verify_cpupower is changed

    # ---- sleep.conf checks ----

    - name: Check systemd sleep.conf exists
      ansible.builtin.stat:
        path: /etc/systemd/sleep.conf
      register: _power_verify_sleep_conf
      failed_when: not _power_verify_sleep_conf.stat.exists

    - name: Check sleep.conf contains SuspendMode
      ansible.builtin.command: grep 'SuspendMode' /etc/systemd/sleep.conf
      register: _power_verify_suspend_mode
      changed_when: false
      failed_when: _power_verify_suspend_mode.rc != 0

    # ---- Device detection ----

    - name: Read DMI chassis type for conditional checks
      ansible.builtin.slurp:
        src: /sys/class/dmi/id/chassis_type
      register: _power_verify_chassis
      failed_when: false

    - name: Set laptop detection fact for verification
      ansible.builtin.set_fact:
        _power_verify_is_laptop: >-
          {{ _power_verify_chassis is succeeded and
             (_power_verify_chassis.content | b64decode | trim) in ['8', '9', '10', '14', '31'] }}

    # ---- TLP checks (laptop only) ----

    - name: Check TLP is installed (laptop only)
      ansible.builtin.package:
        name: tlp
        state: present
      check_mode: true
      register: _power_verify_tlp
      failed_when: _power_verify_tlp is changed
      when: _power_verify_is_laptop

    - name: Check TLP config exists (laptop only)
      ansible.builtin.stat:
        path: /etc/tlp.conf
      register: _power_verify_tlp_conf
      failed_when: not _power_verify_tlp_conf.stat.exists
      when: _power_verify_is_laptop

    - name: Check TLP service is enabled (laptop only)
      ansible.builtin.systemd:
        name: tlp
        enabled: true
      check_mode: true
      register: _power_verify_tlp_service
      failed_when: _power_verify_tlp_service is changed
      when: _power_verify_is_laptop

    # ---- CPU governor check ----

    - name: Read current CPU governor
      ansible.builtin.slurp:
        src: /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
      register: _power_verify_governor_raw
      failed_when: false

    - name: Assert governor has a valid value
      ansible.builtin.assert:
        that:
          - _power_verify_governor_raw is succeeded
          - (_power_verify_governor_raw.content | b64decode | trim) | length > 0
        fail_msg: "CPU governor could not be read from /sys/"
        success_msg: "CPU governor: {{ _power_verify_governor_raw.content | b64decode | trim }}"
      when: _power_verify_governor_raw is succeeded

    # ---- logind.conf check ----

    - name: Check logind.conf contains HandleLidSwitch
      ansible.builtin.command: grep 'HandleLidSwitch=' /etc/systemd/logind.conf
      register: _power_verify_logind
      changed_when: false
      failed_when: _power_verify_logind.rc != 0

    # ---- Audit checks ----

    - name: Check power-audit script exists
      ansible.builtin.stat:
        path: /usr/local/bin/power-audit.sh
      register: _power_verify_audit_script
      failed_when: not _power_verify_audit_script.stat.exists

    - name: Check power-audit script is executable
      ansible.builtin.assert:
        that:
          - _power_verify_audit_script.stat.mode == '0755'
        fail_msg: "power-audit.sh mode is {{ _power_verify_audit_script.stat.mode }}, expected 0755"
        success_msg: "power-audit.sh has correct permissions"

    - name: Check power-audit timer is enabled
      ansible.builtin.command: systemctl is-enabled power-audit.timer
      register: _power_verify_audit_timer
      changed_when: false
      failed_when: _power_verify_audit_timer.stdout != 'enabled'

    # ---- Drift detection state directory ----

    - name: Check drift state directory exists
      ansible.builtin.stat:
        path: /var/lib/ansible-power-management
      register: _power_verify_drift_dir
      failed_when: not _power_verify_drift_dir.stat.exists

    - name: Assert drift state directory permissions
      ansible.builtin.assert:
        that:
          - _power_verify_drift_dir.stat.isdir
          - _power_verify_drift_dir.stat.mode == '0700'
        fail_msg: "Drift state directory has wrong type/permissions"
        success_msg: "Drift state directory exists with mode 0700"

    # ---- Summary ----

    - name: Show test results
      ansible.builtin.debug:
        msg:
          - "All power management checks passed!"
          - "Device type: {{ 'laptop' if _power_verify_is_laptop else 'desktop' }}"
          - "cpupower installed, sleep.conf deployed"
          - "logind.conf configured with HandleLidSwitch"
          - "TLP: {{ 'installed and enabled' if _power_verify_is_laptop else 'skipped (desktop)' }}"
          - "Audit: script deployed, timer enabled"
          - "Drift: state directory present"
