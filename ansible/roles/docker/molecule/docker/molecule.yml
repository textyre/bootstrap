---
driver:
  name: docker

platforms:
  # Default security settings (all CIS features enabled, service skipped)
  - name: Archlinux-systemd
    image: "${MOLECULE_ARCH_IMAGE:-ghcr.io/textyre/arch-base:latest}"
    pre_build_image: true
    command: sleep infinity
    dns_servers:
      - 8.8.8.8
      - 8.8.4.4

  - name: Ubuntu-systemd
    image: "${MOLECULE_UBUNTU_IMAGE:-ghcr.io/textyre/ubuntu-base:latest}"
    pre_build_image: true
    command: sleep infinity
    dns_servers:
      - 8.8.8.8
      - 8.8.4.4

  # Negative-path platforms: test optional security settings disabled
  - name: Archlinux-nosec
    image: "${MOLECULE_ARCH_IMAGE:-ghcr.io/textyre/arch-base:latest}"
    pre_build_image: true
    command: sleep infinity
    dns_servers:
      - 8.8.8.8
      - 8.8.4.4

  - name: Ubuntu-nosec
    image: "${MOLECULE_UBUNTU_IMAGE:-ghcr.io/textyre/ubuntu-base:latest}"
    pre_build_image: true
    command: sleep infinity
    dns_servers:
      - 8.8.8.8
      - 8.8.4.4

provisioner:
  name: ansible
  options:
    skip-tags: service
  env:
    ANSIBLE_ROLES_PATH: "${MOLECULE_PROJECT_DIRECTORY}/../"
  config_options:
    defaults:
      callbacks_enabled: profile_tasks
  inventory:
    host_vars:
      # Default security settings (all CIS features enabled)
      # docker_add_user_to_group=false to avoid usermod in containers (unstable in DinD)
      Archlinux-systemd:
        docker_enable_service: false
        docker_add_user_to_group: false
      Ubuntu-systemd:
        docker_enable_service: false
        docker_add_user_to_group: false
      # nosec platforms: all optional security features disabled
      Archlinux-nosec:
        docker_enable_service: false
        docker_icc: true
        docker_userns_remap: ""
        docker_live_restore: false
        docker_no_new_privileges: false
        docker_add_user_to_group: false
      Ubuntu-nosec:
        docker_enable_service: false
        docker_icc: true
        docker_userns_remap: ""
        docker_live_restore: false
        docker_no_new_privileges: false
        docker_add_user_to_group: false
  playbooks:
    prepare: prepare.yml
    converge: ../shared/converge.yml
    verify: ../shared/verify.yml

verifier:
  name: ansible

scenario:
  test_sequence:
    - syntax
    - create
    - prepare
    - converge
    - idempotence
    - verify
    - destroy
