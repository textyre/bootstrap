---
- name: Verify
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/inventory/group_vars/all/vault.yml"

  tasks:
    - name: Check /etc/docker/daemon.json exists
      ansible.builtin.stat:
        path: /etc/docker/daemon.json
      register: docker_verify_daemon_json
      failed_when: not docker_verify_daemon_json.stat.exists

    - name: Check daemon.json is valid JSON
      ansible.builtin.command: python3 -c "import json; json.load(open('/etc/docker/daemon.json'))"
      register: docker_verify_json_valid
      changed_when: false
      failed_when: docker_verify_json_valid.rc != 0

    - name: Check user is in docker group
      ansible.builtin.command: "groups {{ ansible_facts['env']['SUDO_USER'] | default(ansible_facts['user_id']) }}"
      register: docker_verify_docker_group
      changed_when: false
      failed_when: "'docker' not in docker_verify_docker_group.stdout"

    - name: Check docker service is enabled and running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true
      check_mode: true
      register: docker_verify_service
      failed_when: docker_verify_service is changed

    - name: Show test results
      ansible.builtin.debug:
        msg:
          - "All checks passed!"
          - "daemon.json exists and valid"
          - "User in docker group"
          - "docker service enabled and running"
