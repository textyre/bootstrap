---
- name: Verify packages role
  hosts: all
  become: true
  gather_facts: true

  tasks:

    # ---- Build expected package list ----

    - name: Build combined package list (mirrors tasks/main.yml logic)
      ansible.builtin.set_fact:
        packages_verify_expected: >-
          {{ (packages_base | default([]))
             + (packages_editors | default([]))
             + (packages_docker | default([]))
             + (packages_xorg | default([]))
             + (packages_wm | default([]))
             + (packages_filemanager | default([]))
             + (packages_network | default([]))
             + (packages_media | default([]))
             + (packages_desktop | default([]))
             + (packages_graphics | default([]))
             + (packages_session | default([]))
             + (packages_terminal | default([]))
             + (packages_fonts | default([]))
             + (packages_theming | default([]))
             + (packages_search | default([]))
             + (packages_viewers | default([]))
             + (packages_distro[ansible_facts['os_family']] | default([])) }}

    # ---- Gather package facts ----

    - name: Gather package facts
      ansible.builtin.package_facts:
        manager: auto

    # ---- Assert all expected packages are installed ----

    - name: Assert each expected package is installed
      ansible.builtin.assert:
        that: "item in ansible_facts.packages"
        fail_msg: "Package '{{ item }}' not found in installed packages"
        quiet: true
      loop: "{{ packages_verify_expected }}"
      loop_control:
        label: "{{ item }}"

    # ---- Summary ----

    - name: Show verify result
      ansible.builtin.debug:
        msg: >-
          packages verify passed on
          {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}:
          all {{ packages_verify_expected | length }} packages present.
