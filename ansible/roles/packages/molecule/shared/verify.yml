---
- name: Verify packages role
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "../../defaults/main.yml"

  tasks:

    # ---- Build expected package list ----

    - name: Build combined package list (mirrors tasks/main.yml logic)
      ansible.builtin.set_fact:
        packages_verify_expected: >-
          {{ packages_base
             + packages_editors
             + packages_docker
             + packages_xorg
             + packages_wm
             + packages_filemanager
             + packages_network
             + packages_media
             + packages_desktop
             + packages_graphics
             + packages_session
             + packages_terminal
             + packages_fonts
             + packages_theming
             + packages_search
             + packages_viewers
             + (packages_distro[ansible_facts['os_family']] | default([])) }}

    # ---- Gather package facts ----

    - name: Gather package facts
      ansible.builtin.package_facts:
        manager: auto

    # ---- Assert all expected packages are installed ----

    - name: Assert each expected package is installed
      ansible.builtin.assert:
        that: "item in ansible_facts.packages"
        fail_msg: "Package '{{ item }}' not found in installed packages"
        quiet: true
      loop: "{{ packages_verify_expected }}"
      loop_control:
        label: "{{ item }}"

    # ---- Verify idempotence hint: no pending actions ----

    - name: Verify package install is idempotent (Arch)
      community.general.pacman:
        name: "{{ packages_verify_expected }}"
        state: present
      check_mode: true
      register: packages_verify_idem_arch
      when: ansible_facts['os_family'] == 'Archlinux'

    - name: Assert pacman install reports no changes
      ansible.builtin.assert:
        that: not packages_verify_idem_arch.changed
        fail_msg: "pacman would still install packages -- converge was not idempotent"
      when: ansible_facts['os_family'] == 'Archlinux'

    - name: Verify package install is idempotent (Debian)
      ansible.builtin.apt:
        name: "{{ packages_verify_expected }}"
        state: present
      check_mode: true
      register: packages_verify_idem_deb
      when: ansible_facts['os_family'] == 'Debian'

    - name: Assert apt install reports no changes
      ansible.builtin.assert:
        that: not packages_verify_idem_deb.changed
        fail_msg: "apt would still install packages -- converge was not idempotent"
      when: ansible_facts['os_family'] == 'Debian'

    # ---- Summary ----

    - name: Show verify result
      ansible.builtin.debug:
        msg: >-
          packages verify passed on
          {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}:
          all {{ packages_verify_expected | length }} packages present and idempotent.
