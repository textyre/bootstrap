---
- name: Verify packages role
  hosts: all
  become: true
  gather_facts: true

  tasks:

    # ---- Build expected package list (mirrors tasks/main.yml logic) ----

    - name: Build combined package list
      ansible.builtin.set_fact:
        _packages_verify_expected: >-
          {{ (packages_base | default([]))
             + (packages_editors | default([]))
             + (packages_docker | default([]))
             + (packages_xorg | default([]))
             + (packages_wm | default([]))
             + (packages_filemanager | default([]))
             + (packages_network | default([]))
             + (packages_media | default([]))
             + (packages_desktop | default([]))
             + (packages_graphics | default([]))
             + (packages_session | default([]))
             + (packages_terminal | default([]))
             + (packages_fonts | default([]))
             + (packages_theming | default([]))
             + (packages_search | default([]))
             + (packages_viewers | default([]))
             + (packages_distro[ansible_facts['os_family']] | default([])) }}

    # ---- Verify each package is installed via native package manager ----

    - name: "Verify package installed (pacman -Q): {{ item }}"
      ansible.builtin.command:
        cmd: "pacman -Q {{ item }}"
      register: _packages_verify_pacman
      changed_when: false
      failed_when: _packages_verify_pacman.rc != 0
      loop: "{{ _packages_verify_expected }}"
      loop_control:
        label: "{{ item }}"
      when: ansible_facts['os_family'] == 'Archlinux'

    - name: "Verify package installed (dpkg-query): {{ item }}"
      ansible.builtin.command:
        cmd: "dpkg-query -W -f='${Status}' {{ item }}"
      register: _packages_verify_dpkg
      changed_when: false
      failed_when: >-
        _packages_verify_dpkg.rc != 0 or
        'install ok installed' not in _packages_verify_dpkg.stdout
      loop: "{{ _packages_verify_expected }}"
      loop_control:
        label: "{{ item }}"
      when: ansible_facts['os_family'] == 'Debian'

    # ---- Summary ----

    - name: Show verify result
      ansible.builtin.debug:
        msg: >-
          packages verify passed on
          {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}:
          all {{ _packages_verify_expected | length }} packages verified
          via native package manager.
