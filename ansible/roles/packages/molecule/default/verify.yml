---
# Verify that all packages from the test set are installed

- name: Verify
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/inventory/group_vars/all/vault.yml"

  tasks:
    - name: Build combined package list
      ansible.builtin.set_fact:
        _packages_all: >-
          {{ packages_base
             + packages_editors
             + packages_docker
             + packages_xorg
             + packages_wm
             + packages_filemanager
             + packages_network
             + packages_media
             + packages_desktop
             + packages_graphics
             + packages_session
             + packages_terminal
             + packages_fonts
             + packages_theming
             + packages_search
             + packages_viewers
             + (packages_distro[ansible_facts['os_family']] | default([])) }}

    - name: Verify all packages are installed (Arch)
      ansible.builtin.command: "pacman -Q {{ item }}"
      loop: "{{ _packages_all }}"
      changed_when: false
      when: ansible_facts['os_family'] == 'Archlinux'

    - name: Verify all packages are installed (Debian)
      ansible.builtin.command: "dpkg -l {{ item }}"
      loop: "{{ _packages_all }}"
      changed_when: false
      when: ansible_facts['os_family'] == 'Debian'

    - name: Show verification results
      ansible.builtin.debug:
        msg: "All {{ _packages_all | length }} packages verified as installed"
