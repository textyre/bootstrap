---
# Molecule verify playbook
# Проверяет что пакеты установлены корректно

- name: Verify
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/inventory/group_vars/all/vault.yml"

  tasks:
    - name: Check that base packages are installed
      ansible.builtin.package:
        name: "{{ item }}"
        state: present
      check_mode: true
      register: _packages_pkg_check
      failed_when: _packages_pkg_check is changed
      loop:
        - git
        - curl
        - vim

    - name: Check that jq is installed
      ansible.builtin.package:
        name: jq
        state: present
      check_mode: true
      register: _packages_jq_check
      failed_when: _packages_jq_check is changed

    - name: Verify git is executable  # noqa: command-instead-of-module
      ansible.builtin.command: git --version
      changed_when: false
      register: _packages_git_version

    - name: Show test results
      ansible.builtin.debug:
        msg:
          - "All checks passed!"
          - "git: {{ _packages_git_version.stdout }}"
          - "Base packages: installed"
          - "Tools packages: installed"
