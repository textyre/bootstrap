---
# === Official package installation ===
# AUR packages → yay role. Services → docker/lightdm roles. Groups → user role.

# ---- Full system upgrade ----

- name: Full system upgrade (pacman -Syu)
  community.general.pacman:
    update_cache: true
    upgrade: true
  when: ansible_facts['os_family'] == 'Archlinux'
  tags: ['install', 'upgrade']

# ---- Build combined package list ----

- name: Build combined package list
  ansible.builtin.set_fact:
    _packages_all: >-
      {{ packages_base
         + packages_editors
         + packages_docker
         + packages_xorg
         + packages_wm
         + packages_filemanager
         + packages_network
         + packages_media
         + packages_desktop
         + packages_graphics
         + packages_session
         + packages_terminal
         + packages_fonts
         + packages_theming
         + packages_search
         + packages_viewers
         + (packages_distro[ansible_facts['os_family']] | default([])) }}
  tags: ['install']

# ---- OS-specific package installation ----

- name: Install packages (OS-specific)
  ansible.builtin.include_tasks: "install-{{ ansible_facts['os_family'] | lower }}.yml"
  tags: ['install']

# ---- Report ----

- name: Report installed packages
  ansible.builtin.debug:
    msg: "Official packages installed: {{ _packages_all | length }}"
  tags: ['install']
