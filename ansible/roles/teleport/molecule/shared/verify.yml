---
- name: Verify
  hosts: all
  become: true
  gather_facts: true

  tasks:
    # -----------------------------------------------------------------------
    # 1. Teleport binary
    # -----------------------------------------------------------------------
    - name: Check teleport binary is in PATH
      ansible.builtin.shell: command -v teleport
      register: _teleport_verify_which
      changed_when: false
      failed_when: _teleport_verify_which.rc != 0

    - name: Run teleport version
      ansible.builtin.command: teleport version
      register: _teleport_verify_version
      changed_when: false
      failed_when: false

    - name: Assert teleport version runs successfully
      ansible.builtin.assert:
        that:
          - _teleport_verify_version.rc == 0
        fail_msg: >
          'teleport version' failed with rc={{ _teleport_verify_version.rc }}:
          {{ _teleport_verify_version.stderr | default('') }}

    - name: Assert teleport version output contains Teleport
      ansible.builtin.assert:
        that:
          - _teleport_verify_version.stdout is regex('(?i)teleport')
        fail_msg: >
          'teleport version' output does not mention Teleport:
          {{ _teleport_verify_version.stdout }}
      when: _teleport_verify_version.rc == 0

    - name: Show teleport version output
      ansible.builtin.debug:
        msg: "{{ _teleport_verify_version.stdout }}"
      when: _teleport_verify_version.rc == 0

    # -----------------------------------------------------------------------
    # 2. Configuration file — existence and permissions
    # -----------------------------------------------------------------------
    - name: Stat /etc/teleport.yaml
      ansible.builtin.stat:
        path: /etc/teleport.yaml
      register: _teleport_verify_conf_stat

    - name: Assert /etc/teleport.yaml exists
      ansible.builtin.assert:
        that:
          - _teleport_verify_conf_stat.stat.exists
        fail_msg: "/etc/teleport.yaml does not exist"

    - name: Assert /etc/teleport.yaml owner and permissions
      ansible.builtin.assert:
        that:
          - _teleport_verify_conf_stat.stat.pw_name == 'root'
          - _teleport_verify_conf_stat.stat.gr_name == 'root'
          - _teleport_verify_conf_stat.stat.mode == '0600'
        fail_msg: >
          /etc/teleport.yaml has wrong owner/mode:
          owner={{ _teleport_verify_conf_stat.stat.pw_name }}
          group={{ _teleport_verify_conf_stat.stat.gr_name }}
          mode={{ _teleport_verify_conf_stat.stat.mode }}

    # -----------------------------------------------------------------------
    # 3. Configuration file — content validation
    # -----------------------------------------------------------------------
    - name: Slurp /etc/teleport.yaml
      ansible.builtin.slurp:
        src: /etc/teleport.yaml
      register: _teleport_verify_conf_raw
      no_log: true
      when: _teleport_verify_conf_stat.stat.exists

    - name: Assert slurp succeeded
      ansible.builtin.assert:
        that:
          - "'content' in _teleport_verify_conf_raw"
        fail_msg: "Failed to slurp /etc/teleport.yaml"
      when: _teleport_verify_conf_stat.stat.exists

    - name: Decode teleport config
      ansible.builtin.set_fact:
        _teleport_verify_conf_content: "{{ _teleport_verify_conf_raw.content | b64decode }}"
      no_log: true
      when:
        - _teleport_verify_conf_stat.stat.exists
        - "'content' in _teleport_verify_conf_raw"

    - name: Assert config contains version v3
      ansible.builtin.assert:
        that:
          - "'version: v3' in _teleport_verify_conf_content"
        fail_msg: "Config does not contain 'version: v3'"
      when: _teleport_verify_conf_content is defined

    - name: Assert config contains auth_server address
      ansible.builtin.assert:
        that:
          - _teleport_verify_conf_content is regex('auth_server:.*localhost:3025')
        fail_msg: "Config does not contain 'auth_server: localhost:3025'"
      when: _teleport_verify_conf_content is defined

    - name: Assert config contains nodename
      ansible.builtin.assert:
        that:
          - _teleport_verify_conf_content is regex('nodename:.*molecule-test')
        fail_msg: "Config does not contain expected nodename"
      when: _teleport_verify_conf_content is defined

    - name: Assert config contains auth_token
      ansible.builtin.assert:
        that:
          - "'auth_token:' in _teleport_verify_conf_content"
        fail_msg: "Config does not contain 'auth_token:'"
      when: _teleport_verify_conf_content is defined

    - name: Assert config contains data_dir
      ansible.builtin.assert:
        that:
          - "'data_dir: /var/lib/teleport' in _teleport_verify_conf_content"
        fail_msg: "Config does not contain 'data_dir: /var/lib/teleport'"
      when: _teleport_verify_conf_content is defined

    - name: Assert ssh_service section present
      ansible.builtin.assert:
        that:
          - "'ssh_service:' in _teleport_verify_conf_content"
        fail_msg: "Config does not contain 'ssh_service:' section"
      when: _teleport_verify_conf_content is defined

    - name: Assert proxy_service section present
      ansible.builtin.assert:
        that:
          - "'proxy_service:' in _teleport_verify_conf_content"
        fail_msg: "Config does not contain 'proxy_service:' section"
      when: _teleport_verify_conf_content is defined

    - name: Assert auth_service section present
      ansible.builtin.assert:
        that:
          - "'auth_service:' in _teleport_verify_conf_content"
        fail_msg: "Config does not contain 'auth_service:' section"
      when: _teleport_verify_conf_content is defined

    - name: Assert session_recording mode (proxy)
      ansible.builtin.assert:
        that:
          - _teleport_verify_conf_content is regex('mode:\s*["\x27]?proxy["\x27]?')
        fail_msg: >
          Config does not contain session recording mode 'proxy'.
          Content: {{ _teleport_verify_conf_content }}
      when: _teleport_verify_conf_content is defined

    - name: Assert enhanced_recording section present
      ansible.builtin.assert:
        that:
          - "'enhanced_recording:' in _teleport_verify_conf_content"
        fail_msg: "Config does not contain enhanced_recording section"
      when: _teleport_verify_conf_content is defined

    - name: Assert enhanced_recording is enabled
      ansible.builtin.assert:
        that:
          - _teleport_verify_conf_content is regex('enabled:\s*true')
        fail_msg: "Config does not contain enhanced_recording enabled: true"
      when: _teleport_verify_conf_content is defined

    - name: Assert labels section present
      ansible.builtin.assert:
        that:
          - "'labels:' in _teleport_verify_conf_content"
        fail_msg: "Config does not contain labels section"
      when: _teleport_verify_conf_content is defined

    - name: Assert env label present
      ansible.builtin.assert:
        that:
          - _teleport_verify_conf_content is regex('env:')
        fail_msg: "Config does not contain env label"
      when: _teleport_verify_conf_content is defined

    - name: Assert Ansible managed header
      ansible.builtin.assert:
        that:
          - _teleport_verify_conf_content is regex('(?i)(ansible.managed|managed.by.ansible)')
        fail_msg: "Config does not contain Ansible managed header"
      when: _teleport_verify_conf_content is defined

    # -----------------------------------------------------------------------
    # 4. Data directory
    # -----------------------------------------------------------------------
    - name: Stat /var/lib/teleport
      ansible.builtin.stat:
        path: /var/lib/teleport
      register: _teleport_verify_datadir

    - name: Assert /var/lib/teleport exists and is a directory
      ansible.builtin.assert:
        that:
          - _teleport_verify_datadir.stat.exists
          - _teleport_verify_datadir.stat.isdir
        fail_msg: "/var/lib/teleport does not exist or is not a directory"

    - name: Assert /var/lib/teleport owner and permissions
      ansible.builtin.assert:
        that:
          - _teleport_verify_datadir.stat.pw_name == 'root'
          - _teleport_verify_datadir.stat.gr_name == 'root'
          - _teleport_verify_datadir.stat.mode == '0750'
        fail_msg: >
          /var/lib/teleport has wrong owner/mode:
          owner={{ _teleport_verify_datadir.stat.pw_name }}
          group={{ _teleport_verify_datadir.stat.gr_name }}
          mode={{ _teleport_verify_datadir.stat.mode }}

    # -----------------------------------------------------------------------
    # 5. Service enabled state (non-Docker only)
    # -----------------------------------------------------------------------
    - name: Check teleport service is enabled
      ansible.builtin.command:
        cmd: systemctl is-enabled teleport
      register: _teleport_verify_svc_enabled
      changed_when: false
      failed_when: false
      when: ansible_virtualization_type | default('') != 'docker'

    - name: Assert teleport service is enabled
      ansible.builtin.assert:
        that:
          - "'enabled' in _teleport_verify_svc_enabled.stdout"
        fail_msg: >
          teleport service is not enabled:
          {{ _teleport_verify_svc_enabled.stdout | default('') }}
      when:
        - ansible_virtualization_type | default('') != 'docker'
        - _teleport_verify_svc_enabled is defined

    # -----------------------------------------------------------------------
    # 6. Diagnostic notes for Docker-skipped items
    # -----------------------------------------------------------------------
    - name: Note -- service start/connectivity not tested in Docker
      ansible.builtin.debug:
        msg: >
          teleport service start and cluster connectivity are skipped in
          Docker molecule (skip-tags: service). Runtime connectivity
          requires a live Teleport auth cluster -- not tested here.
      when: ansible_virtualization_type | default('') == 'docker'

    - name: Note -- CA export not tested (requires live cluster)
      ansible.builtin.debug:
        msg: >
          teleport_export_ca_key=false in converge vars, so CA export is
          not exercised. CA export requires tctl access to a running auth
          server -- out of scope for offline molecule tests.
