---
# ROLE-005: In-role verification

- name: "Verify teleport binary exists"
  ansible.builtin.command:
    cmd: "teleport version"
  register: teleport_verify_version
  changed_when: false
  failed_when: _teleport_verify_version.rc != 0
  tags: [teleport]

- name: "Verify teleport configuration exists"
  ansible.builtin.stat:
    path: /etc/teleport.yaml
  register: teleport_verify_config
  tags: [teleport]

- name: "Assert teleport configuration exists"
  ansible.builtin.assert:
    that:
      - _teleport_verify_config.stat.exists
      - _teleport_verify_config.stat.mode == '0600'
    fail_msg: "Teleport configuration missing or wrong permissions"
  tags: [teleport]

- name: "Verify teleport service is running"
  ansible.builtin.command:
    cmd: "teleport status"
  register: teleport_verify_status
  changed_when: false
  failed_when: false
  tags: [teleport]
