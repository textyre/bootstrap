---
name: "Molecule"

on:
  push:
    branches: [master]
    paths:
      - 'ansible/roles/**'
      - 'ansible/molecule/Dockerfile.*'
      - 'ansible/requirements.txt'
      - '.github/workflows/molecule.yml'
      - '.github/workflows/_molecule.yml'
  pull_request:
    branches: [master]
    paths:
      - 'ansible/roles/**'
      - 'ansible/molecule/Dockerfile.*'
      - 'ansible/requirements.txt'
      - '.github/workflows/molecule.yml'
      - '.github/workflows/_molecule.yml'
  workflow_dispatch:
    inputs:
      role_filter:
        description: 'Role to test, or "all" for all CI-ready roles'
        required: false
        default: 'all'

concurrency:
  group: molecule-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect:
    name: Detect changed roles
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build.outputs.matrix }}
      empty: ${{ steps.build.outputs.empty }}
      dockerfile_changed: ${{ steps.build.outputs.dockerfile_changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        if: github.event_name != 'workflow_dispatch'
        uses: tj-actions/changed-files@v46
        with:
          files: 'ansible/**'

      - name: Build role matrix
        id: build
        run: |
          # CI-ready roles = those with molecule/docker/molecule.yml
          ALL_ROLES=$(find ansible/roles -name molecule.yml -path "*/docker/molecule.yml" \
            | sed 's|ansible/roles/||;s|/molecule.*||' | sort -u)
          CHANGED=""  # empty on workflow_dispatch; populated on push/PR

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            FILTER="${{ inputs.role_filter }}"
            if [ "$FILTER" = "all" ] || [ -z "$FILTER" ]; then
              ROLES="$ALL_ROLES"
            else
              ROLES="$FILTER"
            fi
          else
            CHANGED="${{ steps.changed.outputs.all_changed_files }}"
            # Infrastructure or common changed â†’ run all CI-ready roles
            if echo "$CHANGED" | tr ' ' '\n' | grep -qE \
              "^ansible/roles/common/|^ansible/molecule/|^ansible/requirements\.txt"; then
              ROLES="$ALL_ROLES"
            else
              # Only changed roles that are CI-ready
              ROLES=$(echo "$CHANGED" | tr ' ' '\n' \
                | grep "^ansible/roles/" \
                | sed 's|ansible/roles/||;s|/.*||' \
                | sort -u \
                | while IFS= read -r role; do
                    [ -f "ansible/roles/$role/molecule/docker/molecule.yml" ] && echo "$role"
                  done)
            fi
          fi

          # Check if Dockerfile changed (only meaningful on push/PR, not dispatch)
          if echo "$CHANGED" | tr ' ' '\n' | grep -q "^ansible/molecule/Dockerfile"; then
            echo "dockerfile_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "dockerfile_changed=false" >> "$GITHUB_OUTPUT"
          fi

          MATRIX=$(printf '%s\n' $ROLES | grep -v '^$' \
            | jq -Rsc '[split("\n")[] | select(length > 0)]')
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"
          if [ "$MATRIX" = "[]" ]; then
            echo "empty=true" >> "$GITHUB_OUTPUT"
          else
            echo "empty=false" >> "$GITHUB_OUTPUT"
          fi

  build-image:
    name: Rebuild arch-systemd image
    needs: detect
    if: needs.detect.outputs.dockerfile_changed == 'true' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ansible/molecule
          file: ansible/molecule/Dockerfile.archlinux
          push: true
          tags: ghcr.io/${{ github.repository }}/arch-systemd:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify image contract
        env:
          IMAGE: ghcr.io/${{ github.repository }}/arch-systemd:latest
        run: |
          docker run --rm "$IMAGE" sh -c '
            set -e
            echo "=== Image Contract Verification ==="
            echo -n "systemd: "   && test -x /usr/lib/systemd/systemd && echo OK
            echo -n "python: "    && python --version
            echo -n "sudo: "      && sudo --version | head -1
            echo -n "SUPPORTED: " && test -f /usr/share/i18n/SUPPORTED && echo OK
            echo -n "en_US: "     && test -f /usr/share/i18n/locales/en_US && echo OK
            echo -n "ru_RU: "     && test -f /usr/share/i18n/locales/ru_RU && echo OK
            echo -n "locale-gen: " && command -v locale-gen
            echo "=== Image contract: PASS ==="
          '

  test:
    needs: [detect, build-image]
    if: always() && needs.detect.outputs.empty == 'false' && needs.build-image.result != 'failure'
    strategy:
      matrix:
        role: ${{ fromJSON(needs.detect.outputs.matrix) }}
      fail-fast: false
    uses: ./.github/workflows/_molecule.yml
    with:
      role_name: ${{ matrix.role }}
