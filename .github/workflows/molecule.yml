# Purpose: Main CI orchestrator for Molecule tests. Detects which roles changed
#          and dispatches Docker (fast) and Vagrant/KVM (realistic) test matrices.
# Triggers: push/PR to master (ansible/roles/**, requirements.txt, workflow files),
#           workflow_dispatch (role_filter input: specific role name or "all")
# Uses:    .github/workflows/_molecule.yml (Docker runner)
#          .github/workflows/_molecule-vagrant.yml (Vagrant runner)
# Notes:   Only roles with molecule/docker/molecule.yml are CI-ready.
#          Changes to ansible/roles/common/ trigger ALL CI-ready roles.
---
name: "Molecule"

on:
  push:
    branches: [master]
    paths:
      - 'ansible/roles/**'
      - 'ansible/requirements.txt'
      - '.github/workflows/molecule.yml'
      - '.github/workflows/_molecule.yml'
      - '.github/workflows/_molecule-vagrant.yml'
  pull_request:
    branches: [master]
    paths:
      - 'ansible/roles/**'
      - 'ansible/requirements.txt'
      - '.github/workflows/molecule.yml'
      - '.github/workflows/_molecule.yml'
      - '.github/workflows/_molecule-vagrant.yml'
  workflow_dispatch:
    inputs:
      role_filter:
        description: 'Role to test, or "all" for all CI-ready roles'
        required: false
        default: 'all'

concurrency:
  group: molecule-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect:
    name: Detect changed roles
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build.outputs.matrix }}
      empty: ${{ steps.build.outputs.empty }}
      vagrant_matrix: ${{ steps.build.outputs.vagrant_matrix }}
      vagrant_empty: ${{ steps.build.outputs.vagrant_empty }}
      vagrant_laptop_matrix: ${{ steps.build.outputs.vagrant_laptop_matrix }}
      vagrant_laptop_empty: ${{ steps.build.outputs.vagrant_laptop_empty }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        if: github.event_name != 'workflow_dispatch'
        uses: tj-actions/changed-files@v46
        with:
          files: 'ansible/**'

      - name: Build role matrix
        id: build
        run: |
          # CI-ready roles = those with molecule/docker/molecule.yml
          ALL_ROLES=$(find ansible/roles -name molecule.yml -path "*/docker/molecule.yml" \
            | sed 's|ansible/roles/||;s|/molecule.*||' | sort -u)
          # Vagrant-capable roles = those also with molecule/vagrant/molecule.yml
          ALL_VAGRANT=$(find ansible/roles -name molecule.yml -path "*/vagrant/molecule.yml" \
            | sed 's|ansible/roles/||;s|/molecule.*||' | sort -u)

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            FILTER="${{ inputs.role_filter }}"
            if [ "$FILTER" = "all" ] || [ -z "$FILTER" ]; then
              ROLES="$ALL_ROLES"
            else
              ROLES="$FILTER"
            fi
          else
            CHANGED="${{ steps.changed.outputs.all_changed_files }}"
            # Infrastructure or common changed â†’ run all CI-ready roles
            if echo "$CHANGED" | tr ' ' '\n' | grep -qE \
              "^ansible/roles/common/|^ansible/requirements\.txt"; then
              ROLES="$ALL_ROLES"
            else
              # Only changed roles that are CI-ready
              ROLES=$(echo "$CHANGED" | tr ' ' '\n' \
                | grep "^ansible/roles/" \
                | sed 's|ansible/roles/||;s|/.*||' \
                | sort -u \
                | while IFS= read -r role; do
                    [ -f "ansible/roles/$role/molecule/docker/molecule.yml" ] && echo "$role"
                  done)
            fi
          fi

          MATRIX=$(printf '%s\n' $ROLES | grep -v '^$' \
            | jq -Rsc '[split("\n")[] | select(length > 0)]')
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"
          if [ "$MATRIX" = "[]" ]; then
            echo "empty=true" >> "$GITHUB_OUTPUT"
          else
            echo "empty=false" >> "$GITHUB_OUTPUT"
          fi

          # Vagrant matrix = intersection of changed roles and vagrant-capable roles
          VAGRANT_ROLES=$(comm -12 \
            <(printf '%s\n' $ROLES | sort -u | grep -v '^$') \
            <(printf '%s\n' $ALL_VAGRANT | grep -v '^$'))
          VAGRANT_MATRIX=$(printf '%s\n' $VAGRANT_ROLES | grep -v '^$' \
            | jq -Rsc '[split("\n")[] | select(length > 0)]')
          echo "vagrant_matrix=$VAGRANT_MATRIX" >> "$GITHUB_OUTPUT"
          if [ "$VAGRANT_MATRIX" = "[]" ]; then
            echo "vagrant_empty=true" >> "$GITHUB_OUTPUT"
          else
            echo "vagrant_empty=false" >> "$GITHUB_OUTPUT"
          fi

          # Vagrant-laptop roles = those with molecule/vagrant-laptop/molecule.yml
          ALL_VAGRANT_LAPTOP=$(find ansible/roles -name molecule.yml -path "*/vagrant-laptop/molecule.yml" \
            | sed 's|ansible/roles/||;s|/molecule.*||' | sort -u)
          VAGRANT_LAPTOP_ROLES=$(comm -12 \
            <(printf '%s\n' $ROLES | sort -u | grep -v '^$') \
            <(printf '%s\n' $ALL_VAGRANT_LAPTOP | grep -v '^$'))
          VAGRANT_LAPTOP_MATRIX=$(printf '%s\n' $VAGRANT_LAPTOP_ROLES | grep -v '^$' \
            | jq -Rsc '[split("\n")[] | select(length > 0)]')
          echo "vagrant_laptop_matrix=$VAGRANT_LAPTOP_MATRIX" >> "$GITHUB_OUTPUT"
          if [ "$VAGRANT_LAPTOP_MATRIX" = "[]" ]; then
            echo "vagrant_laptop_empty=true" >> "$GITHUB_OUTPUT"
          else
            echo "vagrant_laptop_empty=false" >> "$GITHUB_OUTPUT"
          fi

  test:
    needs: detect
    if: needs.detect.outputs.empty == 'false'
    strategy:
      matrix:
        role: ${{ fromJSON(needs.detect.outputs.matrix) }}
      fail-fast: false
    uses: ./.github/workflows/_molecule.yml
    with:
      role_name: ${{ matrix.role }}

  test-vagrant:
    needs: detect
    if: needs.detect.outputs.vagrant_empty == 'false'
    strategy:
      matrix:
        role: ${{ fromJSON(needs.detect.outputs.vagrant_matrix) }}
        platform: [arch-vm, ubuntu-base]
      fail-fast: false
    uses: ./.github/workflows/_molecule-vagrant.yml
    with:
      role_name: ${{ matrix.role }}
      platform: ${{ matrix.platform }}

  test-vagrant-laptop:
    needs: detect
    if: needs.detect.outputs.vagrant_laptop_empty == 'false'
    strategy:
      matrix:
        role: ${{ fromJSON(needs.detect.outputs.vagrant_laptop_matrix) }}
        platform: [arch-vm, ubuntu-base]
      fail-fast: false
    uses: ./.github/workflows/_molecule-vagrant.yml
    with:
      role_name: ${{ matrix.role }}
      platform: ${{ matrix.platform }}
      scenario: vagrant-laptop
