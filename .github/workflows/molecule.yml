# Purpose: Docker-based Molecule tests. Detects changed roles and runs
#          molecule test -s docker for each in a ci-env container.
# Triggers: push/PR to master (ansible/roles/**, requirements.txt),
#           workflow_dispatch (role_filter: role name or "all")
# Uses:    ghcr.io/<repo>/ci-env:latest  (built by build-ci-image.yml)
#          ghcr.io/textyre/arch-base:latest
#          ghcr.io/textyre/ubuntu-base:latest
# Notes:   Only roles with molecule/docker/molecule.yml are tested here.
#          Changes to ansible/roles/common/ trigger ALL CI-ready roles.
---
name: "Molecule"

on:
  push:
    branches: [master]
    paths:
      - 'ansible/roles/**'
      - 'ansible/requirements.txt'
      - '.github/workflows/molecule.yml'
  pull_request:
    branches: [master]
    paths:
      - 'ansible/roles/**'
      - 'ansible/requirements.txt'
      - '.github/workflows/molecule.yml'
  workflow_dispatch:
    inputs:
      role_filter:
        description: 'Role to test, or "all" for all CI-ready roles'
        required: false
        default: 'all'

concurrency:
  group: molecule-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect:
    name: Detect changed roles
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build.outputs.matrix }}
      empty: ${{ steps.build.outputs.empty }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        if: github.event_name != 'workflow_dispatch'
        uses: tj-actions/changed-files@v46
        with:
          files: 'ansible/**'

      - name: Build role matrix
        id: build
        run: |
          # CI-ready roles = those with molecule/docker/molecule.yml
          ALL_ROLES=$(find ansible/roles -name molecule.yml -path "*/docker/molecule.yml" \
            | sed 's|ansible/roles/||;s|/molecule.*||' | sort -u)

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            FILTER="${{ inputs.role_filter }}"
            if [ "$FILTER" = "all" ] || [ -z "$FILTER" ]; then
              ROLES="$ALL_ROLES"
            else
              ROLES="$FILTER"
            fi
          else
            CHANGED="${{ steps.changed.outputs.all_changed_files }}"
            # Infrastructure or common changed â†’ run all CI-ready roles
            if echo "$CHANGED" | tr ' ' '\n' | grep -qE \
              "^ansible/roles/common/|^ansible/requirements\.txt"; then
              ROLES="$ALL_ROLES"
            else
              # Only changed roles that are CI-ready
              ROLES=$(echo "$CHANGED" | tr ' ' '\n' \
                | grep "^ansible/roles/" \
                | sed 's|ansible/roles/||;s|/.*||' \
                | sort -u \
                | while IFS= read -r role; do
                    [ -f "ansible/roles/$role/molecule/docker/molecule.yml" ] && echo "$role"
                  done)
            fi
          fi

          MATRIX=$(printf '%s\n' $ROLES | grep -v '^$' \
            | jq -Rsc '[split("\n")[] | select(length > 0)]')
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"
          if [ "$MATRIX" = "[]" ]; then
            echo "empty=true" >> "$GITHUB_OUTPUT"
          else
            echo "empty=false" >> "$GITHUB_OUTPUT"
          fi

  test-docker:
    needs: detect
    if: needs.detect.outputs.empty == 'false'
    name: "${{ matrix.role }} (test-docker)"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        role: ${{ fromJSON(needs.detect.outputs.matrix) }}
      fail-fast: false
    container:
      image: ghcr.io/${{ github.repository }}/ci-env:latest
      options: --volume /var/run/docker.sock:/var/run/docker.sock
    env:
      PY_COLORS: "1"
      ANSIBLE_FORCE_COLOR: "1"
      MOLECULE_ARCH_IMAGE: ghcr.io/textyre/arch-base:latest
      MOLECULE_UBUNTU_IMAGE: ghcr.io/textyre/ubuntu-base:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Molecule
        run: molecule test -s docker
        working-directory: "ansible/roles/${{ matrix.role }}"
