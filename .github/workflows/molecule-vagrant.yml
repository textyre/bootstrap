---
name: "Molecule Vagrant (KVM)"

on:
  schedule:
    - cron: '0 4 * * 1'  # Weekly, Monday 04:00 UTC
  workflow_dispatch:
    inputs:
      role:
        description: 'Role to test (must have molecule/vagrant/ scenario)'
        default: 'package_manager'
        required: false

jobs:
  vagrant-test:
    name: "${{ inputs.role || 'package_manager' }} â€” ${{ matrix.platform }}"
    runs-on: ubuntu-latest

    strategy:
      matrix:
        platform: [arch-vm, ubuntu-noble]
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | \
            sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Install libvirt + vagrant
        run: |
          # Add HashiCorp apt repo (vagrant not in Ubuntu 24.04 standard repos)
          wget -O- https://apt.releases.hashicorp.com/gpg | \
            sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
            https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
            sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -qq
          sudo apt-get install -y \
            libvirt-daemon-system libvirt-dev qemu-kvm \
            vagrant ruby-dev build-essential pkg-config
          sudo systemctl start libvirtd
          sudo chmod a+rw /var/run/libvirt/libvirt-sock
          vagrant plugin install vagrant-libvirt

      - name: Set up Python + molecule
        run: |
          python3 -m venv .venv
          .venv/bin/pip install --quiet --upgrade pip
          .venv/bin/pip install --quiet \
            "ansible-core==2.20.1" \
            "molecule==25.12.0" \
            "molecule-plugins[vagrant]==25.8.12" \
            "python-vagrant" \
            "jmespath" "rich"
          # Ansible discovers system Python (/usr/bin/python3) for localhost module
          # execution. The vagrant Ansible module needs python-vagrant importable from
          # that Python. Install system-wide so it's always in sys.path.
          sudo python3 -m pip install --break-system-packages python-vagrant
          python3 -c "import vagrant; print('python-vagrant OK:', vagrant.__file__)"

      - name: Install Ansible Galaxy collections
        run: .venv/bin/ansible-galaxy collection install -r ansible/requirements.yml

      - name: Run Molecule
        env:
          PY_COLORS: "1"
          ANSIBLE_FORCE_COLOR: "1"
        run: |
          # molecule-plugins vagrant driver needs ANSIBLE_LIBRARY pointing to its module directory
          VAGRANT_PKG=$($GITHUB_WORKSPACE/.venv/bin/python3 -c \
            "import os, molecule_plugins.vagrant; print(os.path.dirname(molecule_plugins.vagrant.__file__))")
          export ANSIBLE_LIBRARY="$VAGRANT_PKG"
          $GITHUB_WORKSPACE/.venv/bin/molecule test -s vagrant --platform-name ${{ matrix.platform }}
        working-directory: "ansible/roles/${{ inputs.role || 'package_manager' }}"
