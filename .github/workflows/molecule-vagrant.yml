---
name: "Molecule Vagrant (KVM)"

on:
  schedule:
    - cron: '0 4 * * 1'  # Weekly, Monday 04:00 UTC
  workflow_dispatch:
    inputs:
      role:
        description: 'Role to test (must have molecule/vagrant/ scenario)'
        default: 'package_manager'
        required: false

jobs:
  vagrant-test:
    name: "${{ inputs.role || 'package_manager' }} â€” ${{ matrix.platform }}"
    runs-on: ubuntu-latest

    strategy:
      matrix:
        platform: [arch-vm, ubuntu-base]
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | \
            sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Install libvirt + vagrant
        run: |
          # Add HashiCorp apt repo (vagrant not in Ubuntu 24.04 standard repos)
          wget -O- https://apt.releases.hashicorp.com/gpg | \
            sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
            https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
            sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -qq
          sudo apt-get install -y \
            libvirt-daemon-system libvirt-dev qemu-kvm \
            vagrant ruby-dev build-essential pkg-config
          sudo systemctl start libvirtd
          sudo chmod a+rw /var/run/libvirt/libvirt-sock
          vagrant plugin install vagrant-libvirt

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install molecule + dependencies
        run: |
          pip install \
            "ansible-core==2.20.1" \
            "molecule==25.12.0" \
            "molecule-plugins[vagrant]==25.8.12" \
            "jmespath" "rich"
          # molecule-plugins[vagrant] depends on python-vagrant; verify it's importable
          python -c "import vagrant; print('python-vagrant OK:', vagrant.__file__)"

      - name: Install Ansible Galaxy collections
        run: ansible-galaxy collection install -r ansible/requirements.yml

      - name: Run Molecule
        env:
          PY_COLORS: "1"
          ANSIBLE_FORCE_COLOR: "1"
        run: |
          # molecule-plugins bundles a vagrant Ansible module in its modules/ directory.
          # Point ANSIBLE_LIBRARY there so Ansible resolves the 'vagrant' task action.
          VAGRANT_MODULES=$(python3 -c \
            "import os, molecule_plugins.vagrant; \
             print(os.path.join(os.path.dirname(molecule_plugins.vagrant.__file__), 'modules'))")
          export ANSIBLE_LIBRARY="$VAGRANT_MODULES"
          molecule test -s vagrant --platform-name ${{ matrix.platform }}
        working-directory: "ansible/roles/${{ inputs.role || 'package_manager' }}"
