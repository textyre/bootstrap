# Purpose: Reusable workflow — runs molecule test for a single role using Vagrant/KVM.
#          Provides a realistic systemd environment closer to production than Docker.
# Triggers: workflow_call only (called by molecule.yml)
# Uses:    arch-base.box (github.com/textyre/arch-images releases)
#          ubuntu-base.box (github.com/textyre/ubuntu-images releases)
# Notes:   KVM is enabled via udev rules. vagrant-libvirt is always reinstalled
#          fresh (native .so must be compiled against the runner's libvirt).
#          Pip cache key contains HARDCODED versions — update key when bumping deps.
#          [KNOWN ISSUE #5] Cache key: pip-vagrant-${{ runner.os }}-ansible-core-2.20.1-molecule-25.12.0
---
name: "Molecule Vagrant (reusable)"

on:
  workflow_call:
    inputs:
      role_name:
        required: true
        type: string
        description: "Role name (directory under ansible/roles/)"
      platform:
        required: true
        type: string
        description: "Vagrant platform name (arch-vm or ubuntu-base)"
      scenario:
        required: false
        type: string
        default: 'vagrant'
        description: "Molecule scenario name (default: vagrant)"

jobs:
  test:
    name: "${{ inputs.role_name }} — ${{ inputs.platform }}"
    runs-on: ubuntu-latest

    concurrency:
      group: "${{ inputs.scenario }}-${{ inputs.role_name }}-${{ inputs.platform }}-${{ github.event.pull_request.number || github.sha }}"
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | \
            sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Install libvirt + vagrant
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | \
            sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
            https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
            sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -qq
          sudo apt-get install -y \
            libvirt-daemon-system libvirt-dev qemu-kvm \
            vagrant ruby-dev build-essential pkg-config
          sudo systemctl start libvirtd
          sudo chmod a+rw /var/run/libvirt/libvirt-sock

      - name: Get Vagrant version
        id: vagrant-ver
        run: echo "version=$(vagrant --version | cut -d' ' -f2)" >> $GITHUB_OUTPUT

      - name: Get libvirt version
        id: libvirt-ver
        run: echo "version=$(dpkg -s libvirt-dev | grep '^Version:' | cut -d' ' -f2)" >> $GITHUB_OUTPUT

      - name: Cache vagrant plugins
        uses: actions/cache@v4
        id: vagrant-gems-cache
        with:
          path: ~/.vagrant.d/gems
          key: vagrant-gems-${{ runner.os }}-${{ steps.vagrant-ver.outputs.version }}-libvirt${{ steps.libvirt-ver.outputs.version }}
          restore-keys: |
            vagrant-gems-${{ runner.os }}-${{ steps.vagrant-ver.outputs.version }}-
            vagrant-gems-${{ runner.os }}-

      - name: Install vagrant-libvirt plugin
        run: |
          # Always uninstall + reinstall so native extensions are compiled fresh
          # against this runner's libvirt. The gems cache speeds up the download
          # (.gem files in ~/.vagrant.d/gems/cache/) but extensions must be rebuilt.
          vagrant plugin uninstall vagrant-libvirt 2>/dev/null || true
          vagrant plugin install vagrant-libvirt

      - name: Resolve box version
        id: box
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ inputs.platform }}" = "arch-vm" ]; then
            TAG=$(gh api repos/textyre/arch-images/releases/latest --jq '.tag_name')
            echo "name=arch-base" >> $GITHUB_OUTPUT
            echo "url=https://github.com/textyre/arch-images/releases/latest/download/arch-base.box" >> $GITHUB_OUTPUT
          else
            TAG=$(gh api repos/textyre/ubuntu-images/releases/latest --jq '.tag_name')
            echo "name=ubuntu-base" >> $GITHUB_OUTPUT
            echo "url=https://github.com/textyre/ubuntu-images/releases/latest/download/ubuntu-base.box" >> $GITHUB_OUTPUT
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Cache Vagrant box
        uses: actions/cache@v4
        id: box-cache
        with:
          path: ~/.vagrant.d/boxes
          key: vagrant-box-${{ inputs.platform }}-${{ steps.box.outputs.tag }}
          restore-keys: vagrant-box-${{ inputs.platform }}-

      - name: Add Vagrant box
        if: steps.box-cache.outputs.cache-hit != 'true'
        run: |
          vagrant box add ${{ steps.box.outputs.name }} \
            ${{ steps.box.outputs.url }} --provider libvirt

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-vagrant-${{ runner.os }}-ansible-core-2.20.1-molecule-25.12.0
          restore-keys: pip-vagrant-${{ runner.os }}-

      - name: Install molecule + dependencies
        run: |
          pip install \
            "ansible-core==2.20.1" \
            "molecule==25.12.0" \
            "molecule-plugins[vagrant]==25.8.12" \
            "jmespath" "rich"
          python -c "import vagrant; print('python-vagrant OK:', vagrant.__file__)"

      - name: Cache Ansible collections
        uses: actions/cache@v4
        with:
          path: ~/.ansible/collections
          key: ansible-collections-${{ hashFiles('ansible/requirements.yml') }}
          restore-keys: ansible-collections-

      - name: Install Ansible Galaxy collections
        run: ansible-galaxy collection install -r ansible/requirements.yml

      - name: Run Molecule
        env:
          PY_COLORS: "1"
          ANSIBLE_FORCE_COLOR: "1"
        run: |
          VAGRANT_MODULES=$(python3 -c \
            "import os, molecule_plugins.vagrant; \
             print(os.path.join(os.path.dirname(molecule_plugins.vagrant.__file__), 'modules'))")
          export ANSIBLE_LIBRARY="$VAGRANT_MODULES"
          molecule test -s ${{ inputs.scenario }} --platform-name ${{ inputs.platform }}
        working-directory: "ansible/roles/${{ inputs.role_name }}"
