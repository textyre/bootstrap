---
name: "Molecule Vagrant (reusable)"

on:
  workflow_call:
    inputs:
      role_name:
        required: true
        type: string
        description: "Role name (directory under ansible/roles/)"
      platform:
        required: true
        type: string
        description: "Vagrant platform name (arch-vm or ubuntu-base)"
      scenario:
        required: false
        type: string
        default: 'vagrant'
        description: "Molecule scenario name (default: vagrant)"

jobs:
  test:
    name: "${{ inputs.role_name }} â€” ${{ inputs.platform }}"
    runs-on: ubuntu-latest
    timeout-minutes: 60

    concurrency:
      group: "${{ inputs.scenario }}-${{ inputs.role_name }}-${{ inputs.platform }}-${{ github.event.pull_request.number || github.sha }}"
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | \
            sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: apt-vagrant-${{ runner.os }}-${{ hashFiles('.github/workflows/_molecule-vagrant.yml') }}
          restore-keys: apt-vagrant-${{ runner.os }}-

      - name: Install libvirt + vagrant
        run: |
          wget --fail --retry-connrefused --tries=3 -O- https://apt.releases.hashicorp.com/gpg | \
            sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
            https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
            sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -qq
          sudo apt-get install -y \
            libvirt-daemon-system libvirt-dev qemu-kvm \
            vagrant ruby-dev build-essential pkg-config
          sudo systemctl start libvirtd
          sudo chmod a+rw /var/run/libvirt/libvirt-sock

      - name: Get tool versions
        id: versions
        run: |
          echo "vagrant=$(vagrant --version | cut -d' ' -f2)" >> $GITHUB_OUTPUT
          echo "libvirt=$(dpkg -s libvirt-dev | grep '^Version:' | cut -d' ' -f2)" >> $GITHUB_OUTPUT

      - name: Cache vagrant plugins
        uses: actions/cache@v4
        id: vagrant-gems-cache
        with:
          path: ~/.vagrant.d/gems
          key: vagrant-gems-${{ runner.os }}-${{ steps.versions.outputs.vagrant }}-libvirt${{ steps.versions.outputs.libvirt }}
          restore-keys: |
            vagrant-gems-${{ runner.os }}-${{ steps.versions.outputs.vagrant }}-
            vagrant-gems-${{ runner.os }}-

      - name: Install vagrant-libvirt plugin
        run: |
          # Always uninstall + reinstall so native extensions are compiled fresh
          # against this runner's libvirt. The gems cache speeds up the download
          # (.gem files in ~/.vagrant.d/gems/cache/) but extensions must be rebuilt.
          vagrant plugin uninstall vagrant-libvirt 2>/dev/null || true
          vagrant plugin install vagrant-libvirt

      - name: Resolve box version
        id: box
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ inputs.platform }}" = "arch-vm" ]; then
            TAG=$(gh api repos/textyre/arch-images/releases/latest --jq '.tag_name')
            echo "name=arch-base" >> $GITHUB_OUTPUT
            echo "url=https://github.com/textyre/arch-images/releases/latest/download/arch-base.box" >> $GITHUB_OUTPUT
          else
            TAG=$(gh api repos/textyre/ubuntu-images/releases/latest --jq '.tag_name')
            echo "name=ubuntu-base" >> $GITHUB_OUTPUT
            echo "url=https://github.com/textyre/ubuntu-images/releases/latest/download/ubuntu-base.box" >> $GITHUB_OUTPUT
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Cache Vagrant box
        uses: actions/cache@v4
        id: box-cache
        with:
          path: ~/.vagrant.d/boxes
          key: vagrant-box-${{ inputs.platform }}-${{ steps.box.outputs.tag }}
          restore-keys: vagrant-box-${{ inputs.platform }}-

      - name: Add Vagrant box
        if: steps.box-cache.outputs.cache-hit != 'true'
        run: |
          vagrant box add ${{ steps.box.outputs.name }} \
            ${{ steps.box.outputs.url }} --provider libvirt

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-vagrant-${{ runner.os }}-${{ hashFiles('ansible/requirements.txt', 'ansible/requirements-molecule-vagrant.txt') }}
          restore-keys: pip-vagrant-${{ runner.os }}-

      - name: Install molecule + dependencies
        run: pip install -r ansible/requirements-molecule-vagrant.txt

      - name: Cache Ansible collections
        uses: actions/cache@v4
        with:
          path: ~/.ansible/collections
          key: ansible-collections-${{ hashFiles('ansible/requirements.yml') }}
          restore-keys: ansible-collections-

      - name: Install Ansible Galaxy collections
        run: ansible-galaxy collection install -r ansible/requirements.yml

      - name: Run Molecule
        env:
          PY_COLORS: "1"
          ANSIBLE_FORCE_COLOR: "1"
        run: |
          VAGRANT_MODULES=$(python3 -c \
            "import os, molecule_plugins.vagrant; \
             print(os.path.join(os.path.dirname(molecule_plugins.vagrant.__file__), 'modules'))")
          export ANSIBLE_LIBRARY="$VAGRANT_MODULES"
          molecule test -s ${{ inputs.scenario }} --platform-name ${{ inputs.platform }}
        working-directory: "ansible/roles/${{ inputs.role_name }}"
