version: '3'

vars:
  ANSIBLE_DIR: ansible
  VENV: '{{.ANSIBLE_DIR}}/.venv'
  PREFIX: 'env PATH="{{.TASKFILE_DIR}}/{{.VENV}}/bin:$PATH"'
  ANSIBLE: '{{.PREFIX}} ansible-playbook'
  PLAYBOOK: playbooks/workstation.yml

env:
  REPO_ROOT: '{{.TASKFILE_DIR}}'
  ANSIBLE_CONFIG: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}/ansible.cfg'
  ANSIBLE_ROLES_PATH: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}/roles:{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}/playbooks/roles:~/.ansible/roles:/usr/share/ansible/roles'
  ANSIBLE_INVENTORY: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}/inventory/hosts.yml'
  ANSIBLE_VAULT_PASSWORD_FILE: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}/vault-pass.sh'

tasks:
  default:
    desc: "Show available commands"
    cmds:
      - task --list
    silent: true

  bootstrap:
    desc: "Install all dependencies (run once on fresh system)"
    dir: '{{.ANSIBLE_DIR}}'
    cmds:
      - echo "==> Creating Python virtual environment..."
      - python -m venv .venv
      - echo "==> Installing Python dependencies..."
      - '{{.PREFIX}} pip install --upgrade pip'
      - '{{.PREFIX}} pip install -r requirements.txt'
      - echo "==> Installing Ansible Galaxy collections..."
      - '{{.PREFIX}} ansible-galaxy collection install -r requirements.yml'
      - echo "Bootstrap complete! Run 'task check' or 'task test'"

  check:
    desc: "Validate playbook syntax"
    deps: [_ensure-venv]
    dir: '{{.ANSIBLE_DIR}}'
    cmds:
      - 'echo "==> Checking playbook syntax..."'
      - "{{.ANSIBLE}} playbooks/mirrors-update.yml --syntax-check"
      - "{{.ANSIBLE}} playbooks/workstation.yml --syntax-check"
      - 'echo "Syntax check passed"'

  lint:
    desc: "Run ansible-lint"
    deps: [_ensure-venv]
    dir: '{{.ANSIBLE_DIR}}'
    cmds:
      - '{{.PREFIX}} ansible-lint playbooks/ roles/'

  test:
    desc: "Run all tests (check + lint + molecule for all roles)"
    prompt: "Molecule tests will modify your system. Create VM snapshot first?"
    cmds:
      - task: check
      - task: lint
      - task: test-base-system
      - task: test-vm
      - task: test-reflector
      - task: test-yay
      - task: test-packages
      - task: test-user
      - task: test-ssh
      - task: test-git
      - task: test-shell
      - task: test-docker
      - task: test-firewall
      - task: test-xorg
      - task: test-lightdm
      - task: test-chezmoi
      - task: test-zen-browser
      - 'echo "All tests passed!"'

  # --- Individual role tests ---

  test-base-system:
    desc: "Run molecule tests for base_system"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}/roles/base_system'
    env:
      MOLECULE_PROJECT_DIRECTORY: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}'
    cmds:
      - 'echo "==> Testing base_system role..."'
      - '{{.PREFIX}} molecule test'

  test-vm:
    desc: "Run molecule tests for vm"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}/roles/vm'
    env:
      MOLECULE_PROJECT_DIRECTORY: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}'
    cmds:
      - 'echo "==> Testing vm role..."'
      - '{{.PREFIX}} molecule test'

  test-reflector:
    desc: "Run molecule tests for reflector"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}/roles/reflector'
    env:
      MOLECULE_PROJECT_DIRECTORY: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}'
    cmds:
      - 'echo "==> Testing reflector role..."'
      - '{{.PREFIX}} molecule test'

  test-yay:
    desc: "Run molecule tests for yay"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}/roles/yay'
    env:
      MOLECULE_PROJECT_DIRECTORY: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}'
    cmds:
      - 'echo "==> Testing yay role..."'
      - '{{.PREFIX}} molecule test'

  test-packages:
    desc: "Run molecule tests for packages"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}/roles/packages'
    env:
      MOLECULE_PROJECT_DIRECTORY: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}'
    cmds:
      - 'echo "==> Testing packages role..."'
      - '{{.PREFIX}} molecule test'

  test-user:
    desc: "Run molecule tests for user"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}/roles/user'
    env:
      MOLECULE_PROJECT_DIRECTORY: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}'
    cmds:
      - 'echo "==> Testing user role..."'
      - '{{.PREFIX}} molecule test'

  test-ssh:
    desc: "Run molecule tests for ssh"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}/roles/ssh'
    env:
      MOLECULE_PROJECT_DIRECTORY: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}'
    cmds:
      - 'echo "==> Testing ssh role..."'
      - '{{.PREFIX}} molecule test'

  test-git:
    desc: "Run molecule tests for git"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}/roles/git'
    env:
      MOLECULE_PROJECT_DIRECTORY: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}'
    cmds:
      - 'echo "==> Testing git role..."'
      - '{{.PREFIX}} molecule test'

  test-shell:
    desc: "Run molecule tests for shell"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}/roles/shell'
    env:
      MOLECULE_PROJECT_DIRECTORY: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}'
    cmds:
      - 'echo "==> Testing shell role..."'
      - '{{.PREFIX}} molecule test'

  test-docker:
    desc: "Run molecule tests for docker"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}/roles/docker'
    env:
      MOLECULE_PROJECT_DIRECTORY: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}'
    cmds:
      - 'echo "==> Testing docker role..."'
      - '{{.PREFIX}} molecule test'

  test-firewall:
    desc: "Run molecule tests for firewall"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}/roles/firewall'
    env:
      MOLECULE_PROJECT_DIRECTORY: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}'
    cmds:
      - 'echo "==> Testing firewall role..."'
      - '{{.PREFIX}} molecule test'

  test-xorg:
    desc: "Run molecule tests for xorg"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}/roles/xorg'
    env:
      MOLECULE_PROJECT_DIRECTORY: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}'
    cmds:
      - 'echo "==> Testing xorg role..."'
      - '{{.PREFIX}} molecule test'

  test-lightdm:
    desc: "Run molecule tests for lightdm"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}/roles/lightdm'
    env:
      MOLECULE_PROJECT_DIRECTORY: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}'
    cmds:
      - 'echo "==> Testing lightdm role..."'
      - '{{.PREFIX}} molecule test'

  test-chezmoi:
    desc: "Run molecule tests for chezmoi"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}/roles/chezmoi'
    env:
      MOLECULE_PROJECT_DIRECTORY: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}'
    cmds:
      - 'echo "==> Testing chezmoi role..."'
      - '{{.PREFIX}} molecule test'

  test-zen-browser:
    desc: "Run molecule tests for zen_browser"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}/roles/zen_browser'
    env:
      MOLECULE_PROJECT_DIRECTORY: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}'
    cmds:
      - 'echo "==> Testing zen_browser role..."'
      - '{{.PREFIX}} molecule test'

  # --- Playbook execution ---

  dry-run:
    desc: "Show what would change without applying"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}'
    cmds:
      - '{{.ANSIBLE}} {{.PLAYBOOK}} --check --diff'

  run:
    desc: "Apply playbook (real changes!)"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}'
    prompt: "This will modify your system. Continue?"
    cmds:
      - 'echo "==> Running playbook..."'
      - "{{.ANSIBLE}} {{.PLAYBOOK}} -v"

  workstation:
    desc: "Setup full workstation (all 13 roles)"
    deps: [_ensure-venv, _check-vault]
    dir: '{{.ANSIBLE_DIR}}'
    prompt: "This will install all packages and configure your system. Continue?"
    cmds:
      - 'echo "==> Setting up workstation..."'
      - "{{.ANSIBLE}} playbooks/workstation.yml -v"

  # --- ctOS Greeter ---

  greeter:build:
    desc: "Build ctOS greeter theme (Vite + TypeScript)"
    dir: greeter
    cmds:
      - npm ci
      - npm run build

  greeter:dev:
    desc: "Start Vite dev server for greeter theme"
    dir: greeter
    cmds:
      - npm run dev

  all:
    desc: "Run check + lint"
    cmds:
      - task: check
      - task: lint

  clean:
    desc: "Remove venv and cache"
    cmds:
      - rm -rf {{.VENV}} {{.ANSIBLE_DIR}}/.molecule {{.ANSIBLE_DIR}}/__pycache__

  vault-create:
    desc: "Create encrypted vault.yml with sudo password"
    deps: [_ensure-venv, _ensure-vault-pass]
    dir: '{{.ANSIBLE_DIR}}'
    status:
      - test -f inventory/group_vars/all/vault.yml
    cmds:
      - echo "==> Creating encrypted vault.yml..."
      - |
        read -s -r -p "Enter sudo password for ansible_become_password: " sudo_pass
        echo
        echo "ansible_become_password: \"${sudo_pass}\"" | \
          {{.PREFIX}} ansible-vault encrypt \
            --output inventory/group_vars/all/vault.yml -
        chmod 600 inventory/group_vars/all/vault.yml
        unset sudo_pass
      - echo "vault.yml created and encrypted"

  vault-edit:
    desc: "Edit encrypted vault.yml"
    deps: [_ensure-venv, _ensure-vault-pass]
    dir: '{{.ANSIBLE_DIR}}'
    preconditions:
      - sh: test -f inventory/group_vars/all/vault.yml
        msg: "vault.yml not found. Run 'task vault-create' first"
    cmds:
      - '{{.PREFIX}} ansible-vault edit inventory/group_vars/all/vault.yml'

  vault-view:
    desc: "View decrypted vault.yml contents"
    deps: [_ensure-venv, _ensure-vault-pass]
    dir: '{{.ANSIBLE_DIR}}'
    preconditions:
      - sh: test -f inventory/group_vars/all/vault.yml
        msg: "vault.yml not found. Run 'task vault-create' first"
    cmds:
      - '{{.PREFIX}} ansible-vault view inventory/group_vars/all/vault.yml'

  # --- Internal tasks ---

  _ensure-venv:
    internal: true
    status:
      - test -d {{.VENV}}
    cmds:
      - echo "Run 'task bootstrap' first"
      - exit 1

  _ensure-vault-pass:
    internal: true
    silent: true
    preconditions:
      - sh: '{{.TASKFILE_DIR}}/{{.ANSIBLE_DIR}}/vault-pass.sh >/dev/null 2>&1'
        msg: |
          Vault password not configured. Setup:
            1. echo 'password' > ~/.vault-pass && chmod 600 ~/.vault-pass
            2. pass insert ansible/vault-password

  _check-vault:
    internal: true
    dir: '{{.ANSIBLE_DIR}}'
    silent: true
    preconditions:
      - sh: test -f inventory/group_vars/all/vault.yml
        msg: |
          vault.yml not found. Create it:
            task vault-create
      - sh: '{{.PREFIX}} ansible-vault view inventory/group_vars/all/vault.yml >/dev/null 2>&1'
        msg: |
          Cannot decrypt vault. Setup vault password:
            1. echo 'password' > ~/.vault-pass && chmod 600 ~/.vault-pass
            2. pass insert ansible/vault-password
