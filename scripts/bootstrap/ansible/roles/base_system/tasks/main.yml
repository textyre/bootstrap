---
# === Базовая настройка системы ===
# Локаль, таймзона, hostname, pacman.conf

- name: Assert Arch Linux
  ansible.builtin.assert:
    that:
      - ansible_facts['os_family'] == 'Archlinux'
    fail_msg: "Роль base_system поддерживает только Arch Linux"
  tags: ['system']

# ---- Таймзона ----

- name: Set timezone
  community.general.timezone:
    name: "{{ base_system_timezone }}"
  tags: ['system', 'timezone']

# ---- Локаль ----

- name: Uncomment locale in locale.gen
  ansible.builtin.lineinfile:
    path: /etc/locale.gen
    regexp: '^#?\s*{{ base_system_locale }}'
    line: "{{ base_system_locale }} UTF-8"
    state: present
  register: _base_system_locale_gen
  tags: ['system', 'locale']

- name: Generate locale
  ansible.builtin.command: locale-gen
  when: _base_system_locale_gen is changed
  changed_when: true
  tags: ['system', 'locale']

- name: Set default locale
  ansible.builtin.copy:
    dest: /etc/locale.conf
    content: "LANG={{ base_system_locale }}\n"
    owner: root
    group: root
    mode: '0644'
  tags: ['system', 'locale']

# ---- Hostname ----

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ base_system_hostname }}"
  tags: ['system', 'hostname']

- name: Ensure /etc/hosts contains hostname
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "127.0.1.1\t{{ base_system_hostname }}"
    state: present
  tags: ['system', 'hostname']

# ---- Pacman configuration ----

- name: Enable ParallelDownloads in pacman.conf
  ansible.builtin.lineinfile:
    path: /etc/pacman.conf
    regexp: '^#?\s*ParallelDownloads'
    line: "ParallelDownloads = {{ base_system_pacman_parallel_downloads }}"
  tags: ['system', 'pacman']

- name: Enable Color in pacman.conf
  ansible.builtin.lineinfile:
    path: /etc/pacman.conf
    regexp: '^#?\s*Color'
    line: "Color"
  when: base_system_pacman_color
  tags: ['system', 'pacman']

- name: Enable VerbosePkgLists in pacman.conf
  ansible.builtin.lineinfile:
    path: /etc/pacman.conf
    regexp: '^#?\s*VerbosePkgLists'
    line: "VerbosePkgLists"
  when: base_system_pacman_verbose_pkg_lists
  tags: ['system', 'pacman']

# ---- Внешний кэш pacman (опционально) ----

- name: Setup external pacman cache
  when: base_system_setup_pacman_cache and base_system_pacman_cache_root | length > 0
  tags: ['system', 'pacman-cache']
  block:
    - name: Create pacman cache directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      loop:
        - "{{ base_system_pacman_cache_root }}/var/lib/pacman/sync"
        - "{{ base_system_pacman_cache_root }}/var/cache/pacman/pkg"
        - "{{ base_system_pacman_cache_root }}/etc/pacman.d"

    - name: Check if alpm user exists
      ansible.builtin.getent:
        database: passwd
        key: alpm
      register: _base_system_alpm_user
      failed_when: false

    - name: Set alpm group ownership on pacman cache dirs
      ansible.builtin.file:
        path: "{{ item }}"
        owner: root
        group: alpm
        mode: '2775'
        recurse: true
      loop:
        - "{{ base_system_pacman_cache_root }}/var"
        - "{{ base_system_pacman_cache_root }}/etc"
      when: >
        _base_system_alpm_user.ansible_facts.getent_passwd is defined
        and 'alpm' in _base_system_alpm_user.ansible_facts.getent_passwd

- name: Report base system configuration
  ansible.builtin.debug:
    msg:
      - "Таймзона: {{ base_system_timezone }}"
      - "Локаль: {{ base_system_locale }}"
      - "Hostname: {{ base_system_hostname }}"
      - "ParallelDownloads: {{ base_system_pacman_parallel_downloads }}"
  tags: ['system']
