---
- name: Ensure host is Arch Linux
  ansible.builtin.assert:
    that:
      - ansible_facts['os_family'] is defined
      - ansible_facts['os_family'] == 'Archlinux'
    fail_msg: "This role supports Arch Linux only"

- name: Install reflector package
  community.general.pacman:
    name: reflector
    state: present
  tags: ['install']

- name: Deploy reflector config
  ansible.builtin.template:
    src: reflector.conf.j2
    dest: "{{ reflector_conf_path }}"
    owner: root
    group: root
    mode: '0644'
  notify: Reload systemd
  tags: ['configure']

- name: Ensure timer dropin dir exists
  ansible.builtin.file:
    path: /etc/systemd/system/reflector.timer.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags: ['configure']

- name: Set reflector timer schedule drop-in
  ansible.builtin.copy:
    dest: /etc/systemd/system/reflector.timer.d/override.conf
    content: |
      [Timer]
      OnCalendar={{ reflector_timer_schedule }}
    owner: root
    group: root
    mode: '0644'
  notify: Reload systemd
  tags: ['configure']

- name: Ensure reflector.timer is enabled and started
  ansible.builtin.systemd:
    name: reflector.timer
    enabled: yes
    state: started
    daemon_reload: yes
  tags: ['service']

- name: Update pacman cache
  community.general.pacman:
    update_cache: yes
  tags: ['update']

- name: Read current mirrorlist (for comparison)
  ansible.builtin.slurp:
    src: "{{ reflector_mirrorlist_path }}"
  register: reflector_old_mirror
  ignore_errors: true
  tags: ['update']

- name: Backup current mirrorlist BEFORE update
  ansible.builtin.copy:
    remote_src: yes
    src: "{{ reflector_mirrorlist_path }}"
    dest: "{{ reflector_mirrorlist_path }}.bak.{{ ansible_facts['date_time']['iso8601_basic'] | default(lookup('pipe', 'date -u +%Y%m%dT%H%M%SZ')) }}"
    mode: '0644'
  when: reflector_backup_mirrorlist and reflector_old_mirror is succeeded
  tags: ['update']

- name: Run reflector to update mirrorlist now (with retries)
  ansible.builtin.command: >-
    reflector
    --country {{ reflector_countries }}
    --protocol {{ reflector_protocol }}
    --latest {{ reflector_latest }}
    --sort {{ reflector_sort }}
    --age {{ reflector_age }}
    --connection-timeout {{ reflector_connection_timeout }}
    --download-timeout {{ reflector_download_timeout }}
    --threads {{ reflector_threads }}
    --save {{ reflector_mirrorlist_path }}
  register: reflector_run
  retries: "{{ reflector_retries }}"
  delay: "{{ reflector_retry_delay }}"
  until: reflector_run.rc == 0
  failed_when: reflector_run.rc != 0
  check_mode: no
  environment: "{{ {'http_proxy': reflector_proxy, 'https_proxy': reflector_proxy} if reflector_proxy | length > 0 else {} }}"
  tags: ['update']

- name: Read new mirrorlist
  ansible.builtin.slurp:
    src: "{{ reflector_mirrorlist_path }}"
  register: reflector_new_mirror
  tags: ['update']

- name: Determine if mirrorlist changed
  ansible.builtin.set_fact:
    reflector_mirrorlist_changed: "{{ (reflector_old_mirror.content | default('')) != (reflector_new_mirror.content | default('')) }}"
  tags: ['update']

- name: Report reflector result
  ansible.builtin.debug:
    msg: "Reflector completed. Mirrorlist changed: {{ reflector_mirrorlist_changed }}"
  changed_when: reflector_mirrorlist_changed
  tags: ['update']
