# Molecule Testing

## Что это?

Molecule - фреймворк для автоматизированного тестирования Ansible ролей.

**Как работает:**
1. **Converge** - применяет роль к системе
2. **Verify** - автоматически проверяет результат
3. **Idempotence** - проверяет идемпотентность

## Для вашего случая (Arch Linux VM)

Вы уже работаете в Arch Linux VM, поэтому Molecule будет применять роль **прямо к вашей системе**.

### ⚠️ ВАЖНО: Molecule ИЗМЕНЯЕТ систему!

**Что будет изменено:**
- Установлен пакет `reflector`
- Создан `/etc/xdg/reflector/reflector.conf`
- Настроен `reflector.timer` в systemd
- Обновлен `/etc/pacman.d/mirrorlist`

**Перед запуском:**
1. Создайте снапшот VM в VirtualBox
2. Запустите `task test`
3. Если всё ок - оставьте изменения
4. Если что-то не так - откатите снапшот

## Запуск тестов

### Синтаксис и линтинг (безопасно)
```bash
task check  # Проверка синтаксиса
task lint   # Ansible-lint
task all    # Синтаксис + линтинг
```

### Molecule (изменяет систему!)
```bash
# 1. В VirtualBox: VM → Снапшоты → Создать
# 2. Запустить тесты
task test

# 3a. Если всё ок - оставить изменения
# 3b. Если нет - откатить снапшот в VirtualBox
```

## Что проверяет Molecule?

После применения роли автоматически проверяет:

1. ✅ Пакет `reflector` установлен
2. ✅ Конфиг `/etc/xdg/reflector/reflector.conf` существует
3. ✅ Конфиг содержит правильные параметры
4. ✅ Systemd таймер настроен
5. ✅ Таймер включен и запущен
6. ✅ Mirrorlist обновлен и содержит серверы

## Рабочий процесс

### Разработка
```bash
# Быстрая проверка без изменений
task check
task lint

# При необходимости - применить к системе
ansible-playbook playbooks/mirrors-update.yml
```

### Перед коммитом
```bash
# Полная проверка с автоматической верификацией
task test
```

## Альтернативы

### 1. Ручная проверка (без Molecule)
```bash
ansible-playbook playbooks/mirrors-update.yml

# Вручную проверяем:
systemctl status reflector.timer
cat /etc/pacman.d/mirrorlist
cat /etc/xdg/reflector/reflector.conf
```
**Минус:** Легко забыть что-то проверить

### 2. Check mode (dry-run)
```bash
ansible-playbook playbooks/mirrors-update.yml --check --diff
```
**Минус:** Не все модули поддерживают, не проверяет реальный результат

### 3. Molecule (текущий подход)
```bash
task test
```
**Плюс:** Автоматически проверяет ВСЁ
**Минус:** Изменяет систему (нужен снапшот)

## Почему не Docker/Vagrant?

**Docker:**
- ❌ Нет полноценного systemd
- ❌ Arch Linux образы нестабильны

**Vagrant:**
- ❌ Вы уже в VM (nested virtualization медленно)
- ❌ Избыточно

**Delegated driver (localhost):**
- ✅ Вы УЖЕ на Arch Linux
- ✅ Просто делаете снапшот VM
- ✅ Быстро и просто

## FAQ

**Q: Безопасно ли запускать `task test`?**
A: НЕТ! Роль будет применена к вашей системе. Создайте снапшот VM перед запуском.

**Q: Как откатить изменения?**
A: В VirtualBox: VM → Снапшоты → Восстановить нужный снапшот.

**Q: Можно ли протестировать без изменения системы?**
A: Частично - используйте `task check` и `task lint` для проверки синтаксиса. Для полной проверки нужно применять роль.

**Q: Зачем Molecule если можно просто запустить playbook?**
A: Molecule **автоматически проверяет** результат (systemd, файлы, содержимое). Без него вы проверяете вручную и можете что-то пропустить.

**Q: Что если я не хочу создавать снапшоты?**
A: Тогда просто применяйте роль напрямую: `ansible-playbook playbooks/mirrors-update.yml`. Molecule нужен только для автоматизированного тестирования.
