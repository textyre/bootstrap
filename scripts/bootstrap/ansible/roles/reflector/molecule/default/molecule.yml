---
# Molecule configuration for reflector role testing
#
# DELEGATED DRIVER: Применяет роль к localhost (вашей Arch Linux VM)
#
# ВНИМАНИЕ: Этот тест РЕАЛЬНО изменяет систему!
#   - Устанавливает reflector
#   - Настраивает systemd таймер
#   - Обновляет /etc/pacman.d/mirrorlist
#
# Перед запуском: Создайте снапшот VM в VirtualBox!
# После теста: Откатите снапшот или оставьте изменения

dependency:
  name: galaxy
  options:
    requirements-file: requirements.yml
    ignore-errors: true

driver:
  name: delegated  # Не создает контейнеры, работает с localhost
  options:
    managed: false  # Molecule не управляет инфраструктурой
    ansible_connection_options:
      ansible_connection: local

platforms:
  - name: localhost
    groups:
      - arch_hosts

provisioner:
  name: ansible
  inventory:
    group_vars:
      all:
        # Test with safe defaults (небольшие значения для быстрого теста)
        reflector_countries: "US,DE"
        reflector_latest: 5
        reflector_age: 24
        reflector_backup_mirrorlist: true
  playbooks:
    converge: converge.yml
    verify: verify.yml
  config_options:
    defaults:
      callbacks_enabled: profile_tasks
      stdout_callback: yaml
  env:
    ANSIBLE_VERBOSITY: "1"

verifier:
  name: ansible

scenario:
  test_sequence:
    - dependency
    - syntax
    - converge
    - idempotence
    - verify
  create_sequence:
    - dependency
  check_sequence:
    - dependency
    - syntax
  converge_sequence:
    - dependency
    - converge
  destroy_sequence: []
