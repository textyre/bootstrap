version: '3'

vars:
  VENV: .venv
  PREFIX: 'env PATH="{{.TASKFILE_DIR}}/{{.VENV}}/bin:$PATH"'
  ANSIBLE: '{{.PREFIX}} ansible-playbook'
  PLAYBOOK: playbooks/workstation.yml

tasks:
  default:
    desc: "Show available commands"
    cmds:
      - task --list
    silent: true

  bootstrap:
    desc: "Install all dependencies (run once on fresh system)"
    cmds:
      - echo "==> Creating Python virtual environment..."
      - python -m venv {{.VENV}}
      - echo "==> Installing Python dependencies..."
      - '{{.PREFIX}} pip install --upgrade pip'
      - '{{.PREFIX}} pip install -r requirements.txt'
      - echo "Bootstrap complete! Run 'task check' or 'task test'"

  check:
    desc: "Validate playbook syntax"
    deps: [_ensure-venv]
    cmds:
      - 'echo "==> Checking playbook syntax..."'
      - "{{.ANSIBLE}} playbooks/mirrors-update.yml --syntax-check"
      - "{{.ANSIBLE}} playbooks/workstation.yml --syntax-check"
      - 'echo "Syntax check passed"'

  lint:
    desc: "Run ansible-lint"
    deps: [_ensure-venv]
    cmds:
      - '{{.PREFIX}} ansible-lint playbooks/ roles/'

  test:
    desc: "Run all tests (check + lint + molecule for all roles)"
    prompt: "Molecule tests will modify your system. Create VM snapshot first?"
    cmds:
      - task: check
      - task: lint
      - task: test-base-system
      - task: test-reflector
      - task: test-yay
      - task: test-packages
      - task: test-user
      - task: test-ssh
      - task: test-git
      - task: test-shell
      - task: test-docker
      - task: test-firewall
      - task: test-xorg
      - task: test-lightdm
      - task: test-chezmoi
      - 'echo "All tests passed!"'

  # --- Individual role tests ---

  test-base-system:
    desc: "Run molecule tests for base_system"
    deps: [_ensure-venv, _check-vault]
    dir: roles/base_system
    env:
      MOLECULE_PROJECT_DIRECTORY: "{{.TASKFILE_DIR}}"
    cmds:
      - 'echo "==> Testing base_system role..."'
      - '{{.PREFIX}} molecule test'

  test-reflector:
    desc: "Run molecule tests for reflector"
    deps: [_ensure-venv, _check-vault]
    dir: roles/reflector
    env:
      MOLECULE_PROJECT_DIRECTORY: "{{.TASKFILE_DIR}}"
    cmds:
      - 'echo "==> Testing reflector role..."'
      - '{{.PREFIX}} molecule test'

  test-yay:
    desc: "Run molecule tests for yay"
    deps: [_ensure-venv, _check-vault]
    dir: roles/yay
    env:
      MOLECULE_PROJECT_DIRECTORY: "{{.TASKFILE_DIR}}"
    cmds:
      - 'echo "==> Testing yay role..."'
      - '{{.PREFIX}} molecule test'

  test-packages:
    desc: "Run molecule tests for packages"
    deps: [_ensure-venv, _check-vault]
    dir: roles/packages
    env:
      MOLECULE_PROJECT_DIRECTORY: "{{.TASKFILE_DIR}}"
    cmds:
      - 'echo "==> Testing packages role..."'
      - '{{.PREFIX}} molecule test'

  test-user:
    desc: "Run molecule tests for user"
    deps: [_ensure-venv, _check-vault]
    dir: roles/user
    env:
      MOLECULE_PROJECT_DIRECTORY: "{{.TASKFILE_DIR}}"
    cmds:
      - 'echo "==> Testing user role..."'
      - '{{.PREFIX}} molecule test'

  test-ssh:
    desc: "Run molecule tests for ssh"
    deps: [_ensure-venv, _check-vault]
    dir: roles/ssh
    env:
      MOLECULE_PROJECT_DIRECTORY: "{{.TASKFILE_DIR}}"
    cmds:
      - 'echo "==> Testing ssh role..."'
      - '{{.PREFIX}} molecule test'

  test-git:
    desc: "Run molecule tests for git"
    deps: [_ensure-venv, _check-vault]
    dir: roles/git
    env:
      MOLECULE_PROJECT_DIRECTORY: "{{.TASKFILE_DIR}}"
    cmds:
      - 'echo "==> Testing git role..."'
      - '{{.PREFIX}} molecule test'

  test-shell:
    desc: "Run molecule tests for shell"
    deps: [_ensure-venv, _check-vault]
    dir: roles/shell
    env:
      MOLECULE_PROJECT_DIRECTORY: "{{.TASKFILE_DIR}}"
    cmds:
      - 'echo "==> Testing shell role..."'
      - '{{.PREFIX}} molecule test'

  test-docker:
    desc: "Run molecule tests for docker"
    deps: [_ensure-venv, _check-vault]
    dir: roles/docker
    env:
      MOLECULE_PROJECT_DIRECTORY: "{{.TASKFILE_DIR}}"
    cmds:
      - 'echo "==> Testing docker role..."'
      - '{{.PREFIX}} molecule test'

  test-firewall:
    desc: "Run molecule tests for firewall"
    deps: [_ensure-venv, _check-vault]
    dir: roles/firewall
    env:
      MOLECULE_PROJECT_DIRECTORY: "{{.TASKFILE_DIR}}"
    cmds:
      - 'echo "==> Testing firewall role..."'
      - '{{.PREFIX}} molecule test'

  test-xorg:
    desc: "Run molecule tests for xorg"
    deps: [_ensure-venv, _check-vault]
    dir: roles/xorg
    env:
      MOLECULE_PROJECT_DIRECTORY: "{{.TASKFILE_DIR}}"
    cmds:
      - 'echo "==> Testing xorg role..."'
      - '{{.PREFIX}} molecule test'

  test-lightdm:
    desc: "Run molecule tests for lightdm"
    deps: [_ensure-venv, _check-vault]
    dir: roles/lightdm
    env:
      MOLECULE_PROJECT_DIRECTORY: "{{.TASKFILE_DIR}}"
    cmds:
      - 'echo "==> Testing lightdm role..."'
      - '{{.PREFIX}} molecule test'

  test-chezmoi:
    desc: "Run molecule tests for chezmoi"
    deps: [_ensure-venv, _check-vault]
    dir: roles/chezmoi
    env:
      MOLECULE_PROJECT_DIRECTORY: "{{.TASKFILE_DIR}}"
    cmds:
      - 'echo "==> Testing chezmoi role..."'
      - '{{.PREFIX}} molecule test'

  # --- Playbook execution ---

  dry-run:
    desc: "Show what would change without applying"
    deps: [_ensure-venv, _check-vault]
    cmds:
      - '{{.ANSIBLE}} {{.PLAYBOOK}} --check --diff'

  run:
    desc: "Apply playbook (real changes!)"
    deps: [_ensure-venv, _check-vault]
    prompt: "This will modify your system. Continue?"
    cmds:
      - 'echo "==> Running playbook..."'
      - "{{.ANSIBLE}} {{.PLAYBOOK}} -v"

  workstation:
    desc: "Setup full workstation (all 13 roles)"
    deps: [_ensure-venv, _check-vault]
    prompt: "This will install all packages and configure your system. Continue?"
    cmds:
      - 'echo "==> Setting up workstation..."'
      - "{{.ANSIBLE}} playbooks/workstation.yml -v"

  all:
    desc: "Run check + lint"
    cmds:
      - task: check
      - task: lint

  clean:
    desc: "Remove venv and cache"
    cmds:
      - rm -rf {{.VENV}} .molecule __pycache__

  # --- Internal tasks ---

  _ensure-venv:
    internal: true
    status:
      - test -d {{.VENV}}
    cmds:
      - echo "Run 'task bootstrap' first"
      - exit 1

  _check-vault:
    internal: true
    silent: true
    preconditions:
      - sh: '{{.PREFIX}} ansible-vault view inventory/group_vars/all/vault.yml >/dev/null 2>&1'
        msg: |
          Cannot decrypt vault. Setup vault password:
            1. echo 'password' > ~/.vault-pass && chmod 600 ~/.vault-pass
            2. pass insert ansible/vault-password
