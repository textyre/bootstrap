version: '3'

vars:
  VENV: .venv
  PREFIX: 'env PATH="{{.TASKFILE_DIR}}/{{.VENV}}/bin:$PATH"'
  PLAYBOOK: playbooks/mirrors-update.yml

tasks:
  default:
    desc: "Show available commands"
    cmds:
      - task --list
    silent: true

  bootstrap:
    desc: "Install all dependencies (run once on fresh system)"
    cmds:
      - echo "==> Creating Python virtual environment..."
      - python -m venv {{.VENV}}
      - echo "==> Installing Python dependencies..."
      - '{{.PREFIX}} pip install --upgrade pip'
      - '{{.PREFIX}} pip install -r requirements.txt'
      - echo "Bootstrap complete! Run 'task check' or 'task test'"

  check:
    desc: "Validate playbook syntax"
    deps: [_ensure-venv]
    cmds:
      - '{{.PREFIX}} ansible-playbook {{.PLAYBOOK}} --syntax-check'

  lint:
    desc: "Run ansible-lint"
    deps: [_ensure-venv]
    cmds:
      - '{{.PREFIX}} ansible-lint playbooks/ roles/'

  test:
    desc: "Run molecule tests (set MOLECULE_SUDO_PASS first)"
    deps: [_ensure-venv]
    dir: roles/reflector
    env:
      MOLECULE_PROJECT_DIRECTORY: "{{.TASKFILE_DIR}}"
    cmds:
      - 'echo "WARNING: This will modify your system!"'
      - '{{.PREFIX}} molecule test'

  dry-run:
    desc: "Show what would change without applying"
    deps: [_ensure-venv]
    cmds:
      - '{{.PREFIX}} ansible-playbook {{.PLAYBOOK}} --check --diff'

  run:
    desc: "Apply playbook (real changes!)"
    deps: [_ensure-venv]
    prompt: "This will modify your system. Continue?"
    cmds:
      - '{{.PREFIX}} ansible-playbook {{.PLAYBOOK}}'

  all:
    desc: "Run check + lint"
    cmds:
      - task: check
      - task: lint

  clean:
    desc: "Remove venv and cache"
    cmds:
      - rm -rf {{.VENV}} .molecule __pycache__

  _ensure-venv:
    internal: true
    status:
      - test -d {{.VENV}}
    cmds:
      - echo "Run 'task bootstrap' first"
      - exit 1
