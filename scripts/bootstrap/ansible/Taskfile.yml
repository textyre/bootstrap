version: '3'

vars:
  VENV: .venv
  PREFIX: 'env PATH="{{.TASKFILE_DIR}}/{{.VENV}}/bin:$PATH"'
  ANSIBLE: '{{.PREFIX}} ansible-playbook'
  PLAYBOOK: playbooks/mirrors-update.yml

tasks:
  default:
    desc: "Show available commands"
    cmds:
      - task --list
    silent: true

  bootstrap:
    desc: "Install all dependencies (run once on fresh system)"
    cmds:
      - echo "==> Creating Python virtual environment..."
      - python -m venv {{.VENV}}
      - echo "==> Installing Python dependencies..."
      - '{{.PREFIX}} pip install --upgrade pip'
      - '{{.PREFIX}} pip install -r requirements.txt'
      - echo "Bootstrap complete! Run 'task check' or 'task test'"

  check:
    desc: "Validate playbook syntax"
    deps: [_ensure-venv]
    cmds:
      - 'echo "==> Checking playbook syntax..."'
      - "{{.ANSIBLE}} {{.PLAYBOOK}} --syntax-check"
      - "{{.ANSIBLE}} playbooks/workstation.yml --syntax-check"
      - 'echo "✓ Syntax check passed"'

  lint:
    desc: "Run ansible-lint"
    deps: [_ensure-venv]
    cmds:
      - '{{.PREFIX}} ansible-lint playbooks/ roles/'

  test:
    desc: "Run molecule tests for reflector (modifies system! Create VM snapshot first)"
    deps: [_ensure-venv]
    dir: roles/reflector
    env:
      MOLECULE_PROJECT_DIRECTORY: "{{.TASKFILE_DIR}}"
    cmds:
      - 'echo "⚠️  WARNING: This will modify your system!"'
      - 'echo "==> Applying reflector role and verifying..."'
      - '{{.PREFIX}} molecule test'
      - 'echo "✅ Reflector tests passed!"'

  test-packages:
    desc: "Run molecule tests for packages (modifies system! Create VM snapshot first)"
    deps: [_ensure-venv]
    dir: roles/packages
    env:
      MOLECULE_PROJECT_DIRECTORY: "{{.TASKFILE_DIR}}"
    cmds:
      - 'echo "⚠️  WARNING: This will install packages on your system!"'
      - 'echo "==> Applying packages role and verifying..."'
      - '{{.PREFIX}} molecule test'
      - 'echo "✅ Packages tests passed!"'

  test-full:
    desc: "Run all tests (check + lint + molecule for all roles)"
    prompt: "Molecule test will modify your system. Create VM snapshot first?"
    cmds:
      - task: check
      - task: lint
      - task: test
      - task: test-packages
      - 'echo "✓ All tests passed!"'

  dry-run:
    desc: "Show what would change without applying"
    deps: [_ensure-venv]
    cmds:
      - '{{.ANSIBLE}} {{.PLAYBOOK}} --check --diff'

  run:
    desc: "Apply playbook (real changes!)"
    deps: [_ensure-venv]
    prompt: "This will modify your system. Continue?"
    cmds:
      - 'echo "==> Running playbook..."'
      - "{{.ANSIBLE}} {{.PLAYBOOK}} -v"

  workstation:
    desc: "Setup full workstation (mirrors + packages)"
    deps: [_ensure-venv]
    prompt: "This will install all packages and configure your system. Continue?"
    cmds:
      - 'echo "==> Setting up workstation..."'
      - "{{.ANSIBLE}} playbooks/workstation.yml -v"

  all:
    desc: "Run check + lint"
    cmds:
      - task: check
      - task: lint

  clean:
    desc: "Remove venv and cache"
    cmds:
      - rm -rf {{.VENV}} .molecule __pycache__

  _ensure-venv:
    internal: true
    status:
      - test -d {{.VENV}}
    cmds:
      - echo "Run 'task bootstrap' first"
      - exit 1
