#!/usr/bin/env bash
# Set wallpaper using feh and save state
# Usage: wallpaper-set <path_to_image>

set -euo pipefail

STATE_DIR="${XDG_STATE_HOME:-$HOME/.local/state}"
STATE_FILE="$STATE_DIR/wallpaper-current"
WALLPAPER_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/wallpapers"

die() { echo "Error: $1" >&2; exit 1; }

if [[ $# -ne 1 ]]; then
    echo "Usage: wallpaper-set <path_to_image>"
    exit 1
fi

IMAGE="$1"

# Resolve relative paths against wallpaper dir
if [[ ! -f "$IMAGE" ]] && [[ -f "$WALLPAPER_DIR/$IMAGE" ]]; then
    IMAGE="$WALLPAPER_DIR/$IMAGE"
fi

[[ -f "$IMAGE" ]] || die "File not found: $IMAGE"

# Resolve to absolute path
IMAGE="$(realpath "$IMAGE")"

# Set wallpaper
feh --bg-fill "$IMAGE"

# Save state
mkdir -p "$STATE_DIR"
echo "$IMAGE" > "$STATE_FILE"

notify-send -u low "Wallpaper" "$(basename "$IMAGE")"
