#!/usr/bin/env bash
# Cycle wallpapers (next/prev)
# Usage: wallpaper-cycle [next|prev]

set -euo pipefail

STATE_DIR="${XDG_STATE_HOME:-$HOME/.local/state}"
STATE_FILE="$STATE_DIR/wallpaper-current"
WALLPAPER_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/wallpapers"
DIRECTION="${1:-next}"

if [[ ! -d "$WALLPAPER_DIR" ]]; then
    echo "Wallpaper directory not found: $WALLPAPER_DIR" >&2
    exit 1
fi

# Get sorted list of wallpapers
mapfile -t WALLPAPERS < <(find "$WALLPAPER_DIR" -maxdepth 1 -type f \
    \( -iname '*.png' -o -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.webp' -o -iname '*.bmp' \) \
    | sort)

COUNT=${#WALLPAPERS[@]}
if [[ $COUNT -eq 0 ]]; then
    echo "No wallpapers found in $WALLPAPER_DIR" >&2
    exit 1
fi

# Find current index
CURRENT_IDX=0
if [[ -f "$STATE_FILE" ]]; then
    CURRENT="$(cat "$STATE_FILE")"
    for i in "${!WALLPAPERS[@]}"; do
        if [[ "${WALLPAPERS[$i]}" == "$CURRENT" ]]; then
            CURRENT_IDX=$i
            break
        fi
    done
fi

# Calculate next index
case "$DIRECTION" in
    next) NEW_IDX=$(( (CURRENT_IDX + 1) % COUNT )) ;;
    prev) NEW_IDX=$(( (CURRENT_IDX - 1 + COUNT) % COUNT )) ;;
    *)    echo "Usage: wallpaper-cycle [next|prev]" >&2; exit 1 ;;
esac

wallpaper-set "${WALLPAPERS[$NEW_IDX]}"
