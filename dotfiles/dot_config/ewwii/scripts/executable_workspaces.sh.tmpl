#!/bin/bash
# ============================================================
# Workspaces JSON Generator for Ewwii
# Outputs JSON array of workspaces on i3 events
# Supports custom icons from workspace-icons.conf
# ============================================================

set -euo pipefail

# Ensure DISPLAY is set (required when launched from ewwii daemon)
export DISPLAY="${DISPLAY:-:0}"

# Custom icon file
ICON_FILE="${HOME}/.config/ewwii/workspace-icons.conf"

# Default icons for workspaces 1-10
declare -A DEFAULT_ICONS=(
    [1]="ðŸŒ"
    [2]="ó°€«"
    [3]="ó°€›"
    [4]=""
    [5]=""
    [6]=""
    [7]=""
    [8]=""
    [9]=""
    [10]=""
)

# Get icon for workspace (custom or default)
get_icon() {
    local ws_num="$1"

    # Check custom icon file first
    if [[ -f "$ICON_FILE" ]]; then
        local custom_icon
        custom_icon=$(grep "^${ws_num}=" "$ICON_FILE" 2>/dev/null | cut -d= -f2 | head -1)
        if [[ -n "$custom_icon" ]]; then
            echo "$custom_icon"
            return
        fi
    fi

    # Return default icon
    echo "${DEFAULT_ICONS[$ws_num]:-$ws_num}"
}

# Minimum workspaces to always show
MIN_WS={{ .layout.min_workspaces }}

# Generate workspaces JSON with custom icons
generate_json() {
    local workspaces
    workspaces=$(i3-msg -t get_workspaces 2>/dev/null) || return

    # Track which workspace numbers exist
    declare -A existing_ws

    # Build entries for existing workspaces
    local entries=()

    while read -r ws; do
        local num name focused urgent visible windows
        num=$(echo "$ws" | jq -r '.num')
        name=$(echo "$ws" | jq -r '.name')
        focused=$(echo "$ws" | jq -r '.focused')
        urgent=$(echo "$ws" | jq -r '.urgent')
        visible=$(echo "$ws" | jq -r '.visible')
        windows=$(echo "$ws" | jq -r '.windows // 0')

        existing_ws[$num]=1

        # Get icon (custom or default)
        local icon
        icon=$(get_icon "$num")

        # Determine state
        local state
        if [[ "$focused" == "true" ]]; then
            state="focused"
        elif [[ "$urgent" == "true" ]]; then
            state="urgent"
        elif [[ "$visible" == "true" ]] || [[ "$windows" -gt 0 ]]; then
            state="occupied"
        else
            state="empty"
        fi

        entries+=("$(jq -nc \
            --argjson number "$num" \
            --arg name "$name" \
            --arg icon "$icon" \
            --arg state "$state" \
            '{number: $number, name: $name, icon: $icon, state: $state}')")
    done < <(echo "$workspaces" | jq -c '.[]')

    # Add empty workspaces up to MIN_WS
    for n in $(seq 1 "$MIN_WS"); do
        if [[ -z "${existing_ws[$n]:-}" ]]; then
            local icon
            icon=$(get_icon "$n")
            entries+=("$(jq -nc \
                --argjson number "$n" \
                --arg name "$n" \
                --arg icon "$icon" \
                --arg state "empty" \
                '{number: $number, name: $name, icon: $icon, state: $state}')")
        fi
    done

    # Sort by workspace number and output
    local result="["
    local first=true
    while IFS= read -r entry; do
        if [[ "$first" == "true" ]]; then
            first=false
            result+="$entry"
        else
            result+=",$entry"
        fi
    done < <(printf '%s\n' "${entries[@]}" | jq -sc 'sort_by(.number)[]')

    result+="]"
    echo "$result"
}

# Output initial state
generate_json

# Subscribe to i3 workspace events and regenerate on change
i3-msg -t subscribe '["workspace"]' --monitor 2>/dev/null | while read -r _; do
    generate_json
done
