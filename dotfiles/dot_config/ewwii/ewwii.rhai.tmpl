// ============================================================
// Ewwii Config — Single-Bar Floating Islands Design
// Generated by chezmoi — DO NOT EDIT DIRECTLY
// Syntax: Ewwii 0.4.0 Rhai
// ============================================================
// Design: One transparent dock window spanning full width,
// with styled "island" boxes inside a horizontal box layout.
// This avoids i3's dock-stacking behavior.
// ============================================================
// NOTE: All styles are applied via CSS classes (ewwii.scss).
// No inline styles are used in this configuration.
// ============================================================
{{- $t := index .themes .theme_name }}

// ============================================================
// WIDGETS — Dynamic Workspaces
// ============================================================
fn workspaces(ws_json) {
    let buttons = [];
    let icon_size = {{ .font.icon_size }};

    if ws_json == "" || ws_json == "[]" {
        // Fallback: show 3 empty workspaces
        for n in 1..=3 {
            let ws_label = "" + n;
            buttons.push(eventbox(#{
                class: "ws empty",
                onclick: "i3-msg workspace number " + n,
                cursor: "pointer",
                halign: "center",
                valign: "center",
            }, [
                label(#{ text: ws_label })
            ]));
        }
    } else {
        // Dynamic workspaces from script
        let ws_list = parse_json(ws_json);

        for ws in ws_list {
            buttons.push(eventbox(#{
                class: "ws " + ws.state,
                onclick: "i3-msg workspace number " + ws.number,
                cursor: "pointer",
                halign: "center",
                valign: "center",
            }, [
                label(#{ text: ws.icon })
            ]));
        }
    }

    return box(#{
        class: "workspaces",
        orientation: "h",
        spacing: 4,
        space_evenly: false,
        halign: "center",
        valign: "center",
    }, buttons);
}

// ============================================================
// WIDGETS — Clock
// ============================================================
fn clock_widget(time_var, date_var) {
    let c_fg = "{{ $t.fg }}";
    let icon_calendar = "{{ .font.icon_calendar }}";
    let icon_size = {{ .font.icon_size }};
    let bar_size = {{ .font.bar_size }};

    return eventbox(#{
        class: "clock",
        onclick: "gsimplecal &",
        cursor: "pointer",
        halign: "center",
        valign: "center",
    }, [
        label(#{
            halign: "center",
            valign: "center",
            markup: `${icon_calendar} ${date_var}  ${time_var}`,
        })
    ]);
}

// ============================================================
// WIDGETS — System bar assembly
// ============================================================
fn system_info_btn(network_ip, cpu, memory) {
    let icon_wifi = "{{ .font.icon_wifi }}";
    let icon_cpu = "{{ .font.icon_cpu }}";
    let icon_database = "{{ .font.icon_database }}";

    return box(#{
        class: "system-info",
        orientation: "h",
        space_evenly: false,
        halign: "center",
        valign: "center",
    }, [
        label(#{ class: "sys-icon", text: icon_wifi }),
        label(#{ class: "sys-val", text: network_ip }),
        label(#{ class: "sys-icon", text: icon_cpu }),
        label(#{ class: "sys-val", text: `${cpu}%` }),
        label(#{ class: "sys-icon sys-icon-db", text: icon_database }),
        label(#{ class: "sys-val", text: `${memory}%` }),
    ]);
}

fn system_cog_btn() {
    let icon_cog = "{{ .font.icon_cog }}";

    return eventbox(#{
        class: "system-cog",
        onclick: "~/.config/rofi/scripts/controlcenter.sh &",
        cursor: "pointer",
        halign: "center",
        valign: "center",
    }, [
        label(#{ text: icon_cog })
    ]);
}

fn system_power_btn() {
    let icon_power = "{{ .font.icon_power }}";

    return eventbox(#{
        class: "system-power",
        onclick: "~/.config/rofi/scripts/powermenu.sh &",
        cursor: "pointer",
        halign: "center",
        valign: "center",
    }, [
        label(#{ text: icon_power })
    ]);
}

// ============================================================
// MAIN ENTRY POINT
// ============================================================
enter([
    // ========================================
    // DATA SOURCES — Polling (periodic updates)
    // ========================================
    poll("time", #{
        interval: "1s",
        cmd: "date '+%H:%M'",
        initial: "--:--",
    }),
    poll("date_str", #{
        interval: "60s",
        cmd: "date '+%a %b %d'",
        initial: "--- --- --",
    }),
    poll("cpu", #{
        interval: "2s",
        cmd: "top -bn1 | grep 'Cpu(s)' | awk '{print int($2)}'",
        initial: "0",
    }),
    poll("memory", #{
        interval: "3s",
        cmd: "awk '/MemTotal/{t=$2} /MemAvailable/{a=$2} END{printf \"%d\", (t-a)*100/t}' /proc/meminfo",
        initial: "0",
    }),
    poll("network_ip", #{
        interval: "5s",
        cmd: "ip route get 1 2>/dev/null | awk '{print $7; exit}' || echo 'offline'",
        initial: "...",
    }),

    // ========================================
    // DATA SOURCES — Listen (event-driven updates)
    // ========================================

    // Workspaces JSON from i3 events
    listen("workspaces_json", #{
        cmd: "~/.config/ewwii/scripts/workspaces.sh",
        initial: "[]",
    }),

    // ========================================
    // SINGLE BAR WINDOW
    // ========================================
    // One transparent dock window with islands inside.
    // Dock type ensures i3 reserves space at top.
    // All styles via external ewwii.scss (CSS classes on widgets).
    // ========================================

    defwindow("bar", #{
        monitor: 0,
        windowtype: "dock",
        stacking: "fg",
        geometry: #{
            x: "0px",
            y: "0px",
            width: "100%",
            height: "{{ add .layout.bar_pad_top .layout.bar_height .layout.bar_pad_bottom }}px",
            anchor: "top center",
        },
        reserve: #{
            side: "top",
            distance: "{{ add .layout.bar_pad_top .layout.bar_height .layout.bar_pad_bottom }}px",
        },
    },
    // Main bar container — spacer pattern for true centering
    box(#{
        class: "bar-container",
        orientation: "h",
        space_evenly: false,
        halign: "fill",
        valign: "center",
    }, [
        // ====== LEFT: workspaces ======
        box(#{
            class: "bar-left",
            orientation: "h",
            space_evenly: false,
            halign: "start",
            valign: "center",
        }, [
            box(#{
                class: "island ws-island",
                space_evenly: false,
                valign: "center",
            }, [workspaces(workspaces_json)]),
        ]),

        // ====== SPACER ======
        box(#{ hexpand: true, space_evenly: false }, []),

        // ====== CENTER: clock ======
        box(#{
            class: "island clock-island",
            space_evenly: false,
            halign: "center",
            valign: "center",
        }, [clock_widget(time, date_str)]),

        // ====== SPACER ======
        box(#{ hexpand: true, space_evenly: false }, []),

        // ====== RIGHT: system ======
        box(#{
            class: "island system-island",
            orientation: "h",
            space_evenly: false,
            halign: "end",
            valign: "center",
        }, [system_info_btn(network_ip, cpu, memory), system_cog_btn(), system_power_btn()]),
    ])
)
])
