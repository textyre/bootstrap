// ============================================================
// Ewwii Config — 4-Bar Floating Islands Design
// Generated by chezmoi — DO NOT EDIT DIRECTLY
// Syntax: Ewwii 0.4.0 Rhai
// ============================================================
{{- $t := index .themes .theme_name }}

// ============================================================
// WIDGETS — Dynamic Workspaces
// ============================================================
fn workspaces(ws_json) {
    let buttons = [];

    // Parse JSON string to array (ewwii provides parse_json)
    if ws_json == "" || ws_json == "[]" {
        // Fallback: show 3 empty workspaces
        for n in 1..=3 {
            buttons.push(button(#{
                class: "ws empty",
                onclick: `i3-msg workspace number ${n}`,
                label: if n == 1 { "1" } else if n == 2 { "2" } else { "3" },
            }));
        }
    } else {
        // Dynamic workspaces from script
        let ws_list = parse_json(ws_json);

        for ws in ws_list {
            let class_name = "ws " + ws.state;
            buttons.push(button(#{
                class: class_name,
                onclick: `i3-msg workspace number ${ws.number}`,
                label: ws.icon,
            }));
        }
    }

    return box(#{
        class: "workspaces",
        orientation: "h",
        spacing: {{ .layout.sep_gap }},
        halign: "center",
        valign: "center",
    }, buttons);
}

// ============================================================
// WIDGETS — Clock
// ============================================================
fn clock_widget(time_var, date_var) {
    return eventbox(#{
        onclick: "gsimplecal &",
    }, [
        box(#{
            class: "clock",
            orientation: "h",
            spacing: 6,
            halign: "center",
            valign: "center",
        }, [
            label(#{ class: "icon", text: "" }),
            label(#{ class: "date", text: date_var }),
            box(#{ class: "spacer" }, []),
            label(#{ class: "time", text: time_var }),
        ])
    ]);
}

// ============================================================
// WIDGETS — System modules
// ============================================================
fn network_module(ip_var) {
    return eventbox(#{
        onclick: "alacritty -e nmtui &",
    }, [
        box(#{
            class: "module success",
            orientation: "h",
            spacing: 6,
        }, [
            label(#{ class: "icon", text: "" }),
            label(#{ class: "value", text: ip_var }),
        ])
    ]);
}

fn volume_module(vol_var) {
    return eventbox(#{
        onclick: "pavucontrol &",
        onscroll: `if [ '{}' = 'up' ]; then pamixer -i 5; else pamixer -d 5; fi`,
    }, [
        box(#{
            class: "module",
            orientation: "h",
            spacing: 6,
        }, [
            label(#{ class: "icon", text: "" }),
            label(#{ class: "value", text: vol_var + "%" }),
        ])
    ]);
}

fn cpu_module(cpu_var) {
    return box(#{
        class: "module info",
        orientation: "h",
        spacing: 6,
    }, [
        label(#{ class: "icon", text: "" }),
        label(#{ class: "value", text: cpu_var + "%" }),
    ]);
}

fn memory_module(mem_var) {
    return box(#{
        class: "module warning",
        orientation: "h",
        spacing: 6,
    }, [
        label(#{ class: "icon", text: "" }),
        label(#{ class: "value", text: mem_var + "%" }),
    ]);
}

fn controlcenter_btn() {
    return eventbox(#{
        onclick: "~/.config/rofi/scripts/controlcenter.sh &",
    }, [
        label(#{ class: "icon accent", text: "" })
    ]);
}

fn powermenu_btn() {
    return eventbox(#{
        onclick: "~/.config/rofi/scripts/powermenu.sh &",
    }, [
        label(#{ class: "icon urgent", text: "" })
    ]);
}

fn sep() {
    return box(#{ class: "sep", width: {{ .layout.sep_gap }} }, []);
}

// ============================================================
// WIDGETS — System bar assembly
// ============================================================
fn system_bar(network_ip, volume, cpu, memory) {
    return box(#{
        class: "system",
        orientation: "h",
        halign: "fill",
        valign: "center",
    }, [
        network_module(network_ip),
        sep(),
        volume_module(volume),
        sep(),
        cpu_module(cpu),
        sep(),
        memory_module(memory),
        sep(),
        controlcenter_btn(),
        sep(),
        powermenu_btn(),
    ]);
}

// ============================================================
// WIDGETS — Add button
// ============================================================
fn add_button() {
    return eventbox(#{
        onclick: "~/.config/ewwii/scripts/add-workspace.sh &",
    }, [
        box(#{
            class: "add-btn",
            halign: "center",
            valign: "center",
        }, [
            label(#{ class: "icon accent", text: "+" })
        ])
    ]);
}

// ============================================================
// MAIN ENTRY POINT
// ============================================================
enter([
    // ========================================
    // DATA SOURCES — Polling (periodic updates)
    // ========================================
    poll("time", #{
        interval: "1s",
        cmd: "date '+%H:%M'",
        initial: "--:--",
    }),
    poll("date_str", #{
        interval: "60s",
        cmd: "date '+%a %b %d'",
        initial: "--- --- --",
    }),
    poll("cpu", #{
        interval: "2s",
        cmd: "top -bn1 | grep 'Cpu(s)' | awk '{print int($2)}'",
        initial: "0",
    }),
    poll("memory", #{
        interval: "3s",
        cmd: "free | grep Mem | awk '{print int($3/$2 * 100)}'",
        initial: "0",
    }),
    poll("volume", #{
        interval: "1s",
        cmd: "pamixer --get-volume 2>/dev/null || echo 0",
        initial: "0",
    }),
    poll("network_ip", #{
        interval: "5s",
        cmd: "ip route get 1 2>/dev/null | awk '{print $7; exit}' || echo 'offline'",
        initial: "...",
    }),

    // ========================================
    // DATA SOURCES — Listen (event-driven updates)
    // ========================================

    // Workspaces JSON from i3 events
    listen("workspaces_json", #{
        cmd: "~/.config/ewwii/scripts/workspaces.sh",
        initial: "[]",
    }),

    // Dynamic workspace bar width (recalculates on WS changes)
    listen("ws_bar_width", #{
        cmd: "~/.config/ewwii/scripts/calc-ws-width.sh",
        initial: "{{ .layout.bar_width_workspaces }}",
    }),

    // Dynamic add button X position (recalculates on WS changes)
    listen("ws_add_x", #{
        cmd: "~/.config/ewwii/scripts/calc-add-offset.sh",
        initial: "{{ add .layout.gaps_outer .layout.bar_width_workspaces .layout.ws_add_gap }}",
    }),

    // ========================================
    // WINDOWS
    // ========================================

    // Window: Workspaces (left island) — dynamic width
    defwindow("workspaces", #{
        monitor: 0,
        windowtype: "utility",
        geometry: #{
            x: "{{ .layout.gaps_outer }}px",
            y: "{{ .layout.bar_offset_y }}px",
            width: ws_bar_width + "px",
            height: "{{ .layout.bar_height }}px",
            anchor: "top left",
        },
    }, box(#{ class: "island ws-island" }, [workspaces(workspaces_json)])),

    // Window: Add button (left, after workspaces) — dynamic position
    defwindow("workspace-add", #{
        monitor: 0,
        windowtype: "utility",
        geometry: #{
            x: ws_add_x + "px",
            y: "{{ .layout.bar_offset_y }}px",
            width: "40px",
            height: "{{ .layout.bar_height }}px",
            anchor: "top left",
        },
    }, box(#{ class: "island add-island" }, [add_button()])),

    // Window: Clock (center island)
    defwindow("clock", #{
        monitor: 0,
        windowtype: "utility",
        geometry: #{
            x: "50%",
            y: "{{ .layout.bar_offset_y }}px",
            width: "{{ .layout.bar_width_clock }}px",
            height: "{{ .layout.bar_height }}px",
            anchor: "top center",
        },
    }, box(#{ class: "island clock-island" }, [clock_widget(time, date_str)])),

    // Window: System (right island)
    defwindow("system", #{
        monitor: 0,
        windowtype: "utility",
        geometry: #{
            x: "{{ .layout.gaps_outer }}px",
            y: "{{ .layout.bar_offset_y }}px",
            width: "{{ .layout.bar_width_system }}px",
            height: "{{ .layout.bar_height }}px",
            anchor: "top right",
        },
    }, box(#{ class: "island system-island" }, [system_bar(network_ip, volume, cpu, memory)])),
])
